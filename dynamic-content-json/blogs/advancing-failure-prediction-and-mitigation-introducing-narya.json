{
    "Slug": "advancing-failure-prediction-and-mitigation-introducing-narya",
    "Title": "障害の予測と軽減を進める -Narya の導入",
    "Summary": "Project Narya is a holistic, end-to-end prediction and mitigation service—named after the \"ring of fire\" from Lord of the Rings, known to resist the weariness of time.",
    "Content": "<p><em>&quot;この投稿では、Azure プラットフォームの信頼性を継続的に向上させるための取り組みが進行中の<a href=\"https://www.aka.ms/AdvancingReliability\" target=\"_blank\">「信頼性の向上</a>」シリーズを引き続き取り上げています。2018 年には、<a href=\"https://azure.microsoft.com/blog/improving-azure-virtual-machine-resiliency-with-predictive-ml-and-live-migration/\" target=\"_blank\">ライブ マイグレーション</a>を使用して仮想マシン (VM) の回復性を向上させるために取り&#39;手順を共有しました。2019 年に、ホストの障害を識別し、メモリを保持するソフト カーネルの再起動を通じてそれらのエラーから回復<a href=\"https://azure.microsoft.com/blog/improving-azure-virtual-machines-resiliency-with-project-tardigrade/\" target=\"_blank\">する Project Tardigrade</a> を使用して、仮想マシン&nbsp;の信頼性をさらに向上&#39;方法を共有しました。2020 年には、人工知能を使用してサービス品質を向上させる <a href=\"https://azure.microsoft.com/blog/advancing-azure-service-quality-with-artificial-intelligence-aiops/\" target=\"_blank\">AIOps ビジョン</a>を共有しました。今日は、エンド ツー エンドの予測と軽減サービスProject Narya を導入することで、これらの取り組みの進化に関する更新プログラムを提供したいと考えています。先週 <a href=\"https://www.youtube.com/watch?v=69PrhWQorEM\" target=\"_blank\">Microsoft Ignite で共有</a>したように、Narya は Azure のインテリジェント インフラストラクチャの重要な部分になりました。次の投稿は、Azure コンピューティング チームのプログラム マネージャーである <strong>Jeffrey He</strong> によって作成されました。&quot;&mdash;</em>Mark Russinovich、CTO、Azure</p>\n\n<hr>\n<p><em>この投稿には、プリンシパル データ科学者 マネージャー<strong>の Yingnong Dang</strong> とシニア データ サイエン<strong>ティストのセバスチャン レヴィ</strong>、<strong>ランドルフ 八尾</strong>、<strong>および蔦江からの</strong>投稿が含まれます。</em></p>\n\n<p>Projectナヤは、ロード・オブ・ザ・リングからの火&quot;のリングの後&quot;に名前が付いた、包括的でエンドツーエンドの予測と軽減サービス&mdash;であり、時間の疲れを損なうことに抵抗することが知られています。 Narya は、Azure ホストの障害を予測して軽減するだけでなく、軽減アクションの影響を測定し、自動フィードバック ループを使用して軽減戦略をインテリジェントに調整するように設計されています。 これは、世界中のすべての Azure コンピューティング クラスターにデプロイした一般的な機械学習および予測サービス システムである Resource Central プラットフォームを活用しています。 Narya は 1 年以上運用されており、平均して仮想マシンの中断が 26%&mdash; 削減され、Azure ワークロードをよりスムーズに実行できます。&nbsp;このブログ投稿では、この Narya フレームワークの概要について詳しくは、第 14 回 USENIX オペレーティング システムの設計と実装に関する USENIX シンポジウム (OSDI 2020) の<a href=\"https://www.usenix.org/conference/osdi20/presentation/levy\" target=\"_blank\">運用クラウド VM の中断&quot;を回避するための予測および適応型障害軽減策に関する記事をご覧&quot;</a>ください。&nbsp;</p>\n\n<h2>ナリヤの前にはどのようにアプローチしましたか?</h2>\n\n<p>以前は、機械学習を使用して障害予測を通知し、予測されたエラーに基づいて軽減アクションを静的に選択しました。 たとえば、ハードウェアの一部が危険であると判断&quot;された場合は、ワークロードを実行しているお客様に対して、仮想マシン&nbsp;の表示によって機能低下しているハードウェア&nbsp;が検出されたことを通知&quot;します。 また、常に次の一連の手順を実行します。</p>\n\n<ol>\n    <li>ノードでの新しい割り当てをブロックします。</li>\n    <li>可能な限り多くの仮想マシンをその場で移行します (ライブ マイグレーションを使用)。</li>\n    <li>有効期間の短い仮想マシン&nbsp;が有機的に停止されるか、顧客によって再デプロイされるまで数日待ちます。</li>\n    <li>残りの仮想マシンを移行するには、仮想マシン&nbsp;を切断して正常なノードに移動します。</li>\n    <li>ノードを運用環境から取り出し、内部診断を実行して修復アクションを決定します。</li>\n</ol>\n\n<p>この方法はうまくいきましたが、特定のシナリオで改善する機会がいくつか見えました。 たとえば、一部の障害が深刻すぎる (ディスクが破損しているなど) 場合、仮想マシンが停止または再デプロイされるまで何日も待てなくなる場合があります。 それ以外の場合、リスク&quot;の高い&quot;予測は、より軽微な、または偽陽性である可能性があります。 このような場合、強制移行は不要な顧客の影響を引き起こし、代わりに、特定の期間が経過した後もさらにシグナルを監視し、ノードを再評価することをお勧めします。 最終的には、お客様に最適なシステムを真に設計するには、予測に対する対応をより柔軟にする必要があるだけでなく、さまざまなシナリオに対するアクションの正確な顧客の影響を測定する必要があると結論付けました。</p>\n\n<h2>Narya を使用して、このアプローチを行うにはどうすればよいでしょうか。</h2>\n\n<p>ここでナリヤが登場します。 リスクの高い予測に対して 1 つの事前に決定された軽減アクションを&quot;&quot;用意するのではなく、Narya は多くの可能な軽減アクションを考慮します。 特定の予測セットに対して、Narya はオンライン A/B テスト フレームワークまたは強化学習フレームワークを使用して、最適な応答を決定します。</p>\n\n<h3>フェーズ 1: 故障予測</h3>\n\n<p>Narya は、まずフリート テレメトリを使用して、ハードウェア障害による潜在的なホスト障害を予測します。 ドメインエキスパート、知識ベースの予測ルール、機械学習ベースの方法の両方を組み合わせて使用することで、正確な予測を生成できます。</p>\n\n<p>ドメインエキスパート予測ルールの例として、CPUInternal&nbsp; Error (IERR) が&nbsp; n 日以内に 2 回発生した場合 (たとえば、n = 30) です。これは、ノードが間もなく再び失敗する可能性が高いことを示します。 Narya は現在、データドリブンメソッドから派生した数十のドメインエキスパート予測ルールを使用しています。</p>\n\n<p>Narya には機械学習モデルも組み込まれています。これは、予測ルール&mdash;よりも大きな期間にわたってより多くのシグナルとパターンを分析し、以前に障害を予測する際に役立ちます。 これは、以前の障害予測作業に基づいていますが、個々のコンポーネントの障害に焦点を当てるのではなく、実際の顧客の影響に関してホストの全体的な正常性をレビューするようになりました。 2018年からは、着信信号の種類を拡大し、信号品質を向上させてきた。 その結果、偽陽性と陰性の数が減り、最終的にこの故障予測ステップの有効性が向上しました。</p>\n\n<h3>フェーズ 2: 軽減アクションの決定と適用</h3>\n\n<p>1 つの固定軽減戦略を用意するのではなく、Narya が考慮する軽減アクションの選択を作成しました。 各軽減アクションは、次のような多数の小さな手順の複合と見なすことができます。</p>\n\n<ul>\n    <li>ノードをアロカテーブルとしてマークします。</li>\n    <li>仮想マシン&nbsp;を他のノードに<a href=\"https://azure.microsoft.com/blog/improving-azure-virtual-machine-resiliency-with-predictive-ml-and-live-migration/\" target=\"_blank\">ライブ移行</a>する。</li>\n    <li>メモリを保持しながら<a href=\"https://azure.microsoft.com/blog/improving-azure-virtual-machines-resiliency-with-project-tardigrade/\" target=\"_blank\">カーネルを論理的に再起動</a>します。これによって、短時間の一時停止しか発生するお客様のワークロードへの中断が最小限に抑えられます。</li>\n    <li>ノード上のデプリトリタイジング&nbsp;割り当て。</li>\n    <li>その他</li>\n</ul>\n\n<p>たとえば、1 つの軽減アクションとして、ノードをアロカブルにマークしてから、メモリ保持カーネルのソフト リブートを試み、成功した場合は再び割り当て可能なマークを付けます。 失敗した場合は、ライブ マイグレーションを実装し、ノードを診断に送信します。そこでテストを実行して、ハードウェアが機能低下しているかどうかを判断します。 その場合は、ノードを送信してハードウェアの修復と交換を行います。 全体的に、これにより、さまざまな軽減策を使用してさまざまなシナリオを処理する柔軟性が大幅に向上し、Azure ホストの全体的な回復性が向上します。</p>\n\n<p>より柔軟な方法で危険な&quot;予測に&quot;対応するために、Narya はオンライン A/B テスト フレームワークと強化学習 (RL) フレームワークを使用して、最小限の仮想マシンの中断に対して軽減アクションを継続的に最適化します。</p>\n\n<h3>A/B テスト フレームワーク</h3>\n\n<p>Narya は、A/B テストを行うときに、さまざまな軽減アクションを選択し、アクションを実行しないコントロール グループと比較し、すべてのデータを収集して、どの軽減アクションがどのシナリオに最適かを判断します。 それ以降、この特定の一連の障害予測では、仮想マシン&nbsp;のrebootを減らし、利用可能な容量を増やし、最高のパフォーマンスを維持するのに役立つ最適なアクション&mdash;を継続的に選択します。</p>\n\n<h3>強化学習 (RL) フレームワーク</h3>\n\n<p>Narya が強化学習を使用する場合は、時間の経過と同時にさまざまなアクションを調査し、最も頻繁に最新のアクションを比較することで、全体的なカスタマー エクスペリエンスを最大化する方法を学習します。 強化学習は、最も最適なアクションの使用と新しいアクションの探索のバランスを継続的に取ることで、最適でないアクションを回避するように自動的に学習するという点で、A/B テストとは異なります。</p>\n\n<h3>フェーズ 3: 顧客の影響を観察し、モデルを再トレーニングする</h3>\n\n<p>最後に、軽減アクションが実行された後、新しいデータを収集できます。 現在、最新の顧客影響データの測定値が得られます。これは、Narya フレームワークのすべてのステップでモデルを継続的に改善するために使用されます。 Narya はこれを自動的&mdash;に行うことを確認します。データは、障害予測ステップでドメインエキスパートルールと機械学習モデルを更新するのに役立つだけでなく、意思決定ステップでより良い軽減アクション ポリシーを通知します。</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8e1ca08a-b3f4-4108-b491-6819e133e7aa.png\"><img alt=\"Narya starts with a hardware failure prediction, makes a smart decision on how to respond, implements the response, then measures the customer impact and incorporates it via a feedback loop.\" border=\"0\" height=\"332\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f61ae5d8-a9d6-44e7-a78c-f15d702aec41.png\" style=\"border: 0px currentcolor; border-image: none; display: inline; background-image: none;\" title=\"\" width=\"1024\"></a></p>\n\n<p><em>図 1: Narya はハードウェア障害予測から始まり、応答方法をスマートに決定し、応答を実装した後、顧客の影響を測定し、フィードバック ループを介して組み込みます。</em></p>\n\n<h2>アクションのナリヤ: 例</h2>\n\n<p>Narya が実際の顧客ワークロードの保護に役立った実際の例を次に示します。</p>\n\n<ul>\n    <li>T0 20:15:31,Narya は、ディスクの問題によりノードが故障する確率が高いと予測しました。</li>\n    <li>T0 20:32:01、Narya は軽減アクションを選択しました。 &quot;ノードを 3 日間参加不可としてマークし、ライブ マイグレーションを試み、すべての仮想マシンが移行された後、またはホストが失敗した場合は、ノードを診断に送信します。&quot;</li>\n    <li>T0 20:32:11、ノードが承認不可とマークされ、ライブ マイグレーションがトリガーされました。</li>\n    <li>T0 20:47:22 &ndash; 00:11:55、ライブ マイグレーションの対象となる 9 台の仮想マシンがノードから正常にライブ マイグレーションされました。</li>\n    <li>T1 19:14:01、ノードが異常になり、ノード上の 15 台の仮想マシン&nbsp;が再起動されました。</li>\n    <li>T1 19:55:07、障害状態に入った後に診断に送信されたノード。</li>\n    <li>T2 00:14:12、ディスクストレステストに失敗しました。</li>\n    <li>T3 00:19:56、ディスクが置き換えられました。</li>\n</ul>\n\n<p>この実際の例では、Narya は 9 台の仮想マシン&nbsp;を回避し、間もなく失敗すると予想されるノードに新しいワークロードが割り当てられていないことを確認することで、さらにお客様の負担を防ぎました。 さらに、破損したノードはすぐに修復のために送信され、問題が既に予想されていたため、仮想マシン&nbsp;の再起動が繰り返されませんでした。 この例は比較的単純ですが、主な目的は、Narya が状況を評価し、この状況に対してこの軽減アクションをスマートに選択したことを示することです。 他のシナリオでは、軽減アクションでは、ノードを別の日数だけ参加不可にしたり、ライブ マイグレーションではなくソフト カーネルの再起動を試したり、ノードを完全にアロケーションとしてマークするのではなく、割り当てを枯渇させたりすることがあります。 Narya は、全体的なカスタマー エクスペリエンスを最大限に向上させるために、さまざまな &quot;リスク&quot; の予測にはるかに柔軟に対応できるように構築されています。</p>\n\n<h2>ナリヤの違いは何ですか?</h2>\n\n<ol>\n    <li><strong>データドリブン アクションの選択:</strong> 軽減アクションに最適な推測を行う代わりに、データを使用して選択した各軽減アクションの真の影響を判断し、各軽減アクションの影響をテストおよび測定しています。</li>\n    <li><strong>可能な限り動的:</strong> 静的な軽減策の割り当てとは対照的に、Narya は、ソフトウェア更新プログラム、ハードウェア更新プログラム、または顧客のワークロードの変更などを介してシステムが変更された場合でも、最適な軽減アクションが選択されることを継続的に保証するようになりました。たとえば、CPU の頻度の低下によって発生した予測エラーによってライブ マイグレーションが実行される静的割り当てがあるとします。 これは、差し迫った障害を示す防御メカニズムである可能性がありますが、Azure プラットフォームに対する最近の更新では、システムが意図的に CPU 周波数を調整して電力消費を再調整する可能性があります。つまり、CPU 頻度の低下が、必ずしもライブ マイグレーションを実行する必要があるとは限りません。 静的割り当てでは、正常なノードの使用を誤って回避するため、最終的に害を及ぼすアクションを誤って適用します。 Narya では、A/B テストと強化学習から、この特定のシナリオでは、ライブ マイグレーションが最適な軽減アクションではなくなったことがわかります。</li>\n    <li><strong>柔軟な軽減策:</strong> 以前は、特定の症状セットに対して処方できる軽減アクションは 1 つだけでした。 ただし、マルチテナントと多様な顧客ワークロードでは、エキスパート ドメインの知識を持つ場合でも、事前に最適な軽減策を決定することは困難でした。 Narya を使用すると、必要な数の軽減アクションを構成できるようになり、Narya がさまざまなエラー予測に最適なアクション 項目を自動的にテストして選択できるようになりました。 最後に、スマートな安全メカニズムが導入されているため、Narya&#39;の軽減アクション チェーンが、不定のブロックにつながる可能性のあるデッドロックを防ぐことも確信できます。</li>\n</ol>\n\n<h2>今後の予定</h2>\n\n<p>今後は、Narya を改善して、Azure の回復性と信頼性をさらに高めたいと考えています。 具体的には、次の予定です。</p>\n\n<ul>\n    <li><strong>より多くの予測シナリオを組み込みます。</strong> より多くのハードウェア障害の種類をカバーする、より高度なハードウェア障害予測手法を開発する予定です。 また、この予測手順には、より多くのソフトウェア シナリオを組み込む予定です。</li>\n    <li><strong>より多くの軽減アクションを組み込む:</strong> 追加の軽減アクションを構築することで、Narya が広範な障害予測に対応する方法に柔軟性を高めることができます。</li>\n    <li><strong>意思決定をよりスマートにする:</strong>最後に、最適な軽減策を決定するスマートな意思決定&quot;ステップにニュアンスを&quot;追加することで、Narya を改善する予定です。 たとえば、特定のノードで実行されているワークロードを確認し、その情報をスマートな意思決定&quot;ステップに&quot;組み込み、中断を最小限に抑える方法で軽減アクションを実行します。</li>\n</ul>\n\n<p>Narya フレームワークの詳細については、第 14 回 USENIX オペレーティング システムの設計と実装に関するシンポジウム (OSDI 2020) で<a href=\"https://www.usenix.org/conference/osdi20/presentation/levy\" target=\"_blank\">運用クラウド VM の中断&quot;を回避するためのPredictive および Adaptive Failure Mitigation に関する記事を参照&quot;</a>&nbsp;&nbsp;してください。&nbsp;</p>\n"
}