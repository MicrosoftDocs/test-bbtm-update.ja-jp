{
    "Slug": "analysis-of-network-connection-data-with-azure-monitor-for-virtual-machines",
    "Title": "仮想マシン用の Azure Monitor を使用したネットワーク接続データの分析",
    "Summary": "Azure Monitor for virtual machines (VMs) collects network connection data that you can use to analyze the dependencies and network traffic of your VMs.",
    "Content": "<p>仮想マシン (VM) 用の Azure Monitor では、VM の依存関係とネットワーク トラフィックを分析するために使用できるネットワーク接続データが収集されます。 ライブ接続と失敗した接続の数、送受信されたバイト数、および VM の接続依存関係をプロセス レベルまで分析できます。 悪意のある接続が検出されると、それらの IP アドレスと脅威レベルに関する情報が含まれます。 新しくリリースされた <strong>VMBoundPort</strong> データ セットを使用すると、開いているポートとその接続を分析してセキュリティ分析を行うことができます。</p>\n\n<p>このデータの分析を開始するには、<a href=\"https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-onboard\" target=\"_blank\">オンボードしてAzure Monitor for VMsする</a>必要があります。</p>\n\n<h2>Workbooks</h2>\n\n<p>事前構築済みの編集可能なレポートを使用して分析を開始する場合は、Azure Monitor for VMsに付属しているブックの一部を試すことができます。 オンボードしたら、Azure Monitor に移動し、[分析情報] メニュー セクションから <strong>Virtual Machines (プレビュー)</strong> を選択します。 ここから、[ <strong>パフォーマンス] タブまたは [マップ] タブ</strong> に移動して <strong>、[ブックの表示</strong> ] のリンクを表示できます。ブック ギャラリーには、ネットワーク データを分析する次のブックが含まれます。</p>\n\n<ul>\n <li>接続の概要</li>\n <li>失敗した接続</li>\n <li>TCP トラフィック</li>\n <li>トラフィックの比較</li>\n <li>［アクティブなポート］</li>\n <li>ポートを開く</li>\n</ul>\n\n<p>これらの編集可能なレポートを使用すると、1 つの VM、VM のグループ、および仮想マシン スケール セットの接続データを分析できます。</p>\n\n<h2>Log Analytics</h2>\n\n<p>Log Analytics を使用してデータを分析する場合は、Azure Monitor に移動し、[ <strong>ログ</strong> ] を選択してデータのクエリを開始できます。 ログ ビューには、選択されているワークスペースの名前と、そのワークスペース内のスキーマが表示されます。 <strong> ServiceMap </strong>データ型の下には、次の 2 つのテーブルがあります。</p>\n\n<ul>\n <li>VMBoundPort</li>\n <li>VMConnection</li>\n</ul>\n\n<p>次のクエリをコピーして Log Analytics クエリ ボックスに貼り付けて実行できます。 クエリを実行するコンピューターの名前を指定するには、以下のいくつかの例を編集する必要があることに注意してください。</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f4803989-7e95-431a-8ec0-7487f2499176.png\"><img alt=\"Screenshot of copying and pasting queries into the Log Analytics query box\" border=\"0\" height=\"859\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/3bba4bf7-c087-4d77-84b1-547fcc9174ba.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Log Analytics クエリ ボックスへのクエリのコピーと貼り付けのスクリーンショット\" width=\"1583\"></a></p>\n\n<h2>一般的なクエリ</h2>\n\n<p>VM で開いているポートの数を確認します。これは、どの VM の構成とセキュリティの脆弱性を評価するときに役立ちます。</p>\n\n<pre>\nVMBoundPort\n| where Ip != &quot;127.0.0.1&quot;\n| summarize by Computer, Machine, Port, Protocol\n| summarize OpenPorts=count() by Computer, Machine\n| order by OpenPorts desc</pre>\n\n<p>VM 上のバインドされたポートを一覧表示します。これは、どの VM の構成とセキュリティの脆弱性を評価するときに役立ちます。</p>\n\n<pre>\nVMBoundPort\n| distinct Computer, Port, ProcessName</pre>\n\n<p>アプリケーションまたはサービスがどのように構成されているかを判断するために、ポート別にネットワーク アクティビティを分析します。</p>\n\n<pre>\nVMBoundPort\n| where Ip != &quot;127.0.0.1&quot;\n| summarize BytesSent=sum(BytesSent), BytesReceived=sum(BytesReceived), LinksEstablished=sum(LinksEstablished), LinksTerminated=sum(LinksTerminated), arg_max(TimeGenerated, LinksLive) by Machine, Computer, ProcessName, Ip, Port, IsWildcardBind\n| project-away TimeGenerated\n| order by Machine, Computer, Port, Ip, ProcessName</pre>\n\n<p>VM の送信および受信したバイト数の傾向。</p>\n\n<pre>\nVMConnection\n| summarize sum(BytesSent), sum(BytesReceived) by bin(TimeGenerated,1hr), Computer\n| order by Computer desc\n//| limit 5000\n| render timechart</pre>\n\n<p>ワークスペースに多数のコンピューターがある場合は、上記の例の limit ステートメントのコメントを解除できます。 グラフ ツールを使用すると、送信または受信したバイト数を表示したり、特定のコンピューターにフィルター処理したりできます。</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f88791f3-002a-464a-8fdb-74a468153a2e.png\"><img alt=\"Screenshot of chart tools being used to view Bytes sent or received\" border=\"0\" height=\"575\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/59117028-f2a7-4e56-8dde-082fea7321bc.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"送信または受信したバイト数を表示するために使用されているグラフ ツールのスクリーンショット\" width=\"1046\"></a></p>\n\n<p>時間の経過と同時に接続エラーが発生し、障害率が安定しているか、または変化しているかを判断します。</p>\n\n<pre>\nVMConnection\n| where Computer == &lt;replace this with a computer name, e.g. &lsquo;acme-demo&rsquo;&gt;\n| extend bythehour = datetime_part(&quot;hour&quot;, TimeGenerated)\n| project bythehour, LinksFailed\n| summarize failCount = count() by bythehour\n| sort by bythehour asc\n| render timechart</pre>\n\n<p>リンク状態の傾向。マシンの動作と接続状態を分析します。</p>\n\n<pre>\nVMConnection\n| where Computer == &lt;replace this with a computer name, e.g. &lsquo;acme-demo&rsquo;&gt;\n| summarize  dcount(LinksEstablished), dcount(LinksLive), dcount(LinksFailed), dcount(LinksTerminated) by bin(TimeGenerated, 1h)\n| render timechart</pre>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e3ff4bd7-e708-426d-a35f-b8622593c2f8.png\"><img alt=\"Screenshot of line chart showing query results from the last 24 hours\" border=\"0\" height=\"570\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b308be9d-4320-43ec-b2cf-e153ebf2db98.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"過去 24 時間のクエリ結果を示す折れ線グラフのスクリーンショット\" width=\"1047\"></a></p>\n\n<h2>Azure Monitor for VMsでのログ クエリの概要</h2>\n\n<p>Azure Monitor for VMsの詳細については、「Azure Monitor for VMs <a href=\"https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-overview\" target=\"_blank\">(プレビュー)</a>」の概要&ldquo;を参照してください。&rdquo;Azure Monitor for VMsを既に使用している場合は、<a href=\"https://docs.microsoft.com/en-us/azure/azure-monitor/insights/vminsights-log-search\" target=\"_blank\">Log Analytics を使用してデータにクエリを実行するための</a>クエリの例をドキュメントで確認できます。</p>\n"
}