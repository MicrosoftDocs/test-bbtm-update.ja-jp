{
    "Slug": "allocation-failure-and-remediation",
    "Title": "割り当ての失敗と修復",
    "Summary": "This post explains the causes of some of the common allocation failures and suggests possible remediation. The information may also be useful when you plan the deployment of your services.",
    "Content": "VM を作成するときに、停止 (割り当て解除) された VM を再起動するか、VM のサイズを変更するか、新しい Web ロール または worker ロール インスタンスを追加すると、Microsoft Azureコンピューティング リソースがサブスクリプションに割り当てられます。 これらの操作をしているときに、Azure サブスクリプションの制限に達していなくても、エラーが発生する場合があります。 このブログ投稿では、一般的な割り当てエラーの原因について説明し、考えられる修復を提案します。 この情報は、サービスのデプロイを計画する場合にも役立ちます。\n\nAzure データセンターのサーバーは、クラスターにパーティション分割されています。 通常、割り当て要求は複数のクラスターで試行されますが、割り当て要求からの特定の制約により、Azure プラットフォームは 1 つのクラスターでのみ要求を試行する可能性があります。 このブログ投稿では、これを \"クラスターにピン留め\" と見なします。 次の図 1 は、複数のクラスターで試行される通常の割り当ての場合を示しています。図 2 は、既存のクラウド サービス <em>CS_1</em>がホストされるため、<em>クラスター 2</em> にピン留めされた割り当てのケースを示しています。\n\n<img style=\"float: none; padding-top: 0px; padding-left: 0px; margin: 0px auto; padding-right: 0px; border: 0px;\" title=\"AllocationBlogPost1\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/AllocationBlogPost1.png\" alt=\"AllocationBlogPost1\" width=\"610\" height=\"296\" border=\"0\" />\n\n割り当て要求がクラスターにピン留めされている場合、リソース プールが小さいため、空きリソースが見つからない可能性が高くなります。 さらに、割り当て要求がクラスターに固定されていて、そのクラスターでは要求されたリソースの種類がサポートされていない場合、クラスターに空きリソースがあっても、要求は失敗します。 次の図 3 は、唯一の候補クラスターに空きリソースがないため、ピン留めされた割り当てが失敗する場合を示しています。図 4 は、クラスターに空きリソースがある場合でも、唯一の候補クラスターが要求された VM サイズをサポートしていないために、ピン留めされた割り当てが失敗するケースを示しています。\n\n<img style=\"float: none; padding-top: 0px; padding-left: 0px; margin: 0px auto; padding-right: 0px; border: 0px;\" title=\"AllocationBlogPost2\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/AllocationBlogPost2.png\" alt=\"AllocationBlogPost2\" width=\"610\" height=\"345\" border=\"0\" />\n\n次のセクションでは、割り当て要求をピン留めする一般的なケースを示します。 割り当てエラーが発生した場合は、説明されている状況のいずれかが自分に適用されるかどうかを確認します。 要求がピン留めされている場合は、ピン留め制約の一部を削除して、より多くのクラスターに要求を開き、割り当てが成功する可能性を高めます。\n\n一般に、\"要求された VM サイズがサポートされていません\" というエラーが示されていない限り、要求に対応するために十分なリソースがクラスター内で解放されている可能性があるため、後でいつでも再試行できます。 問題が要求された VM サイズがサポートされていない場合は、別の VM サイズを試してください。それ以外の場合、唯一のオプションは、次のセクションで提案されているようにピン留め制約を削除することです。\n\nアフィニティ グループに関連する 2 つの一般的なエラー シナリオです。 以前は、アフィニティ グループを使用して VM/サービス インスタンスとの近接性を提供したり、Virtual Network (VNet) の作成を有効にしたりしていました。 リージョン Virtual Networkの導入により、アフィニティ グループはVirtual Networkを作成する必要がなくなりました。 Azure インフラストラクチャでのネットワーク待ち時間の短縮に伴い、VM/サービスの近接性にアフィニティ グループを使用することをお勧めします。 アフィニティ グループの推奨事項のトピックに関するフォローアップ ドキュメントの更新が行われます。\n\n次の図 5 は、(固定された) 割り当てシナリオの分類を示しています。 次のセクションでは、各シナリオについて詳しく説明します。\n\n<img style=\"float: none; padding-top: 0px; padding-left: 0px; margin: 0px auto; padding-right: 0px; border: 0px;\" title=\"AllocationBlogPost3\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/AllocationBlogPost3.png\" alt=\"AllocationBlogPost3\" width=\"610\" height=\"237\" border=\"0\" />\n<h1>割り当てシナリオ</h1>\n<blockquote>注(*): Azure プラットフォームから返される割り当てエラーを使用して、対応するシナリオを特定します。 各シナリオ セクションに記載されているエラーは短い形式です。 詳細なエラー文字列については、付録を参照してください。</blockquote>\n<h2>シナリオ: VM のサイズ変更、または既存のクラウド サービスへの VM またはロール インスタンスの追加</h2>\n<strong>エラー</strong>: Upgrade_VMSizeNotSupported* または GeneralError*\n\n<strong>クラスターのピン留めの原因</strong>: VM のサイズ変更、または既存のクラウド サービスへの VM またはロール インスタンスの追加の要求は、既存のクラウド サービスをホストする元のクラスターで試行する必要があります。 新しいクラウド サービスを作成すると、Azure プラットフォームは、空きリソースを持つ別のクラスター、または要求した VM サイズをサポートするクラスターを見つけることができます。\n\n<strong>修復</strong>:\n\nエラーが Upgrade_VMSizeNotSupported* である場合は、別の VM サイズを試してみてください。 別の VM サイズを使用することは選択肢ではありませんが、別の VIP を使用することが許容される場合は、新しい VM をホストする新しいクラウド サービスを作成し、既存の VM が実行されているリージョン Virtual Networkに新しいクラウド サービスを追加します。 既存のクラウド サービスでリージョン Virtual Networkを使用していない場合でも、新しいクラウド サービスの新しいVirtual Networkを作成し、この<a href=\"https://msdn.microsoft.com/en-us/library/azure/dn690122.aspx\">リンク</a>の指示に従って既存の VNet を新しい VNet に接続できます。 地域Virtual Networkの詳細については、この<a href=\"https://azure.microsoft.com/blog/2014/05/14/regional-virtual-networks/\">ブログ記事</a>を参照してください。\n\nエラーが GeneralError の場合 *は、リソースの種類 (特定の VM サイズなど) がクラスターでサポートされている可能性がありますが、現時点ではクラスターには空きリソースがありません。上記と同様に、新しいクラウド サービスを作成して目的のコンピューティング リソースを追加し (新しいクラウド サービスでは別の VIP を使用する必要があることに注意してください)、リージョン Virtual Networkを使用してCloud Servicesを接続してみてください。 <h2>シナリオ: 停止 (割り当て解除) VM の再起動 - <span style=\"text-decoration: underline;\">部分</span>割り当て</h2>\n解除 <strong>エラー</strong>: GeneralError*\n\n<strong>クラスターのピン留めの原因</strong>: <span style=\"text-decoration: underline;\">部分的</span> な割り当て解除とは、クラウド サービス <span style=\"text-decoration: underline;\">内のすべての VM ではなく</span> 、1 つ以上を停止 (割り当て解除) したことを意味します。 VM を停止 (割り当て解除) すると、関連付けられているリソースが解放されます。 そのため、停止した (割り当て解除された) VM を再起動すると、新しい割り当て要求になります。 部分的に割り当て解除されたクラウド サービスで VM を再起動することは、既存のクラウド サービスに VM を追加することと同じであり、既存のクラウド サービスをホストする元のクラスターで割り当て要求を試行する必要があります。 別のクラウド サービスを作成すると、Azure プラットフォームは、空きリソースを持つ別のクラスター、または要求した VM サイズをサポートするクラスターを見つけることができます。\n\n<strong>修復</strong>:\n\n別の VIP を使用できる場合は、停止している (割り当て解除された) VM を削除し (ただし、関連付けられているディスクは保持します)、VM を別のクラウド サービス経由で追加し直します。 リージョン Virtual Networkを使用して、Cloud Servicesを接続します。\n<ol>\n <li>既存のクラウド サービスでリージョン Virtual Networkを使用している場合は、新しいクラウド サービスを同じVirtual Networkに追加するだけです。</li>\n <li>既存のクラウド サービスでリージョン Virtual Networkを使用していない場合は、新しいクラウド サービスの新しいVirtual Networkを作成します。 この <a href=\"https://msdn.microsoft.com/en-us/library/azure/dn690122.aspx\">リンク</a> の手順に従って、既存の VNet を新しい VNet に接続します。 地域Virtual Networkの詳細については、この<a href=\"https://azure.microsoft.com/blog/2014/05/14/regional-virtual-networks/\">ブログ記事</a>を参照してください。</li>\n</ol>\n<h2>シナリオ: 停止 (割り当て解除) VM の再起動 - <span style=\"text-decoration: underline;\">完全な</span> De-Allocation</h2>\n<strong>エラー</strong>: GeneralError*\n\n<strong>クラスターのピン留めの原因</strong>: <span style=\"text-decoration: underline;\">完全な</span> 割り当て解除とは、クラウド サービス <span style=\"text-decoration: underline;\">からすべての</span> VM を停止 (割り当て解除) したことを意味します。 現時点では、これらの VM を再起動するための割り当て要求は、クラウド サービスをホストする元のクラスターで試行する必要があります。 新しいクラウド サービスを作成すると、Azure プラットフォームは、空きリソースを持つ別のクラスター、または要求した VM サイズをサポートするクラスターを見つけることができます。\n\n<strong>修復</strong>:\n\n別の VIP を使用できる場合は、元の停止済み (割り当て解除済み) VM を削除し (ただし、関連付けられているディスクは保持します)、対応するクラウド サービス (VM を停止 (割り当て解除) したときに、関連するコンピューティング リソースは既に解放されています) を削除します。 VM を追加し直す新しいクラウド サービスを作成します。\n<h2>シナリオ: ステージング/運用デプロイ (サービスとしてのプラットフォームのみ)</h2>\n<strong>エラー</strong>: New_General* またはNew_VMSizeNotSupported*\n\n<strong>クラスターのピン留めの原因</strong>: クラウド サービスのステージングデプロイと運用デプロイは、同じクラスターでホストされます。 2 つ目のデプロイを追加する場合、対応する割り当て要求は、最初のデプロイをホストする同じクラスター内で試行されます。\n\n<strong>修復</strong>:\n\n許容される場合は、最初のデプロイと元のクラウド サービスを削除し、クラウド サービスを再デプロイします。 このアクションは、デプロイの両方に適した十分な空きリソースを持つクラスター、または要求した VM サイズをサポートするクラスター内に最初のデプロイを配置する場合があります。\n<h2>シナリオ: アフィニティ グループ - VM/サービスの近接性</h2>\n<strong>エラー</strong>: New_General* またはNew_VMSizeNotSupported*\n\n<strong>クラスターのピン留めの原因</strong>: アフィニティ グループに割り当てられたコンピューティング リソースは、1 つのクラスターに関連付けられます。 そのアフィニティ グループ内の新しいコンピューティング リソース要求は、既存のリソースがホストされているのと同じクラスターで試行されます。 これは、新しいリソースが新しいクラウド サービスまたは既存のクラウド サービスを通じて作成される場合に関係なく当てはまります。\n\n<strong>修復</strong>:\n\n必要がない場合は、アフィニティ グループを使用しないか、コンピューティング リソースを複数のアフィニティ グループにグループ化してみてください。\n<h2>シナリオ: Affinity-Group ベースのVirtual Network</h2>\n<strong>エラー</strong>: New_General* またはNew_VMSizeNotSupported*\n\n<strong>クラスターのピン留めの原因</strong>: リージョン Virtual Networkが発表される前に、Virtual Networkをアフィニティ グループに関連付ける必要がありました。 その結果、アフィニティ グループに配置されたコンピューティング リソースは、上記の「Affinity Group - VM/Service Proximity」シナリオで説明したのと同じ制約によってバインドされます。コンピューティング リソースは 1 つのクラスターに関連付けられます。\n\n<strong>修復</strong>:\n\nアフィニティ グループが必要ない場合は、追加する新しいリソースの新しいリージョン Virtual Networkを作成します。 この <a href=\"https://msdn.microsoft.com/en-us/library/azure/dn690122.aspx\">リンク</a> の手順に従って、既存の VNet を新しい VNet に接続します。 地域Virtual Networkの詳細については、この<a href=\"https://azure.microsoft.com/blog/2014/05/14/regional-virtual-networks/\">ブログ記事</a>を参照してください。\n\nまたは、この<a href=\"https://azure.microsoft.com/blog/2014/11/26/migrating-existing-services-to-regional-scope/\">リンク</a>の手順に従って Affinity-Group ベースのVirtual Networkをリージョン Virtual Networkに移行し、目的のリソースをもう一度追加してみてください。\n<h1>付録</h1>\n<h2>エラー文字列参照</h2>\n<strong>New_VMSizeNotSupported</strong>: \"デプロイ要求の制約により、このデプロイに必要な VM サイズ (または VM サイズの組み合わせ) をプロビジョニングできません。 可能であれば、仮想ネットワークのバインドなどの制約条件の緩和、他のデプロイがなくアフィニティ グループが別のホストされるサービスへのデプロイ、アフィニティ グループのないホストされるサービスへのデプロイ、別のリージョンへのデプロイのいずれかを試してください。\"\n\n<strong>New_General</strong>: \"割り当てに失敗しました。要求の制約を満たすことができない。 要求されている新しいサービスのデプロイがアフィニティ グループにバインドされているか、仮想ネットワークを対象としています。または、このホストされるサービスに既存のデプロイがあります。 ここに挙げた条件に該当する場合には、新しいデプロイが特定の Azure リソースに制限されます。 後でもう一度やり直すか、VM サイズを小さくするか、ロール インスタンスの数を減らしてください。 可能な場合には、上に挙げた制約条件を削除することや、別のリージョンにデプロイすることもできます。\"\n\n<strong>Upgrade_VMSizeNotSupported</strong>: \"デプロイをアップグレードできません。 要求された VM サイズ XXX は、既存のデプロイをサポートするリソースの中では用意できない可能性があります。 後でもう一度やり直すか、VM サイズを変更するか、ロール インスタンスの数を減らしてみてください。または、空のホストされるサービスの下で、新しいアフィニティ グループを指定するかアフィニティ グループのバインドなしを指定して、デプロイを作成してください。\"\n\n<strong>GeneralError</strong>: \"サーバーで内部エラーが発生しました。 要求を再試行してください。\" または \"サービスの割り当てを生成できませんでした。"
}