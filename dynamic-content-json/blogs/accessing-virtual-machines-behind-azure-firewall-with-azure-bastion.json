{
    "Slug": "accessing-virtual-machines-behind-azure-firewall-with-azure-bastion",
    "Title": "Azure Bastion を使用したAzure Firewallの背後にある仮想マシンへのアクセス",
    "Summary": "Azure Virtual Network enables a flexible foundation for building advanced networking architectures. Managing heterogeneous environments with various types of filtering components, such as Azure Firewall or your favorite network virtual appliance, requires a little bit of planning.",
    "Content": "<p>Azure Virtual Networkを使用すると、高度なネットワーク アーキテクチャを構築するための柔軟な基盤を実現できます。 Azure Firewallやお気に入りのネットワーク仮想アプライアンス (NVA) など、さまざまな種類のフィルター コンポーネントを使用して異種環境を管理するには、少し計画が必要です。</p>\n\n<p><a href=\"https://azure.microsoft.com/en-us/blog/announcing-the-preview-of-microsoft-azure-bastion/\" target=\"_blank\">現在プレビュー段階にある</a> Azure Bastion は、サービスとしてのフル マネージド プラットフォーム (PaaS) であり、Azure portalを介して仮想マシン (VM) に直接安全でシームレスなリモート デスクトップ プロトコル (RDP) と Secure Shell (SSH) アクセスを提供します。 Azure Bastion は仮想ネットワークに直接プロビジョニングされ、パブリック IP アドレスを介して露出することなく、接続されているすべての VM をサポートします。</p>\n\n<p>Azure Firewallまたは NVA をデプロイするときは、必ずサブネットからのすべてのトラフィックを強制的にトンネリングします。 0.0.0.0/0 のユーザー定義ルートを適用すると、仮想ネットワーク内のワークロードへのイングレス トラフィックとエグレス トラフィックの非対称ルーティングが発生する可能性があります。</p>\n\n<p>簡単ではありませんが、多くの場合、すべてのアプリケーションでこれを解決するために、DS NAT、転送など、増え続けるネットワーク 規則のセットを作成して管理しています。 これはすべてのアプリケーションに影響を与える可能性がありますが、RDP と SSH が最も一般的な例です。 このシナリオでは、インターネットからのイングレス トラフィックが仮想ネットワーク内の仮想マシンに直接送信される可能性がありますが、エグレス トラフィックは最終的に NVA に送信されます。 ほとんどの NVA はステートフルであるため、最初は受信していなかったため、このトラフィックは破棄されます。</p>\n\n<p>Azure Bastion を使用すると、ステートフル NVA を含む仮想ネットワーク内のワークロードに対する RDP/SSH を簡単に設定したり、強制トンネリングを有効にしたAzure Firewallしたりできます。 このブログでは、シームレスに動作させる方法について説明します。</p>\n\n<p style=\"text-align: center;\"><iframe allow=\"autoplay; encrypted-media\" allowfullscreen=\"\" frameborder=\"0\" height=\"315\" scrolling=\"no\" src=\"https://www.microsoft.com/en-us/videoplayer/embed/RE39JYA\" width=\"560\"></iframe></p>\n\n<ul>\n <li>仮想ネットワークに Azure Bastion (プレビュー) をデプロイする方法のリファレンスについては、<a href=\"https://docs.microsoft.com/en-us/azure/bastion/bastion-create-host-portal\" target=\"_blank\">Azure Bastion ホストの作成 (プレビュー)</a> に関するドキュメント&ldquo;を参照してください。&rdquo;</li>\n <li>仮想ネットワークにAzure Firewallを実装する方法については、Azure portalを<a href=\"https://docs.microsoft.com/en-us/azure/firewall/tutorial-firewall-deploy-portal\" target=\"_blank\">使用したAzure Firewallのデプロイと構成</a>に関するドキュメント&ldquo;を参照してください。&rdquo;</li>\n</ul>\n\n<p>仮想ネットワークに Azure Bastion と Azure Firewall の両方をデプロイしたので、このシナリオで動作するように Azure Bastion を構成する方法を見てみましょう。</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e22d790b-e4f5-4f45-9dca-39528683a333.png\"><img alt=\"Azure Bastion architecture\" border=\"0\" height=\"563\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/66f4fbe8-a443-440f-b4a4-8b2de1c96fc8.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Azure Bastion のアーキテクチャ\" width=\"1024\"></a></p>\n\n<h2>Azure Bastion の構成</h2>\n\n<p>Azure Firewallまたは仮想アプライアンスをデプロイするときに、Azure Firewallのデプロイ中に作成された <strong>RouteTable</strong> を、仮想ネットワーク内のすべてのサブネットに関連付ける場合があります。 <strong>AzureBastionSubnet</strong> サブネットも含まれている場合もあります。&nbsp;</p>\n\n<p>これにより、AzureBastionSubnet サブネットにユーザー定義ルートが適用され、すべての Azure Bastion トラフィックがAzure Firewallに転送され、Azure Bastion に必要なトラフィックがブロックされます。 これを回避するには、Azure Bastion の構成は非常に簡単ですが、 <strong>RouteTable</strong> を <strong>AzureBastionSubnet</strong> サブネットに関連付けないでください。</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2c59a68a-72bf-440b-8a60-790af4ee09b5.png\"><img alt=\"myRoute table in Microsoft Azure\" border=\"0\" height=\"1141\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fbb546cb-7244-479d-917b-6461cd14e326.png\" style=\"border: 0px currentcolor; border-image: none; display: inline; background-image: none;\" title=\"Microsoft Azureの myRoute テーブル\" width=\"3000\"></a></p>\n\n<p>前述のように、 <strong>myRouteTable</strong> は <strong>AzureBastionSubnet</strong> ではなく、 <strong>Workload-SN</strong> などの他のサブネットと関連付けられています。</p>\n\n<p><strong>AzureBastionSubnet</strong> サブネットはセキュリティで保護されたプラットフォームマネージド サブネットであり、Azure Bastion を除き、他の Azure リソースはこのサブネットにデプロイできません。 Azure Bastion へのすべての接続は、2FA を使用したAzure Active Directory トークン ベースの認証を通じて適用され、すべてのトラフィックは HTTPS 経由で暗号化されます。&nbsp;</p>\n\n<p>Azure Bastion は内部的に強化されており、ポート 443 からのトラフィックのみを許可するため、追加のネットワーク セキュリティ グループ (NSG) またはユーザー定義ルートをサブネットに適用するタスクを節約できます。</p>\n\n<p>これにより、RDP/SSH 要求は Azure Bastion に送信されます。 上記の例を使用して構成された既定のルート (0.0.0.0/0) は、このサブネットに関連付けられていないため、 <strong>AzureBastionSubnet</strong>&#39;適用されません。 Azure Bastion は、受信 RDP/SSH 要求に基づいて、Workload-SN など、既定のルートが関連付けられている他のサブネット内の仮想マシンに接続します。 仮想マシンからのリターン トラフィックは、仮想ネットワーク内の特定のプライベート IP に転送されるため、仮想ネットワーク内の NVA ではなく Azure Bastion に直接送信されます。 仮想ネットワーク内の特定のプライベート IP アドレスは、より具体的なルートであるため、NVA への強制トンネル ルートよりも優先されるため、仮想ネットワークに NVA または Azure Firewallがデプロイされたときに RDP/SSH トラフィックが Azure Bastion とシームレスに動作します。</p>\n\n<p>私たちは、お客様とコミュニティのエンゲージメントと興奮に感謝し、サービスをさらに改善し、すぐに一般公開するためにあなたの <a href=\"https://feedback.azure.com/forums/922378-azure-bastion\" target=\"_blank\">フィードバック</a> を楽しみにしています。</p>\n"
}