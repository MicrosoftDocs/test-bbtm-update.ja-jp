{
    "Slug": "always-on-real-time-threat-protection-with-azure-cosmos-db-part-one",
    "Title": "Azure Cosmos DB を使用した Always-on、リアルタイムの脅威保護 - パート 1",
    "Summary": "Microsoft Azure Advanced Threat Protection is a cloud-based security service that uses customers’ on-premises Azure Active Directory signals to identify, detect, and investigate advanced threats, compromised identities, and malicious insider actions.",
    "Content": "<p><em>この 2 部構成のブログ投稿は、組織が実際のニーズを満たすために Azure Cosmos DB を使用する方法と、その違い&rsquo;についてのシリーズの一部です。パート 1 では、Microsoft Azure Advanced Threat Protection チームが Azure Cosmos DB を採用するに至った課題とその&rsquo;使用方法について説明します。<a href=\"https://azure.microsoft.com/en-us/blog/always-on-real-time-threat-protection-with-azure-cosmos-db-part-two/\" target=\"_blank\">パート 2</a> では、&rsquo;チーム&rsquo;の取り組みの結果を調べます。</em></p>\n\n<h2>リアルタイム セキュリティ ソリューションからクラウド スケールへの変換</h2>\n\n<p>Microsoft Azure Advanced Threat Protection はクラウドベースのセキュリティ サービスであり、オンプレミスのAzure Active Directoryシグナルを&rsquo;使用して、高度な脅威、侵害された ID、悪意のあるインサイダー アクションを特定、検出、調査します。 2018 年に開始されたこのソリューションは、オンプレミス ソリューションである Microsoft Advanced Threat Analytics を Azure に進化させたものです。 どちらのオファリングも、次の 2 つの主要コンポーネントで構成されます。</p>\n\n<ol>\n <li>エージェントまたはセンサー。各組織&rsquo;のドメイン コントローラーにインストールされます。 センサーは、ユーザーからドメイン コントローラーに送信されたトラフィックと、ドメイン コントローラーによって生成されたWindows (ETW) イベントのイベント トレースを検査し、その情報を一元化されたバックエンドに送信します。</li>\n <li>すべてのセンサーからの情報を集約する一元化されたバックエンド (中央) は、組織&rsquo;のユーザーとコンピューターの動作を学習し、悪意のあるアクティビティを示す可能性のある異常を探します。</li>\n</ol>\n\n<p>Advanced Threat Analytics&rsquo; センターは、MongoDB のオンプレミス インスタンスをメイン データベース&mdash;として使用し、現在もオンプレミスのインストールに使用しています。 ただし、クラウド内のマネージド サービスである Azure Advanced Threat Protection センターを開発する場合、Microsoft ではよりパフォーマンスが高くスケーラブルなものが必要です。 &ldquo;Azure Advanced Threat Protection のバックエンドは、Azure が提供するすべての機能とインテリジェンスを最大限に活用して、大規模にスケーリングし、毎週アップグレードし、&rdquo;継続的に進化する高度な検出アルゴリズム&mdash;を実行する必要があります。Microsoft の Advanced Threat Analytics のプリンシパル グループ エンジニアリング マネージャーである Yaron Hagai は説明します。</p>\n\n<p>Azure Advanced Threat Protection のエンティティとプロファイル&mdash;を格納するための最適なデータベースを検索する際に、各組織&rsquo;のユーザーと computersHagais&mdash;&rsquo; チームに関するすべてのセンサーからリアルタイムで学習されたデータは、次の重要な要件をマップしました。</p>\n\n<ul>\n <li><strong>顧客ごとの柔軟なスケーラビリティ:</strong> Azure Advanced Threat Protection を採用する各組織は、数百のセンサーをインストールでき、1 秒あたり数万件のイベントが発生する可能性があります。 各組織&rsquo;のベースラインを学習し、その異常検出アルゴリズムをリアルタイムで適用するために、Azure Advanced Threat Protection には、効率的かつコスト効率の高いスケーリングが可能なデータベースが必要でした。</li>\n <li><strong>移行の容易さ:</strong> Azure Advanced Threat Protection データ モデルは、検出ロジックの変更をサポートするために絶えず進化しています。 Hagais&rsquo; チームは、サービス&rsquo; コードと絶えず変化するデータ モデルの間で常に下位互換性を維持することを心配したくありませんでした&rsquo;。そのため、デプロイした Azure Advanced Threat Protection に対するほぼすべての新しい更新プログラムを使用して、迅速かつ簡単なデータ移行をサポートできるデータベースが必要でした。</li>\n <li><strong>geo レプリケーション:</strong> すべての Azure サービスと同様に、Advanced Threat Protection では、データセンターの障害が発生する可能性が非常に低い場合を含め、お客様&rsquo; の重要なディザスター リカバリーとビジネス継続性のニーズをサポートする必要があります。 geo レプリケーションを使用することで、お客様&rsquo; のデータをプライマリ データセンターからバックアップ データセンターにレプリケートできます。また、プライマリ データセンターで障害が発生した場合は、Azure Advanced Threat Protection ワークロードをバックアップ データセンターに切り替えることができます。</li>\n</ul>\n\n<h2>クラウド内のマネージドでスケーラブルなスキーマレスデータベース</h2>\n\n<p>チームは、Azure Advanced Threat Protection のバックエンド データベースとして Azure Cosmos DB を選択しました。 &ldquo;Azure で唯一管理され、スケーラブルでスキーマが少ないデータベースとして、Azure Cosmos DB が明確に選択されたと&rdquo; Hagai 氏は述べています。 &ldquo;成長する顧客基盤をサポートするために必要なスケーラビリティと、成長がバックエンド サービスに及ぼす負荷を提供しました。 また、各組織とそのコンピューターとユーザーに格納されるデータの観点から必要な柔軟性も提供しました。 また、新しい検出を継続的に追加し、既存の検出を変更するために必要な柔軟性を提供しました。そのためには、Azure Cosmos DB コンテナーに格納されているデータを常に変更する機能が必要です。&rdquo;</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/df089b93-20cf-4e7a-91c5-86db20701215.png\"><img alt=\"Azure Advanced Threat Protection diagram\" border=\"0\" height=\"468\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/26f5efba-060f-47c9-9308-2f436924f276.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Azure Advanced Threat Protection の図\" width=\"776\"></a></p>\n\n<h3>コンテナーとパーティション分割</h3>\n\n<p><a href=\"https://www.azurecosmosdb.com/\" target=\"_blank\">Azure Cosmos DB</a> がサポートする多くの API のうち、開発チームは、SQL API と Azure Advanced Threat Protection 用 MongoDB 用 Azure Cosmos DB API の両方を検討しました。 最終的に、SQL API を選択しました。これは、グローバル リージョン間でのマルチホーミングと、待機時間が短い直接接続モードをサポートする、Microsoft が作成した豊富なクライアント SDK にアクセスできるためです。 開発者は、テナントまたは顧客ごとに 1 つの Azure Cosmos DB データベースを割り当てることを選択しました。 各データベースには 5 つのコンテナーがあり、各コンテナーは 1 つのパーティションで始まります。 &ldquo;これにより、お客様が Azure Advanced Threat Protection の使用を停止した場合に、&rdquo; お客様のデータを簡単に削除できます。Hagai 氏は説明します。 &ldquo;ただし、さらに重要なのは、オンプレミス センサーによって生成されるスループットに基づいて、各顧客&rsquo;のコンテナーを個別にスケーリングできることです。&rdquo;</p>\n\n<p>顧客ごとのコンテナーのセットのうち、通常、2 つは複数のパーティションに拡張されます。</p>\n\n<ul>\n <li>Active Directory から同期された、組織内のコンピューターとユーザーに関するすべてのメタデータを含む <em>UniqueEntity</em>。</li>\n <li><em>UniqueEntityProfile</em> は、UniqueEntity コンテナー内の各エンティティの動作ベースラインを含み、侵害されたユーザーまたはコンピューター、または悪意のある内部関係者を意味する動作の異常を特定するために検出ロジックによって使用されます。</li>\n</ul>\n\n<p>&ldquo;両方のコンテナーの読み取り/書き込みスループットが非常に高く、 <a href=\"https://docs.microsoft.com/en-ca/azure/cosmos-db/request-units\" target=\"_blank\">1 秒あたりの要求ユニット数 (RU/秒)</a> が大きいと Hagai&rdquo; 氏は説明します。 &ldquo;Azure Cosmos DB では、コンテナーの成長に合わせてコンテナーのストレージがシームレスにスケールアウトされ、一部の大規模な顧客はコンテナーあたりテラバイトのサイズにスケールアップしました。これは、VM 上の MongoDB では不可能でした。&rdquo;</p>\n\n<p>通常、各顧客の他の 3 つのコンテナーには 1,000 未満のドキュメントが含まれており、1 つのパーティションを超えて拡張することはありません。 これには次のようなものがあります。</p>\n\n<ul>\n <li><em>SystemProfile</em>。テナントについて学習し、動作ベースの検出に適用されるデータが含まれています。</li>\n <li><em>SystemEntity</em>。テナントに関する構成情報とデータが含まれています。</li>\n <li><em>アラート</em>。Azure Advanced Threat Protection によって生成および更新されるアラートが含まれます。</li>\n</ul>\n\n<h3>移行</h3>\n\n<p>Azure Advanced Threat Protection 検出ロジックが絶えず進化して改善するにつれて、各顧客&rsquo;の UniqueEntityProfile コンテナーに格納される行動データも進化し、改善されます。 古いスキーマとの下位互換性の必要性を回避するために、Azure Advanced Threat Protection には、データ モデルの変更を含むサービスへのアップグレードごとに実行される 2 つの移行メカニズムが維持されています。</p>\n\n<ul>\n <li><strong>オンザフライ:</strong>Azure Advanced Threat Protection は、Azure Cosmos DB からドキュメントを読み取ると、そのバージョン フィールドを確認します。 バージョンが古い場合、Azure Advanced Threat Protection は、Hagais&rsquo; の開発者チームによって記述された明示的な変換ロジックを使用して、ドキュメントを現在のバージョンに移行します。</li>\n <li><strong>バッチ：</strong> アップグレードが成功した後、Azure Advanced Threat Protection はスケジュールされたタスクを起動して、すべての顧客のすべてのドキュメントを最新バージョンに移行します。オンザフライ メカニズムによって既に移行されているものは除きます。</li>\n</ul>\n\n<p>これら 2 つの移行メカニズムを組み合わせることで、サービスがアップグレードされ、データ アクセス層コードが変更された後に、古いドキュメントの解析によってエラーが発生しないようにします。 以降のバージョンでは常に削除される明示的な移行コードに加えて、下位互換性コードは必要ありません。</p>\n\n<h3>エラスティック スケーリングと自動バックアップ</h3>\n\n<p>読み取り/書き込みスループットが非常に高いコンテナーは、多くの場合、container の <a href=\"https://docs.microsoft.com/en-ca/azure/cosmos-db/set-throughput\" target=\"_blank\">プロビジョニングされた RU/秒の制限</a>に達するため、レートが制限されます。 サービス&rsquo; ノードの 1 つである各ノードが仮想マシンである場合、コンテナーに対して操作を実行しようと試み、<a href=\"https://docs.microsoft.com/en-us/rest/api/cosmos-db/http-status-codes-for-cosmosdb\" target=\"_blank\">429 個の要求&rdquo;レート制限例外を取得&ldquo;</a>すると、Azure Service Fabric リモート処理を使用して、一元化されたエラスティック スケーリング サービスを介して要求を送信し、スループットを向上させます。 一元化されたサービスは、複数のノードからのこのような要求を集約して、短時間で複数回スループットを増やさないようにします。これは、複数のノードに影響を与えるスループットのバーストが 1 回だけ発生する可能性があるためです。 RU/秒の全体的なコストを最小限に抑えるために、同様の定期的なスケール ダウン プロセスにより、必要に応じてプロビジョニングされたスループットが削減されます (各顧客&rsquo;の勤務時間外など)。</p>\n\n<p>Azure Advanced Threat Protection は、<a href=\"https://docs.microsoft.com/en-us/azure/cosmos-db/online-backup-and-restore\" target=\"_blank\">Azure Cosmos DB の自動バックアップ機能</a>を利用して、各コンテナーの保護に役立ちます。 バックアップは Azure Blob Storage に存在し、geo 冗長ストレージ (GRS) を使用して別のリージョンにレプリケートされます。 Azure Advanced Threat Protection では、お客様の構成データも別のリージョンにレプリケートされます。これにより、障害発生時の迅速な復旧が可能になります。 &ldquo;これは主に、元のデータベースが失われた&rdquo;場合に IT 管理者が何百ものセンサーを再構成する必要があることを防止するセンサー構成データ&mdash;を保護するために行います。Hagai 氏は説明します。</p>\n\n<p>Azure Advanced Threat Protection は最近、完全 geo レプリケーションのオンボードを開始しました。 &ldquo;Weve は&rsquo;、運用データを別のリージョンにシームレスかつ簡単にレプリケーションできるように、geo レプリケーションとマルチリージョン書き込みを有効にし始めました。&rdquo; Hagai 氏は言います。 &ldquo;これにより、サービスの可用性をさらに向上させ、保証することができ、独自の高可用性メカニズムを維持する必要と比較して、サービスの配信が簡素化されます。&rdquo;</p>\n\n<p><a href=\"https://azure.microsoft.com/en-us/blog/always-on-real-time-threat-protection-with-azure-cosmos-db-part-two/\" target=\"_blank\">パート 2</a> に進み、Azure Cosmos DB の Azure Advanced Threat Protection チーム&rsquo;の実装による結果について説明します。</p>\n"
}