### YamlMime:Yaml
ms.openlocfilehash: a5ca0902183badb08e320c69af834184fa312669
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139896010"
Slug: details-of-the-december-28th-2012-windows-azure-storage-disruption-in-us-south
Title: 米国南部での 2012 年 12 月 28 日のWindows Azure Storageの詳細
Summary: '概要: 2012 年 12 月 28 日に、サービスの中断が発生し、アカウントの 1.8% に影響をWindows Azure Storageしました。&nbsp;影響を受けたストレージ アカウントは、1 つのストレージ スタンプ (クラスター) に含めでした。'
Content: <h3>はじめに</h3>  <p>2012 年 12 月 <sup>28 日</sup>に、サービスの中断が発生し、アカウントの 1.8% Windows Azure Storageされました。&nbsp;影響を受けたストレージ アカウントは、米国南部リージョンの 1 つのストレージ スタンプ (クラスター) に含めがありました。&nbsp;中断と、影響を受けたお客様の原因となる問題について申し訳ない。 中断の根本原因&rsquo;&rsquo;、復旧プロセス、学習した結果、サービスを改善するために行っていることについて、さらに詳しい情報を提供したいと考えました。&nbsp; &nbsp;影響を受け取ったお客様に対して、以下に示すサービス クレジットを事前に発行しています。&nbsp;&nbsp;私たちは、サービスの品質を向上させるために、このインシデントから学んだことを実装するために取り組み中です。&nbsp;</p>  <h3>Windows Azure の概要</h3>  <p>サービスの中断の詳細を確認し、何が起こったかを理解するのに役立つ前に、最初&rsquo;に、Azure のコンポーネントに関する追加情報を共有Windowsしています。&nbsp;</p>  <p>Windows Azure では、さまざまなデータ センターと異なる地理的リージョンにわたって多くのクラウド サービスが実行されます。 Windows Azure ストレージは、Azure 上でクラウド サービスWindowsされます。&nbsp;リージョンごとに複数の物理ストレージ サービスのデプロイがあります。これはスタンプと呼ばれるサービスです。&nbsp;各ストレージ スタンプには、ストレージ ノードの複数のラックがあります。&nbsp;このインシデントは、米国南部リージョンの 1 つのストレージ スタンプに影響を与えました。&nbsp;</p>  <p>Windows Azure Fabric Controller は、ハードウェアを管理するリソースのプロビジョニングと管理レイヤーであり、Windows Azure&nbsp; プラットフォーム上のクラウド サービスのリソース割り当て、デプロイ、アップグレード、管理を提供します。特定のクラスのエラーが複数のスタンプに影響を与えるのを防ぐために、記憶域スタンプごとに個別のファブリック コントローラーがあります。これは、このインシデントに役立ちます。&nbsp;&nbsp;</p>  <p>ファブリック コントローラーは、ノード管理、ネットワーク構成、正常性の監視、サービス インスタンスの開始/停止、ストレージ スタンプのサービスのデプロイを提供します。 &nbsp;さらに、このスタンプは、ネットワーク トポロジ情報、ノードの物理的なレイアウト、および記憶域ノードのハードウェア構成をファブリック コントローラーから取得します。&nbsp; ストレージ サービスは、ディスク全体のレプリケーションとデータの配置を管理し、ストレージ クラスター内のデータとアプリケーション のトラフィックを負荷分散する責任を負います。</p>  <p>ファブリック コントローラーでディスクの再フォーマットのようなアクションが誤って実行されるのを防ぐために、ファブリック &ldquo;コントローラーにはノード保護と呼ばれる防御ラインがあります&rdquo;。&nbsp; ストレージ サービスでは、この機能を利用してすべてのノードを保護します。&nbsp; ストレージ スタンプは常に保護することを目的としていますが、特定のストレージ ノードの保護をオフにする正当なシナリオがあります。 &nbsp;最も一般的な方法は、マシンが (修復のために) サービスを提供される場合です。 &nbsp;したがって、ノードが修復から戻ると、ファブリックに同化する準備がされている間、保護はオフになります。&nbsp; 準備アクションが完了すると、そのストレージ ノードに対してノード保護がオンに戻されます。</p>  <h3>根本原因</h3>  <p>組み合わせるとサービスが中断されるという 3 つの問題が発生しました。</p>  <p>まず、影響を受けた 1 つのストレージ スタンプ内で、一部のストレージ ノードは、修復のために使用された後に (一期間に) 実稼働状態に戻り、ノード保護を有効にしなかった&nbsp; 。これは、構成プロセスの人的エラーが原因で発生し、ノード保護なしで実行されているスタンプ内のストレージ ノードの約 10% が原因でした。&nbsp;</p>  <p>次に、修復からストレージ ノードを取り戻す場合に関連する構成エラーを検出する監視システムに欠陥が生じ、アラームとエスカレーションの失敗が発生しました。</p>  <p>最後に、12 月 28 日午前 7 時 (PST) に、このストレージ スタンプのファブリック コントローラーに対して新しいプライマリ ノードへの移行が開始されました。 &nbsp;新しいプライマリ ノードへの移行は、通常のメンテナンスやハードウェアの更新など、さまざまな理由で頻繁に発生する通常の発生です。 &nbsp;&lsquo;&rsquo;新しいプライマリの構成中に、ファブリック コントローラーによって既存のクラスター状態が読み込まれます。この場合、ファブリック コントローラーが、保護されていないストレージ ノードに対する準備アクションを誤ってトリガーするバグにぶつながっています。 &nbsp;&nbsp;準備アクションを実行すると、保護されていない記憶域ノードを使用できる状態になります。これには、それらのノード上のドライブの簡単な形式が含まれます。 &nbsp;ノード保護は、ファブリック コントローラーが保護されたノードをフォーマットしなきことを確認することを目的としています。 残念ながら、このスタンプのアクティブなストレージ ノードの 10% が保護されていないとして誤ってフラグが設定されたため、準備アクションの一部として書式設定されました。</p>  <p>ストレージ スタンプ内では、3 つの異なる障害ドメイン (個別の電源、ネットワーク、ラック上) にデータの 3 つのコピーを分散します。 通常、これにより、スタンプ内のデータで 2 つのノードが同時に障害が発生した場合でも存続できます。 ただし、再フォーマットされたノードは、すべての障害ドメインに分散され、場合によっては、データの 3 つのコピーすべてが使用できなくなる可能性があります。</p>  <h3>Storage サービスの復旧</h3>  <p>ノードが再フォーマットされ、サービスを復元するための 2 つの方法を検討していたと判断しました。&nbsp;</p>  <ul>  <li><strong>米国南部のデータの復元 (プラン A) </strong>- 米国南部のストレージ スタンプ上のボリュームとすべてのディスクを復元し、データを失う必要がない可用性 <strong>を復元します</strong>。<strong></strong></li>  <li><strong>米国北部への geo フェールオーバー (計画 B) </strong>- <a href="https://blogs.msdn.com/b/windowsazurestorage/archive/2011/09/15/introducing-geo-replication-for-windows-azure-storage.aspx" target="_blank">ストレージ</a> スタンプ内の顧客を米国南部から米国北部 (geo レプリケートされた場所) にフェールオーバーして、可用性を復元します。&nbsp; この結果、次の結果になります。 <strong></strong>  <ul>  <li>geo レプリケーションが非同期的Windows Azure <a href="https://azure.microsoft.com/en-us/home/features/data-management/" target="_blank">BLOB と Table</a> に対する最新の更新プログラムが失われる。<strong></strong></li>  <li>現時点ではWindows Azure キューにはローカル冗長性しか持たWindows、スタンプ内の顧客の Azure Queue データが失われる。<strong></strong></li>  <li>Geo 冗長ネットワークを使用してローカル冗長ネットワークを選択Storageのお客様のデータStorage。<strong></strong></li>  </ul>  </li>  </ul>  <p><strong>私たちの</strong>主な目標は、妥当な時間内にプラン A&nbsp; を実行できなかった場合にプラン B に戻るという考えで、顧客データを保持することです。 &nbsp;</p>  <p>次に、&rsquo;ストレージ サービスを復旧するために実行した手順について説明し、geo レプリケーションとフェールオーバー プロセスの詳細について説明します。</p>  <h4>インセット データの復元 (プラン A)</h4>  <p>非常に対象が絞り込まれる一方で、この停止は固有の状況でした。&nbsp; 米国南部のストレージ スタンプを回復するには、配置されたボリューム上のデータを復旧するアプローチを設計する必要があります。&nbsp; また、あるドライブから次のドライブにデータをコピーしないように、このアプローチを効率的に行う必要がありました。&nbsp;&nbsp;</p>  <p>ファブリック コントローラーは、これらのストレージ ノード &lsquo;でボリュームの&rsquo; 簡単な形式を実行して、使用を準備しました。&nbsp; この種類の形式では、初期 MFT (マスター ファイル テーブル) を使用して、すべての新しい<a href="https://en.wikipedia.org/wiki/Master_File_Table#Internals" target="_blank">メタデータ ファイルが作成されます</a>。&nbsp; いくつかの初期レコードを除き、MFT を復旧しました。&nbsp; MFT &lsquo;を回復した後、ボリュームで chkdsk /f&rsquo; を実行すると、クイック形式で上書きされたいくつかの初期 MFT レコードを除き、ボリューム全体が再作成されます。&nbsp;</p>  <p>これらの初期 MFT レコードには、失われた&rsquo;ボリューム ディレクトリ構造のルートが含まれます。&nbsp;&lsquo;chkdsk /f&rdquo;&rsquo; &ldquo;を実行すると、ボリューム上の見つかったディレクトリに親ディレクトリが見つからなかったファイルが配置されました。&nbsp;見つかったディレクトリ内の各ファイルは、エクステント (顧客データを含むファイル) を表しました。&nbsp;これらのファイルの名前付け規則には、元のファイルの完全なパスを含むチェックサムが含まれています。&nbsp;これにより、元のディレクトリ&ldquo;&rdquo;構造を完全に復旧し、回復されたエクステントを見つかったディレクトリから適切な場所に移動するために、各エクステントの適切な完全パスを特定できます。</p>  <p>各ストレージ ノード上のディスクの 1 つは、復旧にさらに多くの作業が必要なジャーナル ドライブです。 &nbsp;ジャーナル ドライブは、ストレージ ノードへの書き込みを迅速にコミットし、顧客への書き戻しを確認するために使用されます。一方、ストレージ ノードは、それらの書き込みを多数の宛先ドライブの 1 つに格納します。&nbsp; ジャーナル ボリュームの場合、復旧のためにジャーナルをコピーするために、ボリューム上のジャーナル ファイル署名を検索するツールを作成する必要がありました。&nbsp;</p>  <p>インシデントの 32 時間後に、上記の手法を使用して、テスト環境のストレージ ノードからボリュームを完全に復旧できると確認しました。これは、プラン A を続行する自信を与えました。 &nbsp;</p>  <p>ソリューションを製品に組み込む前にテストし、復旧に時間を追加する追加の複雑さを検出しました。 ボリュームの回復を実行するには、ボリュームをロックする必要があります。&nbsp;&lsquo;ファブリック コントローラーがボリュームがロックされているのを検出すると、ノードは正しいと見なされ、再起動します。これは、ボリュームを回復するために chkdsk /f&rsquo;&nbsp; の途中にあるときに問題でした。そのため、ノードを保護された状態にし、データ復旧期間中にファブリック コントローラー サービス管理アクティビティからノードを削除する必要がありました。</p>  <p>さらに、ノードを修復のために取り出した後にノードを取り戻す場合、ファブリック コントローラーは、すべてのディスクが機能すると予想されます。&nbsp; 問題は、ノードに障害が発生したディスクが複数あるまで修復のために記憶域ノードを送信しなかから、1 つ以上の不良ディスクがある可能性があるノードを取り戻していた点です。&nbsp; 通常の状況では、ファブリック コントローラーでは、これらのノードがオンラインに戻って機能するストレージ スタンプの一部になるのを許可しません。&nbsp; この問題を回避するために、この記憶域スタンプのファブリック コントローラーに修正プログラムを展開し、ディスクが見つからないノードをフォールドに戻します。</p>  <p>午後 2 時 (PST)、12/30/12 までに、すべてのツールとプロセスが検証され、実稼働環境でストレージ スタンプの完全復旧を開始できます。&nbsp;</p>  <p>ストレージの回復は、すべてのストレージ ノードに対して方法的に実行され、二重チェックされた後、ファブリック コントローラーの管理に戻されます。&nbsp; その後、ストレージ スタンプのすべてのパーティションを読み込み、午後 9 時 32 分 (PST)、12/30/12 までにストレージ スタンプがライブで、顧客にトラフィックを提供しました。&nbsp;&nbsp;</p>  <p>ストレージ スタンプ内にあるエクステントの完全な一覧が常に表示され、すべてのエクステントが復旧されました。&nbsp; さらに、スタンプ上のエクステントに対してすべてのチェックサムが検証され、すべてのデータがデータ損失なしで復旧されたと確認されました。</p>  <h4>geo 冗長StorageとGeo-Failover (プラン B)</h4>  <p>この停止に関連するお客様からの一般的な問い合わせは、停止の完全な影響が理解された後に、サービスの Geo-Failover をすぐに開始しなかった理由に焦点を当てて、&nbsp;この問い合わせに対処するために、まず geo レプリケーションサービスの概要を説明Storage。</p>  <p><strong>Geo 冗長サービスとはStorage?</strong></p>  <p>geo レプリケーションは、ストレージ アカウントの作成時に構成されます。&nbsp; 顧客がストレージ アカウントの作成を選択した場所が主要な &lsquo;場所&rsquo; です。&nbsp; 顧客データが geo レプリケート&rsquo;される場所は、セカンダリの場所と呼ばれます。 &nbsp;セカンダリの場所は、ここで説明するようにプライマリの場所に基づいて自動的に決定 <a href="https://blogs.msdn.com/b/windowsazurestorage/archive/2011/09/15/introducing-geo-replication-for-windows-azure-storage.aspx" target="_blank">されます</a>。</p>  <p>geo 冗長Storage<strong></strong>は、2 つの場所に顧客データを格納することで、最も高いレベルの耐久性を提供します。1 つ目の場所と、プライマリの場所から数百マイル離れた場所です。 &nbsp;すべてのWindows Azure BLOB および Table データは geo レプリケートされます。 &nbsp;<a href="https://blogs.msdn.com/b/windowsazurestorage/archive/2011/09/15/introducing-geo-replication-for-windows-azure-storage.aspx" target="_blank">現時点では、キュー データは geo レプリケートされません</a>。 &nbsp;Geo 冗長ストレージでは、プライマリの場所とセカンダリの両方の場所 (合計 6 つのコピー) に、顧客データの 3 つのコピー (レプリカ) を保持します。 これにより、各データ センターが一般的なハードウェア障害 (不良ドライブ、不良ノード、ラック障害、ネットワークまたは電源の問題など) から復旧できます。&nbsp; これにより、大きな障害が発生した場合に備え、2 番目のデータセンター内のデータの geo レプリケートされたコピーも提供されます。 &nbsp;geo レプリケーションでは、 <em>geo レプリケーション</em> がバックグラウンドで実行される非同期レプリケーションが使用されます。そのため、ストレージ アカウントの更新パフォーマンスに影響はありません。 2 つの場所は、更新プログラムを geo レプリケートするために互いに話し合う必要があります。 &nbsp;回復するために互いに話し合う必要はない。 &nbsp;これは、プライマリからセカンダリ スタンプへの即時フェールオーバーを行う必要がある場合、geo&rsquo; レプリケーションを介してセカンダリ ロケーションにコミットされたデータはすべて既に永続的であり、顧客アプリケーションは、geo レプリケートされていない最近の変更から失われたデータのみを処理する必要があるという意味なので、これは重要です。</p>  <p><strong>フェールオーバー プロセス</strong></p>  <p>フェールオーバーは、顧客のプライマリ ストレージ&rsquo; アカウントの場所をプライマリ ストレージ スタンプからセカンダリ ストレージ スタンプに変更するプロセスです。&nbsp;</p>  <p>現在の実稼働環境の geo レプリケーションでは、フェールオーバーはストレージ アカウント レベルではなく、ストレージ スタンプ レベルです。&nbsp; つまり、geo フェールオーバーを実行する必要がある場合は、1 つのストレージ スタンプ内のすべての顧客を、古いプライマリ スタンプからセカンダリ スタンプ (新しいプライマリ) にフェールオーバーします。&nbsp; お客様のデータ損失を最小限に抑えるために、数日以内に復旧できないプライマリに大きな障害が発生した場合にのみフェールオーバーを実行します。</p>  <p><strong>この中断Geo-Failoverトリガーされない理由</strong></p>  <p>geo レプリケーションは非同期で行われるので、米国南部から米国北部にフェールオーバーすると、ストレージ アカウントに対する最近の更新は予想通り失われます。&nbsp;影響を受けたストレージ スタンプの場合、スタンプ内のすべての顧客で最近のデータ更新の 8GB が失われたと推定されます。&nbsp;さらに、Windows Azure キューは geo レプリケートされません (CY13 で配信しています)。 &nbsp;そのため、フェールオーバーを実行した場合、影響Windowsのストレージ アカウントに対して Azure Queue データが失われます。&nbsp;さらに、ローカル冗長ストレージを使用することを選択Storage、データが失われる可能性があります。&nbsp;</p>  <p>一部のお客様は、可用性に対するデータの耐久性を最適化するために、スタンプを復旧する必要があるという意見がありました。&nbsp; 他のお客様は、可用性を最適化し、迅速にフェールオーバーしたいという希望を表明しました。&nbsp; 数日でデータが失われずに米国南部のプライマリ ストレージ スタンプを持ち戻す可能性がある、と考えたので、データの耐久性を優先しました。&nbsp;&nbsp;</p>  <h3>サービスの改善</h3>  <p>インシデントが発生した後は、時間を取ってインシデントを分析し、エンジニアリング、運用、コミュニケーションを改善する方法を分析します。 &nbsp;可能な限り多くのことを学習するために、根本原因分析を行い、インシデントのすべての側面を分析して、お客様のプラットフォームの信頼性を向上させる必要があります。&nbsp;</p>  <p>この分析は 4 つの主要な領域に分かれ、インシデント ライフサイクルの各部分と、その前のエンジニアリング プロセスを確認します。</p>  <ul>  <li><strong>検出</strong> &ndash; 障害を迅速に表面化し、復旧に優先順位を付ける方法</li>  <li><strong>回復</strong> &ndash; 復旧時間を短縮し、お客様に与える影響を軽減する方法</li>  <li><strong>防止</strong> &ndash; システムが障害を回避、分離、または復旧する方法</li>  <li><strong>応答</strong> &ndash; インシデント中に顧客をサポートする方法</li>  </ul>  <h4>検出</h4>  <p>修復からのストレージ ノードの取り込みに関連する構成エラーを検出する監視システムが修正されました。</p>  <h4>Recovery</h4>  <p>主なアクション項目は、お客様が耐久性と可用性の選択を可能にし、お客様が回復力のあるアプリケーションを構築可能にするための項目です。 &nbsp;今後の次の機能を通じて、この取り組みについて取り組み中です。</p>  <ul>  <li><strong>キューの geo レプリケーション&ndash; </strong>キュー データの geo レプリケーションは、複数のアカウントに対してWindows Azure Storage予定です。<strong></strong></li>  <li><strong>Geo-Replicated Storage アカウント</strong>への読み取り専用アクセス -&rsquo; セカンダリ ロケーションから顧客のストレージ アカウントへの読み取り専用アクセスを有効にする予定です。&nbsp; &nbsp;<strong></strong></li>  <li><strong>お客様が制御するフェールオーバー (Geo-Replicated Storage アカウント)</strong> &ndash;お客様が個々のビジネス ニーズに基づいて、データの耐久性よりもサービスの可用性を優先できるよう計画しています。&nbsp;&nbsp;お客様がストレージ アカウントのフェールオーバーをトリガーできる API を提供する予定です。</li>  </ul>  <h4>防止</h4>  <p>ファブリック コントローラーのバグを修正しました。その結果、ストレージ ノードが準備状態に追い込まれます。&nbsp; また、運用プロセスを再調査して、適切なトレーニングが継続的に行われ、プロセスが継続的に改善されている状態を確認しています。</p>  <h4>Response</h4>  <p>2012 年 12 月 28 日の午前 7 時 30 分 (PST) から午前 9:00 (PST) まで、プライマリ Service Health ダッシュボードは、影響を受けるストレージ スタンプ内のデータに依存していたため、使用できません。 停止に関連する初期ダッシュボードの更新は、午前 8 時 45 分 (PST) に試行され、失敗しました。 フェールオーバー サイトは午前 8 時 45 分 (PST) にアクティブ化され、午前 9 時 1 分 (PST) に成功しました。</p>  <p>同様のインシデントが発生した場合の影響を軽減するために、Azure サービス ダッシュボードの複数レベルのフェールオーバー手順が既に改善されています。</p>  <p>Azure ダッシュボードに、リアルタイムでわかっている情報を投稿Windows<a href="https://azure.microsoft.com/en-us/support/service-dashboard/" target="_blank">しています</a>。&nbsp; &nbsp;</p>  <p>Azure Platform とプロセスのパフォーマンスを向上Windows継続的に取り組み、同様のトリガー条件を考慮して、ライブ サイト インシデントが今後発生しなかからなかに発生しないようしています。&nbsp;これらの機能強化の多くは、修正、監視とアラートの改善、および全体的なプラットフォームの回復性を対象としながら、停止中により詳細で時間の長い通信を提供する機能も向上します。 これらの機能強化は、解決のために ETA の可視性を向上するのにも役立ちます。</p>  <h3>サービス クレジット</h3>  <p>このサービスの中断は、影響を受けるお客様に大きな影響を与えたと認識しています。&nbsp; このイベントの異常な性質と期間により、影響を受けるすべてのストレージ容量とストレージ トランザクションの料金について、影響を受けるすべての顧客に対して、影響を受ける毎月の請求期間に対して 100% のサービス クレジットを提供しています。</p>  <p>これらのクレジットは事前に適用され、影響を受ける請求期間の後の請求期間に反映されます。 &nbsp;その他の質問がある場合は、Azure サポートWindows問<a href="https://azure.microsoft.com/support/?WT.mc_id=cmp_pst001_blg_post0072" target="_blank">い</a>合わせください。</p>  <h3>まとめ</h3>  <p>Azure Windowsチームは、上記の問題と、今後数週間にお客様への影響を引き続き確認し、サービスを改善するためのすべての手順を実行します。 &nbsp;この停止が顧客に与えた影響を心から感謝し、ビジネス ニーズを満たす高可用性サービスを提供するために引き続き取り組んでいきます</p>
