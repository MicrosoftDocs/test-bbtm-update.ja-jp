### YamlMime:Yaml
ms.openlocfilehash: 23a5f24ff07c096c7ecc2185cb442d5393f7bc99
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139903857"
Slug: virtual-machine-memory-allocation-and-placement-on-azure-stack
Title: Azure Stack での仮想マシンのメモリ割り当てと配置
Summary: 'お客様は Azure Stack をさまざまな方法で使用してきました。 オンプレミスと Azure の両方にデプロイするアプリケーションを構築するためのプラットフォームとして、接続された切断のシナリオで使用される Azure Stack については、引き続き説明します。 '
Content: >-
  <p>お客様は Azure Stack をさまざまな方法で使用してきました。 オンプレミスと Azure の両方をデプロイするアプリケーションを構築するためのプラットフォームとして、接続された切断シナリオで使用される Azure Stack が引き続き表示されます。 多くのお客様は、既存のアプリケーションを Azure Stack に移行することを望んでいます。</p>


  <p>Azure Stack &rsquo; を開始した &rsquo; 後でも、どのような場合でも、いくつかの機能が異なる方法で実行されることに注意する必要があります。 このような機能の1つに、容量計画があります。 Azure Stack のオペレーターとして、システムに追加の容量を追加する必要がある時期を正確に計画する必要があります。 これを計画するには、容量の関数としてのメモリがシステムでどのように消費されるかを理解することが重要です。 この記事の目的は、Azure Stack での仮想マシン (VM) の配置のしくみを詳しく説明することです。容量計画のために使用可能なメモリを決定する際には、さまざまなコンポーネントに焦点を当てます。</p>


  <p>Azure Stack は、コンピューティングとストレージのハイパー集約クラスターとして構築されています。 この収束により、スケール ユニットと呼ばれる、ハードウェアの共有が可能になります。 Azure Stack では、スケール ユニットにより、リソースの可用性とスケーラビリティが提供されます。 スケールユニットは、ホストまたはノードと呼ばれる一連の Azure Stack サーバーで構成されます。 このインフラストラクチャ ソフトウェアは一連の VM 内でホストされ、テナント VM と同じ物理サーバーを共有します。 すべての Azure Stack vm は、スケールユニット &rsquo; s Windows サーバークラスタリングテクノロジと個々の hyper-v インスタンスによって管理されます。 スケール ユニットにより、Azure Stack の習得と管理が簡素化されます。 また、スケールユニットを使用すると、Azure Stack、テナント、およびインフラストラクチャ全体のすべてのサービスの移動とスケーラビリティも実現できます。</p>


  <p>管理ポータルの円グラフを確認すると、次のように Azure Stack の空きメモリと使用されているメモリを表示できます。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e77053a3-6337-48b3-8b5e-2d7b93f5b40c.png"><img alt="Capacity Chart on the Azure Stack Administrator Portal" border="0" height="304" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/806c7795-5296-47d8-9b60-feba9db7f4c6.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="Azure Stack 管理者ポータルの容量チャート" width="566"></a></p>


  <p align="center"><em>図 1: Azure Stack 管理者ポータルの容量グラフ</em></p>


  <p>円グラフの使用済みセクションのメモリは、次のようなコンポーネントによって消費されます。</p>


  <ol>
   <li><strong>ホスト OS の使用量または予約</strong> &ndash; これは、ホスト上のオペレーティング システム (OS)、仮想メモリのページ テーブル、ホスト OS で実行されているプロセス、およびスペース ダイレクトのメモリ キャッシュによって使用されているメモリです。 この値は、ホストで実行されている別の Hyper-V プロセスで使用されるメモリに依存するため、変動する可能性があります。</li>
   <li><strong>インフラストラクチャサービス</strong> &ndash; これらは、Azure Stack を構成するインフラストラクチャ Vm です。 Azure Stack の1904リリースバージョンの場合は、メモリの 242 GB + (4 GB x のノード数) を占有する約31の Vm が必要になります。 インフラストラクチャ サービスをよりスケーラブルで回復性のあるものにするよう取り組んでいるため、インフラストラクチャ サービス コンポーネントのメモリ使用率が変わる可能性があります。</li>
   <li><strong>回復性の予約</strong> &ndash; Azure Stack では、Vm のライブマイグレーションを可能にするために、1つのホストで障害が発生したときだけでなく、修正プログラムや更新時にも、テナントの可用性を確保するためにメモリの一部が予約されます。</li>
   <li><strong>テナント vm</strong> &ndash; これらは Azure Stack ユーザーによって作成されたテナント Vm です。 実行中の VM だけでなく、ファブリック上に配置されているすべての VM もメモリを消費します。 つまり、&ldquo;作成中&rdquo;または&ldquo;失敗&rdquo;状態の VM やゲスト内からシャットダウンされた VM はメモリを消費します。 ただし、ポータル、powershell、cli の [割り当て解除の停止] オプションを使用して割り当て解除された Vm は、Azure Stack のメモリを消費しません。</li>
   <li><strong>アドオン RPs</strong> &ndash;アドオン RPs (SQL、MySQL、App Service など) 用にデプロイされた vm。</li>
  </ol>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/48ec644d-522a-409d-9b28-c15d1975130c.png"><img alt="Capacity usage on a 4-node Azure Stack" border="0" height="193" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2f8375c4-d31b-44fe-95f2-e447e2735edf.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="4ノード Azure Stack の容量使用率" width="404"></a></p>


  <p align="center"><em>図 2: 4 ノードの Azure Stack の容量使用率</em></p>


  <p>Azure Stack では、配置エンジンにより、使用可能なホストにわたってテナント VM の配置が自動的に実行されます。 Vm を配置する際の2つの考慮事項は、その VM の種類に対してホストに <strong>十分なメモリ</strong> があるかどうか、および vm が <a href="https://docs.microsoft.com/en-us/azure-stack/operator/azure-stack-overview#providing-high-availability" target="_blank">可用性セット</a> の一部であるか、 <a href="https://docs.microsoft.com/en-us/azure/virtual-machine-scale-sets/overview" target="_blank">vm スケールセット</a>であるかということです。 &nbsp;Azure Stack は、コミット前のメモリを&#39;しません。 ただし、物理コア数のオーバーコミットは許可されています。 配置&#39;アルゴリズムでは、既存の仮想マシンと物理コアのオーバープロビジョニング比率が考慮されないため、各ホストの比率は異なる可能性があります。</p>


  <h2>メモリの考慮事項: 可用性セット/VM スケールセット</h2>


  <p>Azure Stack のマルチ VM 実稼働システムの高可用性を実現するには、Vm を複数の障害ドメイン、つまり Azure Stack ホストに分散する可用性セットに配置する必要があります。 ホストで障害が発生した場合、障害が発生したドメインの Vm は他のホストで再起動されますが、可能であれば、同じ可用性セット内の他の Vm とは別の障害ドメインに保持されます。 ホストがオンラインに戻ると、高可用性を維持するために VM の再配置が行われます。 VM スケールセットでは、バックエンドの可用性セットを使用して、各スケールセットの VM インスタンスが別のフォールトドメインに配置されていることを確認します。 配置を試す前に Azure Stack ホストがさまざまなレベルでいっぱいになる可能性があるため、VM/VMSS インスタンスを別々の Azure Stack ホストに配置する容量がないため、可用性セットまたは VMSS 内の Vm が作成時に失敗することがあります。</p>


  <h2>メモリの考慮事項: Azure Stack の回復性リソース</h2>


  <p>Azure Stack は、正常にプロビジョニングされた VM の実行を維持するよう設計されています。 ハードウェア障害または再起動が必要なためにホストがオフラインになった場合、または Azure Stack ホストの修正プログラムと更新プログラムがある場合は、そのホストで実行されている Vm をソリューション内の別の使用可能なホストにライブマイグレーションしようとします。&nbsp;</p>


  <p>このライブマイグレーションは、再起動または移行を実行するための予約メモリ容量がある場合にのみ実現できます。 そのため、すべてのホストメモリの一部が予約され、テナント VM の配置に使用できなくなります。</p>


  <p>詳細については、 <a href="https://docs.microsoft.com/en-us/azure-stack/operator/azure-stack-capacity-planning-compute#azure-stack-memory" target="_blank">回復性の予約の計算</a>に関するページを参照してください。 この計算の簡単な例を次に示します。</p>


  <p><strong>Vm の配置で使用可能なメモリ</strong> = ホストメモリ &ndash; の合計回復性 &ndash; を実行するテナントの vm で使用されるメモリの Azure Stack インフラストラクチャのオーバーヘッド</p>


  <p>回復性のための予約 = H + R * ((N-1) * H) + V * (N-2)</p>


  <p>各値の説明:</p>


  <ul>
   <li>H = 1 つのホスト メモリのサイズ</li>
   <li>N = スケールユニットのサイズ (ホストの数)</li>
   <li>R = ホスト OS によって使用されるオペレーティングシステムの予約/メモリ (この数式では 15)</li>
   <li>V = スケール ユニット内の最大 VM</li>
  </ul>


  <p>Azure Stack インフラストラクチャのオーバーヘッド = 242 GB + (4 GB x ノード)。 約31の Vm のこのアカウントは、Azure Stack&#39;s インフラストラクチャをホストするために使用されます。</p>


  <p>ホスト OS によって使用されるメモリ = ホスト メモリの 15% (0.15)。 オペレーティング システムの予約値は概算であり、ホストおよび一般的なオペレーティング システムのオーバーヘッドの物理メモリ容量によって異なります。</p>


  <p>値 V (スケール ユニット内の最大 VM) は、デプロイされた最大のテナント VM に動的に基づきます。 たとえば、最大 VM 値は、7 GB、112 GB、または Azure Stack ソリューションでサポートされるその他の VM メモリのサイズになる場合があります。 ここでは最大の VM のサイズを選択して十分なメモリを確保したので、この大きな VM のライブ マイグレーションは失敗しません。 Azure Stack ファブリック上で最大の VM を変更すると、VM 自体のメモリの増加に加えて、回復性のための予約が増加します。</p>


  <p>図3は、ホストごとに 384 GB のメモリを備えた12のホスト Azure Stack と、Azure Stack の最大の VM サイズによって使用可能なメモリの量がどのように変化するかを示したグラフです。 これらの例の最大の VM は、Azure Stack に配置されている唯一の VM です。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5becd364-1028-4274-88bc-1efb4dca7493.png"><img alt="image" border="0" height="320" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f8f11061-e41a-4961-aacc-50228b8ffbf9.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="絵" width="515"></a></p>


  <p align="center"><em>図 3: 最大 VM サイズが変更される使用可能なメモリ</em></p>


  <p>回復性の予約は、ホストのサイズの機能でもあります。 次の図4は、さまざまなホストメモリサイズの Azure stack で使用可能なメモリの最大サイズを示しています。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4d821dc9-5758-4557-8fab-59c8aacdfcf9.png"><img alt="image" border="0" height="325" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/275b7a34-9c25-4ecb-bb54-3ef4e0562600.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="絵" width="520"></a></p>


  <p align="center"><em>図 4: さまざまなホストメモリで最大規模の Vm が使用可能なメモリ</em></p>


  <p>上記の計算は概算であり、Azure Stack の現行バージョンに基づいて変更される可能性があります。 テナントの VM とサービスをデプロイできるかどうかは、デプロイされるソリューションの詳細に基づきます。 この計算例は単なるガイドであり、VM をデプロイできるかどうかを示す絶対的な答えではありません。</p>


  <p>Azure Stack のキャパシティプランニングについては、前述の考慮事項を念頭に置いてください。 また、容量計画のニーズを軽減するのに役立つ <a href="https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fazure%2Fazure-stack%2Fcapacity-planning-spreadsheet&amp;data=02%7C01%7Ckivenkat%40microsoft.com%7Cf1f1b0dbfb2e4fb386c408d6e5e8055f%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636949182022565887&amp;sdata=%2F7Lvl3bU6VTAwMDBQCk1DDGU69%2BxzxmtnVaFHrmrEKg%3D&amp;reserved=0" target="_blank">Azure Stack Capacity Planner</a> も公開しています。 詳細については、 <a href="https://docs.microsoft.com/en-us/azure-stack/operator/azure-stack-capacity-planning-compute" target="_blank">よく寄せられる質問</a>を参照してください。</p>
