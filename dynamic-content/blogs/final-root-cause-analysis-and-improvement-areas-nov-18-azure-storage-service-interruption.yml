### YamlMime:Yaml
ms.openlocfilehash: ab4d53fd85be4f58e835d71c7ca175d9276ced1b
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139909015"
Slug: final-root-cause-analysis-and-improvement-areas-nov-18-azure-storage-service-interruption
Title: '最終的な根本原因の分析と改善の領域: 11 月 18 日 Azure Storageサービスの中断'
Summary: 2014 年 11 月 18 日、Microsoft Azure のお客様の多くで、Azure Storage や他のいくつかのサービス (Virtual Machines など) に影響を与えるサービスの中断が発生しました。
Content: >-
  2014 年 11 月 18 日、Microsoft Azure のお客様の多くで、Azure Storage や他のいくつかのサービス (Virtual Machines など) に影響を与えるサービスの中断が発生しました。 このインシデントに続いて、お<a href="https://azure.microsoft.com/blog/2014/11/19/update-on-azure-storage-service-interruption/"></a>客様が問題への対処方法を理解するために、予備的な根本原因分析 (RCA) の概要を説明するブログを投稿しました。 それ以降、最優先事項は、このインシデントを積極的に調査し、軽減しています。 現在、最終的な RCA を共有しています。これには、この状況に対して再び発生した状況を軽減するために実行した手順の包括的な概要と、コミュニケーションとサポートの対応を改善するために実行されている手順が含まれています。 お客様のアプリケーションとサービスに対して、このサービスの中断が与えた重大な影響について、心からおわび申し上げます。 お客様が Microsoft Azure に配置されている信頼に感謝します。また、ビジネスの継続的な改善に役立つフィードバックを皆様に個人的に感謝したいと思います。

  <h2>根本原因の分析</h2>

  11 月 <sup>18 日</sup> [PST] (11 月 <sup>19 日</sup> (UTC)) Microsoft Azure でサービスの中断が発生し、複数のリージョンの Azure Storage サービスで断続的な接続の問題が発生しました。 依存サービス (主に Azure Virtual Machines) では、サービスの接続が失われるAzure Storageしました。


  このドキュメントでは、標準的なストレージ更新プロセスを示し、そのプロセスからの逸脱によって中断が発生した方法について説明し、一部の顧客が受ける二次的影響の原因を説明し、顧客のコミュニケーションとサポートの欠陥について説明し、最後に、同様の中断の繰り返しを防ぎ、通信とサポート対応を改善するために実行している手順の概要を示します。

  <h2>Microsoft Azure Storageデプロイ</h2>

  ソフトウェアの Azure Storage展開 (つまり、コードの発行) と構成の展開 (つまり、設定の変更) の 2 種類の展開があります。 ソフトウェアと構成の両方のデプロイでは、複数の検証ステージが必要であり、Azure インフラストラクチャに段階的に小規模なバッチでデプロイされます。 このプログレッシブ デプロイ アプローチは "flighting" と呼ばれる。 フライトが進行中の場合は、正常性チェックを密接に監視します。 継続的な使用状況とテストで成功した結果が示されるので、変更を新しいインフラストラクチャ全体の追加のスライスAzure Storageします。


  一般的なデプロイ プロセスを次に示します。

  <ol>
      <li>まず、内部テスト環境に更新プログラムをデプロイし、そこでテストと検証を行います。</li>
      <li>テスト環境の検証に合格した後、実稼働レベルのワークロードを実行する実稼働前環境に更新プログラムをデプロイします。</li>
      <li>運用前環境での検証に続いて、運用インフラストラクチャの小さなスライスに更新プログラムをデプロイします。</li>
      <li>各スライスの検証が完了した後、更新プログラムを段階的に大きいスライスにフライトします。 これらの更新プログラムをフライトするときに、公開される可能性がある新しい問題がペアのリージョンのセット (西ヨーロッパや北ヨーロッパなど) の 1 つのリージョンにのみ影響を与える、地理的に分離されたスライスが選択されます。</li>
  </ol>

  <h2>Storage インシデントの概要</h2>

  プラットフォームのすべての側面のパフォーマンスを向上させる方法を継続的に探しています。 この場合、テーブル フロントエンドの CPU フットプリントを減らすことAzure Storageパフォーマンスを向上させるAzure Storageを開発しました。


  構成スイッチを使用して、説明されているフライトアプローチを使用して、新しいコードを既定で無効にしたソフトウェア変更をデプロイしました。 その後、テスト環境と実稼働前環境Front-Endsスイッチを使用して、Azure Table Storage のコードを有効にしました。 正常性チェックに正常に合格した後、実稼働環境のサブセットに対する変更を有効にし、数週間テストしました。


  テスト中に、この修正プログラムはパフォーマンスの大幅な向上を示し、Azure Table Storage のパフォーマンスに関する既知の顧客の問題を解決しました。 機能強化により、修正プログラムを実稼働環境に広範にデプロイする決定が行われた。 このデプロイ中に、次の 2 つの操作エラーが発生しました。


  1. 小さなスライス間で変更を段階的にデプロイする標準的なフライトデプロイ ポリシーに従ってはいけでした。


  Azure Table Storage のパフォーマンスの問題を修正するエンジニアは、変更が運用インフラストラクチャの一部で数週間既にフライト済みだったため、インフラストラクチャ全体でこれを実現するリスクが低かったと考えました。 残念ながら、構成ツールでは、インフラストラクチャ全体に変更を段階的にデプロイするこのポリシーを適切に適用する必要がなかった。


  2. テストおよび実稼働前の検証は Azure Table Storage フロントエンドに対して行われいましたが、構成スイッチが Azure Blob Storage フロントエンドに対して正しく有効になっていませんでした。


  Azure Blob Storage Front-Ends でこの変更を有効にすると、一部の Azure Blob Storage Front-Ends が無限ループに入り、要求を処理できないというバグが発生しました。


  自動監視アラートは、インシデントから数分以内にエンジニアリング チームに通知しました。 多くの Azure Blob Storage が問題を発生から保護した問題の開始から 30 分以内に、Front-Ends変更をグローバルに元に戻しました。 既に無限ループにFront-Endsした Azure Blob Storage ストレージ は、無限ループが原因で構成の変更を受け入れなくなっています。 これらは、構成の変更を元に戻した後に再起動を必要とし、復旧時間を延長しました。

  <h2>展開ポリシーの適用</h2>

  問題が検出された後、コア デプロイ ツールのギャップを調べるために、すべての構成変更が直ちに停止されました。分析が完了したら、コードまたは構成に関する標準の更新プログラムに対して上記のテストおよびフライト ポリシーへのコンプライアンスを適用するために、デプロイ システム ツールの更新プログラムをリリースしました。


  要約すると、Microsoft Azureは明確な運用ガイドラインを持っていますが、人間の決定とプロトコルに依存するデプロイ ツールにはギャップがあります。 ツールの更新により、デプロイ プラットフォーム自体によってポリシーが適用されます。

  <h2>セカンダリ サービスの中断 (Virtual Machines</h2>

  Azure Compute の自動復旧メカニズムにより、サービスの中断が解決された後、ほぼすべての仮想マシンが手動Azure Storage復旧しました。 ただし、手動回復が必要な Virtual Machines のサブセットを特定しました。これは、正常に開始しなかったか、RDP、SSH、または他のパブリック エンドポイント経由でアクセスできないためです。 基になる問題は、次の 3 つのカテゴリに分類されます。


  <b>1. <strong>ディスク マウント タイムアウト</strong></b>


  復旧中に、一連の VM で起動プロセス中にディスク マウント タイムアウト エラーが発生しました。これは、サービスがまだ中断から復旧している間に Storage サービスの負荷が高かった場合です。 これらのお客様は、Azure トラブルシューティング サポート ブログで公開されている手順に従って、VM のブロックを解除 <a href="https://blogs.msdn.com/b/mast/archive/2014/11/20/recovering-azure-vm-by-attaching-os-disk-to-another-azure-vm.aspx">できます</a>。 VM の大部分では、中断が完全に解決された後、Azure Storage サービスの負荷が通常のレベルに減少していたことを考えると、必要な復旧手順は仮想マシンを再起動するだけで済みます。


  <b>2.Storage <strong></strong></b> サービスの中断中にプロビジョニングおよび作成されたセットアップ Windows Virtual Machines で失敗した VM は、Windows セットアップを正常に完了できません。 これらのVirtual Machines VM プロビジョニング手順を繰り返して再作成されました。 Linux Virtual Machines影響を受け取りでした。


  <b>3.ネットワーク プログラミング エラー</b>


  パブリック IP アドレス エンドポイントVirtual Machines接続できなかったVirtual Networkにデプロイされたアプリケーションの一部。 これには、これらの VM への RDP 接続と SSH 接続が含まれていました。 ストレージの停止中に特定の状態が発生すると、中断後にネットワークを再Storageしました。 数時間以内に、影響を受けるユーザーにサービスを復元する軽減策をデプロイVirtual Machines再起動する必要はありません。

  <h2>停止イベントのタイムライン [UTC]</h2>

  <ul>
      <li><b>11/19 00:50 AM</b> – サービス中断イベントで複数Storageが検出されました</li>
      <li><b>11/19 00:51 AM - 05:50 AM</b> -プライマリマルチリージョンとStorage影響。 ほとんどのお客様は、この期間中に影響と回復を経験しているでしょう</li>
      <li><b>11/19 05:51 AM - 11:00 AM</b>  -Storage影響は、顧客の小さなサブセットに分離されます</li>
      <li><b>11/19 10:50 AM</b>  -Storage解決され、プライマリ サービス中断イベントの結果として生じる、Virtual Machinesの小さなサブセットへの継続的Storage影響が特定されました</li>
      <li><b>11/19 11:00 AM</b> – Azure Engineering では、引き続きプラットフォームの自動化を実行して、影響を受けた残りのサービスを検出して修復Virtual Machines</li>
      <li><b>11/21 午前 11:00</b> – Azure 環境全体で自動復旧が完了しました。 Azure チームは、フォローアップの質問や支援を求め、すべてのお客様が引き続き利用できます</li>
  </ul>

  <h2>お客様のコミュニケーションとサポートに関する問題</h2>

  上記のサービスの中断に加えて、インシデント中に高品質の通信とサポートを提供する必要はありません。 次の 3 つの領域で不足しています。


  1) ダッシュボードに投稿された状態情報の遅延 <a href="https://azure.microsoft.com/en-us/status/">Service Healthエラー</a>。


  2) コミュニケーションのチャネルが不十分です (ツイート、ブログ、フォーラム)。


  3) データからの応答が遅Microsoft サポート。

  <h2>Service Healthダッシュボードの初期投稿の遅延とエラー</h2>

  [Service Health ダッシュボードには、Web コンポーネントと、状態の更新に使用される発行ツールがあります。Web コンポーネントには、必要に応じて、フェールオーバーを有効にするプライマリデプロイとセカンダリ デプロイの両方があります。 Storage の中断が原因でセカンダリ Web コンポーネントにフェールオーバーした場合、発行ツールはプライマリからセカンダリ ストレージの場所に正常に移行できなかった。 その結果、更新された状態の発行が遅れ、プラットフォームの全体的な状態に関する最初の混乱が発生しました。


  データの不整合の問題を解決した後、ダッシュボードの明確さの欠如を引き起こした 3 つのService Healthいました。


  1) ダッシュボード ヘッダーのバグにより、ダッシュボードにアクティブなアドバイザリがあるにもかかわらず、ページの上部に "All Good" が不正確に表示されました。 この誤解を招く状態を修正するために、インシデント中に更新プログラムがデプロイされました。


  2) サービス グリッドには、個々の Azure サービスの状態が正確に反映されたというのではありません。 サービスへの影響の詳細は、グリッドではなく概要投稿でのみ説明されています。


  3) リージョンに影響を与えるセカンダリの問題Virtual Machines、Service Health ダッシュボードは、リージョンの小さなサブセットに対する影響を誤って発表しました。 影響Service Healthスコープ全体を反映するように、新しいダッシュボードが後で更新されました。

  <h2>コミュニケーションのチャネルが不十分 (ツイート、ブログ、フォーラム)</h2>

  [Service Healthダッシュボード] は、状態情報の主要なソースです。上記の問題により @Azure 、サービスの中断に関するアカウントからのツイートが、進行中の問題を確認するために送信されました。しかし、これらのツイートには、インシデントを解決するために実行されている現在の状態とアクションを顧客に通知するための適切な頻度と行動が欠けていました。 また、サービス中断の継続的な更新を提供するために、Azure ブログに対する更新プログラムを投稿しました。

  <h2>遅延応答時間 (Microsoft サポート</h2>

  ダッシュボードの障害が発生したService Health影響も、新しいエコシステムMicrosoft サポートしました。 ダッシュボードService Health正確な状態を報告しなかったため、サポート呼び出しのボリュームは通常よりもはるかに高くなっています。 インシデントの影響を受けたお客様は、サービスに関する正確な情報を見つけ出す必要がなMicrosoft サポート。 残念ながら、顧客サポートの量が多かった結果、一部の顧客はサポートに関する問い合わせに対して応答時間の遅延を経験しました。 これらの問題に対処するために、Azure のエンジニアリングチームは、お客様のサービスの回復を支援するダイレクトカスタマーエンゲージメントを提供することで、Azure サポートチームをサポートしています。

  <h2>機能強化</h2>

  Microsoft では、Azure プラットフォームのエクスペリエンスを向上させることに取り組んでおり、次の点が改善されています。

  <h2>Storage サービスの中断:</h2>

  デプロイツールによって、増分バッチに標準の運用変更を適用する展開プロトコルが適用されていることを確認します。

  <h2>バーチャルマシンサービスの中断:</h2>

  <ul>
      <li>Windows および Linux vm の "低速ブート" シナリオの回復性と復旧を向上させます。</li>
      <li>ストレージインシデントに起因する Windows セットアッププロビジョニングエラーからの検出と回復を向上させます。</li>
      <li>顧客のサブセットのネットワークプログラミングエラーの原因となったネットワークサービスを修正しました</li>
  </ul>

  <h2>接続</h2>

  <ul>
      <li>ヘッダーの状態が正しくないことを示す Service Health ダッシュボードの構成ミスを修正します</li>
      <li>新しいソーシャルメディア通信手順を実装して、複数のメカニズムを使用して状態を効果的に伝達します。</li>
      <li>Service Health ダッシュボードと作成ツールの回復性を向上させます。</li>
  </ul>

  <h2>サポート:</h2>

  <ul>
      <li>Microsoft サポート自動化ツールとインフラストラクチャの回復性が向上しました</li>
  </ul>
