### YamlMime:Yaml
ms.openlocfilehash: 47aa92e82da727bfa471fbf941cf1730c12888ca
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139892241"
Slug: sql-data-warehouse-columstore-monitor
Title: 列ストアのSQL Data Warehouse機能を使用して Azure のパフォーマンスを向上させる
Summary: このブログでは、DMV を使用して SQLDW で列ストアの正常性を監視する方法について説明します。
Content: >-
  <p><a href="https://azure.microsoft.com/en-us/services/sql-data-warehouse/" target="_blank">Azure SQL Data Warehouse</a> (SQL DW) は、SQLベースのペタバイト規模で、非常に並列な、データ ウェアハウス用のクラウド ソリューションです。 フル マネージドで高いエラスティック性を備え、数分で容量をプロビジョニングおよびスケーリングできます。 コンピューティングとストレージは個別にスケーリングでき、バーストからアーカイブのシナリオまで幅広く利用できます。</p>


  <p>Azure SQL DW は、分析ワークロードに対して<a href="https://docs.microsoft.com/en-us/sql/relational-databases/indexes/columnstore-indexes-overview" target="_blank"></a>非常に高速なパフォーマンスを提供する列ストア エンジンを搭載しています。 これは、業界をリードする Microsoft データベースに組み込<a href="https://blogs.msdn.microsoft.com/sqlserverstorageengine/2016/03/14/columnstore-index-how-does-sql-server-delivers-industry-leading-performance-for-analytic-queries/" target="_blank">SQL Server同じ列ストア エンジンです</a>。 Azure SQL DW から最大限の速度を得るには、列ストア行グループの品質を最大化することが重要です。 行グループは、列ストアで一緒に圧縮される行のチャンクです。 行グループの品質をより簡単に監視およびチューニングするために、新しい動的管理ビュー (DMV) <a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-dynamic-management-views/system-dynamic-management-views" target="_blank">が</a> 公開されました。</p>


  <h2>高品質の行グループとは</h2>


  <p>100 万行 (正確には 1,048,576 行) の行グループは理想的な品質であり、適切な状況下では、Azure SQL DW によって作成されます。 メモリ不足などの最適でない条件 <a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-memory-optimizations-for-columnstore-compression#rowgroups-can-get-trimmed-during-compression" target="_blank">では</a>、行数が少ない行グループが作成されます。 これにより、圧縮品質に悪影響を及ぼすだけでなく、行グループの付帯構造の行ごとのオーバーヘッドが増加する可能性があります。 これにより、クエリのパフォーマンスが大幅に低下する可能性があります (注: SQL DW &lt; では、10,000 行の行グループの作成が防止されます)。</p>


  <h2>行グループの品質を監視する方法</h2>


  <p>Azure SQL DW には、列ストア テーブルの行グループの物理的な統計に関する情報を公開する新しい DMV <a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-reference-tsql-system-views#sql-server-dmvs-available-in-sql-data-warehouse" target="_blank">(sys.dm_pdw_nodes_db_column_store_row_group_physical_stats</a>) が追加されました。 この&rsquo; DMV &ndash; から情報を取得するために使用できる便利なビュー (<a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-memory-optimizations-for-columnstore-compression#how-to-monitor-rowgroup-quality" target="_blank">vCS_rg_physical_stats</a>) がある長い名前に感じ込む必要があります。 重要な情報は、行trim_reason_descが途中でトリミングされたかどうかを示す値です。 トリミングされていない場合は、理想的な品質です (trim_reason_desc = NO_TRIM)。 トリミングされた場合は、trim_reason_descや削除などのトリミングの理由MEMORY_LIMITATION設定DICTIONARY_SIZE。 次の例のスクリーンショットは、さまざまなトリミングの理由により、行グループの品質が低いテーブルのスナップショットを示しています。</p>


  <p><img alt="DMVBlogSS1" border="0" height="356" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f48f973d-e806-4e14-b5fa-d2df9176ad8b.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="DMVBlogSS1" width="610"></p>


  <h2>行グループの品質を向上させる方法</h2>


  <p>トリミングされた行グループを特定したら、その行の内容に応じて修正<em></em>trim_reason_descできます。 最も重要なヒントを次に示します。</p>


  <ul>
   <li>BULKLOAD: 読み込み用の行の受信バッチの行数が 100 万行未満の場合、トリムの理由は に設定されます。 圧縮された行グループは、挿入される行が 100,000 行を超える場合 (デルタ ストアへの挿入 <a href="https://docs.microsoft.com/en-us/sql/relational-databases/indexes/columnstore-indexes-overview" target="_blank">ではなく) いつでも</a>作成されますが、トリミングの理由は BULKLOAD に設定されます。 これを乗り越えるには、バッチ読み込みウィンドウを増やして、より多くの行を累積します。 また、パーティション構成を再 <a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-best-practices#do-not-over-partition" target="_blank">評価</a> して、行グループがパーティションの境界をまたがれなすぎるので、パーティション構成が細かすぎすぎずに再評価します。</li>
   <li>MEMORY_LIMITATION: 100 万行の行グループを作成するには、エンジンで一定の<a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-memory-optimizations-for-columnstore-compression#how-to-estimate-memory-requirements" target="_blank"></a>量の作業メモリが必要です。 読み込みセッションに使用できるメモリが、必要な作業メモリよりも少ない場合、行グループは途中でトリミングされます。 列 <a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-memory-optimizations-for-columnstore-compression" target="_blank">ストアの</a> 圧縮に関する記事では、これを修正するために実行できる操作について説明しますが、簡単に言うと、経験則として、少なくとも <a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-develop-concurrency#resource-classes" target="_blank">mediumrc</a> ユーザーを使用してデータを読み込むというルールがあります。 また、読み込みニーズに十分なメモリを確保するには、十分な大きな <a href="https://docs.microsoft.com/en-us/azure/sql-data-warehouse/sql-data-warehouse-develop-concurrency#memory-allocation" target="_blank">SLO</a> を使用する必要があります。</li>
   <li>DICTIONARY_SIZE: これは、非常に広い文字列や高いカーディナリティ文字列を持つ文字列列が少なくとも 1 つあるため、行グループのトリミングが発生したかどうかを示します。 ディクショナリ のサイズはメモリ内で 16 MB に制限され、これが到達すると、行グループが圧縮されます。 このような場合は、問題のある列を別のテーブルに分離することをお勧めします。</li>
  </ul>


  <p>次のスクリーンショットは、行グループの品質が固定された同じテーブルのコピーを示しています。次の推奨事項に従って、データの削除によるトリミングMEMORY_LIMITATION。</p>


  <p><img alt="DMVBlogSS2" border="0" height="367" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/dcd2799d-a4f7-43c8-8e4c-dbe0fd520de0.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="DMVBlogSS2" width="610"></p>


  <h2>次の手順</h2>


  <p>列ストア行グループの品質を監視する方法がわかったので、定期的な負荷の一部として積極的に最適なパフォーマンスを維持し、発生した場合に品質の問題を修正することができます。 Azure SQL DW をまだ使用していない場合は、ビジネス インテリジェンスとワークロードに対して試ビジネス分析勧めしています。</p>


  <h2>詳細情報</h2>


  <p>Azure SQL DW の詳細については、以下を参照してください。</p>


  <p><a href="https://azure.microsoft.com/documentation/articles/sql-data-warehouse-overview-what-is/" target="_blank">Azure SQL Data Warehouse の概要</a></p>


  <p><a href="https://azure.microsoft.com/documentation/articles/sql-data-warehouse-best-practices/" target="_blank">SQL Data Warehouse のベスト プラクティス</a></p>


  <p><a href="https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureSQLDataWarehouse" target="_blank">MSDN フォーラム</a></p>


  <p><a href="https://stackoverflow.com/questions/tagged/azure-sqldw" target="_blank">Stack Overflow フォーラム</a></p>
