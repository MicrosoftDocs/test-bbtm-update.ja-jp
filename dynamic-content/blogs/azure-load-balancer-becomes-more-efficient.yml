### YamlMime:Yaml
ms.openlocfilehash: d46be02fed1ec89c5fa857bedc6ab06b02f76cf1
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139895635"
Slug: azure-load-balancer-becomes-more-efficient
Title: Azure Load Balancer がより効率的になります。
Summary: Azure では、2017以降の高度で効率的な Load Balancer プラットフォームが導入されました。 このプラットフォームでは、新しい Standard Load Balancer を使用して、顧客のワークロードに対してまったく新しい機能セットを追加します。 新しい Load Balancer プラットフォームによってもたらされる重要な機能の1つは、単純で予測可能で効率的な送信接続の管理です。
Content: >-
  <p>Azure では、2017以降の高度で効率的な Load Balancer プラットフォームが導入されました。 このプラットフォームでは、新しい <a href="https://aka.ms/lbstandard" target="_blank">Standard Load Balancer</a>を使用して、顧客のワークロードに対してまったく新しい機能セットを追加します。 新しい Load Balancer プラットフォームによってもたらされる重要な機能の1つは、単純で予測可能で効率的な送信接続の管理です。</p>


  <p>既に Standard Load Balancer と統合されていますが、Azure の他のデプロイにもこの利点をもたらします。 このブログでは、その内容と、すべての利用者にとってどのように機能が向上するかについて説明します。 注目すべき重要な変更点は、送信接続の動作の事前および事後プラットフォーム統合です。これは、お客様にとって非常に重要な設計ポイントです。</p>


  <h2>Load Balancer とソース NAT</h2>


  <p>Azure デプロイでは、顧客 &rsquo; のデプロイモデルと使用されているリソースに応じて、<a href="https://aka.ms/lboutbound#scenarios" target="_blank">送信接続に 3</a>つ以上のシナリオを使用します。 Azure では、送信元ネットワークアドレス変換 (SNAT) を使用して、これらのシナリオを有効にします。 複数のプライベート IP アドレスまたはロールが同じパブリック IP を共有している場合 (Load Balancer に割り当てられているパブリック IP アドレス、 <a href="https://aka.ms/lboutboundrules" target="_blank">送信ルール</a> に使用される、またはスタンドアロン仮想 mahines のパブリック ip アドレスが自動的に割り当てられる)、Azure はポートマスカレード SNAT (PAT) を使用して、パブリック ip アドレスの一時ポートを使用して インスタンスレベルのパブリック IP アドレス (ILPIP) が割り当てられている場合、PAT は適用されません。</p>


  <p>複数のインスタンスがパブリック IP アドレスを共有している場合は、Azure Load Balancer VIP の背後にある各インスタンスに、PAT (SNAT ポート) に使用される固定数の一時的なポートが事前に割り当てられます。これは、送信フローのマスカレードに必要です。 インスタンスあたりの事前に割り当てられたポート数は、バックエンドプールのサイズによって決まります。詳細については、「 <a href="https://aka.ms/lboutbound#snat" target="_blank">SNAT アルゴリズム</a> 」を参照してください。</p>


  <h2>従来の SNAT アルゴリズムと新しい SNAT アルゴリズムの違い</h2>


  <p>また、プラットフォームの改善に伴い、Azure で SNAT アルゴリズムが動作する方法が改善されました。 次の表は、これらの割り当てモードとそれらのプロパティを並べて比較したものです。</p>


  <table align="center" border="2" cellpadding="1" cellspacing="0">
   <tbody>
    <tr>
     <td style="vertical-align: middle; width: 100px;">&nbsp;</td>
     <td style="vertical-align: middle; width: 220px;"><strong>レガシ SNAT ポートの割り当て<br>
  (レガシ Basic SKU のデプロイ)</strong></td>
     <td style="vertical-align: middle; width: 300px;"><strong>新しい SNAT ポートの割り当て<br>
  (最近の Basic SKU デプロイと Standard SKU デプロイ)</strong></td>
    </tr>
    <tr>
     <td style="vertical-align: middle; width: 100px;"><strong>適用範囲</strong></td>
     <td style="vertical-align: middle; width: 220px;">2017年9月より前にデプロイされたサービスは、この割り当てモードを使用します</td>
     <td style="vertical-align: middle; width: 300px;">2017年9月以降にデプロイされたサービスは、この割り当てモードを使用します。</td>
    </tr>
    <tr>
     <td style="vertical-align: middle; width: 100px;"><strong>事前割り当て</strong></td>
     <td style="vertical-align: middle; width: 220px;">160<br>
  (300 インスタンスを超えるテナントの場合は、より小さい数)</td>
     <td style="vertical-align: middle; width: 300px;">
     <p>バックエンドプールのサイズとプールの境界に応じた SNAT ポートの割り当てについては、 <a href="https://aka.ms/lboutbound#snat" target="_blank">snat ポートの事前割り当て</a>に関するページを参照してください。</p>

     <p style="margin-left: 40px;"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/6cb31eb5-3a64-4336-b317-ea87ec99a0f7.png"><img alt="An image of back-end instnace count vs Ephermeral port count" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/202ba353-e7f0-4241-b8aa-5a618d043b97.png" style="border: 0px currentcolor; display: inline; background-image: none; width: 300px; height: 119px;" title="バックエンドのインスタンス count と Ephermeral のポート数の画像"></a></p>

     <p>送信規則が使用される場合、事前割り当ては、送信規則で定義されているポートと同じになります。 一部のインスタンスでポートが枯渇した場合は、SNAT ポートは割り当てられません。</p>
     </td>
    </tr>
    <tr>
     <td style="vertical-align: middle; width: 100px;"><strong>最大ポート数</strong></td>
     <td style="width: 220px;">すべてが使い果たされるまで、少数のポートを動的にオンデマンドで割り当てることができます。 (1 つのフロントエンド IP アドレスで使用できる SNAT ポートの合計は65535で、すべてのバックエンドインスタンスで共有されています。)<br>
  要求を調整することはできません。</td>
     <td style="vertical-align: middle; width: 300px;">Basic SKU リソース * の場合、使用可能なすべての SNAT ポートは動的にオンデマンドで割り当てられます。<br>
  要求のスロットルがいくつか適用されます (1 秒あたりのインスタンス数)。<br>

  * Standard SKU リソースに対して、ポートの動的割り当ては行われません。</td>
    </tr>
    <tr>
     <td style="vertical-align: middle; width: 100px;"><strong>スケールアップ</strong></td>
     <td style="vertical-align: middle; width: 220px;">
     <p>ポートの再割り当てが完了しました。</p>

     <p>既存の接続は再割り当て時に削除される可能性があります。</p>
     </td>
     <td style="width: 300px;">
     <p>静的 SNAT ポートは、常に新しいインスタンスに割り当てられます。</p>

     <p>バックエンドプールの境界が変更された場合、またはポートが枯渇した場合は、ポートの再割り当てが完了します。</p>

     <p>既存の接続は再割り当て時に削除される可能性があります。</p>
     </td>
    </tr>
    <tr>
     <td style="vertical-align: middle; width: 100px;"><strong>スケールダウン</strong></td>
     <td style="vertical-align: middle; width: 220px;">ポートの再割り当てが完了しました。</td>
     <td style="vertical-align: middle; width: 300px;">バックエンドプールの境界が変更された場合、ポートの再割り当てが行われ、すべてに追加のポートが割り当てられます。</td>
    </tr>
    <tr>
     <td style="vertical-align: middle; width: 100px;"><strong>ユース ケース</strong></td>
     <td style="vertical-align: middle; width: 220px;">
     <ul>
      <li>ノイズのある近隣ノードがすべてのポートを消費し、残りのインスタンス/テナントの処理を阻害する可能性があります。</li>
      <li>ポート割り当ての管理は、調整なしではほぼ不可能です。</li>
     </ul>
     </td>
     <td style="vertical-align: middle; width: 220px;">
     <ul>
      <li>SNAT ポートの割り当てをより適切にカスタマイズし、制御します。</li>
      <li>多くのお客様のシナリオに対応するための事前割り当てが高くなります。</li>
      <li>非常に予測可能なポート割り当てとアプリケーション動作。</li>
     </ul>
     </td>
    </tr>
   </tbody>
  </table>


  <h2>プラットフォームの統合と SNAT ポート割り当てへの影響</h2>


  <p>&rsquo;2 つのプラットフォームの統合に取り組んで、信頼性と効率性を高め、お客様のテレメトリや SKU のアップグレードなどの機能を有効にします。 この統合により、Azure 全体のすべてのユーザーが新しい SNAT ポート割り当てアルゴリズムに移行されます。 この統合演習は進行中であり、Spring 2020 より前に終了する予定です。</p>


  <h3>プラットフォーム統合後に取得する SNAT 割り当ての種類</h3>


  <p>次のようなシナリオに分類してみましょう &rsquo; 。</p>


  <ol>
   <li><strong>従来の snat ポートの割り当て</strong> は snat ポート割り当ての古いモードであり、2017年9月より前に作成されたデプロイで使用されています。 このモードでは、少数の SNAT ポート (160) を Load Balancer の背後にあるインスタンスに静的に割り当て、その後、SNAT エラーと動的なオンデマンド割り当てに依存します。

   <ul>
    <li><strong>プラットフォーム統合後</strong>、上記のセクションの説明に従って、これらのデプロイは新しいプラットフォームの <strong>新しい SNAT 割り当て</strong> に移行されます。 ただし、 &rsquo; 移行後の新しいプラットフォームでは、静的ポート割り当ての &lt; 最大値と同じポート割り当てが、古いプラットフォーム &gt; の動的ポート割り当てと同じになるようにします。</li>
   </ul>
   </li>
   <li>古いプラットフォームの<strong>新しい SNAT ポート割り当てモード</strong>については、2018年前半に導入されました。 このモードは、前に説明した新しい SNAT ポート割り当てモードと同じです。
   <ul>
    <li><strong>プラットフォームの統合後</strong>は、これらの展開は変更されず、古いプラットフォームから SNAT ポートが割り当てられるようになります。</li>
   </ul>
   </li>
  </ol>


  <h3>サービスや既存の送信フローにどのような影響があるか。</h3>


  <ol>
   <li>ほとんどのケースでは、インスタンスが既定の事前に割り当てられている SNAT ポートよりも使用量が少ない場合、既存のフローには影響しません。</li>
   <li>少数の (動的割り当てを使用して受信した) SNAT ポートの数が非常に多い少数の顧客デプロイでは、追加の動的ポート割り当てに依存するフローの一部が一時的に削除される可能性があります。 これは数秒以内に自動的に修正します。</li>
  </ol>


  <h2>ここでは何をすればよいですか。</h2>


  <p>「 <a href="https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections#snatexhaust" target="_blank">SNAT ポートの枯渇の管理</a> 」で説明されているシナリオとパターンを確認して理解し、信頼性と拡張性に優れたシナリオを設計する方法について説明します。</p>


  <h2>操作方法今後の重大な期間は中断しないようにしてください。</h2>


  <p>プラットフォーム統合とその結果のポート割り当てアルゴリズムは、Azure platform レベルの変更です。 ただし、Azure で重要な運用ワークロードを実行していて、このレベルのサービスロジックの変更が重大な期間に実装されていないことを確認し、サービスの中断を回避することをお勧めします。 このようなシナリオでは、デプロイ情報 &rsquo; を使用してポータルから Load Balancer サポートケースを作成し、サービスを中断しないようにします。</p>
