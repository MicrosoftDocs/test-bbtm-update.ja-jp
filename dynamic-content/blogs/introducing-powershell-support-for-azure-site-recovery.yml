### YamlMime:Yaml
ms.openlocfilehash: 7b11f5674cca39e5a0569b073cdc576337681b41
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139904739"
Slug: introducing-powershell-support-for-azure-site-recovery
Title: Azure Site Recovery の PowerShell サポートの概要
Summary: 先週、Azure Site Recovery によって管理される2つの Hyper-v サイト間での回復に関する PowerShell サポートを発表しました。 ASR コマンドレットを使用して、仮想マシンの保護を有効にしたり、仮想マシンまたは仮想マシンを含む復旧計画に対して回復操作を実行したりすることができます。
Content: "先週、Azure Site Recovery によって管理される2つの Hyper-v サイト間での回復に関する PowerShell サポートを <a href=\"https://aka.ms/powershell_blog_annoucement\">発表</a> しました。 ASR コマンドレットを使用して、仮想マシンの保護を有効にしたり、仮想マシンまたは仮想マシンを含む復旧計画に対して回復操作を実行したりすることができます。 PowerShell のサポートにより、管理者は ASR サービスに対してスクリプトを実行できるようになります。また、ホスティングサービスプロバイダーは、Self-Service ポータルを拡張してディザスターリカバリーを実現することができます。\n\nPowerShell のサポートは Azure PowerShell の一部として出荷され、2014年10月 Azure PowerShell リリースで利用できます。 Azure PowerShell を既に使用している場合は、バージョン<a href=\"https://aka.ms/powershell_blog_v0.8.10\">0.8.10</a>以降にアップグレードする必要があります。 の<a href=\"https://aka.ms/powershell_blog_setup\">セットアップと構成</a>が完了すると Azure PowerShell 使用可能なすべての Azure Site Recovery コマンドレットの一覧を表示できるようになります。\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_List.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_List\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_List_thumb.png\" alt=\"ASR_cmdlet_List\" width=\"1342\" height=\"310\" border=\"0\" /></a>\n<h3>ASR コンテナーのコンテキストを設定する</h3>\nAzure Site Recovery コマンドレットの使用を開始するには、ASR コンテナー情報を使用して PowerShell 実行空間コンテキストを設定する必要があります。 セットアップを行うには、登録キーファイルを Azure portal からダウンロードする必要があります。これは、セットアップ時およびコンテナーへの SCVMM の登録時にも使用されます。 コンテキストがセットアップされると、残りのコマンドレットは、セットアップ済みのコンテキスト内で実行されます。\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_registrationFile2.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_registrationFile2\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_registrationFile2_thumb.png\" alt=\"ASR_cmdlet_registrationFile2\" width=\"1408\" height=\"605\" border=\"0\" /></a>\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_Import.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_Import\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_Import_thumb.png\" alt=\"ASR_cmdlet_Import\" width=\"915\" height=\"113\" border=\"0\" /></a>\n<h3>登録済み SCVMM サーバーの一覧表示</h3>\n<a href=\"https://aka.ms/powershell_blog_scvmmsetup\">SCVMM サーバーがセットアップされ</a>、Azure Site Recovery に登録されると、Get-AzureSiteRecoveryServer コマンドレットを使用して表示できます。 コマンドレットは、サーバー情報と共に、通信のハートビートとプロバイダーのバージョンを出力します。これにより、ASR のビューでサーバーの状態を監視できるようになります。\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_Server.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_Server\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_Server_thumb.png\" alt=\"ASR_cmdlet_Server\" width=\"447\" height=\"170\" border=\"0\" /></a>\n<h3>SCVMM クラウドの一覧表示</h3>\nAzure Site Recovery は、SCVMM クラウドを使用して仮想マシンのスケール管理を行います。 SCVMM で構成が完了すると、AzureSiteRecoveryProtectionContainer を使用して、ASR によって検出された SCVMM クラウドの情報を表示できます。 SCVMM クラウド名または SCVMM クラウド ID のいずれかを使用して、必要なクラウドをフィルター処理できます。\n\n&nbsp;\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_Cloud.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_Cloud\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_Cloud_thumb.png\" alt=\"ASR_cmdlet_Cloud\" width=\"699\" height=\"347\" border=\"0\" /></a>\n\n<b><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_PC.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_PC\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_PC_thumb.png\" alt=\"ASR_cmdlet_PC\" width=\"689\" height=\"119\" border=\"0\" /></a></b>\n<h3>リスト Virtual Machines</h3>\n仮想マシンは、保護コンテナーのコンテキストで表示できます。 ASR によって検出された SCVMM 仮想マシンの情報は、AzureSiteRecoveryProtectionEntity を使用して表示できます。 保護コンテナーと同様に、SCVMM VMID または仮想マシン名を使用して保護エンティティをフィルター処理できます。\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_PE.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_PE\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_PE_thumb.png\" alt=\"ASR_cmdlet_PE\" width=\"1113\" height=\"114\" border=\"0\" /></a>\n<h3>Virtual Machines の保護</h3>\n保護対象の仮想マシンと保護されていない仮想マシンの両方が保護エンティティの一覧に返されます 保護管理は、AzureSiteRecoveryProtectionEntity を使用して保護エンティティに対して実行できます。 これは、Azure Site Recovery ジョブを返す非同期操作です。 ジョブの状態は、AzureSiteRecoveryJobGet-AzureSiteRecoveryJob を使用してさらに完了に追跡できます。\n\n次の例のように、同じスクリプトスニペットを簡単に使用できます。\n<pre class=\"prettyprint\">param\n(    \n    [parameter(Mandatory=$TRUE, HelpMessage=\"SCVMM Cloud Name\")]\n    [ValidateNotNullOrEmpty()]\n    [string] $ProtectedContainerName,\n\n    [parameter(Mandatory=$TRUE, HelpMessage=\"List of VM names in the SCVMM cloud\")]\n    [ValidateNotNullOrEmpty()]\n    [string[]] $VMList,\n\n    [parameter(Mandatory=$TRUE, HelpMessage=\"Protection State\")]\n    [ValidateNotNullOrEmpty()]\n [ValidateSet('ENABLE','DISABLE')]\n    [string] $ProtectionState\n)\n\n$ProtectedContainers =  Get-AzureSiteRecoveryProtectionContainer | %{ $_.Name }\nif(!$ProtectedContainers.Contains($ProtectedContainerName))\n{ \n Write-Error \"PROTECTED CONTAINER $CloudName NOT FOUND IN ASR\"\n return;\n}\n\n$ASRProtectedContainer = Get-AzureSiteRecoveryProtectionContainer -Name $ProtectedContainerName\nWrite-Output \"ProtectedContainer \" $ASRProtectedContainer\n\n$JobsList = $VMList | %{ \n  Write-Host \"Starting $ProtectionState Protections on $_\"; \n  Get-AzureSiteRecoveryProtectionEntity -Name $_ -ProtectionContainer $ASRProtectedContainer | Set-AzureSiteRecoveryProtectionEntity -Protection $ProtectionState -WaitForCompletion\n } \n\n$hasFailed = $FALSE\nforeach($Job in $JobsList)\n{\n    $JobDetails = Get-AzureSiteRecoveryJob -Job $Job\n    if($JobDetails.Errors.Count -ne 0)\n    {\n  $hasFailed = $TRUE\n  Write-Host \"JobID $Job.Id Failed\"\n  foreach($JobError in $JobDetails.Errors)\n  {\n   Write-Host $JobError.ServiceErrorDetails\n   Write-Host $JobError.ProviderErrorDetails\n   Write-Host $JobError\n  }  \n    }\n}\n\nWrite-Host \"PROPERTIES AFTER $ProtectionState DR OPERATION\"\n\n$VMList | %{ Get-AzureSiteRecoveryProtectionEntity -Name $_ -ProtectionContainer $ASRProtectedContainer }\n\nif(!$hasFailed)\n{\n Write-Host \"ENABLE DR OF ALL VMs COMPLETED SUCCESSFULLY\"\n}</pre>\n&nbsp;\n<h3>復旧計画の作成と管理</h3>\n仮想マシンの保護を有効にすると、復旧計画を作成できます。 復旧計画を作成すると、フェールオーバーと復旧の対象に含める仮想マシンをグループにまとめて、それらの仮想マシン グループをフェールオーバーする順序を指定できます。 Azure Site Recovery コマンドレットを使用すると、Azure portal で作成された既存の復旧計画を XML ファイルの形式でダウンロードできます。 復旧計画 XML ファイルを利用して、新しい復旧計画を作成したり、既存の復旧計画を更新したりすることができます。\n\n復旧計画の管理コマンドレットを次に示します。\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/11/03/ASR_cmdlet_RPcmdList.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px\" title=\"ASR_cmdlet_RPcmdList\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ASR_cmdlet_RPcmdList_thumb.png\" alt=\"ASR_cmdlet_RPcmdList\" width=\"1186\" height=\"122\" border=\"0\" /></a>\n\n復旧計画のサンプル XML は次のようになります。\n<pre class=\"prettyprint\">&lt;?xml version=\"1.0\" encoding=\"utf-8\"?&gt;\n&lt;RecoveryPlan Id=\"1077cccd-e483-4320-bbcd-b04ca39a7015\" Name=\"Contoso\" PrimaryServerId=\"4c6e08af-7a59-4749-9ccd-0ea089ad264c\" \n              SecondaryServerId=\"fc769e95-24cc-41e2-919e-1e25b2c5d50a\" Description=\"\" Version=\"V2014_07\"&gt;\n  &lt;Actions /&gt;\n  &lt;ActionGroups&gt;\n    &lt;ShutdownAllActionGroup Id=\"ShutdownAllActionGroup\"&gt;\n      &lt;PreActionSequence /&gt;\n      &lt;PostActionSequence /&gt;\n    &lt;/ShutdownAllActionGroup&gt;\n    &lt;FailoverAllActionGroup Id=\"FailoverAllActionGroup\"&gt;\n      &lt;PreActionSequence /&gt;\n      &lt;PostActionSequence /&gt;\n    &lt;/FailoverAllActionGroup&gt;\n    &lt;BootActionGroup Id=\"DefaultActionGroup\"&gt;\n      &lt;PreActionSequence /&gt;\n      &lt;PostActionSequence /&gt;\n      &lt;ProtectionEntity PrimaryProtectionEntityId=\"aa4718c1-19c2-4c44-b749-3b87a5ed4954\" /&gt;\n      &lt;ProtectionEntity PrimaryProtectionEntityId=\"981dab28-644d-4cca-aea7-b65123eb5ee3\" /&gt;\n    &lt;/BootActionGroup&gt;\n    &lt;BootActionGroup Id=\"Group2\"&gt;\n      &lt;PreActionSequence /&gt;\n      &lt;PostActionSequence /&gt;\n      &lt;ProtectionEntity PrimaryProtectionEntityId=\"7f24915d-5415-4d7a-86fe-6beef5b8acfd\" /&gt;\n      &lt;ProtectionEntity PrimaryProtectionEntityId=\"050414cf-03b0-4d2c-bb63-0993c047d658\" /&gt;\n      &lt;ProtectionEntity PrimaryProtectionEntityId=\"be96b86f-0257-42ce-8fe7-c627cfb90410\" /&gt;\n    &lt;/BootActionGroup&gt;\n  &lt;/ActionGroups&gt;\n  &lt;ActionGroupSequence&gt;\n    &lt;ActionGroup Id=\"ShutdownAllActionGroup\" ActionId=\"ShutdownAllActionGroup\" Before=\"FailoverAllActionGroup\" /&gt;\n    &lt;ActionGroup Id=\"FailoverAllActionGroup\" ActionId=\"FailoverAllActionGroup\" After=\"ShutdownAllActionGroup\" Before=\"DefaultActionGroup\" /&gt;\n    &lt;ActionGroup Id=\"DefaultActionGroup\" ActionId=\"DefaultActionGroup\" After=\"FailoverAllActionGroup\" Before=\"864672ba-0c94-4cc7-b7f0-c3d202c3aaeb\" /&gt;\n    &lt;ActionGroup Id=\"864672ba-0c94-4cc7-b7f0-c3d202c3aaeb\" ActionId=\"Group2\" After=\"DefaultActionGroup\" /&gt;\n  &lt;/ActionGroupSequence&gt;\n&lt;/RecoveryPlan&gt;</pre>\n&nbsp;\n<h3>[フェールオーバー]</h3>\nAzure Site Recovery は、テスト、計画、計画外の3種類のフェールオーバーをサポートしています。 すべてのフェールオーバー操作は、個々の Virtual Machines と復旧計画の両方でサポートされています。 これらの機能は、PowerShell コマンドレットでも使用できるようになりました。 ASR フェールオーバーは非同期操作であるため、これらのコマンドレットを実行すると、応答として Azure Site Recovery ジョブが返されます。 ジョブの状態は、AzureSiteRecoveryJob を使用してさらに完了に追跡できます。\n\n次の例のように、同じスクリプトスニペットを簡単に使用できます。\n<pre class=\"prettyprint\">param\n(    \n    [parameter(Mandatory=$FALSE, HelpMessage=\"Name of the RP\")]\n    [ValidateNotNullOrEmpty()]\n    [string] $RPName,\n\n    [parameter(Mandatory=$TRUE, HelpMessage=\"Failover Type\")]\n    [ValidateNotNullOrEmpty()]\n [ValidateSet('PLANNED','UNPLANNED', 'TEST')]\n [string] $FailoverType,\n\n    [parameter(Mandatory=$TRUE, HelpMessage=\"Failover direction\")]\n    [ValidateNotNullOrEmpty()]\n [ValidateSet('PrimaryToRecovery','RecoveryToPrimary')]\n    [string] $FailoverDirection,\n\n    [parameter(Mandatory=$TRUE, HelpMessage=\"Should do commit on the RP after failover\")]\n    [ValidateNotNullOrEmpty()]\n    [bool] $ShouldCommit,\n\n    [parameter(Mandatory=$TRUE, HelpMessage=\"Should do reverse replicate on the RP after commit\")]\n    [ValidateNotNullOrEmpty()]\n    [bool] $ShouldReverseReplicate\n)\n\n##\n## This routine checks for error in jobs.\n##\nfunction WaitForJobCompletionAndCheck-JobErrors([string] $JobId)\n{\n        $IsCompleted = $false\n\n        while(!$IsCompleted)\n        {\n\n         $Job = Get-AzureSiteRecoveryJob -Id $JobId\n\n         if($Job.State -eq \"Succeeded\")\n         {\n          $IsCompleted = $true\n                Write-Output \"Job with Id $JobId executed successfully.\"\n                return\n         }\n         if($Job.State -eq \"Failed\")\n         {\n          $IsCompleted = $true;\n                 Write-Output \"The Job Id $JobId has failed in execution\"\n         }\n\n         if($Job.State -eq \"Suspended\" )\n         {\n         Resume-AzureSiteRecoveryJob -Job $Job\n         }\n            else\n            {\n                Write-Output \"The job $JobID is in progress\"  \n          Start-Sleep -s 15\n            }\n        }\n\n  $hasFailed = $false\n\n  $JobDetails = Get-AzureSiteRecoveryJob -Id $JobId\n  if($JobDetails.Errors.Count -ne 0)\n  {\n   $hasFailed = $true\n   Write-Error \"JobID $JobId Failed\"\n   foreach($JobError in $JobDetails.Errors)\n   {\n    Write-Error $JobError.ServiceErrorDetails\n    Write-Error $JobError.ProviderErrorDetails\n   }\n  }\n\n}\n\n$RecoveryPlans =  Get-AzureSiteRecoveryRecoveryPlan | %{ $_.Name }\nif(!$RecoveryPlans.Contains($RPName))\n{ \n Write-Error \"RECOVERY PLAN $RPName NOT FOUND IN ASR\"\n return;\n}\n\n$RecoveryPlanObject = Get-AzureSiteRecoveryRecoveryPlan -Name $RPName\n\nWrite-Output \"RECOVERY PLAN DETAILS : \" \nWrite-Output $RecoveryPlanObject\n\nWrite-Output \"Starting RP $FailoverType Failover of $RPName :\";\n\nif($FailoverType.ToUpper() -eq \"PLANNED\")\n{\n $Job = Start-AzureSiteRecoveryPlannedFailoverJob -RecoveryPlan $RecoveryPlanObject -Direction $FailoverDirection \n}\nelseif($FailoverType.ToUpper() -eq \"UNPLANNED\")\n{\n $Job = Start-AzureSiteRecoveryUnplannedFailoverJob -RecoveryPlan $RecoveryPlanObject -Direction $FailoverDirection \n}\nelseif($FailoverType.ToUpper() -eq \"TEST\")\n{\n $Job = Start-AzureSiteRecoveryTestFailoverJob -RecoveryPlan $RecoveryPlanObject -Direction $FailoverDirection \n}\nelse\n{\n Write-Error \"Invalid RP Failover Type - $FailoverType\"\n} \nWaitForJobCompletionAndCheck-JobErrors $Job.ID\n\nif($ShouldCommit)\n{\n Write-Output \"Starting RP Commit Failover for $RPName\"; \n\n $RecoveryPlanObject = Get-AzureSiteRecoveryRecoveryPlan -Name $RPName\n Write-Output $RecoveryPlanObject\n\n $JobsList = Start-AzureSiteRecoveryCommitFailoverJob -RecoveryPlan $RecoveryPlanObject \n\n WaitForJobCompletionAndCheck-JobErrors $JobsList.ID\n}\n\nif($ShouldReverseReplicate)\n{\n Write-Output \"Starting RP Reverse Replication for $RPName\"; \n\n $RecoveryPlanObject = Get-AzureSiteRecoveryRecoveryPlan -Name $RPName\n Write-Output $RecoveryPlanObject\n\n $JobsList = Update-AzureSiteRecoveryProtectionDirection  -RecoveryPlan  $RecoveryPlanObject -Direction $FailoverDirection \n\n WaitForJobCompletionAndCheck-JobErrors $JobsList.ID\n}\n\n$RecoveryPlanObject = Get-AzureSiteRecoveryRecoveryPlan -Name $RPName\nWrite-Output $RecoveryPlanObject</pre>"
