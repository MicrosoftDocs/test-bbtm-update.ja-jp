### YamlMime:Yaml
ms.openlocfilehash: 41fa55f774572a954669da5216a170252d16c610
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139904095"
Slug: migrate-azure-virtual-machines-between-storage-accounts
Title: ストレージ アカウント間での Azure 仮想マシンの移行
Summary: この記事では、あるストレージアカウントから別のストレージアカウントに仮想マシンを移行する方法について説明します。
Content: "Azure での一般的なタスクの1つは、仮想マシンをあるストレージアカウントから別のストレージアカウントに移行することです。\n\nこれらの手順に進む前に、Azure Virtual Machines のセットアップ方法を簡単に確認することをお勧めします。 Azure の仮想マシンを作成するときに、コンピューティングと Storage という2つのサービスがこのマシンの作成に使用されます。 Storage 側では、Azure Storage サービス内のいずれかのストレージアカウントに VHD が作成されます。 この VHD が格納されている物理ノードは、仮想マシンを配置するために指定したリージョンにあります。 コンピューティング側では、仮想マシンを配置するための物理ノードが2番目のクラスターに見つかります。 そのクラスターで VM が起動すると、Storage サービスとの接続が確立され、VHD からブートされます。\n\n仮想マシンを作成するときは、VM を作成しているのと同じリージョンのストレージアカウントに VHD が配置されている必要があります。 これにより、仮想マシンとストレージアカウントの間の通信時にパフォーマンスの一貫性が確保されます。\n\n<img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px\" title=\"IaaSArchitecture\" alt=\"IaaSArchitecture\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/IaaSArchitecture.png\" width=\"614\" height=\"295\" border=\"0\" />\n\nここでは、仮想マシンをあるリージョンから別のリージョンに移行する手順について説明します。\n<ol>\n <li>仮想マシンを停止します。</li>\n <li>ソースリージョンのストレージアカウントからターゲットリージョンのストレージアカウントに VHD blob をコピーします。</li>\n <li>Blob から Azure ディスクを作成する</li>\n <li>ディスクから仮想マシンを起動します。</li>\n</ol>\n<h2>仮想マシンを停止します。</h2>\nサービス管理ポータルに移動し、移行する仮想マシンを選択して、コントロールメニューの [シャットダウン] を選択します。\n\n<img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px\" title=\"ShutdownVm\" alt=\"ShutdownVm\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ShutdownVm.png\" width=\"614\" height=\"220\" border=\"0\" />\n\nまた、Azure Powershell コマンドレットを使用して、同じタスクを実行することもできます。\n<pre class=\"prettyprint\">$servicename = \"KenazTestService\"\n$vmname = \"TestVM1\"\nGet-AzureVM -ServiceName $servicename -Name $vmname | Stop-AzureVM</pre>\nコピー操作の実行時にファイルシステムの整合性を保つには、VM を停止する必要があります。 現時点では、Azure はライブマイグレーションをサポートしていません。 この操作は、特殊化された VM をあるリージョンから別のリージョンに移行することを意味します。 一般化されたイメージから VM を作成する場合は、仮想マシンを停止する前に準備します。\n<h2>VHD blob をコピーする</h2>\nAzure Storage サービスは、あるストレージアカウントから別のストレージアカウントに blob を移動する機能を公開します。 これを行うには、次の手順を実行する必要があります。\n<ol>\n <li>ソースストレージアカウント情報を決定する</li>\n <li>コピー先のストレージアカウント情報を決定する</li>\n <li>コピー先のストレージアカウントにターゲットコンテナーが存在することを確認する</li>\n <li>Blob コピーの実行</li>\n</ol>\n<b>注: </b>異なるリージョンのストレージアカウント間で blob をコピーする場合、blob のサイズに応じて最大1時間以上かかることがあります。\n\nこれを行う最も簡単な方法は、Azure Powershell を使用することです。\n<pre class=\"prettyprint\">Select-AzureSubscription \"kenazsubscription\" \n\n# VHD blob to copy #\n$blobName = \"KenazTestService-TestVM1-2014-8-26-15-1-55-658-0.vhd\" \n\n# Source Storage Account Information #\n$sourceStorageAccountName = \"kenazsa\"\n$sourceKey = \"MySourceStorageAccountKey\"\n$sourceContext = New-AzureStorageContext –StorageAccountName $sourceStorageAccountName -StorageAccountKey $sourceKey  \n$sourceContainer = \"vhds\"\n\n# Destination Storage Account Information #\n$destinationStorageAccountName = \"kenazdestinationsa\"\n$destinationKey = \"MyDestinationStorageAccountKey\"\n$destinationContext = New-AzureStorageContext –StorageAccountName $destinationStorageAccountName -StorageAccountKey $destinationKey  \n\n# Create the destination container #\n$destinationContainerName = \"destinationvhds\"\nNew-AzureStorageContainer -Name $destinationContainerName -Context $destinationContext \n\n# Copy the blob # \n$blobCopy = Start-AzureStorageBlobCopy -DestContainer $destinationContainerName `\n                        -DestContext $destinationContext `\n                        -SrcBlob $blobName `\n                        -Context $sourceContext `\n                        -SrcContainer $sourceContainer</pre>\nこれにより、コピー元のストレージアカウントからコピー先のストレージアカウントに blob コピーが開始されます。 この時点で、blob が完全にコピーされるまでしばらく待機する必要があります。 操作の状態を確認するには、次のコマンドを実行します。\n<pre class=\"prettyprint\">while(($blobCopy | Get-AzureStorageBlobCopyState).Status -eq \"Pending\")\n{\n    Start-Sleep -s 30\n    $blobCopy | Get-AzureStorageBlobCopyState\n}</pre>\nBlob のコピーが完了すると、blob コピーの状態は \"成功\" になります。vhd のコピーのより包括的な例については、「<a href=\"https://gallery.technet.microsoft.com/scriptcenter/Azure-Virtual-Machine-Copy-1041199c\">Azure 仮想マシン: Storage アカウント間で vhd をコピー</a>する」を参照してください。\n<h2>AzCopy を使用した Blob コピー</h2>\nまた、AzCopy ユーティリティを使用する方法もあります (<a href=\"https://aka.ms/downloadazcopy\">こちらからダウンロード</a>してください)。 ストレージアカウント間の同等の blob コピーは次のとおりです。\n<pre class=\"prettyprint\">AzCopy https://sourceaccount.blob.core.windows.net/mycontainer1 https://destaccount.blob.core.windows.net/mycontainer2 /sourcekey:key1 /destkey:key2 abc.txt</pre>\nさまざまなシナリオで AzCopy を使用する方法の詳細については、「<a href=\"https://azure.microsoft.com/en-us/documentation/articles/storage-use-azcopy/\">azcopy Command-Line ユーティリティを使用したはじめに</a>」を参照してください。\n<h2>Azure ディスクを作成する</h2>\nこの時点で、コピー先のストレージアカウントにコピーした blob は blob のままです。 そこから起動するには、この blob から Azure ディスクを作成する必要があります。 Virtual Machines の [ディスク] セクションに移動し、[作成] を選択します。\n\n<b>注: </b>これらの手順は、特殊化された Vm に固有のものです。 VHD をイメージとして使用する場合は、VM を再起動し、sysprep を実行し、blob をにコピーしてから、を (ディスクではなく) イメージとして追加する必要があります。\n\n<img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px\" title=\"VirtualMachineDisks\" alt=\"VirtualMachineDisks\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/VirtualMachineDisks.png\" width=\"614\" height=\"208\" border=\"0\" />\n\nVHD URL エクスプローラーを使用して、blob をコピーしたコピー先コンテナーから blob を選択します。 \"VHD にオペレーティングシステムが含まれています\" と表示される切り替えを選択します。 これは、作成中のディスクオブジェクトが、データディスクの1つではなく OS ディスクとして使用されることを Azure に示します。\n\n<img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px\" title=\"CreateVHD\" alt=\"CreateVHD\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/CreateVHD.png\" width=\"578\" height=\"484\" border=\"0\" />\n\n<b>注: </b>\"Blob でリースの競合が発生しました...\" というエラーが表示された場合は、前の手順に戻って、blob のコピーが完了したことを確認します。\n\n<img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px\" title=\"LeaseCOnflict\" alt=\"LeaseCOnflict\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/LeaseCOnflict.png\" width=\"614\" height=\"161\" border=\"0\" />\n\nまたは、Powershell コマンドレットを使用して、同じ操作を実行することもできます。\n<pre class=\"prettyprint\">Add-AzureDisk -DiskName \"myMigratedTestVM\" `\n            -OS Linux `\n            -MediaLocation \"https://kenazdestinationsa.blob.core.windows.net/destinationvhds/KenazTestService-TestVM1-2014-8-26-16-16-48-522-0.vhd\" `\n            -Verbose</pre>\n完了すると、ディスクが Virtual Machines の [ディスク] セクションに表示されます。\n<h2>仮想マシンの作成</h2>\nこの時点で、作成したディスクオブジェクトを使用して仮想マシンを作成できます。 サービス管理ポータルから、[ギャラリーから仮想マシンを作成] を選択し、[ディスク] の下に作成したディスクを選択します。\n\n<b>注</b>: 記憶域プールが構成されている (またはドライブ文字の順序を同じにする) VM を移動する場合は、ソース VM で lun 番号を VHD マッピングにメモし、データディスクが移行先 vm の同じ lun に接続されていることを確認します。\n\n<a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2014/10/15/LinuxVM.png\"><img style=\"padding-top: 0px;padding-left: 0px;padding-right: 0px;border: 0px\" title=\"起動時\" alt=\"LinuxVM\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/LinuxVM_thumb.png\" width=\"644\" height=\"362\" border=\"0\" /></a>\n\nこれで、仮想マシンが移行先のストレージアカウントで実行されるようになりました。"
