### YamlMime:Yaml
ms.openlocfilehash: 49065e947e34ba15b67082e8f4b6a59cfb2822fe
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139895563"
Slug: detecting-threats-targeting-containers-with-azure-security-center
Title: Azure Security Center を使用してコンテナーを対象とする脅威を検出する
Summary: クラウドに移行するサービスが増え、セキュリティ上の課題が生じます。 このブログ投稿では、コンテナー環境のセキュリティに関する考慮事項に焦点を当てます。
Content: >-
  <p>より多くのサービスがクラウドに移行し、セキュリティ上の課題に直面しています。 このブログ投稿では、コンテナー環境のセキュリティに関する考慮事項に焦点を当てます。</p>


  <p>以前の <a href="https://azure.microsoft.com/en-us/blog/protect-linux-containers-running-in-iaas-with-azure-security-center/">ブログ記事</a> では、コンテナーの ci ベンチマークに基づく Docker の推奨事項とコンプライアンスを含む、コンテナーのセキュリティに関する新機能について発表しました Azure Security Center。 &rsquo;コンテナー化された環境では、Docker レベルから Kubernetes クラスターレベルまで、いくつかのセキュリティの問題について説明します。また、Azure Security Center を使用して、環境内の脅威をリアルタイムで検出し、軽減する方法について &rsquo; も説明します。</p>


  <h2>Docker analytics</h2>


  <p>Docker に関しては、攻撃者のための一般的なアクセスベクターは、正しく構成されていないデーモンです。 既定では、Docker エンジンには、UNIX ソケットを介してのみアクセスできます。 この設定により、Docker エンジン &rsquo; にリモートでアクセスできるようになります。 ただし、多くの場合、リモート管理が必要です。 そのため、Docker でも TCP ソケットがサポートします。 Docker は、暗号化および認証されたリモート <a href="https://docs.docker.com/engine/security/https/">通信</a>をサポートしています。 ただし、デーモンの実行時に tlsverify &rdquo; フラグを明示的に指定 &ldquo; せずに、TCP ソケットを使用してデーモンを実行すると、docker ホストへのネットワークアクセス権を持つすべてのユーザーが、docker エンジンに認証されていない API 要求を送信できるようになります。</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/672ea32d-dcf6-46eb-904a-06337e5de31c.png"><img alt="docker1" border="0" height="428" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f2332f52-cec9-4e8a-b18b-33575f929633.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="docker1" width="640"></a></p>


  <p align="center"><em>図 1 &ndash; ネットワーク経由でアクセス可能な Docker デーモンを公開しました</em></p>


  <p align="left"><br>

  公開された Docker デーモンを実行するホストは、非常に短時間で危害を受けます。 Microsoft Threat 知能 Center &rsquo; s <a href="https://azure.microsoft.com/en-us/blog/leverage-azure-security-center-to-detect-when-compromised-linux-machines-attack/">honeypots</a>では、公開された Docker デーモンを検索するスキャナーが頻繁に見られます。 Azure Security Center は、このような動作を検出して警告できます。</p>


  <p align="center">&nbsp;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/82fcfd99-7f71-4d35-a9b3-220496700689.png"><img alt="exposed_alert" border="0" height="768" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b324b5ff-bd9c-47b9-9b95-4f592e2af611.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="exposed_alert" width="606"></a></p>


  <p align="center"><em>図 2. &nbsp;&ndash;公開された Docker アラート</em></p>


  <p><br>

  もう1つのセキュリティ上の懸念は、コンテナーを実際には必要以上の特権で実行している可能性があるということです。 高い特権を持つコンテナーは、ホスト &rsquo; のリソースにアクセスできます。 そのため、侵害された特権コンテナーは、侵害されたホストにつながる可能性があります。 Azure Security Center は、特権コンテナーが実行されたときに検出して警告します。</p>


  <p align="center">&nbsp;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ebeb5bdf-8ea7-4060-9bb4-7d267967db08.png"><img alt="privileged_alert" border="0" height="480" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4c6f2200-6487-42fa-bd75-64552708560e.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="privileged_alert" width="592"></a></p>


  <p align="center"><em>図 3 &ndash; 特権コンテナーアラート</em></p>


  <p><br>

  コンテナーで SSH サーバーを実行したり、悪意のあるイメージを実行したりするなど、Azure Security Center によって検出される可能性のある疑わしい動作があります。</p>


  <h2>クラスターレベルのセキュリティ</h2>


  <p>通常、Docker の1つのインスタンスを実行するだけでは十分ではなく、コンテナークラスターが必要です。 ほとんどのユーザーは、コンテナーオーケストレーションに Kubernetes を使用します。 クラスター管理の大きな懸念事項は、クラスター内で特権の昇格と横方向の移動が行われる可能性です。 &nbsp; ここではいくつかのシナリオを紹介し、これらの悪意のあるアクティビティを特定するために Azure Security Center がどのように役立つかを説明します。</p>


  <p>最初のデモでは、 &rsquo; RBAC が有効になっていないクラスターを使用します。</p>


  <p>このようなシナリオ (図 4) では、ポッドに既定でマウントされるサービスアカウントに高いクラスター特権が与えられます。 コンテナーの1つが侵害された場合、攻撃者は、そのコンテナーにマウントされているサービスアカウントにアクセスして、API サーバーとの通信に使用することができます。</p>


  <p align="center">&nbsp;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/88407d11-28db-457a-976c-cdde024c0270.png"><img alt="k81" border="0" height="425" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0d7111cb-a51f-4800-9e5e-81362d68f710.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="k81" width="640"></a></p>


  <p align="center"><em>図 4 &ndash; 脆弱な web アプリケーションコンテナーが API サーバーにアクセスする</em></p>


  <p><br>

  この例では、クラスター内のいずれかのコンテナーが、リモートコード実行の脆弱性により脆弱で、インターネットに公開されている web アプリケーションを実行しています。 Web アプリケーションには、 <a href="https://www.drupal.org/sa-core-2018-002">CVE-2018-7600</a>を含むリモートコードの実行を許可する脆弱性の例が多数あります。</p>


  <p>この RCE 脆弱性を使用して、クラスターで実行されている侵害されたアプリケーションから API サーバーに要求を送信します。 サービスアカウントには高い特権があるため、クラスターで任意のアクションを実行できます。 次の例では、クラスターからシークレットを取得し、その出力を web アプリケーションのファイルシステムに保存します。これにより、後でアクセスできるようになります。</p>


  <p align="center"><em><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/bfc1683b-0ccc-49c6-a173-e7db1877cb44.png"><img alt="A snippet of command text which would allow an attacker to retrieve all secrets from a compromised cluster. " border="0" height="43" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0ee5fb58-4f7e-4ab0-8c76-556292cc24bd.png" style="border: 0px currentcolor; border-image: none; width: 1238px; height: 52px; display: inline; background-image: none;" title="攻撃者が侵害されたクラスターからすべてのシークレットを取得できるようにするコマンドテキストのスニペット。 " width="1024"></a></em></p>


  <p align="center"><em>図 5 &ndash; ペイロード送信要求を API サーバーに送信する</em></p>


  <p><br>

  図 5. で、既定の名前空間のすべてのシークレットを一覧表示する API サーバー (IP 10.0.0.1 内) に要求を送信します。 これを行うには、侵害されたコンテナーの <em>/var/run/secretes/kubernetes.io/serviceaccount/token</em> にあるサービスアカウントトークンを使用します。</p>


  <p>これで、シークレットを格納するファイル secrets.txt にアクセスできるようになりました。</p>


  <p align="center"><em><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1e8de2ed-bc02-4b88-a4a9-f544bbc97f5c.png"><img alt="An image showing the information dump of the cluster's secrets." height="279" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1de82d82-876b-42f2-b43f-b04e7572b7a8.png" style="border: 0px currentcolor; border-image: none; width: 425px; height: 185px; display: inline; background-image: none;" title="クラスターのシークレットの情報ダンプを示すイメージ。" width="640"></a></em></p>


  <p align="center">&nbsp;</p>


  <p align="center"><em>図 6 &ndash; クラスター &rsquo; のシークレットのダンプ</em></p>


  <p><br>

  また、新しいコンテナーの一覧表示、削除、および作成を行ったり、他のクラスターリソースを変更したりすることもできます。</p>


  <p>Azure Security Center は、Kubernetes ノード (必要なクラスター &rsquo; ノードの auditd) から API サーバーへの疑わしい要求を特定し、アラートを送信できます。</p>


  <p align="center">&nbsp;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c2e86b7f-f90d-4b20-b562-6c3b28591216.png"><img alt="k8s_alert_1" border="0" height="480" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0e9a32ac-e237-4074-82cb-745c6de11c8c.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="k8s_alert_1" width="600"></a></p>


  <p align="center"><em>図 7 &ndash; 疑わしい API 要求のアラート</em></p>


  <p><br>

  この攻撃の軽減策の1つは、RBAC を使用してクラスターのアクセス許可を管理することです。 RBAC を使用すると、ユーザーは異なるアカウントに異なるアクセス許可を与えることができます。 既定では、サービスアカウントには、クラスターで操作を実行するアクセス許可がありません。</p>


  <p>ただし、RBAC が有効になっている場合でも多くの場合、攻撃者は悪意のある目的でこのような脆弱性のあるコンテナーを使用できます。 クラスターを監視および管理するための非常に便利な方法は、Kubernetes ダッシュボードを使用することです。 ダッシュボードは、コンテナー自体が、重要な操作を有効にしない既定の RBAC アクセス許可を取得します。 ダッシュボードを使用するには、多くのユーザーが kubernetes サービスアカウントにアクセス許可を付与します。 このような場合、攻撃者は、API サーバーを直接使用する代わりに、プロキシとしてダッシュボードコンテナーを使用して、クラスター内でアクションを実行できます。 次のペイロードでは、名前空間のメインリソースに関する情報を含む、Kubernetes ダッシュボードから既定の名前空間の概要ページを取得します。</p>


  <p align="center"><em><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/63d42a1b-5edf-450a-b7b0-c15115614ed1.png"><img alt="A snippet of command text which would allow an attacker to perform any actions in a cluster by using the dashboard container as a proxy for the API server." src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b643570b-12c3-4b8a-9a5a-e18fc9784144.png" style="border: 0px currentcolor; border-image: none; width: 724px; height: 30px; display: inline; background-image: none;" title="コマンドテキストのスニペット。これにより、攻撃者は、ダッシュボードコンテナーを API サーバーのプロキシとして使用して、クラスター内で任意のアクションを実行できます。"></a></em></p>


  <p align="center">&nbsp;</p>


  <p align="center"><em>図 8 &ndash; ダッシュボードへの要求</em></p>


  <p>&nbsp;</p>


  <p>図8では、侵害されたコンテナーからダッシュボード &rsquo; s クラスター IP (この場合は 10.0.182.140) に要求が送信されます。 図9は、ダッシュボードが使用される場合の攻撃ベクトルを示しています。</p>


  <p align="center">&nbsp;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/d684abcb-931f-4260-9d05-7b7bddc46ec9.png"><img alt="k8s2" border="0" height="382" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9de96d68-59a4-4703-86fa-5a7971ec044f.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="k8s2" width="640"></a></p>


  <p align="center"><em>図 9 &ndash; 脆弱性のあるコンテナーが Kubernetes ダッシュボードにアクセスする</em></p>


  <p><br>

  また Azure Security Center は、Kubernetes ノード (必要なクラスター &rsquo; ノードの auditd) からダッシュボードコンテナーに対する疑わしい要求を特定し、アラートを送信することもできます。</p>


  <p align="center">&nbsp;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5aaf2254-1817-4d10-b1ee-b6a75c6d4a1d.png"><img alt="k8s_alert_2" border="0" height="521" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e997cdb2-223f-42dd-9ac0-61e2437720ff.png" style="border: 0px currentcolor; border-image: none; display: inline; background-image: none;" title="k8s_alert_2" width="600"></a></p>


  <p align="center"><em>図 10 &ndash; ダッシュボードへの疑わしい要求のアラート</em></p>


  <p><br>

  特定のアクセス許可がどのコンテナーにも与えられていない場合でも、脆弱性のあるコンテナーにアクセスできる攻撃者はクラスターに関する有益な情報を得ることができます。 各 Kubernetes ノードは、特定のノードで実行されているコンテナーを管理する Kubelet という名前の Kubernetes エージェントを実行します。 Kubelet は、ポート10255で認証を必要としない読み取り専用 API を公開します。 ノードへのネットワークアクセス権を持つユーザーは、この API に対してクエリを実行し、ノードに関する有益な情報を取得することができます。 具体的には、https://[NODE IP]: 10255/ポッド/は、ノード上で実行されているすべてのポッドを取得します。</p>


  <p>https://[NODE IP]: 10255/spec/は、ノード自体に関する情報 (CPU やメモリの消費量など) を取得します。 攻撃者は、侵害されたコンテナーの環境をより深く理解するために、この情報を使用できます。<br>

  水平方向の移動と特権エスカレーションは、コンテナークラスターのセキュリティに関する主な懸念事項の一部です。 クラスター内の異常な動作を検出すると、これらの脅威を検出して軽減するのに役立ちます。</p>


  <h2>Azure Security Center の概要</h2>


  <p>詳細については、<a href="https://azure.microsoft.com/en-us/blog/protect-linux-containers-running-in-iaas-with-azure-security-center/">コンテナーの</a>Azure Security Center<a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-alerts-type">アラート</a>と保護に関するページを参照してください。 Azure Security Center の Standard レベルを使用して、 <a href="https://azure.microsoft.com/en-us/free/">今すぐ無料で</a>コンテナーを保護しましょう。</p>
