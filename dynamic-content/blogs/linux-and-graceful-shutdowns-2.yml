### YamlMime:Yaml
ms.openlocfilehash: 062a02e5b925f04ae991ef7e1af4df770634a140
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139908878"
Slug: linux-and-graceful-shutdowns-2
Title: Linux とグレースフルシャットダウン
Summary: Azure の IaaS 仮想マシンは、Azure 管理ポータル、Azure Powershell コマンドレット、CLI ツールのいずれかを使用して、または対話形式でログインしているユーザーが、さまざまな方法でシャットダウンできます。…
Content: >-
  Azure の IaaS 仮想マシンは、Azure 管理ポータル、Azure Powershell コマンドレット、CLI ツールのいずれかを使用して、または対話形式でログインしているユーザーが、さまざまな方法でシャットダウンできます。Azure platform 自体は、プラットフォームのメンテナンスを実行するためにシャットダウンを開始することもできます。ベアメタルオンプレミスで実行されている Linux システムのシャットダウンプロセスは十分に理解されていますが、クラウドではどのように機能するのでしょうか。

  <h4 align="left">Azure での正常なシャットダウンの開始</h4>

  Azure で Linux 仮想マシンをシャットダウンするプロセスは、オンプレミスの場合とほぼ同じです。ユーザーがログインし、"/sbin/shutdown now" を実行すると、システムは実行中のサービスの停止を直ちに開始し、最終的にシステムを電源オフにします。もちろん、実際のメカニズムは、ディストリビューションと使用されている init システム (通常は SysV、Upstart、または systemd) によって多少異なりますが、結果は同じです。


  ここで、シャットダウンがポータルまたは Azure platform によって開始された場合はどうなりますか。簡単に言うと、もう一度言っても、ほぼ同じことが起こります。このような場合、Azure はホストと通信し、ゲスト Linux システムの正常なシャットダウンを開始します。Hyper-v および Azure 環境では、正常なシャットダウンを実行する信号はハイパーバイザーから取得され、Linux カーネルに含まれる Linux Integration Services の一部である <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/hv/">hv_utils</a>   ドライバーによって処理されます。この機能は、統合された <em>シャットダウン</em>と呼ばれます。


  ハイパーバイザーからこのシグナルを受信すると、hv_utils ドライバーは Linux ゲストの正常なシャットダウンを開始し、ユーザーが "/sbin/shutdown now" を手動で実行した場合と同じメカニズムを基本的に起動します。Hv_utils がハイパーバイザーからこの信号を受信すると、次のメッセージが、ハイパーバイザーによって Linux システムがシャットダウンされたことを示すログ (通常は、/var/log/messages または/var/log/syslog の場合は) に送信されます。


  <a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1796/4382.Stephen-1.png"><img alt="" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1796/4382.Stephen-1.png" border="0"></a>


  ただし、小さな catch があります。Azure platform は、正常なシャットダウンを開始した後、無期限に待機することはできません。このプラットフォームは、仮想マシンが正常にシャットダウンされるまで <strong>5 分間</strong>   待機します。その時間が経過しても実行中の場合は、コンピューターの電源をオフにします。これは、VM がすべてのスクリプトを実行し、割り当てられた時間内にクリーンにシャットダウンできることを確認するために重要です。

  <h4 align="left">シャットダウンプロセスの管理</h4>

  Azure での Linux ユーザーの一般的な要件は、Azure が VM の正常なシャットダウンを開始したときにアプリケーションが正常にシャットダウンされるようにすることです。これで、手動とハイパーバイザーによって開始されるシャットダウンの両方で同じメカニズムが使用されていることがわかったので、既存の Linux init システムを使用して、アプリケーションが正常にシャットダウンされるようにすることができます。


  多くの場合、既存の SysV、systemd、または upstart スクリプトは、アプリケーションを適切にシャットダウンするために十分です。ただし、十分ではない場合、またはアプリケーションの "クリーンアップ" のために追加のプロセスを実行する必要がある場合は、次のような方法があります。

  <ul>
   <li>もちろん、最も簡単な方法は、単に applications init スクリプトを編集し、追加のタスクを追加することです。これにはいくつかの欠点があります。スクリプトの編集時に発生する可能性がある明らかなミスミスやその他のエラーに加えて、スクリプトは通常 RPM または Deb パッケージによって管理されるため、スクリプトのアップグレードを防ぐことができます。1つの利点は、統合された <em>シャットダウン</em>   がハイパーバイザー機能であるため、Azure にデプロイする前に、すべての仮想マシンを hyper-v でローカルにテストできることです。</li>
   <li>別の方法として、独自の init スクリプトを作成することもできます。Linux システムで使用できるさまざまな init システムがあるため、これを行う方法も多数あります。ほとんどのシステムは、ネイティブの init システムと共に少なくとも SysV の互換性があります。したがって、最も簡単な方法は、SysV と互換性のあるスクリプトを記述し、それがランレベル0から実行されるようにすることです。</li>
   <li>さらに複雑なアプローチもあります。これは、Azure ギャラリーの CentOS イメージを使用して最近テストしたものです。このスクリプトは、必要な事前シャットダウンアクションを実行する独自の init スクリプトを作成する場合に適していますが、電源をオフにする前に VM を正常にシャットダウンするための5分間のウィンドウが残っていることに注意してください。</li>
  </ul>

  しかし、Linux 自体と同じように、すべてのディストリビューションとワークロードに対して、ここでは1つのサイズに適合しないすべてのアプローチを使用することはできません。ここで重要な点は、この問題を解決する方法は多数ありますが、Hyper-v または Azure で Vm を完全にシャットダウンするために必要なことは何もありません。お好みの Linux ディストリビューションで既に提供されている標準の手順やメカニズムを引き続き使用することができます。また、これらのシステムを Azure でホストするメリットも享受できます。
