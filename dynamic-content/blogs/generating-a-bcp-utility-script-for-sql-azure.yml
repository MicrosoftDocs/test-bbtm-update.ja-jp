### YamlMime:Yaml
ms.openlocfilehash: fca46a98425cc7e15dce12bd508e3acb06edbd77
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139893042"
Slug: generating-a-bcp-utility-script-for-sql-azure
Title: アプリケーション用の BCP ユーティリティ スクリプトのSQL Azure
Summary: '[この記事は、チームによってSQL Azureされました。]SQL Server から SQL Azure にテーブルを移行する場合、最も簡単な方法の 1 つは、bcp ユーティリティを使用して、SQL Server から にデータを描画することです。'
Content: <p>[この記事は、チームによってSQL Azureされました。]</p><p>SQL Server から SQL Azure にテーブルを移行する場合、最も簡単な方法の 1 つは<a href="https://msdn.microsoft.com/en-us/library/ms162802(SQL.105).aspx">、bcp</a> ユーティリティを使用して SQL Server からファイルにデータを描画し、ファイルから SQL Azure にデータを移動することです。 ただし、bcp ユーティリティでは各テーブルに対して 1 つのコマンドを実行し、一度に 1 つのテーブル分のデータを移動する必要があります (初期のブログ記事で SQL Azure で bcp ユーティリティを使用する方法の詳細については、この記事をご覧ください)。 1 つのバッチ ファイルを使用してすべてのテーブルを移動するとは便利ではありませんか? この記事では、データベース全体SQL必要なすべての bcp ユーティリティ コマンドを含むバッチ ファイルを作成する Transact-SQL スクリプトについて説明します。</p>  <h4>準備</h4>  <p>次のスクリプトを実行する前に、次の手順を実行します。</p>  <ul>   <li>bcp ユーティリティを使用してファイルを移動する前に、SQL Azureにデータベース スキーマを既に作成している必要があります。 これは、スクリプト生成ウィザードを使用して行います。詳細については、前のブログ記事を参照してください。 </li>    <li>コピー先データベースSQL Azureテーブルは空にする必要があります。つまり、同じコピー先データベースで BCP ユーティリティ バッチ ファイルを 2 回実行してはならないことを意味します。 </li>    <li>次のスクリプトは、SQL Server Management Studioソース データベースに接続SQL Server実行されます。 スクリプトを実行する前に、スクリプトの上部にある変数を変更して、ソース SQL Server と宛先 SQL Azure サーバーを反映する必要があります。 </li> </ul>  <p>Transact-SQLスクリプトでは、Transact-SQL PRINT ステートメントを使用してバッチ ファイルのコマンドを生成します。 スクリプトを実行した後、出力全体を拡張子が 1 のファイル.batします。 バッチ ファイルを作成したら、コマンド ラインから実行して、データベースの移動を容易にできます。</p>  <h4>主キーの保持</h4>  <p>IDENTITY を使用して <b>データベース</b> 内に主キーを生成する場合、生成された bcp ユーティリティ コマンドでは、–E フラグを使用して主キーの番号が保持されます。 ただし、外部キーの参照整合性は、挿入時にチェックされません。 これにより、テーブル間の依存関係に関係なく行を挿入できます。主キーを外部キーの前に挿入する必要がない。</p>  <p>プライマリ キーは再生成されないので、バッチ ファイルの実行中にソース データベースも書き込みされない限り、制約に違反する必要はありません。 ここには問題があります。ソース データベースが読み取り専用モードか、データを書き込むアプリケーションがいないか確認する必要があります。 bcp ユーティリティ コマンドは、大きなトランザクション内にラップされません。 バッチ ファイルの最初のコマンドが実行され、最後のコマンドが実行される時間の間にかなりの時間が生じ、データの書き込みを行う機会が生まれる可能性があります。</p>  <h4>スクリプト</h4>  <pre class="csharpcode"><span class="kwrd">SET</span> NOCOUNT <span class="kwrd">ON</span>    <span class="kwrd">DECLARE</span> @DestServer nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @DestDatabase nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @DestLogin nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @DestPassword nvarchar(<span class="kwrd">max</span>)    <span class="kwrd">DECLARE</span> @SrcServer nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @SrcDatabase nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @SrcLogin nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @SrcPassword nvarchar(<span class="kwrd">max</span>)    <span class="rem">-- SQL Azure Server</span>  <span class="kwrd">SET</span>        @DestServer = <span class="str">'yourServer.database.windows.net'</span>  <span class="kwrd">SET</span>        @DestDatabase = <span class="str">'yourDatabase'</span>  <span class="kwrd">SET</span>        @DestLogin = <span class="str">'yourLogin@yourServer'</span>  <span class="kwrd">SET</span>        @DestPassword = <span class="str">'yourPassword'</span>    <span class="rem">-- SQL Server</span>  <span class="kwrd">SET</span>        @SrcServer = <span class="str">'yourServer'</span>  <span class="kwrd">SET</span>        @SrcDatabase = <span class="str">'yourDatabase'</span>  <span class="kwrd">SET</span>        @SrcLogin = <span class="str">'yourLogin'</span>  <span class="kwrd">SET</span>        @SrcPassword = <span class="str">'yourPassword'</span>    <span class="kwrd">PRINT</span> <span class="str">'echo %DATE% %TIME% &gt; bcp.log'</span>  <span class="kwrd">PRINT</span> <span class="str">''</span>    -------------------------------------------------<span class="rem">--</span>    <span class="kwrd">DECLARE</span> @<span class="kwrd">Schema</span> nvarchar(<span class="kwrd">max</span>)  <span class="kwrd">DECLARE</span> @<span class="kwrd">Table</span> nvarchar(<span class="kwrd">max</span>)    <span class="kwrd">DECLARE</span> table_cursor <span class="kwrd">CURSOR</span> <span class="kwrd">FOR</span>      <span class="kwrd">SELECT</span> TABLE_SCHEMA, TABLE_NAME      <span class="kwrd">FROM</span> information_schema.tables       <span class="kwrd">WHERE</span> Table_Type = <span class="str">'BASE TABLE'</span>      <span class="kwrd">OPEN</span> table_cursor;    <span class="rem">-- Perform the first fetch.</span>  <span class="kwrd">FETCH</span> <span class="kwrd">NEXT</span> <span class="kwrd">FROM</span> table_cursor <span class="kwrd">INTO</span> @<span class="kwrd">Schema</span>, @<span class="kwrd">Table</span>;    <span class="rem">-- Check @@FETCH_STATUS to see if there are any</span>  <span class="rem">-- more rows to fetch.</span>  <span class="kwrd">WHILE</span> <span class="preproc">@@FETCH_STATUS</span> = 0  <span class="kwrd">BEGIN</span>        <span class="kwrd">PRINT</span> <span class="str">'REM Download '</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span>      <span class="kwrd">PRINT</span> <span class="str">'echo bcp.exe '</span> + @SrcDatabase + <span class="str">'.'</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> +          @<span class="kwrd">Table</span> + <span class="str">' out '</span> +           @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span> + <span class="str">'.bcp -q -h &quot;TABLOCK&quot; -N -CRAW -S'</span> +          @SrcServer + <span class="str">' &gt;&gt; bcp.log'</span>      <span class="kwrd">PRINT</span> <span class="str">'bcp.exe '</span> + @SrcDatabase + <span class="str">'.'</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span> +           <span class="str">' out '</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span> +           <span class="str">'.bcp -q -h &quot;TABLOCK&quot; -N -CRAW -S'</span> + @SrcServer +           <span class="str">' -U'</span> + @SrcLogin + <span class="str">' -P'</span> + @SrcPassword + <span class="str">' &gt;&gt; bcp.log'</span>      <span class="kwrd">PRINT</span> <span class="str">''</span>        <span class="kwrd">PRINT</span> <span class="str">'REM Upload '</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span>      <span class="kwrd">PRINT</span> <span class="str">'echo bcp.exe '</span> + @DestDatabase + <span class="str">'.'</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> +           @<span class="kwrd">Table</span> + <span class="str">' in '</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span> +           <span class="str">'.bcp -q -h &quot;TABLOCK&quot; -N -E -CRAW -S'</span> + @DestServer +          <span class="str">' &gt;&gt; bcp.log'</span>      <span class="kwrd">PRINT</span> <span class="str">'bcp.exe '</span> + @DestDatabase + <span class="str">'.'</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> +           @<span class="kwrd">Table</span> + <span class="str">' in '</span> + @<span class="kwrd">Schema</span> + <span class="str">'.'</span> + @<span class="kwrd">Table</span> +            <span class="str">'.bcp -q -h &quot;TABLOCK&quot; -N -E -CRAW -S'</span> + @DestServer +            <span class="str">' -U'</span> + @DestLogin + <span class="str">' -P'</span> + @DestPassword + <span class="str">' &gt;&gt; bcp.log'</span>      <span class="kwrd">PRINT</span> <span class="str">''</span>           <span class="rem">-- This is executed as long as the previous fetch succeeds.</span>     <span class="kwrd">FETCH</span> <span class="kwrd">NEXT</span> <span class="kwrd">FROM</span> table_cursor  <span class="kwrd">INTO</span> @<span class="kwrd">Schema</span>, @<span class="kwrd">Table</span>;  <span class="kwrd">END</span>    <span class="kwrd">CLOSE</span> table_cursor;  <span class="kwrd">DEALLOCATE</span> table_cursor;</pre>      <h4>まとめ</h4>    <p>質問、懸念事項、コメントはありますか? 以下に投稿すると、対処を試みることができます。</p>
