### YamlMime:Yaml
ms.openlocfilehash: 699fc143fd4595cb3e01726e8af9a409e4a66fbb
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139905136"
Slug: powershell-module-for-the-oms-search-api
Title: OMS Search API 用の PowerShell モジュール
Summary: Runbook にアップロードして Runbook で直接使用Azure Automation PowerShell モジュールを活用する方法について説明します。 OMS モジュールでは、認証と承認Azure Active Directoryを使用します。
Content: "<p><strong>2016 年 4 月 5 日の更新:</strong> このブログの投稿は、thisblog の <a href=\"https://blogs.technet.microsoft.com/privatecloud/2016/04/05/using-the-oms-search-api-with-native-powershell-cmdlets/\" target=\"_blank\">投稿に</a>&nbsp;取ってかからされました</p>\n\n<p><strong>2015 年 10 月 15 日を更新: </strong>Github の OMS PowerShell モジュールは、Azure リソース <a href=\"https://github.com/tiander/OMSsearchAPI\" target=\"_blank\"></a> グループの開始日/&amp;終了日時をサポートするようにここで更新され、サービス プリンシパル名 (SPN) の使用がサポートされます。</p>\n\n<p>前の <a href=\"https://azure.microsoft.com/blog/2015/07/21/leveraging-the-oms-search-api-in-an-azure-automation-runbook/\" target=\"_blank\">ブログ記事</a> では、Hybrid Runbook Worker に簡単にアップロードしてオンプレミスのリソースを活用する簡単な方法がない場合の Hybrid Runbook Worker Azure Automation のシナリオと使用例について説明しました。 このHybrid Runbook Worker、 <strong>ARMclient </strong>を利用して OMS Search API に接続しました。 このブログ記事では、&#39;にアップロードして Runbook で直接使用できる PowerShell モジュールAzure Automationを活用する方法について説明します。 OMS モジュールでは、認証と承認Azure Active Directoryを使用します。</p>\n\n<blockquote><strong>注: OMS Search API は、OMS 分析データを一括エクスポートすることを意図した機能ではありません。これは、範囲指定された限&ldquo;&rdquo;られた時間と日付範囲で短いクエリを実行することを目的とします</strong></blockquote>\n\n<p>このブログ記事で説明されている PowerShell モジュールは、こちらからダウンロード <a href=\"https://github.com/tiander/OMSsearchAPI\" target=\"_blank\">してください</a>。 このブログ記事では、次の操作を行います。</p>\n\n<ul>\n <li>モジュールを Azure Automation にインポートする</li>\n <li>ユーザーをAzure Active Directoryする</li>\n <li>必要な資産を Azure Automation</li>\n <li>OMS Search API の結果を取得する Runbook を作成する</li>\n</ul>\n\n<h2>PowerShell モジュールを Azure Automation にインポートする</h2>\n\n<p>次の手順では、Azure プレビュー ポータルを使用します。</p>\n\n<ul>\n <li>2 つの PowerShell モジュールを <a href=\"https://github.com/tiander/OMSsearchAPI\" target=\"_blank\">ここからコンピューター</a> にダウンロードします。</li>\n <li>自分のアカウントに移動Azure Automation[資産] を <strong>クリックします。</strong></li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Adding-Module-1.jpg\"><img alt=\"Adding Module 1\" border=\"0\" height=\"244\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Adding-Module-1_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"モジュール 1 の追加\" width=\"206\"></a></blockquote>\n\n<ul>\n <li>[モジュール <strong>] をクリックします</strong>。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Adding-Module-2.jpg\"><img alt=\"Adding Module 2\" border=\"0\" height=\"221\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Adding-Module-2_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"モジュール 2 の追加\" width=\"244\"></a></blockquote>\n\n<ul>\n <li>[モジュール <strong>の追加] をクリックします</strong>。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Adding-Module-3.jpg\"><img alt=\"Adding Module 3\" border=\"0\" height=\"117\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Adding-Module-3_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"モジュール 3 の追加\" width=\"155\"></a></blockquote>\n\n<ul>\n <li>[<strong>アップロード ファイル] を選択</strong>し、ダウンロードした PowerShell モジュールを参照し、最初に [AzureActiveDirectory.zip] <strong> を選択し、[ </strong> OK] を<strong>クリックします。</strong></li>\n <li>これにより PowerShell モジュールがインポートされ、インポート後にアクティビティの <strong>抽出が開始</strong> されます。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Adding-Module-4.jpg\"><img alt=\"Adding Module 4\" border=\"0\" height=\"107\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Adding-Module-4_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"モジュール 4 の追加\" width=\"244\"></a></blockquote>\n\n<ul>\n <li>抽出が正常に完了されたことを確認します。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Adding-Module-5.jpg\"><img alt=\"Adding Module 5\" border=\"0\" height=\"68\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Adding-Module-5_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"モジュール 5 の追加\" width=\"244\"></a></blockquote>\n\n<ul>\n <li>2 番目のモジュール <strong> をOperationsManagementSuite.zip</strong> と同じ方法でインポートし、抽出が正常に完了したことを確認します。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Adding-Module-6.jpg\"><img alt=\"Adding Module 6\" border=\"0\" height=\"176\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Adding-Module-6_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"モジュール 6 の追加\" width=\"244\"></a> &nbsp;</blockquote>\n\n<h2>ユーザーのAzure Active Directory作成</h2>\n\n<p>OMS Search API PowerShell モジュールでは認証に AAD が使用されるので、Azure Active Delivery (AAD) アカウントを作成 (または既存の) 使用する必要があります。 Joe Levy は、このプロセスについて完全に説明 <a href=\"https://azure.microsoft.com/blog/2014/08/27/azure-automation-authenticating-to-azure-using-azure-active-directory/\" target=\"_blank\">します</a>。</p>\n\n<h2>必要な資産の作成</h2>\n\n<p>前の手順でインポートした 2&rsquo; つの PowerShell モジュールでは、2 つの接続オブジェクトを作成する必要があります。 これにより、Runbook での生活がはるかに簡単になります。 [資産] <strong>に移動し</strong> 、[接続] を <strong>クリックします</strong>。</p>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/11/Connections-1.jpg\"><img alt=\"Connections 1\" border=\"0\" height=\"215\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Connections-1_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"接続 1\" width=\"244\"></a></blockquote>\n\n<p>[接続の <strong>追加] をクリックします</strong>。</p>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/11/Connections-2.jpg\"><img alt=\"Connections 2\" border=\"0\" height=\"115\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Connections-2_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"接続 2\" width=\"142\"></a></blockquote>\n\n<p>AzureActiveDirectory <strong>型の</strong> 新しい <strong>接続を作成します</strong> 。 <strong>ClientID</strong> と <strong>Secret</strong> のフィールドは必須です (これは間違いなく修正されます)、ここで何かを入力する必要があります。 Runbook では、アプリケーション用のこれらのフィールドは利用されません。 ここで <strong>N/A を</strong> 入力します。</p>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/11/Connections-5.jpg\"><img alt=\"Connections 5\" border=\"0\" height=\"471\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Connections-5_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"接続 5\" width=\"150\"></a></blockquote>\n\n<p>[保存] <strong>をクリック</strong>し、<strong></strong><strong>OperationsManagementSuite 型の 2 つ目の接続を作成します</strong>。</p>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/11/Connections-4.jpg\"><img alt=\"Connections 4\" border=\"0\" height=\"349\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Connections-4_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"接続 4\" width=\"146\"></a></blockquote>\n\n<p><strong>[Save]</strong> をクリックします。</p>\n\n<h2>OMS Search API Runbook を作成する</h2>\n\n<p>前の <a href=\"https://azure.microsoft.com/blog/2015/07/21/leveraging-the-oms-search-api-in-an-azure-automation-runbook/\" target=\"_blank\">ブログ記事では、</a> ハニースポット アカウントの監視について説明しました。 同&rsquo;じシナリオを使用して、特定のサーバーで失敗したハニースポット アカウントログインをチェックする Runbook を作成します。今回は、インポートされた PowerShell モジュールを活用します。</p>\n\n<ul>\n <li>新しい Runbook を作成します。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Create-runbook.jpg\"><img alt=\"Create runbook\" border=\"0\" height=\"181\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Create-runbook_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"Runbook を作成する\" width=\"244\"></a></blockquote>\n\n<ul>\n <li>ここで、PowerShell ワークフローを使用して Runbook を作成します。</li>\n</ul>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/Create-runbook-2.jpg\"><img alt=\"Create runbook 2\" border=\"0\" height=\"138\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Create-runbook-2_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"Runbook の作成 2\" width=\"244\"></a> &nbsp;</blockquote>\n\n<p><strong>Our Runbook:</strong></p>\n\n<pre class=\"prettyprint\">\nworkflow Get-OMSsearchQuery\n{\n $Alert = $false\n \n #Get our Connection Objects\n       $OMSConnection = Get-AutomationConnection -Name &#39;OMSConnection&#39;\n $ADConnection = Get-AutomationConnection -Name &#39;ADConnection&#39;\n\n #Create our Token \n $UserName = $ADConnection.UserName + &quot;@&quot; + $ADConnection.AzureADDomain\n $ADConn = @{&quot;Username&quot;=$Username;&quot;AzureADDomain&quot;=$ADConnection.AzureADDomain;&quot;Password&quot;=$ADConnection.Password;&quot;APPIdURI&quot;=$ADConnection.AppIdURI;}\n $Token = Get-AzureADToken -Connection $ADConn\n \n #Use our OMSConnection object to retrieve our OMS information\n $WorkSpace = $OMSConnection.Workspace\n $SubID = $OMSConnection.SubscriptionID\n $Region = $OMSConnection.Region\n $APIVersion = $OMSConnection.APIVersion\n \n #Define our search query\n $Query = &#39;Type=SecurityEvent EventID=4625 Computer=WHDVM1&#39;\n Write-Output &quot;*** Executing query *** &quot; $Query\n\n #Get our OMS Search query results for our Honeypot Account\n $Results = Search-OMSWorkspace -Token $Token -Subscription $SubID -Workspace $Workspace -Region $Region -APIVersion &quot;2015-03-20&quot; -Query $Query\n #Uncomment the next line if you want to see all results returned\n #$Results\n $Accounts = $Results.TargetUserName\n \n #Check our Honeypot Account\n foreach ($Account in $Accounts)\n  {\n   if($Account -eq &quot;LocalAdmin&quot;)\n           {\n     $Alert = $true\n     $AccountName = $Account\n     }\n  } \n #We have a match\n if($Alert -eq $true)\n {\n  Write-Output &quot;Raising Alert! Logon attempt found for account: $AccountName&quot;\n }\n #We don&#39;t have a match\n else\n  {\n   Write-Output &quot;These are not the droids you are looking for!&quot;\n  }\n }</pre>\n\n<p>Runbook の実行時の出力:</p>\n\n<blockquote><a href=\"https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/08/10/runbook-output.jpg\"><img alt=\"runbook output\" border=\"0\" height=\"179\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/runbook-output_thumb.jpg\" style=\"border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"Runbook の出力\" width=\"244\"></a></blockquote>\n\n<p>&nbsp; 次の機会まで。 幸せな自動化!</p>"
