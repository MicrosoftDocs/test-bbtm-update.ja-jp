### YamlMime:Yaml
ms.openlocfilehash: 3190cc0bf866bbc33c8397e045d81343cff85806
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139896359"
Slug: using-azure-automation-to-take-actions-on-azure-alerts
Title: Azure Azure Automationを使用してアクションを実行する
Summary: Azure アラートに応答して Azure Automation Runbook を使用してアクションを開始する方法について説明します。
Content: "<p>このブログ記事の公開以降、追加情報がリリースされました。 詳細については、「アラートを使用&nbsp;<a href=\"https://docs.microsoft.com/azure/automation/automation-create-alert-triggered-runbook\" target=\"_blank\">して Runbook をトリガーする」をAzure Automationしてください</a>。</p>\n\n<p>このブログ記事では、Azure アラートに応答してアクションを開始Azure Automation Runbook を使用する方法について説明します。</p>\n\n<p>Webhook を使用すると、ユーザーは、後処理またはカスタム通知のために Azure アラート通知を他のシステムにルーティングできます。 Azure アラート通知の詳細については、ドキュメントを <a href=\"https://azure.microsoft.com/en-us/documentation/articles/insights-receive-alert-notifications/\">参照してください</a>。</p>\n\n<p>アラートが発生した場合に電子メール通知を受け取る以外に、何らかのアクションを実行する方法 (自動修復を実行するスクリプトの呼び出しなど) を行う方法を疑問に思いますか? その後、&rsquo;それ以上待つ必要がなくなりました。Azure Automation、Azure アラート ウィンドウ内に機能が提供されます。 これで、アラートが発生した場合に Webhook Azure Automation呼び出す Azure アラートを作成できます。</p>\n\n<p>たとえば、指定したメトリックの値が割り当てられたしきい値を超えると、アラート ルールがアクティブになり、Automation Runbook をトリガーしていくつかのアクションを実行できます。 Runbook は Automation Webhook を呼び出してトリガーされます。これにより、単一の HTTP 要求を介して Azure Automation で特定の Runbook を開始できます。 新しいAzure Automation? <a href=\"https://azure.microsoft.com/en-us/documentation/services/automation/\">こちら</a>をご覧ください。</p>\n\n<p>Azure アラートを使用して Automation Runbook を構成するための詳細な手順を次に示します。 シナリオ:&nbsp; 仮想マシン (VM) で読み取ったディスクが過去 1 時間で 1 分の 1 秒を超える場合は、電子メールで通知を受け取り、VM を再起動する必要があります (これは Automation Webhook を呼び出して行われます)。</p>\n\n<h2>詳細な手順: </h2>\n\n<ol>\n <li>\n <p>アラートのしきい値を設定<strong>する: Azure</strong> プレビュー ポータルで<strong></strong>、[参照] をクリックし、監視に関心がある VM リソース&#39;を選択し、アラート画面に条件 (メトリック: ディスク読み取り; 条件: より大きい; しきい値: 1 MB/過去 1 時間を超える) を追加します。<a href=\"https://portal.azure.com/\"></a></p>\n\n <p style=\"text-align: center;\"><img border=\"0\" height=\"480\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0a7fefdc-5879-45f9-aa12-17f93d76c6f7.jpeg\" width=\"152\"></p>\n </li>\n <li>\n <p><strong>Runbook を作成します。</strong> アラートに対応するためにAzure Automation Runbook を作成&nbsp; します。 Webhook データと VM コンテキストを取得してアクションを実行できるよう、サンプル Runbook (下記) について説明します。</p>\n </li>\n <li>\n <p><strong>Webhook を作成します。</strong> Azure プレビュー ポータルで Runbook にリンクされた新しい Webhook を作成します。 Webhook の URL をコピーします (Webhook を作成すると、url は Azure portal から表示されなくなるので、Webhook URL を追跡してください)。</p>\n\n <p style=\"text-align: center;\"><img border=\"0\" height=\"480\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/bbb9ca28-44b3-4d43-a5b5-987e78a5b89c.jpeg\" width=\"405\"></p>\n\n <p style=\"text-align: center;\"><img border=\"0\" height=\"480\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/84f9ee8a-2224-4454-a23f-e9577e2d5a0e.jpeg\" width=\"257\"></p>\n </li>\n <li>\n <p><strong>Webhook URL を使用してアラートのしきい値を更新します。</strong> 次に、監視とアラートを行う Azure 内の適切なリソースに移動し、[アラートの作成/更新] 画面で Webhook URL を追加できます</p>\n </li>\n <li>\n <p>アラート条件が満たされ、Runbook がトリガーされると、アラート コンテキストが Runbook に送信されます。&nbsp; ご覧のように、アラート コンテキストには subscriptionID、resourceGroupName、resourceName、resourceType、resourceId、timestamp などの詳細が含まれています。これは、Runbook が使用するリソースを識別するために必要です。 これは <strong>webhookData</strong> オブジェクトの一部として Runbook に渡され、 <strong>Webhook で使用できます。RequestBody プロパティ</strong>。 これを JSON オブジェクトに変換し、アラート コンテキストを抽出できます。 以下のサンプル出力画面を参照してください。</p>\n\n <div>\n <div>\n <div id=\"_com_1\" uage=\"JavaScript\">\n <p>[参照] をクリックし、ポータルで [Automation アカウント &ndash;&gt; Runbook] に移動して、Runbook ジョブの状態を確認し、必要に応じてトラブルシューティングを行います。</p>\n </div>\n </div>\n </div>\n </li>\n</ol>\n\n<p><strong>アラート コンテキストの例:</strong></p>\n\n<pre>\n{&quot;WebhookName&quot;:&quot;AzureAlertTest&quot;,&quot;RequestBody&quot;:&quot;{\\&quot;status\\&quot;:\\&quot;Resolved\\&quot;,\\&quot;context\\&quot;:{\\&quot;id\\&quot;:\\&quot;/subscriptions/&lt;subscriptionID&gt;/resourceGroups/Group/providers/microsoft.insights/alertrules/AlertVM\\&quot;,\\&quot;name\\&quot;:\\&quot;AlertVM\\&quot;,\\&quot;description\\&quot;:\\&quot;\\&quot;,\\&quot;condition\\&quot;:{\\&quot;metricName\\&quot;:\\&quot;Diskread\\&quot;,\\&quot;metricUnit\\&quot;:\\&quot;Count\\&quot;,\\&quot;metricValue\\&quot;:\\&quot;361.811648\\&quot;,\\&quot;threshold\\&quot;:\\&quot;1073741\\&quot;,\\&quot;windowSize\\&quot;:\\&quot;5\\&quot;,\\&quot;timeAggregation\\&quot;:\\&quot;Average\\&quot;,\\&quot;operator\\&quot;:\\&quot;GreaterThan\\&quot;},\\&quot;subscriptionId\\&quot;:\\&lt;subscriptionID&gt; \\&quot;,\\&quot;resourceGroupName\\&quot;:\\&quot;Group\\&quot;,\\&quot;timestamp\\&quot;:\\&quot;2015-09-22T22:51:19.4549592Z\\&quot;,\\&quot;resourceName\\&quot;:\\<strong>&quot;Testvm</strong>\\&quot;,\\&quot;resourceType\\&quot;:\\&quot;microsoft.classiccompute/virtualmachines\\&quot;,\\&quot;resourceId\\&quot;:\\&quot;/subscriptions/&lt;subscriptionID&gt;/resourceGroups/Group/providers/Microsoft.ClassicCompute/virtualMachines/<strong>TestVM</strong>\\&quot;,\\&quot;portalLink\\&quot;:\\&quot;\\&quot;},\\&quot;properties\\&quot;:{}}&quot;,&quot;RequestHeader&quot;:{&quot;Connection&quot;:&quot;Keep-Alive&quot;,&quot;Host&quot;:&quot;&lt;webhookURL&gt;&quot;}</pre>\n\n<p>Webhook データを取得し、コメントを含む VM を再起動するサンプル Runbook を次に示します。 Webhook を操作するように変更できる既存の Runbook のライブラリの Runbook ギャラリーにアクセスして、Azure アラートによって開始することもできます。</p>\n\n<p><strong>サンプル PS スクリプト Runbook</strong></p>\n\n<pre class=\"prettyprint\">\nparam ( \n    [object]$WebhookData\n)\n\nif ($WebhookData -ne $null) {  \n    # Collect properties of WebhookData.\n    $WebhookName    =   $WebhookData.WebhookName\n    $WebhookBody    =   $WebhookData.RequestBody\n    $WebhookHeaders =   $WebhookData.RequestHeader\n       \n    # Information on the webhook name that called This\n    Write-Output &quot;This runbook was started from webhook $WebhookName.&quot;\n       \n    # Obtain the WebhookBody containing the AlertContext\n    $WebhookBody = (ConvertFrom-Json -InputObject $WebhookBody)\n    Write-Output &quot;`nWEBHOOK BODY&quot;\n    Write-Output &quot;=============&quot;\n    Write-Output $WebhookBody\n       \n    # Obtain the AlertContext\n    $AlertContext = [object]$WebhookBody.context\n\n    # Some selected AlertContext information\n    Write-Output &quot;`nALERT CONTEXT DATA&quot;\n    Write-Output &quot;===================&quot;\n    Write-Output $AlertContext.name\n    Write-Output $AlertContext.subscriptionId\n    Write-Output $AlertContext.resourceGroupName\n    Write-Output $AlertContext.resourceName\n    Write-Output $AlertContext.resourceType\n    Write-Output $AlertContext.resourceId\n    Write-Output $AlertContext.timestamp\n      \n    # Act on the AlertContext data, for example, restart the VM.\n       \n    # Authenticate to your Azure subscription using OrganizationId to be able to restart that Virtual Machine. For authenticating to Azure using Azure Active Directory, please see the blog.\n    $cred = Get-AutomationPSCredential -Name &quot;&lt;AutomationCredentialAssetName&gt;&quot;\n    Add-AzureAccount -Credential $cred\n    Select-AzureSubscription -subscriptionName &quot;Visual Studio Ultimate with MSDN&quot;\n       \n    Restart-AzureVM -ServiceName $AlertContext.resourceName -Name $AlertContext.resourceName\n}\nelse \n{\n    Write-Error &quot;This runbook is meant to only be started from a webhook.&quot; \n}\n</pre>\n\n<p><br>\nRunbook が実行されると、alertcontext が Runbook の出力として表示されます。</p>\n\n<p><img src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1dd3738a-d12e-4ec9-a47c-5a177ba98139.png\"></p>\n\n<h2>Automation を使用する場合は、次の操作を行います。</h2>\n\n<p>表示するソリューション、追加する機能、または既存の機能に関するフィードバックはありますか。&nbsp;<a href=\"https://feedback.azure.com/forums/246290-azure-automation/suggestions/9551967-deploy-to-azure-automation-automation-account-nam\">UserVoice でAzure Automationします</a>。</p>\n\n<p>データの使用を開始Azure Automation?&nbsp; このサービスについては、こちらを <a href=\"https://azure.microsoft.com/en-us/services/automation/\">参照し</a>、 <a href=\"https://twitter.com/AzureAutomation\">Twitter Azure Automationを参照してください</a>。</p>\n\n<p>幸せな自動化!</p>"
