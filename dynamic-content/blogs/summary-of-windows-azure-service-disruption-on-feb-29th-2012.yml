### YamlMime:Yaml
ms.openlocfilehash: b81e0cd47bfd499c4f80891d774644b4e5e6805f
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139892045"
Slug: summary-of-windows-azure-service-disruption-on-feb-29th-2012
Title: 2012 年 2 Windows 29 日の Azure サービス中断の概要
Summary: 概要 3 月 1 日の投稿のフォローアップとして、2 月 29 日のサービス中断の根本原因分析の結果を共有したいと思います。 &nbsp;お客様の多くがそうだったとわかっています。
Content: '<h3>はじめに</h3>  <p>3 月 1 日の投稿のフォローアップとして、2 月 29 日のサービス中断の根本原因分析の結果を共有したいと思います。 &nbsp;多くのお客様がこのイベントの影響を受けたことを知っています。また、発生した問題、見つかった問題、これらの問題への対処方法、今後同様の発生を防ぐためにインシデントからどのように学習しているのかについて、透過的に知りたがっています。 &nbsp;&nbsp;</p>  <p>ここでも、このインシデントが発生した中断、ダウンタイム、不便をおかけして申し訳ございません。&nbsp;以下で説明したように、影響を受け取ったお客様に対してサービス クレジットを事前に発行します。&nbsp;学習を使用して Azure のパフォーマンスを向上させるために、既にWindows安心してください。&nbsp;</p>  <h3>Azure とWindows中断の概要</h3>  <p>Windows Azure は、コンピューティング、Storage、ネットワーク、Service Bus や SQL Azure などの上位レベルのサービスなど、さまざまなサービスで構成SQL Azure。&nbsp;この部分的なサービス停止は、Windows Azure Compute および依存サービス (Access Control Service (ACS)、Windows Azure Service Bus、SQL Azure Portal、データ同期 Services&nbsp; に影響を与えました。これは、パフォーマンスやWindows Azure Storageに影響SQL Azure。</p>  <p>このインシデントのトリガーは特定のソフトウェア のバグですが、Windows Azure は多くのコンポーネントで構成され、この中断を複雑にした通常の操作との他の相互作用が発生しました。 このインシデントには 2 つのフェーズがあります。 最初のフェーズは、最初のソフトウェア バグの検出、対応、修正に重点を置いて行いました。&nbsp;2 番目のフェーズでは、進行中の通常のサービス操作との意図しないやり取りが原因で影響を受け、影響を受けした一部のクラスターに焦点を当てていました。&nbsp;問題の技術的な詳細を理解するには、Azure コンポーネントの一部の低レベルの機能に関する背景Windows必要があります。</p>  <h3>ファブリック コントローラー、エージェント、証明書</h3>  <p>Azure Windowsクラウド アプリケーションは、Microsoft データセンターの物理サーバーで実行されている仮想マシンで構成されます。 &ldquo;&rdquo;図 1 に示すように、サーバーは約 1000 のクラスターにグループ化され、それぞれ、ファブリック コントローラー (FC) と呼ばれるスケールアウトされた冗長プラットフォーム ソフトウェア コンポーネントによって個別に管理されます。 各 FC は、クラスターで実行されているアプリケーションのライフサイクルを管理し、その制御下にあるハードウェアの正常性をプロビジョニングおよび監視します。 サーバーに障害が発生したと判断した場合に正常なサーバーに仮想マシン インスタンスを再生するなどの自律操作と、アプリケーションのデプロイ、更新、スケールアウトなどのアプリケーション管理操作の両方を実行します。 データセンターをクラスターに分割すると、FC レベルで障害が分離され、特定のクラスのエラーが発生したクラスター以外のサーバーに影響を与えるのを防ぐ。</p>  <p align="center"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2045.Outage1.png" alt="" border="0"></p>  <p align="center"><em>図 1。クラスターとファブリック コントローラー</em></p>  <p>Windows Azures&rsquo; Platform as a Service (PaaS) 機能の一部では、図 2 に示すように、VM によって使用される OS イメージにデプロイされるゲスト エージェント (GA)&rdquo; &ldquo;を使用して VM で実行されるアプリケーションとの緊密な統合が必要です。 &ldquo;&rdquo; 各サーバーにはホスト エージェント (HA) があります。このホスト エージェントは、アプリケーション シークレット (アプリケーションが HTTPS エンドポイントをセキュリティ保護するためにパッケージに含まれる SSL 証明書など) をデプロイするために利用します。また、VM &ldquo;&rdquo; が正常かどうか、FC が回復アクションを実行する必要があるかどうかが GA で判断されます。</p>  <p align="center"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7824.Outage2.png" alt="" border="0"></p>  <p align="center"><em>図 2。ホスト エージェントとゲスト エージェントの初期化</em></p>  <p>証明書のようなアプリケーション シークレットは、物理ネットワークまたは論理ネットワーク経由で送信するときに常に暗号化されます。そのため、GA &ldquo;&rdquo; は初期化時に転送証明書を作成します。 HA との接続のセットアップ中に GA が実行する最初の手順は、HA に転送証明書の公開キー バージョンを渡す手順です。 その後、HA はシークレットを暗号化できます。また、GA だけが秘密キーを持つため、ターゲット VM 内の GA だけがそれらのシークレットを復号化できます。</p>  <p>新しい転送証明書の生成が必要なケースがいくつかあります。 ほとんどの場合&rsquo;、新しい VM が作成された場合にのみ発生します。これは、ユーザーが新しいデプロイを起動した場合、デプロイがスケールアウトされた場合、またはデプロイが VM オペレーティング システムを更新するときに発生します。 4 つ目のケースは、FC が別のサーバーに対して不健康と見なされたサーバーで実行されている VM &ldquo;を FC が生まれ変えた場合です。これは、プラットフォームがサービスの回復を呼び出すプロセスです。&rdquo;</p>  <h3>Leap Day バグ</h3>  <p>GA が転送証明書を作成すると、1 年間の有効期間が提供されます。 現在の日付の午前 0 時を有効な日付<i></i>として使用し、その日付から有効な日付まで 1 <i>年間を使用</i>します。 うるう日のバグは、GA が現在の<i></i>日付を取得し、その年に 1 つを追加するだけで、有効な日付を計算したというバグです。 つまり、閏日に転送証明書を作成しようとした GA では、2013 <i></i> 年 2 月 29 日の有効な日付が設定されました。これは、証明書の作成が失敗する原因となる無効な日付です。</p>  <p>前述のように、証明書の転送は GA 初期化の最初の手順であり、HA に接続する前に必要です。 GA が証明書の作成に失敗すると、その証明書は終了します。 HA には、GA から聞き取る 25 分のタイムアウトがあります。 GA がタイムアウト内&rsquo;に接続しない場合、HA は VM&rsquo; の OS を再初期化して再起動します。</p>  <p>クリーンな VM (顧客コードが実行されていない VM) が GA 接続を 3 回連続してアウトした場合、GA はエラーを報告するため、ハードウェアの問題が原因である必要があるという判断を HA が行います。 その後、HA はサーバーに障害が発生したと FC に報告し、FC はそれを Human Investigate (HI) という状態に移動します。 HI 状態のサーバーに対する標準的な自律障害復旧操作の一環として、FC は、障害が発生したサーバーに割り当てられた VM を他のサーバーに再生することで、その VM を復旧します。 このような場合、VM が使用可能なサーバーに移動すると、GA の初期化中にうるう日のバグが再現され、HI に移行するサーバーのカスケードが発生します。</p>  <p>カスケードされたソフトウェアのバグがクラスター全体の停止を引き起こすのを防ぐために、FC には HI しきい値があります。このしきい値に達すると、基本的にクラスター全体が同様の HI 状態に移動されます。 その時点で、FC は内部的に開始されたソフトウェア更新プログラムをすべて停止し、サービスの自動修復は無効になります。 この状態は低下しながら、オペレーターが問題をさらに進行させる前に制御して修復する機会を与えます。</p>  <h3>Leap Day バグの動作</h3>  <p>新しい VM の GAs が証明書を生成しようとした 2 月 <sup>28 日</sup> (2 月 <sup>29 日</sup> 00:00 UST) 午後 4 時 (PST) に、うるう日のバグがすぐにトリガーされました。 Storage GA&rsquo; で実行されないので、クラスターは影響を受けでしたが、通常のアプリケーションのデプロイ、スケールアウト、サービスの回復によって新しい VM が作成されます。 同時に、多くのクラスターも、FC、HA、GA の新しいバージョンのロールアウトの最中でした。 これにより、これらのクラスターでバグが直ちにヒットし、サーバーの HI しきい値が午後 5 時 15 分 (PST の午後 5 時 15 分) に正確に 75 分 (3 回 25 分のタイムアウト) に達しました。 このバグは、更新されていないクラスターを通じてより遅く動作しましたが、更新クラスターに対する重大なアラームによって更新が自動的に停止され、運用スタッフに問題が警告されました。 さらに、その原因を調査し、午後 6 時 38 分 (PST) に開発者がバグを特定した、通話時の FC 開発者に通知しました。</p>  <p>この時点では、一部のアプリケーションは単一の VM をオフラインにし、一部のアプリケーションは複数の VM をオフラインにしましたが、複数の VM を持つほとんどのアプリケーションは、容量が少ない場合でも可用性を維持しました。 お客様が誤って実行中のアプリケーションにさらなる影響を及ぼすことを防ぐために、アプリケーションのスケールアウトに失敗し、新しいアプリケーションをデプロイしようとして、サービス管理機能を世界中のすべてのクラスターで午後 6 時 55 分 (PST&nbsp; ) に無効にしました。この手順を実行した&rsquo;のは初めてです。&nbsp; サービス管理を使用すると、お客様&rsquo;はアプリケーションをデプロイ、更新、停止、スケーリングできますが、既にデプロイされているアプリケーションの継続的な操作には必要ありません。 ただし、サービス管理を停止すると、お客様は現在デプロイされているアプリケーションを変更または更新できます。&nbsp;</p>  <p>更新された GA について、午後 10 時 (PST) までにテストとロールアウトの計画を作成し、更新された GA コードを午後 11 時 20 分 (PST) に準備し、2 月 <sup>29 日</sup>午前 1 時 50 分 (PST) にテスト クラスターでテストを完了しました。 並行して、いくつかの独自のアプリケーションの VM 上の実稼働クラスターで修正プログラムを正常にテストしました。 次に、1 つの実稼働クラスターへの GA のロールアウトを開始し、午前 2 時 11 分 (PST) に正常に完了しました。その時点で、修正プログラムをすべてのクラスターにプッシュしました。 クラスターが更新された後、クラスターのサービス管理機能が復元され、午前 5 時 23 分 (PST) に、サービス管理が大部分のクラスターに復元されたと発表しました。</p>  <h3>セカンダリ障害</h3>  <p>サービス管理が無効にされた場合、ほとんどのクラスターは、最新の FC、GA、HA バージョンを既に実行していたか、ロールアウトでほぼ完了しています。 これらのクラスターは完全に修復されました。 ただし、7 つのクラスターは、バグが影響を受けたときにロールアウトを開始したばかりでした。 ほとんどのサーバーには古い HA/GA の組み合わせが含まれています。一部のサーバーには新しい組み合わせがありました。その両方に、次に示すように GA Leap Day のバグが含まれています。</p>  <p align="center"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7416.Outage3.png" alt="" border="0"></p>  <p align="center"><em>図 3。HA と GA の異なるバージョンを実行しているサーバー</em></p>  <p>部分的に更新された状態だった 7 つのクラスターを修復するために、別のアプローチを採用しました。&nbsp; 以前のバージョンの FC HA に復元しましたが、固定 GA で新しい GA を使用して新しい HA に更新する代わりに、一定の GA を使用して復元しました。 最初に行った手順は、以前に新しい HA に更新されたサーバーに古い HA を置いて、古い GA とのバージョンの互換性を維持することで、ソリューションをテストすることでした。 サーバー上の VM は正常に起動し、正常に見えました。</p>  <p>HA と GA の更新プログラムをクラスターに適用する通常の状況では、更新ドメイン (UD) と呼ばれるデプロイの可用性の制約を受け入れるので、更新には数時間かかります。 標準のデプロイ機能を使用して古い HA をプッシュする代わりに、すべてのサーバーの HA &ldquo;&rdquo; を同時に古いバージョンに同時に更新する、更新プログラムを選択するテストに十分な自信を持っています。</p>  <p>残念ながら、修正プログラムをデプロイすることを強く望む中で、古い HA で作成した更新プログラム パッケージに、新しい HA 用に記述されたネットワーク プラグインが含まれており、2 つは互換性がないという事実を見落としました。 ネットワーク プラグインは VM 仮想ネットワークの&rsquo;構成を担当し、その機能を持たなくても、VM にはネットワーク機能はありません。 単一サーバーのテストには、サーバー上の VM へのネットワーク接続のテストが含まれていず、機能していけでした。 図 4 は、互換性のない組み合わせを示しています。</p>  <p style="text-align: center;"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2133.Outage4.png" alt="" border="0"></p>  <p align="center"><em>図 4。HA と HA ネットワーク プラグインの互換性のない組み合わせを実行しているサーバー</em></p>  <p>29 <sup>日</sup>の午前 2 時 47 分 (PST) に、これらの 7 つのクラスターとすべての VM (以前は正常だったものも含む) にコンポーネントの互換性のない組み合わせをプッシュし、ネットワークから切断されました。 Access Control Service (ACS) や Windows Azure Service Bus デプロイなどの主要なサービスがそれらのクラスターに含っていたため、それらを使用しているアプリケーションは、依存しているサービスが失われるため、影響を受ける可能性がありました。</p>  <p>修正された HA パッケージを迅速に生成し、午前 3 時 40 分 (PST) に再びテストしました。今回は、VM の接続と VM の正常性のその他の側面を確認します。 これら 7 つのクラスターへの影響を考えると、PST の午前 5 時 40 分から修正を開始することを選択しました。 クラスターは、主に午前 8 時 (PST) に再び動作しましたが、さまざまな移行の結果、多数のサーバーが破損状態でした。 開発者と運用スタッフは、残りの日を通して、これらのサーバーを手動で復元および検証するために、多大な作業を行いました。 クラスターとサービスがオンラインに戻されたので、ダッシュボードに更新プログラムを提供し、3 <sup>月 1 日</sup>の午前 2 時 15 分 (PST) に Windows のすべての Azure サービスが正常だったという最新のインシデント更新を Windows Azure ダッシュボードに投稿しました。</p>  <h3>サービスの改善</h3>  <p>インシデントが発生した後は、時間を取ってインシデントを分析し、エンジニアリング、運用、コミュニケーションを改善する方法を分析します。&nbsp; 可能な限り学習するために、根本原因分析を行いますが、インシデントのすべての側面の分析も行います。&nbsp; クラウド コンピューティングの 3 つの真相は、ハードウェアの障害、ソフトウェアのバグ、ユーザーの間違いです。&nbsp; 私たちの仕事は、お客様に堅牢なサービスを提供するために、これらすべての予測不可能な問題を軽減することでした。&nbsp; これらの問題を理解し、対処することで、お客様に提供するサービスを引き続き改善していきます。</p>  <p>分析は 4 つの主要な領域に分かれ、インシデント ライフサイクルの各部分と、その前のエンジニアリング プロセスを確認します。</p>  <ul>  <li><b>防止</b> &ndash; システムが障害を回避、分離、または復旧する方法</li>  <li><b>検出</b> &ndash; 障害を迅速に表面化し、復旧に優先順位を付ける方法</li>  <li><b>応答</b> &ndash; インシデント中に顧客をサポートする方法</li>  <li><b>回復</b> &ndash; 復旧時間を短縮し、お客様に与える影響を軽減する方法</li>  </ul>  <h4>防止</h4>  <ul>  <li><b>テスト。</b>&nbsp; 初期停止の根本原因は、日付/時刻値の不正な操作によるソフトウェアのバグでした。&nbsp; 時間関連のバグを検出するためのテストを改善する手順を実行しています。&nbsp; また、コード分析ツールを強化して、このクラスと同様のコーディングの問題を検出し、コード ベースを既に確認しています。</li>  <li><b>障害の分離。</b>&nbsp; ゲスト エージェント (GA) のバグが原因で操作が失敗した場合、ファブリック コントローラーはノードを Human Investigate (HI) 状態に移動しました。&nbsp; GA ではなくハードウェアに障害が発生したと誤って想定しました。&nbsp; これらの障害を区別し、システムにさらに伝達する前にそれらを分離するための手順を実行しています。</li>  <li><b>グレースフルな低下。</b> &nbsp;このインシデント中に既&rsquo; に実行されているサービスを保護するために、サービス管理をオフにする手順を取り上えましたが、これにより、サービスの継続的な管理も妨がっています。&nbsp; サービスのさまざまな側面を無効にしながら、他の要素を維持して表示できるよう、細かい粒度制御を行う手順を取っています。</li>  </ul>  <h4>検出</h4>  <ul>  <li><b>[Fail Fast]を選択します。</b>&nbsp; GA エラーは、長いタイムアウトの 75 分後まで表示されません。&nbsp; このような場合にエラーを迅速に発生し、これらのエラーにアラートを出し、復旧を開始するために、エラーをよりよく分類するための手順を実行しています。</li>  </ul>  <h4>Response</h4>  <ul>  <li><b>サービス ダッシュボード</b>。&nbsp;Azure Windowsは、個々のサービスの正常性を顧客に伝える主要なメカニズムです。&nbsp;&rsquo;&rsquo;ただし、サービス ダッシュボードでは断続的な可用性の問題が発生し、状況全体の概要は提供されません。また、お客様が必要と期待する詳細と透明性の細分性は提供されませんでした。&nbsp;&nbsp;  <ul>  <li><b>断続的な</b>可用性:&nbsp; このダッシュボードは、Azure と Windows Microsoft.com の 2 つの異なる内部インフラストラクチャで実行され、いずれかのシステムの致命的な障害に対処します。&nbsp;また、地理的な特定のインシデントに対処するために geo レプリケートされます。&nbsp;ただし、非常にボリュームが大きかったり、フェールオーバー/負荷分散が行っていたりして、ダッシュボードで断続的な可用性の問題が発生しました。&nbsp;&nbsp;&nbsp;これを修正し、将来より堅牢なサービスを確保するための手順を実行しました。</li>  <li><b>状況の概要</b>: サービス ダッシュボードには、サブリージョン レベルの 60 を超える個々のサービスの正常性状態に関する情報が表示されます。&nbsp; これは個々のサービスの状態を理解する上で重要ですが、概要情報がない場合、お客様は状況を包括的に理解するのが困難でした。&nbsp; お客様は、停止の範囲と重大度を包括的に把握するために、ダッシュボードの概要ビューを求めがありました。&nbsp; この変更を行う手順を実行しています。</li>  <li><b>詳細と透明性</b>: 更新プログラムは 1 時間ごとに投稿されます。ただし、状態の更新は、多くの場合、過去数時間で提供された一般的な情報または繰り返しの情報でした。&nbsp; お客様は、問題を解決するために発生している特定の作業に関する詳細と新しい情報を提供する必要があります。&nbsp; 障害の解決に&rsquo;必要な手順の詳細と透明性、および進行中の進行状況と設定戻しに関する詳細を提供する取り組みです。</li>  </ul>  </li>  <li><b>カスタマー サポート。&nbsp;</b>このインシデントでは、予想よりも長い待機時間を導く非常に高い呼び出し量がありました。&nbsp;&nbsp;サービス ダッシュボードの断続的な可用性と、他の通信チャネルを介した更新の欠如が呼び出し量の増加に寄与した場合に、高い呼び出し量を処理するスタッフがいます。&nbsp;カスタマー サポートスタッフのニーズを再評価し、より広範なチャネルセットを通じてより透過的なコミュニケーションを提供するための手順を実行しています。</li>  <li><b>その他の通信チャネル</b>。&nbsp; 多くのお客様から、インシデントが発生した場合に、ブログ、Facebook ページ、Twitter ハンドルを使用してコミュニケーションを取る方法について、より適切に使用を求めるメッセージが表示されています。&nbsp; また、インシデントの後の数日間で、電子メールを通じて公式の通信を提供する必要があります。&nbsp; コミュニケーション全体を改善し、これらの車両を通じてより積極的な情報を提供するための手順を実行しています。&nbsp; また、お客様に対してより詳細なツールを提供し、特定のサービスに関する問題を診断するためのサポートを提供する手順も実行しています。</li>  </ul>  <h4>Recovery</h4>  <ul>  <li><b>内部ツール。&nbsp;</b>このインシデントに対処するために、内部ツールの一部を開発および変更しました。&nbsp;復旧を高速化し、中間状態からの復旧をより予測可能にするのに役立つツールに引き続き投資します。&nbsp;</li>  <li><b>依存関係の優先順位。</b>&nbsp;また、ACS や Windows Azure Service Bus などのすべての Windows Azure インフラストラクチャ サービスが、お客様への影響を軽減するために復旧するように、依存関係が復旧に組み込むプロセスも調査しています。&nbsp;</li>  <li><b>可視 性。</b>&nbsp; 復旧手順をより詳細に可視化し、進行中の中間の進行状況を顧客に可視化する方法を探しています。</li>  </ul>  <h4>サービス クレジット</h4>  <p>Microsoft は、この停止が多くのお客様に大きな影響を与えたと認識しています。 サービスの品質とサービスの品質 (SLA) のサービス レベル アグリーメントし、引き続きお客様にコミットしています。&nbsp;このイベントの特別な性質により、サービスが影響を受けたかどうかに関係なく、これらのサービスの影響を受ける請求月全体に対して、Windows Azure Compute、Access Control、Service Bus、および Caching&nbsp; のすべての顧客に 33% のクレジットを提供することを決定しました。これらのクレジットは事前に適用され、影響を受ける請求期間の後の請求期間に反映されます。&nbsp;その他の質問がある場合は、サポートにお<a target="_blank" href="https://azure.microsoft.com/support/?WT.mc_id=cmp_pst001_blg_post0072">問い</a>合わせください。</p>  <h3>まとめ</h3>  <p>上記のすべての問題を完全に理解するために時間を費やし続け、今後数日から数週間の間、サービスを改善するための問題に対処して軽減するための手順を実行します。&nbsp;お客様がサービスに対して Azure Windowsに依存し、お客様との SLA を非常に真面目に受け取っています。&nbsp;インシデントが発生した場合は、引き続きお客様と透明性を持ち続け、この学習を使用してエンジニアリング、運用、コミュニケーション、カスタマー サポートを進め、お客様にサービスを改善します。</p>  <p>よろしくお願い申し上げます。</p>  <p>Bill Laing と Windows Azure チーム</p>'
