### YamlMime:Yaml
ms.openlocfilehash: 09304747996afaa019aa471c591ce3fa0fa4ac2f
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139910823"
Slug: detecting-in-memory-attacks-with-sysmon-and-azure-security-center
Title: Sysmon とメモリ内のメモリ内攻撃を検出Azure Security Center
Summary: インメモリ攻撃が増加し、注目を集めています。 この投稿では、2 つのメモリ内攻撃手法について説明し、Sysmon と Azure Security Center を使用してこれらを検出する方法を示します。
Content: >-
  <p>インメモリ攻撃は増加し、注目を集めています。たとえば、これらの投稿では<a href="https://www.scmagazineuk.com/sentinelone-in-memory-attacks-loom-large-leave-little-trace/article/652960/" target="_blank">、SentinelOne: メモリ</a>攻撃が大きくなり、トレースが少ないままにし、メモリ内で<a href="https://www.endgame.com/blog/technical-blog/hunting-memory" target="_blank"></a>ハンティングを行い、メモリ内<a href="https://www.endgame.com/blog/technical-blog/hunting-memory-net-attacks" target="_blank">の .NET</a> 攻撃をハンティングします。</p>


  <p>&ndash;これらの攻撃では、攻撃者は、多くのマルウェア感染で見つかった従来のトロイの木馬や人工的なマルウェアに共通するファイルをディスクに書き込むのではなく、完全にメモリ内で悪意のあるアクティビティを実行します。 「ソフトウェアをインストールせずに&quot;&quot;ハッカーがシステムを侵害する方法」というタイトルの CSO の記事<a href="https://www.csoonline.com/article/3227046/malware/what-is-a-fileless-attack-how-hackers-invade-systems-without-installing-software.html" target="_blank">では、優</a>れた概要が提供されます。</p>


  <p>メモリ内攻撃では、多くの場合、標準的なオペレーティング システムのイベント ログの多くでフットプリントがほとんどまたは何も残さないので、検出は困難な場合があります。 多くのウイルス &ndash; 対策ソリューションは、ある程度のメモリ内保護をサポートしますが、多くの場合、ディスク上の悪意のあるファイルの脅威を検出する場合に最も効果的であり、メモリ内のシナリオでは何もありません。</p>


  <p>この投稿では、2 つのメモリ内攻撃手法について説明し、Sysmon と Azure Security Center を使用してこれらを検出する方法を示します。</p>


  <h2>攻撃</h2>


  <p>この例の攻撃者の戦略は次のとおりです。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7c8dbbe6-55a1-4620-8537-3d6a39302a75.png"><img alt="the-attack" border="0" height="186" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c942b6b6-3c40-4e82-9315-3f97824e201d.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="攻撃この攻撃" width="640"></a>チェーンの最初の 2 つのステージには、メモリ内の手法が含まれる:</p>


  <h3>最初の侵害プロセス &ndash; の挿入</h3>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/88821d14-7270-4316-b67c-bdf1013fe955.png"><img alt="office" border="0" height="433" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/40cd871f-93ad-4bca-bf3f-de76613cb080.png" style="margin: 0px auto; border: 0px currentcolor; border-image: none; float: none; display: block; background-image: none;" title="オフィス" width="539"></a></p>


  <p>このユーザーは、電子メールで配信された Microsoft Office Word ドキュメントでマクロを有効にしています。</p>


  <p>#Hancitor は、マクロを &ndash; 使用してアプリケーションに挿入する脅威のverclsid.exe。 悪意のあるコードはプロセス領域に直接コピーverclsid.exeディスクに触れる必要はありません。 このverclsid.exeは信頼Windowsプロセスなので、そのアクティビティが侵入検出製品によってブロックされる可能性は低い。</p>


  <h3>将来の検出プロセスの干渉を &ndash; 回避する</h3>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/efac326f-06b2-4073-9bba-e1b7a7a16caa.png"><img alt="Phantom" border="0" height="407" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/65a3cbbb-4127-4416-9b35-908648860282.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="ファントム" width="568"></a></p>


  <p>攻撃者は、犠牲になったマシンに足がかりを得た後、将来の検出の可能性を制限する手順を迅速に実行します。</p>


  <p><code><a href="https://artofpwn.com/phant0m-killing-windows-event-log.html" target="_blank">Invoke-Phant0m</a></code>では、API 呼び出Windowsプロセス間呼び出しを使用して、イベント ログ サービスに関連付Windowsスレッドを検索して終了します。 サービスは引き続き実行されている状態 &ndash; ですが、イベント ログにイベントを書き込む予定はありません。</p>


  <p>攻撃者は、そのアクティビティのほとんどがログに記録され続けないという知識を得て、他のアクションを自由に&rsquo;実行できます。</p>


  <h2>Sysmon を使用してメモリ内攻撃を検出し、Azure Security Center</h2>


  <p>アプリケーションで Sysmon イベントを収集して分析Security Center、上記のような攻撃を検出できます。 これらの検出を有効にするには、次の手順を実行する必要があります。</p>


  <ol>
   <li>クラウドとオンプレミスのマシンに Sysmon をインストールする</li>
   <li>Log Analytics ワークスペースで Sysmon イベント データを収集する</li>
   <li>
   <div align="left">疑わしい Sysmon イベントを検出Security Centerカスタム アラートを定義する</div>
   </li>
  </ol>


  <h3>Sysmon のインストールと構成</h3>


  <p>説明した攻撃手法はどちらも、1 つのプロセスが別のプロセス メモリにアクセスする必要&rsquo; があります。 この基本的な操作は、通常の OS 操作の一部として常に行いますが、メモリが変更されるターゲット プロセス (verclsid.exe および svchost.exe) と同様に、ここで関係するアクセスの種類は通常とは異なる (より一般的な読み取り特権ではなく、書き込み特権) です。</p>


  <p>Sysmon では、このようなプロセス アクセスを高度に構成可能な方法でログに記録できます。 ドキュメントからダウンロードしてインストール <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon" target="_blank">できます</a>。 Sysmon 構成は、ログ記録のレベルとボリュームを決定する重要な構成です。</p>


  <p>必要な &ndash; 正確な構成は、実際には Sysmon の根拠の一部として、お客様が OS の既定値を超える非常に細かいレベルのログ記録を柔軟に選択できる必要があります。 推奨される既定の Sysmon &ndash; <a href="https://twitter.com/SwiftOnSecurity" target="_blank">@SwiftOnSecurity</a> 構成を含むオンライン リソースが、次の例<a href="https://github.com/SwiftOnSecurity/sysmon-config" target="_blank">に示GitHub</a>。</p>


  <p>次の構成では、特定のプロセスへの特権レベルのメモリ アクセスのみをログに記録します。 通常、これは非常に少ないボリュームで、Sysmon イベントは攻撃者のアクティビティが発生した場合にのみログに記録されます。</p>


  <pre style="margin-left: 0.5in;">

  exampleSysmonConfig.xml:

  &lt;Sysmon schemaversion=&quot;3.30&quot;&gt;

  &lt;EventFiltering&gt;
    &lt;!-- Restrict logging to access targeting svchost.exe and verclsid.exe --&gt;
    &lt;ProcessAccess onmatch=&quot;exclude&quot;&gt;
      &lt;TargetImage condition=&quot;excludes&quot;&gt;verclsid.exe&lt;/TargetImage&gt;
      &lt;TargetImage condition=&quot;excludes&quot;&gt;svchost.exe&lt;/TargetImage&gt;
    &lt;/ProcessAccess&gt;
    &lt;!-- Process access requests with suspect privileged access,
         or call trace indicative of unknown modules --&gt;
       &lt;ProcessAccess onmatch=&quot;include&quot;&gt;
           &lt;GrantedAccess condition=&quot;is&quot;&gt;0x1F0FFF&lt;/GrantedAccess&gt;
           &lt;GrantedAccess condition=&quot;is&quot;&gt;0x1F1FFF&lt;/GrantedAccess&gt;
           &lt;GrantedAccess condition=&quot;is&quot;&gt;0x1F2FFF&lt;/GrantedAccess&gt;
           &lt;GrantedAccess condition=&quot;is&quot;&gt;0x1F3FFF&lt;/GrantedAccess&gt;
               ...
           &lt;GrantedAccess condition=&quot;is&quot;&gt;0x1FFFFF&lt;/GrantedAccess&gt;
           &lt;CallTrace condition=&quot;contains&quot;&gt;unknown&lt;/CallTrace&gt;
       &lt;/ProcessAccess&gt;
  &lt;/EventFiltering&gt;

  &lt;/Sysmon&gt;</pre>


  <p>その後、インストールは次の方法で実行されます。</p>


  <p><code>sysmon.exe -i exampleSysmonConfig.xml</code></p>


  <p>または: <code>sysmon64.exe -i exampleSysmonConfig.xml</code> (64 ビット バージョンの場合)</p>


  <p>上記の攻撃が実行されると、Sysmon は次のような種類の &lsquo;ProcessAccess イベントをログに&rsquo; 記録します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/795bfbb1-559a-4c2d-8178-e42c33f3a04a.png"><img alt="information" border="0" height="32" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/85584508-356a-4505-9506-2be56e1e8d3c.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="情報" width="640"></a></p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7cacd7c8-cb54-4ad5-8cf0-77c2f1ba3257.png"><img alt="sysmon" border="0" height="269" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a5b0a193-08b8-42cd-9681-d4758b41cb26.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="sysmon" width="640"></a></p>


  <h3>Sysmon イベント データの収集を有効にする</h3>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/37c27580-6025-4598-9458-b6b1220d9a51.jpg"><img alt="Log Analytics" border="0" height="480" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5551b135-60a8-484d-887d-9f75a18e27c0.jpg" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="Log Analytics" width="604"></a></p>


  <p><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-enable-data-collection" target="_blank">Azure Security Center特定のイベント セットを収集して脅威を監視します</a>。 Sysmon &ndash; イベントなどの追加&ndash;のデータ ソースのコレクションは、Azure portal から構成できます。Log Analytics ワークスペースを開き、[詳細] を選択設定。</p>


  <p><a href="https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-data-sources" target="_blank">ログ分析のデータ ソースでは、</a> 分析のために多くの種類のデータをインポートする方法の詳細が提供されます。 イベント データをWindows場合は、次に示すように、イベント ログへのパスを指定します。 Sysmon イベント コレクションの場合は、次の項目を追加します。</p>


  <p><code>Microsoft-Windows-Sysmon/Operational:</code></p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e743f254-0ae7-4203-89fb-e33425b908f9.png"><img alt="advanced-settings" border="0" height="131" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/cc977dc5-dd55-473d-8c29-203aa6ed58c3.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="詳細設定" width="640"></a></p>


  <p>このMicrosoft Monitoring Agent、このワークスペースに接続されているすべてのマシンの Sysmon イベントが収集されます。 このデータに基づいてアラートを設定する必要があります。</p>


  <h3>カスタム アラートを定義する Azure Security Center</h3>


  <h3><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/519c177b-54cc-4728-a4e3-e0c79f68035d.jpg"><img alt="Create custom alert rule" border="0" height="463" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/296c893e-a35a-449a-9a04-e52ae566b87a.jpg" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="カスタム アラート ルールを作成する" width="532"></a></h3>


  <p>上記の Sysmon 構成の例では、ログに記録されるイベントは非常に悪意のあるイベントのみです。 そのため、収集された ProcessAccess イベントに対してアラートを生成できます。</p>


  <p>Security Center で Azure portal を開き、[Customer Alerts and New Custom Alert Rule]を選択し、アラートの詳細を指定して、種類 10 の Sysmon イベントに対して次のクエリを使用します。</p>


  <p><code>search &quot;Microsoft-Windows-Sysmon/Operational&quot; | where EventID==10</code></p>


  <h3>[アラートの表示] Security Center</h3>


  <p>最初のセクションからの攻撃が検出され、結果のアラートが他の組み込みアラートとAzure Security Centerで発生します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/efd8ef7e-bfaa-402d-81b2-4b019c89419d.png"><img alt="alerts-security-center" border="0" height="82" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/45cf5cb0-0e63-469c-b8ff-bddec9d181d0.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="alerts-security-center" width="640"></a></p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/54602099-c93e-45e0-b8f3-dc16890dc477.png"><img alt="suspect-process" border="0" height="248" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e0c0aaf6-cb95-4ffe-8612-4305b9e8a14f.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="suspect-process" width="640"></a></p>


  <h3>より詳細 &ndash; なアラート クエリを改良する</h3>


  <p>収集されるイベントすべてについて警告するのではなく、Sysmon イベントの特定の条件に基づいてアラートを作成できます。 これは、カスタム フィールドを作成し <a href="https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-custom-fields" target="_blank">、</a> これらのフィールドのクエリに基づいてアラート ルールを定義することで実現できます。</p>


  <h2>まとめ</h2>


  <p>この投稿では、Sysmon を使用して複数のメモリ内攻撃を検出する方法について説明し、Azure 仮想マシンとオンプレミス のマシンのかどうかに関して、このデータに基づくアラートを Azure Security Center &ndash; に配置して表示する方法を示しました。</p>


  <p>幸せなハンティング!</p>


  <h2>関連項目</h2>


  <ul>
   <li><a href="https://artofpwn.com/phant0m-killing-windows-event-log.html" target="_blank">Phant0m: イベント ログWindowsを削除する</a> &ndash;2017 年 5 月 6 日</li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-enable-data-collection" target="_blank">Azure Security Center</a> でのデータ収集 -&nbsp;Microsoft Azureドキュメント、2017 年 9 月 11 日</li>
   <li><a href="https://docs.microsoft.com/en-us/azure/log-analytics/log-analytics-data-sources" target="_blank">ログ分析のデータ ソース</a> &ndash;Microsoft Azureドキュメント、2017 年 5 月 23 日</li>
   <li><a href="https://docs.microsoft.com/en-us/azure/security-center/security-center-custom-alert" target="_blank">Azure Security Center (プレビュー) のカスタム アラート ルール</a> &ndash;Microsoft Azureドキュメント、2017 年 9 月 18 日</li>
   <li><a href="https://channel9.msdn.com/Events/Ignite/Microsoft-Ignite-Orlando-2017/BRK3201" target="_blank">クラウドを使用してハイブリッド クラウド保護を簡素化Microsoft Azure Security Center</a> &ndash;Sarah Sarah、 Ignite &ndash; 2017 Taran-Gutman 2017</li>
   <li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon" target="_blank">システム モニター (Sysmon)</a> &ndash; Mark Russinovich と Thomas Thomas Thomaser</li>
   <li>Sysmon (および Splunk) &ndash; を使用した高度なインシデント検出と脅威ハンティング(Tom Ueltschi、スイスポスト CERT、FIRST2017 で発表)</li>
   <li><a href="https://www.crypsisgroup.com/wp-content/uploads/2017/07/CG_WhitePaper_Splunkmon_1216-1.pdf" target="_blank">Splunkmon が &ndash; Sysmon を次のレベルに引き上</a> &ndash; Alec Randazzo、Thomas Ananda、James Espinosa、Thomaspsis</li>
   <li><a href="https://www.eideon.com/2017-09-09-THL01-Mimikatz/" target="_blank">脅威の物語 の攻撃 1</a> &ndash; Eideon、2017 年 9 月 9 日</li>
  </ul>
