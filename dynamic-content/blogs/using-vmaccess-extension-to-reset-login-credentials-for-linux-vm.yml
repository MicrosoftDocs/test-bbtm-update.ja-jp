### YamlMime:Yaml
ms.openlocfilehash: 9dea91dbca3454e04f48886ec1d25f2b457033f9
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139894727"
Slug: using-vmaccess-extension-to-reset-login-credentials-for-linux-vm
Title: VMAccess 拡張機能を使用したログイン資格情報のリセット、新しいユーザーの追加、Linux VM の SSH キーの追加
Summary: VMAccess 拡張機能を使用すると、パスワード、SSH キー、または SSH 構成をリセットして、アクセス権を回復できます
Content: "<p><span style=\"font-size: small;\">Azure VM のパスワードまたは SSH キーを忘れてアクセス権を失ったことはありますか?VMAccess 拡張機能を使用すると、パスワード、SSH キー、または SSH 構成をリセットして、VM へのアクセスを回復できます。パスワードまたは SSH キーを持つ新しいユーザーを追加したり、この拡張機能を使用してユーザーを削除したりすることもできます。</span> この拡張機能は Linux VM を<span style=\"font-size: small;\"></span>対象とします。<span style=\"font-size: small;\">Windows </span>VM の場合は、こちらをクリック<span style=\"font-size: small;\"></span>して詳細を確認してください。<span style=\"font-size: small;\">VM </span><a href=\"https://azure.microsoft.com/blog/2014/04/11/vm-agent-and-extensions-part-1/\"><span style=\"font-size: small;\"></span></a> 拡張機能を初めて使用する場合は、ここにいくつかの背景情報を確認してください。</p>\n\n<p><span style=\"font-size: x-large;\">前提条件</span></p>\n\n<ul>\n <li><span style=\"font-size: small;\">Microsoft Azure Linux エージェント バージョン 2.0.6 以降。ほとんどの Azure VM Linux ギャラリー イメージには、上記のバージョン 2.0.6 が含まれています。<b>waagent -version を実行して、</b>VM にインストールされているバージョンを確認できます。VM で 2.0.6 </span><a href=\"https://github.com/Azure/WALinuxAgent\"><span style=\"font-size: small;\"></span></a> より前のバージョンが実行されている場合は、次の手順に従<span style=\"font-size: small;\">って更新できます。</span></li>\n <li><span style=\"font-size: small;\">&nbsp;</span><a href=\"https://azure.microsoft.com/en-us/documentation/articles/xplat-cli/\"><span style=\"font-size: small;\">クロスプラットフォーム CLI</span></a>&nbsp;または <a href=\"https://azure.microsoft.com/en-us/downloads/\"><span style=\"font-size: small;\">Azure PowerShell</span></a>。</li>\n <li><span style=\"font-size: small;\">リセットまたは追加する新しいパスワードまたは SSH キーと、VM の新<b>しいユーザー。</b></span></li>\n</ul>\n\n<p><strong>2015 年 12 月の更新プログラム:</strong><br />\nLINUX 用 VMAccess 拡張機能で Azure Resource Manager モデルがサポートされています。ARM&nbsp; モデルで Linux 用 VMAccess 拡張機能を実行するサンプル Powershell および CLI スクリプトについては、こちら (Githubrelease&nbsp;) ドキュメントを参照&nbsp;してください。 <a href=\"https://github.com/Azure/azure-linux-extensions/blob/master/VMAccess/README.md\">https://github.com/Azure/azure-linux-extensions/blob/master/VMAccess/README.md</a></p>\n\n<p>&nbsp;</p>\n\n<p><span style=\"font-size: x-large;\">Xplat CLI を使用して VMAccess 拡張機能を使用する</span></p>\n\n<p><span style=\"font-size: small;\">マシンで</span><a href=\"https://azure.microsoft.com/en-us/documentation/articles/xplat-cli/\"><span style=\"font-size: small;\">クロスプラットフォーム</span></a> CLI <span style=\"font-size: small;\"> 環境を設定するには、このガイダンスに従います。xplat-cli がインストールされたら、コマンド ライン インターフェイス (Bash、ターミナル、コマンド プロンプト) から <b>azure</b> コマンドを使用して、xplat-cli コマンドにアクセスできます。たとえば、拡張機能の詳細&lsquo;な使用方法については、azure vm extension set --help&rsquo; を実行します。VMAccess を使用して VM にアクセスできるシナリオは 6 つがあります。シナリオと対応するサンプル スクリプトを次に示します。</span></p>\n\n<p><span style=\"font-size: large;\">1. パスワードのリセット </span></p>\n\n<p><span style=\"font-size: small;\"><b>手順 1:</b> 次の内容を含む PrivateConf.json という名前のファイルを作成します。</span></p>\n\n<pre class=\"prettyprint\">\n{\n&quot;username&quot;:&quot;currentusername&quot;,\n&quot;password&quot;:&quot;newpassword&quot;,\n&quot;expiration&quot;:&quot;2016-01-01&quot;\n}</pre>\n\n<p><span style=\"font-size: small;\"><b>手順 2</b>: &lsquo;azure vm extension set vmname VMAccessForLinux Microsoft.OSTCExtensions 1.* --private-config-path PrivateConf.json を実行する&rsquo;</span></p>\n\n<p><span style=\"font-size: large;\">2. SSH キーのリセット</span></p>\n\n<p><span style=\"font-size: small;\"><b>手順 1</b>: 次の内容を含む PrivateConf.json という名前のファイルを作成します。</span></p>\n\n<pre class=\"prettyprint\">\n  { \n  &quot;username&quot;:&quot;currentusername&quot;, \n  &quot;ssh_key&quot;:&quot;contentofsshkey&quot;,   \n   }</pre>\n\n<p><span style=\"font-size: small;\"><b>手順 2</b>: &lsquo;azure vm extension set vmname VMAccessForLinux Microsoft.OSTCExtensions 1.* --private-config-path PrivateConf.json を実行する&rsquo;</span></p>\n\n<p><span style=\"font-size: large;\">3. パスワードと SSH キーのリセット</span></p>\n\n<p><b>手順 1:</b> 次の内容を含む PrivateConf.json という名前のファイルを作成します。</p>\n\n<pre class=\"prettyprint\">\n{\n&quot;username&quot;:&quot;currentusername&quot;,\n&quot;ssh_key&quot;:&quot;contentofsshkey&quot;,\n&quot;password&quot;:&quot;newpassword&quot;,\n}</pre>\n\n<p><b>手順 2:</b> azure &lsquo;vm extension set vmname VMAccessForLinux Microsoft.OSTCExtensions 1.* --private-config-path PrivateConf.json を実行します&rsquo;</p>\n\n<p><span style=\"font-size: large;\">4. 新しい sudo ユーザー アカウントの作成</span></p>\n\n<p><span style=\"font-size: small;\">ユーザー名を忘れた場合は、VMAccess を使用して sudo 機関を使用して新しいユーザー名を作成できます。この場合、既存のユーザー名と資格情報は変更されません。</span> <span style=\"font-size: small;\">パスワード アクセス権を持つ新しい sudo ユーザーを作成するには、シナリオ 1 のスクリプトを使用します。SSH キー アクセスを使用して新しい sudo ユーザーを作成するには、シナリオ 2 のスクリプトを使用します。シナリオ 3 を使用して、パスワードとキーの両方のアクセス権を持つ新しいユーザーを作成することもできます。[UserName&rdquo;] フィールドには&ldquo;、新しいユーザー名を入力する必要があります。</span></p>\n\n<p><span style=\"font-size: large;\">5. SSH 構成のリセット</span></p>\n\n<p><span style=\"font-size: small;\">SSH 構成が望ましくない状態の場合は、VM へのアクセスも失われる可能性があります。VMAccess 拡張機能を使用して、構成を既定値にリセットできます。これを行うには、キーキーを &ldquo;True にreset_ssh&rdquo;する必要&ldquo;があります&rdquo;。拡張機能によって SSH サーバーが再起動され、VM で SSH ポートが開き、SSH 構成が既定にリセットされます。ユーザー アカウント (名前、パスワード、または SSH キー) は変更されません。</span> <span style=\"font-size: small;\">注: リセットされる SSH 構成ファイルは、/etc/ssh/sshd_config</span>。</p>\n\n<p><span style=\"font-size: small;\"><b>手順 1: </b>次の内容を含む PrivateConf.json という名前のファイルを作成します。</span></p>\n\n<pre class=\"prettyprint\">\n{\n&quot;reset_ssh&quot;:&quot;True&quot;,\n}</pre>\n\n<p><span style=\"font-size: small;\"><b>手順 2:</b> azure &lsquo;vm extension set vmname VMAccessForLinux Microsoft.OSTCExtensions 1.* --private-config-path PrivateConf.json を実行します&rsquo;</span></p>\n\n<p><span style=\"font-size: large;\">6. 既存のユーザーの削除</span></p>\n\n<p><span style=\"font-size: small;\">VM に直接ログインせずにユーザー アカウントを削除する場合は、次のスクリプトを利用できます。</span></p>\n\n<p><span style=\"font-size: small;\"><b>手順 1: </b>次の内容を含む PrivateConf.json という名前のファイルを作成します。</span></p>\n\n<pre class=\"prettyprint\">\n{\n&quot;remove_user&quot;:&quot;usertoberemoveed&quot;,\n}</pre>\n\n<p><span style=\"font-size: small;\"><b>手順 2: </b>&lsquo;azure vm extension set vmname VMAccessForLinux Microsoft.OSTCExtensions 1.* --private-config-path PrivateConf.json&rsquo;</span> を実行する &nbsp;</p>\n\n<p>&nbsp;</p>\n\n<p><span style=\"font-size: x-large;\">PowerShell を使用して VMAccess 拡張機能を使用する</span></p>\n\n<p><span style=\"font-size: small;\">VMAccess を使用して VM にアクセスできるシナリオは 6 つがあります。シナリオと、対応するサンプル PowerShell スクリプトを次に示します。シナリオごとに異なるパラメーター &ldquo;を指定する必要があるだけであることに注意してください。Begin の&rdquo; 実行後のセクションは、次のシナリオに関係なく同じです。 </span></p>\n\n<p><span style=\"font-size: large;\">1. パスワードのリセット </span></p>\n\n<pre class=\"prettyprint\">\n$vm = Get-AzureVM -ServiceName &#39;MyServiceName&#39; -Name &#39;MyVMName&#39;\n#Enter your current user name and new password\n$UserName = &quot;MyCurrentUserName&quot;\n$Password = &quot;MyNewPassWord&quot;\n[hashtable]$Param=@{};\n$Param[&#39;username&#39;] = $UserName;\n$Param[&#39;password&#39;] = $Password;\n$Param[&#39;expiration&#39;] = &#39;2016-01-01&#39;;\n$PrivateConfig = ConvertTo-Json $Param;\n#Begin execution\n$ExtensionName = &#39;VMAccessForLinux&#39;\n$Publisher = &#39;Microsoft.OSTCExtensions&#39;\n$Version = &#39;1.*&#39;\nSet-AzureVMExtension -ExtensionName $ExtensionName -VM $vm -Publisher $Publisher -Version $Version -PrivateConfiguration $PrivateConfig | Update-AzureVM \n</pre>\n\n<p>&nbsp;<span style=\"font-size: large;\">2. SSH キーのリセット</span></p>\n\n<pre class=\"prettyprint\">\n#Sample script for you to reset your SSH keys \n#Identify the VM \n$vm = Get-AzureVM -ServiceName &#39;MyServiceName&#39; -Name &#39;MyVMName&#39; \n#Enter the current user name and the path of your new public SSH key \n$UserName = &quot;CurrentName&quot; \n$cert = Get-Content &quot;CertPath&quot; \n$PrivateConfig = &#39;{&quot;username&quot;:&quot;&#39; + $UserName + &#39;&quot;, &quot;ssh_key&quot;:&quot;&#39; + $cert + &#39;&quot;}&#39;  \n# Begin execution \n$ExtensionName = &#39;VMAccessForLinux&#39; \n$Publisher = &#39;Microsoft.OSTCExtensions&#39; \n$Version =  &#39;1.X&#39; \nSet-AzureVMExtension -ExtensionName $ExtensionName -VM  $vm -Publisher $Publisher -Version $Version -PrivateConfiguration $PrivateConfig | Update-AzureVM</pre>\n\n<p><span style=\"font-size: large;\">3. パスワードと SSH キーのリセット</span></p>\n\n<pre class=\"prettyprint\">\n#Sample script to reset your password and SSH key\n#Identify the VM\n$vm = Get-AzureVM -ServiceName &#39;MyServiceName&#39; -Name &#39;MyVMName&#39;\n#Enter the new password, and cert path of the new SSH public key, with the current user name\n$UserName = &quot;CurrentName&quot;\n$Password = &quot;NewPassword&quot;\n$cert = Get-Content &quot;CertPath&quot;\n$PrivateConfig = &#39;{&quot;username&quot;:&quot;&#39; + $UserName + &#39;&quot;, &quot;password&quot;: &quot;&#39; + $Password + &#39;&quot;, &quot;ssh_key&quot;:&quot;&#39; + $cert + &#39;&quot;}&#39;\n# Begin execution\n$ExtensionName = &#39;VMAccessForLinux&#39;\n$Publisher = &#39;Microsoft.OSTCExtensions&#39;\n$Version = &#39;1.*&#39;\nSet-AzureVMExtension -ExtensionName $ExtensionName -VM $vm -Publisher $Publisher -Version $Version -PrivateConfiguration $PrivateConfig | Update-AzureVM</pre>\n\n<p><span style=\"font-size: large;\">4. 新しい sudo ユーザー アカウントの作成</span></p>\n\n<p><span style=\"font-size: small;\">ユーザー名を忘れた場合は、VMAccess を使用して sudo 機関を使用して新しいユーザー名を作成できます。この場合、既存のユーザー名と資格情報は変更されません。</span> <span style=\"font-size: small;\">パスワード アクセス権を持つ新しい sudo ユーザーを作成するには、シナリオ 1 のスクリプトを使用します。SSH キー アクセスを使用して新しい sudo ユーザーを作成するには、シナリオ 2 のスクリプトを使用します。シナリオ 3 を使用して、パスワードとキーの両方のアクセス権を持つ新しいユーザーを作成することもできます。[UserName] フィールド&ldquo;には&rdquo; 、新しいユーザー名を入力する必要があります。 </span></p>\n\n<p><span style=\"font-size: large;\">5. SSH 構成のリセット</span></p>\n\n<p><span style=\"font-size: small;\">SSH 構成が望ましくない状態の場合は、VM へのアクセスも失われる可能性があります。VMAccess 拡張機能を使用して、構成を既定値にリセットできます。これを行うには、キーキーを &ldquo;True にreset_ssh&rdquo;する必要&ldquo;があります&rdquo;。拡張機能によって SSH サーバーが再起動され、VM で SSH ポートが開き、SSH 構成が既定にリセットされます。ユーザー アカウント (名前、パスワード、または SSH キー) は変更されません。</span> <span style=\"font-size: small;\">注: リセットされる SSH 構成ファイルは、/etc/ssh/sshd_config</span>。</p>\n\n<pre class=\"prettyprint\">\n#Sample script to reset the SSH configuration on your VM \n#Identify the VM\n$vm = Get-AzureVM -ServiceName &#39;MyServiceName&#39; -Name &#39;MyVMName&#39;\n$PrivateConfig = &#39;{&quot;reset_ssh&quot;: &quot;True&quot;}&#39;\n# Begin execution\n$ExtensionName = &#39;VMAccessForLinux&#39;\n$Publisher = &#39;Microsoft.OSTCExtensions&#39;\n$Version = &#39;1.*&#39;\nSet-AzureVMExtension -ExtensionName $ExtensionName -VM $vm -Publisher $Publisher -Version $Version -PrivateConfiguration $PrivateConfig | Update-AzureVM</pre>\n\n<p><span style=\"font-size: large;\">6. 既存のユーザーの削除</span></p>\n\n<p><span style=\"font-size: small;\">VM に直接ログインせずにユーザー アカウントを削除する場合は、次のスクリプトを利用できます。</span></p>\n\n<pre class=\"prettyprint\">\n#Sample script to delete the a user account \n#Identify the VM\n$vm = Get-AzureVM -ServiceName &#39;MyServiceName&#39; -Name &#39;MyVMName&#39;\n#Identify the user account you want to delete\n$UserName = &quot;SomeUser&quot;\n$PrivateConfig = &#39;{&quot;remove_user&quot;: &quot;&#39; + $UserName + &#39;&quot;}&#39;\n# Begin execution\n$ExtensionName = &#39;VMAccessForLinux&#39;\n$Publisher = &#39;Microsoft.OSTCExtensions&#39;\n$Version = &#39;1.*&#39;\nSet-AzureVMExtension -ExtensionName $ExtensionName -VM $vm -Publisher $Publisher -Version $Version -PrivateConfiguration $PrivateConfig | Update-AzureVM</pre>\n\n<p>&nbsp;</p>\n\n<p><span style=\"font-size: x-large;\">結果に対してクエリを実行する</span></p>\n\n<p><span style=\"font-size: small;\">VMAccess 拡張機能の状態は、<span style=\"font-size: small;\">xplat &lsquo;コマンドの azure vm extension get&rsquo;&nbsp;</span> またはPowerShell コマンドレット Get-AzureVM、Get-Deployment を使用して取得できます。</span></p>\n\n<p><span style=\"font-size: x-large;\">リセット後に VM にアクセスする</span></p>\n\n<p><span style=\"font-size: small;\">VMAccess 拡張機能が完了したら、新しいアカウント名、パスワード、または SSH キーを使用してインスタンスにログオンできます。</span></p>\n\n<p><span style=\"font-size: x-large;\">その他の注意事項</span></p>\n\n<p><span style=\"font-size: small;\">既存のユーザー アカウントのパスワードまたは SSH キーのみをリセットする場合は、入力したユーザー名が元のユーザー名と一致する必要があります。元の名前とは異なる名前を入力すると、VMAccess &ldquo;&rdquo; 拡張機能はこれを \"新しいユーザーの作成\" シナリオとして扱い、指定されたパスワードまたはキーを持つ新しいユーザー アカウントを作成します。</span></p>\n\n<p><span style=\"font-size: x-large;\">既知の問題</span></p>\n\n<p><span style=\"font-size: small;\">PowerShell コマンドを実行する場合 &ldquo;Linux VM で Set-AzureVMExtension&rdquo; を実行すると、次のエラーが発生する可能性があります。 &quot;IaaS VM&quot; アクセス拡張機能を設定する前に、VM オブジェクトでゲスト エージェントのプロビジョニングを有効にする必要があります。この問題は、新しいポータルでは発生しません </span><a href=\"https://portal.azure.com/\"><span style=\"font-size: small;\">。</span></a></p>\n\n<p><span style=\"font-size: small;\"><strong>根本原因:</strong> Azure portal を使用してイメージを作成する場合、VM 上のゲスト エージェントの値が常に True に設定されているとは限 &ldquo;ではありません&rdquo;。Vm が PowerShell を使用して作成されている場合、この問題は表示されません。</span></p>\n\n<p><span style=\"font-size: small;\"><strong>解像 度：</strong> 次の PowerShell コマンドを追加して、ProvisionGuestAgent を True に設定 &ldquo;します&rdquo;。</span></p>\n\n<pre class=\"prettyprint\">\n$vm = Get-AzureVM -ServiceName &#39;MyServiceName&#39; -Name &#39;MyVMName&#39;\n$vm.GetInstance().ProvisionGuestAgent = $true</pre>"
