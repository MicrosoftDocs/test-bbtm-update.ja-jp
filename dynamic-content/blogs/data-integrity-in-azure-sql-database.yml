### YamlMime:Yaml
ms.openlocfilehash: 7fe3d59ff4a3b25931d940f87388e4a84f3ca3cf
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139904839"
Slug: data-integrity-in-azure-sql-database
Title: Azure SQL Database でのデータの整合性
Summary: 'Microsoft はデータの整合性を非常に真剣に受け止めています。 データの整合性を監視するために SQL Server で dba が使用する従来の手法 (DBCC CHECKDB など) とデータベースの破損から復旧するためのさまざまな方法がありますが、Azure SQL Database エンジニアリングチームは、データの損失なしに、一部の破損クラスを自動的に処理できる新しい手法を開発できました。 これらの手法は、データの損失やダウンタイムを回避できるようにするために、サービスの一部として使用されます。 '
Content: >-
  <p>Microsoft はデータの整合性を非常に真剣に受け止めています。 データの整合性を監視するために SQL Server で dba が使用する従来の手法 (DBCC CHECKDB など) とデータベースの破損から復旧するためのさまざまな方法がありますが、Azure SQL Database エンジニアリングチームは、データの損失なしに、一部の破損クラスを自動的に処理できる新しい手法を開発できました。 これらの手法は、データの損失やダウンタイムを回避できるようにするために、サービスの一部として使用されます。&nbsp;</p>


  <p>このブログの投稿では、これらの手法の一部、そのしくみ、および Azure SQL Database でデータを保護するために必要な手順について、お客様に与える影響について概説します。</p>


  <h2>Azure SQL Database のデータの整合性を管理する方法</h2>


  <p>Azure SQL Database におけるデータの整合性を保護するジョブには、手法と進化する方法の組み合わせが含まれます。</p>


  <p><strong>広範なデータ整合性エラーのアラート監視</strong>。 Azure SQL Database は、データ整合性の問題を示すすべてのエラーと未処理の例外に関するアラートを生成します。 各アラートは、手動での処理と調査を行うためにエンジニアリングチームに送られます (一般的なプロセスについては後述します)。 この警告システムは、このブログの投稿で説明されている他の問題よりも整合性の問題を検出しました。</p>


  <p><strong>バックアップと復元の整合性チェック</strong>。 Azure SQL Database のエンジニアリング チームは、サービス全体でデータベースの自動データベース バックアップの復元の自動テストを継続的に行っています。 復元時に、データベースは DBCC CHECKDB を使用した整合性チェックも受けます。 整合性チェック中に問題が見つかると、エンジニアリング チームにアラートが送信されます。</p>


  <p><strong>I/o システム &ldquo; で書き込み &rdquo; の検出が失われまし</strong>た。 Azure SQL Database には、物理的な破損の問題の最も一般的な原因を検出するための追加機能があります。I/o システム &ldquo; の書き込み &rdquo; が失われました。 この機能は、ページの書き込みとそれに関連付けられている Lsn (ログシーケンス番号) を追跡します。 それ以降のディスクからのデータページの読み取りは、ページ &rsquo; の予期される LSN と比較されます。 ディスク上のものと予想されるものとの間に Lsn が一致しない場合、ページは古くなっていると見なされ、エンジニアリングチームに直ちにアラートが生成されます。</p>


  <p><strong>ページの自動修復</strong>。 Azure SQL Database は、バックグラウンドでデータベースレプリカを利用してビジネス継続性を確保します。そのため、サービスでは、SQL Server データベースミラーリングと可用性グループに使用されるのと同じテクノロジである<a href="https://docs.microsoft.com/en-us/sql/sql-server/failover-clusters/automatic-page-repair-availability-groups-database-mirroring">ページの自動修復</a>機能も利用されます。 データの整合性の問題が原因で、レプリカがページを読み取ることができない場合、読み取り不可能なページは、データの損失や顧客のダウンタイムなしで、別のレプリカから新しいコピーが取得され、置き換えられます。 この機能は、geo セカンダリを使用した premium レベルのデータベースおよび standard レベルのデータベースに適用されます。</p>


  <p>保存<strong>時および転送中のデータの整合性</strong>。 サービスで作成されたデータベースは、既定では、チェックサム設定を使用してページを検証し、ページ全体にチェックサムを計算し、ページヘッダーに格納するように設定されています。 トランスポート層セキュリティ (TLS) は、TCP/IP によって提供されるベーストランスポートレベルのチェックサムに加えて、すべての通信にも使用されます。</p>


  <h2>データ整合性インシデントの処理方法</h2>


  <p>間違った結果や破損のインシデントは、すべての Azure エンジニアリングチームにとって24時間365日体制で、 <em>最高の重要度</em>で処理されます。 整合性インシデントを処理する際の目標は、可用性の低下を最小限に抑え、データ損失の量を最小限に抑えることです。</p>


  <h3>システムデータの整合性に関する問題の解決</h3>


  <p>顧客データやデータベースの可用性に影響しないインシデントは、顧客に通知することなく修正されます。 たとえば、ページの自動修復では、顧客のデータやクエリの結果に影響を与えない内部データベースのメタデータやテレメトリに対処したり、破損したりする可能性があります。&nbsp;</p>


  <h3>顧客データの整合性に関する問題への対処</h3>


  <p>間違った結果と顧客データの破損の問題はすべて、確認ができる限り早く、影響を受ける顧客に伝達されます。 Azure SQL DB のエンジニアは次のことを行います。</p>


  <ol>
      <li>顧客と直接連携して破損の範囲を説明し、回復オプションの概要を示し、顧客がアプリケーションとシナリオに最適なオプションを選択できるようにします。</li>
      <li>破損が発生する直前の時点への復元を直ちに開始し、別のデータベース名でお客様に無料で使用できるようにします。 可用性が最も高い優先度のお客様は、多くの場合、このバージョンのデータベースの使用を開始し、破損したデータを含むバージョンでの復旧操作は並行して行われます。 この場合、元のデータベースを修復した後、サポートエンジニアは、2つのデータを分岐しているデータを特定し、調整するためにどのような操作を行う必要があるかを顧客が判断できるよう支援します。</li>
      <li>可能な場合は、データの破損によってアプリケーションが他のデータを予期しない方法で変更した可能性があるかどうかなど、アプリケーションへの影響の範囲を理解することをお客様にお手伝いします。</li>
  </ol>


  <p>修復は、さまざまな方法、およびユーザーと組み合わせて実行される手順を使用して行います。 オプションには次のものを含めることができますが、制限はありません。</p>


  <ul>
      <li>インデックス &ndash; の再構築。クラスター化インデックスまたはヒープが破損していない非クラスター化インデックスの例です。</li>
      <li>REPAIR_REBUILD で DBCC CHECKDB を実行します。修復によってデータが失われる可能性はありません。</li>
      <li>REPAIR_ALLOW_DATA_LOSS を指定して DBCC CHECKDB を実行すると、修復によってデータが失われる可能性があります。</li>
      <li>DBCC CHECKDB を使用してデータの整合性の問題を修復できないシナリオでは、エンジニアはデータ整合性の問題が発生する前にポイントインタイムリストアを使用し、トランザクションログから関連するトランザクションを手動で再生します。 このような状況が発生した場合、自動再生が行われないようにトランザクションログが破損していても、顧客データには影響を与えないことが挙げられます。&nbsp;</li>
  </ul>


  <p>誤った結果またはデータの破損の原因となった問題は、エンジニアリングチームからの詳細な post 事後と、問題のために作成された関連する修復項目が密接に追跡されます。 前に説明した書き込み &rdquo; 機能の損失を含め &ldquo; 、これらのポスト事後のために多くの重要な機能強化が行われています。</p>


  <h2>Azure SQL Database での整合性チェックの実行</h2>


  <p>Azure SQL Database エンジニアリングチームは、データ整合性の管理に責任を持ちます。 &nbsp;そのため、ユーザーが Azure SQL Database で整合性チェックを実行する必要はありません。</p>


  <p>サービスによって提供される既存の監視と保護により、お客様は Azure SQL Database でユーザーが開始した整合性チェックを実行することもできます。 たとえば、必要に応じて DBCC CHECKDB を実行することができます。</p>


  <h2>進化的手法</h2>


  <p>Azure SQL Database エンジニアリングチームは、サービスで使用されるソフトウェアとハードウェアのデータ整合性の問題検出機能を定期的に確認し、継続的に改善します。 まれですが、Microsoft カスタマーサポートからの通知を受け取る前にデータ整合性エラーが発生した場合は、 <a href="https://docs.microsoft.com/en-us/azure/azure-supportability/how-to-create-azure-support-request">サポートケースを提出</a>する必要があります。</p>


  <p>Azure SQL Database における Microsoft &rsquo; のデータ整合性戦略に関するフィードバックがある場合は、お客様からのご意見をお待ちしております。 このテーマに関するフィードバックやコメントをエンジニアリングチームに問い合わせるには、電子メール <a href="mailto:SQLDBArchitects@microsoft.com">SQLDBArchitects@microsoft.com</a> をお送りください。</p>
