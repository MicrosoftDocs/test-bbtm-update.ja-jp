### YamlMime:Yaml
ms.openlocfilehash: 2f37f932571ca37f3af78f6a42dccfbae9a5e4f3
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139904062"
Slug: migrating-azure-services-to-new-regions
Title: 新しいリージョンへの Azure サービスの移行
Summary: お客様がリージョン間で Azure サービスを移動する経験についての洞察。  スムーズで簡単な方法で移行を実現した方法について説明します。
Content: >-
  最近、お客様のサービスを米国中南部リージョンから米国東部リージョンのデータセンターに移行する必要があるというエンゲージメントを実施しました。 このエンゲージメントには、容量計画の適切なサイズプレミアム SKU の処理が含まれており、High-Availability とロールバックのためにアクティブな Geo-Replication を活用しています。


  お客様は米国中南部に存在する Azure サービスを米国東部リージョンに移行しようとしています。 サポートに必要な主な領域は、データベースに関するものであり、ダウンタイムの可能性を予測する必要があります。 ダウンタイムは可能な限り少なくする必要がありますが、6時間以内にすることはできません。

  <h2>顧客の概要</h2>

  顧客は、geosocial モバイルゲームの開発者です。 ゲームは世界中の町と都市を認識しており、2つのアフリカ以外の国にも存在します。 プレーヤーは、主に物理的な地理的な場所の面で参加します。

  <h2>計画</h2>

  計画の観点からは、複数のオプションを検討しています。 これらは特に長い議論ではありませんでしたが、このような会話が必然的に一般的であるため、アイデアがあります。

  <ul>
      <li>データベースにはどのくらいの大きさがありますか。</li>
      <li>データベースで使用されている現在の SKU は何ですか?</li>
      <li>許容できるダウンタイムはどれくらいですか?</li>
      <li>移行中に許容できるデータ損失の量 (存在する場合)</li>
      <li>料金はいくらですか?</li>
      <li>まだプレビュー段階にある、最近公開されたサービスやサービスの使用は許容できますか。</li>
      <li>データの移動に関する現在の懸念事項は何ですか。</li>
      <li>心配はありませんか。</li>
  </ul>

  &nbsp;


  このお客様にとって最も重要なのは移動です。 このようにして、実行できることに関してかなりの量の緯度がありました。


  データベースは約35GB でした。 約 5 GB のデータをオンラインにする必要があると見なすことができますが、実質的にはオフラインになるため、時間の経過と共に残りを追加することができます。


  データベースは business edition SKU であり、フェデレーションなどの特定の Azure 機能を利用していませんでした。


  最大8時間のダウンタイムが許容される可能性がありますが、ダウンタイムが2時間未満の場合、ビジネスとコンシューマーの予測を管理するのははるかに簡単でした。 さらに、特定の曜日や時間がダウンタイムにも適していたため、ダウンタイムを制御する必要がありました。


  コストを重視していましたが、コストに関する考慮事項が含まれていたとしても、すべてのアイデアが開かれていました。


  お客様は DBCopy プロセスに細心の注意を払っており、大量のデータセットを移動するためのエクスポート/インポートと共に、非常に長い時間がかかり、ビジネスに深刻な影響を与えていました。


  コンピューティングノードの移動は問題ではありませんでした。既存の blob ストレージデータをすぐに移動する必要はありませんでした。 ソリューションは、既存の blob にアクセスするためにクロス DC ロジックを必要としないように設計されています。


  いくつかのオプションを次に示します。

  <ol>
      <li>Active Geo-Replication の機能を活用する</li>
      <li>すべての接続の停止、データのエクスポート、ファイルのコピー、米国東部リージョンへのインポート</li>
      <li>DBCopy の作成、データのエクスポート、ファイルのコピー、米国東部リージョンでの復元</li>
  </ol>

  Active Geo-Replication オプションは、次の理由で推奨されました。

  <ul>
      <li>最低ダウンタイム</li>
      <li>計画された移行中のデータ損失なし</li>
      <li>Rollback オプションは使用できます
  <ul>
      <li>実行の失敗は、米国中南部データセンターでリソースを再度有効にする簡単な手順です。</li>
  </ul>

  </li>
      <li>最低の TCO</li>
      <li>今後の計画に準拠 (プレミアム SKU へのアップグレード)</li>
  </ul>

  1つの問題は、サービスがプレビューであったが、これは許容できるリスクであると考えられたことです。 パフォーマンスの履歴を確認した後、そのニーズに対して P1 が十分であると判断されました。 レプリケーションがリソースを集中的に使用するのではなく、ピークが1回限りのイベントであることがわかっていて、予測的なリソースの要件が低いという懸念事項がありましたが、この決定は P1 で維持され、すぐに P2 にアップグレードすることができました。


  キャパシティプランニングプロセスの一環として、お客様は Azure SQL Database ( <a href="https://msdn.microsoft.com/en-us/library/azure/dn369873.aspx">https://msdn.microsoft.com/en-us/library/azure/dn369873.aspx</a> ) の記事 Basic、Standard、およびプレミアム Preview を指しました。

  <h2>実行</h2>

  お客様はプレミアム SKU プレビューにサインアップする必要がありました。 これはポータルで実行する必要があり、プロセスが完了するまで数秒かかります。


  サインアップすると、データベースをプレミアムにアップグレードできます。 計画に使用された機能の詳細については、「データベースサービス階層とパフォーマンスレベルの変更」 ( <a href="https://msdn.microsoft.com/en-us/library/dn369872.aspx">https://msdn.microsoft.com/en-us/library/dn369872.aspx</a> ) を参照してください。 次の数式は、実際には非常に正確で、アップグレードにかかった12時間を予測していました。

  <p align="center">3 * (5 分 + データベースサイズ/150 MB/分)</p>

  アップグレードがスムーズに行われました。 いくつかの接続は接続に失敗しましたが、MSDN の記事で説明されているように、これは少しの間、予想していました。


  次の手順は、目的のリージョン (つまり米国東部リージョン) にレプリカを作成することでした。 この処理にかかる時間と、レプリカを実行するために必要なリソースに対する不確実性がありました。 この手順については、「Active Geo-Replication 構成でのフェールオーバー」 ( <a href="https://msdn.microsoft.com/en-us/library/azure/dn741337.aspx">https://msdn.microsoft.com/en-us/library/azure/dn741337.aspx</a> ) に記載されています。 お客様は、レプリカの初期同期にどれくらいの時間がかかったかについての質問に回答する場合に最適です。

  <blockquote>"<em>It [初期同期] は、40分以下になりました *。 実際のコピー時間はわかりません。 このデータベースの bacpac ファイルをローカルに作成することは、4時間かかります。</em>"</blockquote>

  <span style="font-size: small;">* 完全にオンラインエクスペリエンス</span>


  この実行プランはコードデプロイの間で行われていることに注意してください。 この多くは、プロセスが純粋に技術的な場合に24時間以内に発生した可能性があります。 顧客は、実行プランの次のアクションに進む前に、数日待つことを選択しました。 この考え方は、新しいデータセンターではなく、既存のトポロジでコードを大幅に変更することに関連していました。 DDL の変更がレプリケートされるかどうかを懸念していました。 すべての変更は、ログインなど、master データベースの更新に依存するものを除いて、すべてレプリケートされます。 これらは、各環境で実行する必要があります。一方、ユーザーの作成は、ソースで行うことができます。 ログインのトピックに特に関連する、「アクティブ Geo レプリケーションのセキュリティ構成」 ( <a href="https://msdn.microsoft.com/en-us/library/azure/dn741335.aspx">https://msdn.microsoft.com/en-us/library/azure/dn741335.aspx</a> ) を参照してください。


  最後の手順は、新しいリージョンに切り替えることでした。 次に示すのは、このようなタスクを実行する他のユーザーの利益に関して、顧客が共有する手順です。 Active Geo-Replication トポロジを終了するために、「連続コピーの関係を終了する」 ( <a href="https://msdn.microsoft.com/en-us/library/azure/dn741323.aspx">https://msdn.microsoft.com/en-us/library/azure/dn741323.aspx</a> ) のリンクごとの説明がよくわかります。

  <ol>
      <li>1週間前に、データベースを premium にアップグレードし、東部データセンターへの geo レプリケーションをセットアップします。これは、同じ日に実行されている可能性があります。32 GB データベースが米国中南部から東部に完全にレプリケートされるまでに40分かかりました。</li>
      <li>[移動日]米国中南部のコンテナーの名前と一致するように、東に blob コンテナーを作成します。(現時点では blob データを移動することは選択していませんが、ここではそのようにします)。</li>
      <li>新しい Web ロールと Worker ロールを東部にデプロイします。DB と blob storage で、東に新しいデプロイをポイントします。</li>
      <li>新しい (東部) 環境で必要な SSL 証明書をセットアップする</li>
      <li>(<b>ダウンタイムが開始</b>されます)古い Web と新しい Web オフライン回線を使用します。これを行うには、アプリケーションの構成スイッチを使用します。これにより、サイトがメンテナンス中であることを示すわかりやすいメッセージが表示されます。管理者のみがサイト/API に正常にアクセスできます。</li>
      <li>新しい web ロールの IP アドレスを指すように DNS を変更する</li>
      <li>DB と Blob の接続文字列を使用して、東部で新しいコードを古いデータセンター (米国中南部) にデプロイします</li>
      <li>米国中南部 IP アドレスからの接続を許可するように East DB を構成する (必須ではない場合があります)</li>
      <li>米国中南部の新しいデプロイ (ステージング領域) をオフラインモードに設定し、運用環境にスワップします</li>
      <li>DB のアクティブ Geo-Replication の停止 (連続コピーリレーションシップの予定終了)
  <ul>
      <li>ポータルを使用して実行される手順</li>
  </ul>

  </li>
      <li>米国中南部データベースを Read-Only モードに設定する</li>
      <li>米国東部リージョンのデータベースを読み取り/書き込みモードに設定します (レプリケーションが完了した後) (必要ない場合があります)</li>
      <li>(<b>ダウンタイムが終了しまし</b>た)米国中南部と米国東部の両方のリージョンのデータセンターで、web サイトと API の両方を再び有効にします。</li>
      <li>新しいデータベースに AzureDB の自動バックアップを設定します。
  <ul>
      <li>管理ポータルの DB の [構成] セクションで、自動エクスポートを使用します。</li>
  </ul>

  </li>
      <li>DNS レプリケーションが世界中で完全に伝達された後、米国中南部でアプリケーションサーバーを削除します。</li>
  </ol>

  顧客からの次の見積もりは、エクスペリエンスを明確にするための大きな仕事です。

  <blockquote>「<em>移動は非常にスムーズに行われました。 約1時間ダウンしました。そのほとんどが、新しいコードのデプロイ、構成の更新、および運用/ステージングのスワップを待機していました。 Azure DB レプリケーションをシャットダウンし、読み取り/書き込みモードを変更する実際のプロセスは簡単でした。</em>」</blockquote>
