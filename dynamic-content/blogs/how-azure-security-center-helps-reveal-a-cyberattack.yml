### YamlMime:Yaml
ms.openlocfilehash: d9f2fe3dbad31305b581edfbb036d1bdc594dc95
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139890776"
Slug: how-azure-security-center-helps-reveal-a-cyberattack
Title: サイバー Azure Security Centerを明らかにする方法
Summary: Azure Security Center (ASC) アナリスト チームは、ASC アラートをレビューして調査し、Microsoft Azure のお客様に影響を与えるセキュリティ インシデントに関する分析情報を取得し、Azure セキュリティ アラートの改善に役立てします。
Content: >-
  <p>Azure Security Center (ASC) アナリスト チームは、ASC アラートをレビューして調査し、Microsoft Azure のお客様に影響を与えるセキュリティ インシデントに関する分析情報を得て、Azure セキュリティのアラートと検出を改善します。 ASC は、高度な分析とグローバルな脅威インテリジェンスを使用して、急速に進化する脅威に対応するのに役立ちます。</p>


  <p>クラウド セキュリティに関する限り、私たちは長い道のりを行っていますが、現在でも、企業が資産をクラウドに移行する際に、セキュリティ要因について大きく議論されています。 Azure Security Centerチームは、高度な攻撃だけでなく、必ずしも新しい攻撃や新規ではないものからでも、Azure デプロイがセキュリティで保護されているという保証が、お客様にとっていかに重要かについて理解しています。 ASC の美しさは、そのシンプルさにあるのです。 ASC では、機械学習、異常検出、行動分析を使用して疑わしいイベントを特定しますが、Bad Bad Bad/Script Kiddies が Microsoft SQL サーバーに侵入するために使用している SQL ブルート フォース攻撃などの簡単な処理に対応しています。</p>


  <p>&rsquo;このブログでは、Security Center によって検出された SQL ブルート フォース攻撃から始まった 1 つの実際の攻撃キャンペーンのステージと、攻撃の調査と修復に必要な手順について説明します。 このケース スタディでは、攻撃のダイナミックスに関する分析情報と、環境内で同様の攻撃を防ぐ方法に関する推奨事項を提供します。</p>


  <h2>初期 ASC アラートと詳細</h2>


  <p>ハッカーは、インターネットに接続されたデータベースを常にターゲットにしようとしています。 ブルート フォース攻撃によってパスワードを割り込むSQL Server IP アドレスを検出しようとする悪い攻撃が数多く見られています。 このSQLデータベースには、個人を特定できる情報、クレジット カード番号、知的財産など、攻撃者にとって豊富な貴重な情報が含まれる可能性があります。データベースに多&rsquo;くの情報がなくても、安全に構成されていない SQL のインストールに対する攻撃を成功すると、完全なシステム管理者特権を取得できます。</p>


  <p>このケースは、悪意のあるアクティビティの詳細をお客様に通知する ASC アラートSQL開始しました。 &ldquo;SQL サービス アカウントによって起動されたコマンド ライン ftp -s:C:\zyserver.txtSQL&rdquo;は異常であり、ASC アラートによってフラグが設定されました。</p>


  <p>アラートには、検出されたアクティビティの日付と時刻、影響を受けたリソース、サブスクリプション情報などの詳細が表示され、検出された脅威と推奨されるアクションの詳細レポートへのリンクが含まれていました。</p>


  <p>&nbsp;</p>


  <table border="0" cellpadding="2" cellspacing="0" width="999">
   <tbody>
    <tr>
     <td valign="top" width="499"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b5554369-307f-4fdb-b926-181802eb19ec.jpg"><img alt="Malicious SQL activity (2)" border="0" height="564" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/fb5a5593-973a-4f66-90a1-c72d1dcff72a.jpg" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="悪意SQLアクティビティ (2)" width="463"></a></td>
     <td valign="top" width="499"><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/024df1b6-5233-417c-bb65-8036d9f35b3e.png"><img alt="Threat summary" border="0" height="553" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/327e0acc-c7d4-4382-8119-69473123cf1b.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="脅威の概要" width="433"></a></td>
    </tr>
   </tbody>
  </table>


  <p>&nbsp;</p>


  <p>この監視を通じて、ASC アナリスト チームもこのアクティビティに対してアラートを受け取り、アラートの詳細をさらに確認しました。 検出されたのは、SQL サービス アカウント (SQLSERVERAGENT) が FTP スクリプト (つまり、ftp サイトから悪意のあるバイナリをダウンロードして起動するために使用された C:\zyserver.txt) を作成することです。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/349ecba5-5c30-4330-8120-8d8cccf3924a.png"><img alt="Detect" border="0" height="157" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9cf677bc-19c0-40df-8712-4d397ff65910.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="検出" width="772"></a></p>


  <h2>最初の侵害</h2>


  <p>影響を受ける Azure サブスクリプションの詳細な調査は、SQL エラーとトレース ログの検査から始まり、ブルート フォースの試行の兆候SQL見つかりました。 SQL &ldquo;&rdquo; エラー ログで、SQL Admin &lsquo;sa&rsquo; アカウント (組み込みの SQL Server 管理) に対して何百回もの監査ログイン失敗ログオン試行が発生し、最終的にログインが成功しました。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5aacbb32-8c36-43bb-8a16-3c0448aa7281.png"><img alt="failed log in" border="0" height="54" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/56d2dfe0-0466-4181-83c9-d1443a567404.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="失敗したログイン" width="759"></a></p>


  <p>これらのブルート フォース試行は、TCP ポート 1433 で発生しました。これは、公開インターフェイスで公開されました。 TCP ポート 1433 は、ポート 1433 の既定SQL Server。</p>


  <p><strong>メモ：</strong>SQL の既定のポート 1433 を変更することが非常に一般的な推奨事項です。これは、多くのポート スキャン ツールがネットワーク ポートの範囲をスキャンし、最終的には 1433 &ldquo;&rdquo; &ldquo;&rdquo;以外のポートでリッスンしている SQL を見つける可能性があります。</p>


  <p>SQL Admin &lsquo;sa &lsquo;&rsquo; アカウントがブルート フォースによって侵害された後、アカウントを使用して xp_cmdshell&rsquo;&rsquo; 拡張ストアド プロシージャを有効にしました。次に、SQL ログの抜粋で以下で説明しました。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c7c46c81-27d4-4807-8288-f31c4c25ced3.png"><img alt="SQL" border="0" height="66" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8e1a6ed8-877b-432b-85ed-79fcbc2caf74.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="" width="752"></a>SQL xp_cmdshell&lsquo;&rsquo;ストアド プロシージャは既定で無効になっています。これは、Microsoft SQL Server 内から Windows コマンド シェルを呼び出す機能により、攻撃者に特に関心があります。 xp_cmdshell&lsquo;を有効にすると、攻撃者は xp_cmdshell を呼び出す SQL&rsquo; エージェント &lsquo;ジョブを作成し、FTP スクリプトの作成と起動を含む任意のコマンドを起動し、次にマルウェアをダウンロードして実行しました。</p>


  <h2>悪意のあるアクティビティの詳細</h2>


  <p>最初の侵害がどのように発生したのか判断したら、チームはプロセス作成イベントの分析を開始し、他の悪意のあるアクティビティを特定しました。 プロセス作成イベントでは、バックドアと任意のコードのダウンロードとインストール、システムに対するアクセス許可の変更など、さまざまなコマンドの実行が明らかでした。</p>


  <p>以下では、悪意のあると判断したプロセス コマンド ラインの時系列レイアウトについて詳しく説明します。</p>


  <p>最初の侵害の 1 日後に、Cacls.exe を使用してファイル/フォルダーとレジストリ キーに対する ACLS の変更が見え始めました (これは osk.exe と vds.exe に名前が変更されたと思われる)。</p>


  <p><strong>注:</strong> Osk.exeはユーザー補助オンスクリーン キーボードの実行可能ファイルであり、Vds.exe は仮想ディスク サービス実行可能ファイルであり、どちらも通常は Windows インストールにあります。 ただし、以下で詳しく説明するコマンド ラインとコマンド スイッチは、Osk.exe または VDS.exe には使用されません。コマンド ラインとコマンド スイッチはCacls.exe。</p>


  <p>このCacls.exeスイッチ /e /g を使用して、システム アカウントに full(:f) &lsquo; &rsquo; アクセス権を付与し、cmd.exeアクセスnet.exe&lsquo; &rsquo;。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c823c595-3e57-4737-a91c-a7a56148a168.png"><img alt="Screenshot_2" border="0" height="84" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/44b0a86c-cede-4d60-986c-71eccbbfabb0.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="" width="1057"></a>Screenshot_2数秒後に、 のネイティブ アプリケーションを使用して既知のウイルス対策ソフトウェアWindows終了taskkill.exe&ldquo; &rdquo;。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/6222158b-fe72-4bc2-b75d-e7b1990971e3.png"><img alt="Screenshot_1" border="0" height="70" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2c725574-8747-417f-8cbe-099e776cf761.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="Screenshot_1" width="1076"></a></p>


  <p>その後、元の ASC アラートでフラグが設定された FTP スクリプト (c:\zyserver.txt) が作成されました。 この FTP スクリプトは、悪意のある FTP サイトからマルウェア (c:\stserver.exe) をダウンロードし、その後マルウェアを起動します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/40e7a7b5-7a3b-4bcb-a98f-f1e5626245cf.png"><img alt="Image 3" border="0" height="120" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/693db3f0-4824-4646-966b-15fab2a3ce59.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="画像 3" width="1067"></a>数分後に、&ldquo;次の処理に使用される net user &ldquo;&rdquo; コマンドと net localgroup&rdquo; コマンドが表示されます。</p>


  <p>A。&nbsp;&nbsp;&nbsp; 組み込みのゲスト アカウントをアクティブ化し、Administrators グループに追加する</p>


  <p>B。&nbsp;&nbsp;&nbsp;新しいユーザー アカウントを作成し、新しく作成したユーザーを Administrators グループに追加する</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/837e2f19-ab04-4d85-9a03-fda0cfcaeb96.png"><img alt="Image 4" border="0" height="118" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/aca84092-33b9-474a-abaa-7bf94600e88b.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="イメージ 4" width="1046"></a> 2 時間少し後に、レジストリ キーの作成、変更、または削除に使用されている regini.exe コマンドが表示されます。 Regini では、レジストリ キーに対するアクセス許可を、書き込みファイルで定義されている.iniすることもできます。 次に、regsvr32.exe シェル (urlmon.dll、shdocvw.dll) と Windows Windows スクリプト (jscript.dll、vbscript.dll、wshom.) に関連する dll を自動的に (/s スイッチ) 登録しているのを確認します。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/e2921e6f-6665-4c10-b363-d92cccc12b05.png"><img alt="Screenshot_3" border="0" height="99" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f7a9a88b-e3c5-45bc-a24f-4513bfa3c5a8.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="Screenshot_3" width="1061"></a></p>


  <p>その直後に、さまざまな実行可能ファイルに対するアクセス許可がWindowsされます。 基本的に、 コマンドを使用して各 &ldquo; を既定値icacls.exe&rdquo; します。</p>


  <p><strong>メモ：</strong> /reset スイッチは、ACL を、一致するすべてのファイルの既定の継承された ACL に置き換えます。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c8eb00c1-99d1-4679-88ec-8f7295effa51.png"><img alt="Image 6" border="0" height="176" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/adaecb3d-df04-4714-8654-6733e457779f.png" style="border: 0px currentColor; border-image: none; padding-top: 0px; padding-right: 0px; padding-left: 0px; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="図 6" width="939"></a>最後に、ターミナル &ldquo;&rdquo; サーバー fDenyTSConnections レジストリ キーの削除を確認しました。 これは、ターミナル サーバーの接続制限の構成を含むレジストリ キーです。 これにより、悪意のある RDP 接続が攻撃者がサーバーにアクセスするための次のステップになる可能性があるという考えに導かされています。 ただし、ログオン イベントの検査では、悪意のある RDP の試行や接続は明らかになってきなかった。</p>


  <ul>
   <li>ターミナル サーバーレジストリ キーの値を上書きして、ターミナル サーバーの接続 &ldquo;制限を&rdquo; 無効にする<br>
  reg.exe HKLM &quot;\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f&quot;&nbsp;</li>

  </ul>


  <p>スケジュールされたタスクが作成されているのも確認しました。 このタスクは、C &ldquo; :\RECYCLERsvchost.exe&rdquo; から起動されるという名前のバイナリを参照しました。これは疑わしいです。</p>


  <p>正当なsvchost.exe&ldquo; ファイルは \Windows\System32&rdquo; &ldquo;および Windows\sysWOW64&rdquo; にあります。&ldquo;&rdquo; Svchost.exeディレクトリから実行されている場合は、疑わしいと見なす必要があります。</p>


  <ul>
   <li>永続化メカニズム - タスク スケジューラタスクを設定schtasks.exeユーティリティ (schtasks.exe) を使用します<br>
  C:\Windows\System32\schtasks.exe /create /tn 45645&quot; /trC:\RECYCLER\svchost.exe&quot; &quot; /sc minute /mo 1 /ru &quot;システム&quot;&nbsp;</li>

  </ul>


  <h2>推奨される修復と軽減の手順</h2>


  <p>攻撃の範囲と詳細を理解したら、次の修復と軽減の手順を実行する必要があります。</p>


  <p>最初に、可能であれば、最初にバックアップとリビルドを行い、SQL Serverユーザー アカウントをリセットすることをお勧めします。 その後、次の軽減手順を実装して、さらなる攻撃を防ぐのに役立ちます。</p>


  <p>1.sa &lsquo;アカウントを&rsquo;無効にして<a href="https://msdn.microsoft.com/en-us/library/ms189828.aspx">、より安全な認証Windowsする</a></p>


  <p>&lsquo;SQL を使用して sa&rsquo; ログインを無効にするには、sys 管理者として次のコマンドを実行します。</p>


  <pre>

  ALTER LOGIN sa DISABLE


  GO</pre>


  <p>2. 攻撃者が sa アカウントを推測するのを防ぐには &lsquo;、sa&rsquo; アカウントの名前を &lsquo;変更&rsquo; します<br>

  を使用して &lsquo;sa アカウントの&rsquo;名前を変更するにはSQL sys admin として次を実行します。</p>


  <pre>

  ALTER LOGIN sa WITH NAME = [new_name];


  GO</pre>


  <p>3.今後のブルート フォース試行を防<a href="https://msdn.microsoft.com/en-us/library/ms365941.aspx">&lsquo;ぐには、sa パスワードを変更して強化し、sa&rsquo;</a> Login を Disabled に設定&lsquo;します&rsquo;。</p>


  <p>MSDE またはパスワード<a href="https://support.microsoft.com/en-us/kb/322336">でシステム管理者のパスワードを確認</a>および変更する方法SQL Server 2005 Express Edition。</p>


  <p><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/3dfa9cce-2e61-4748-9a20-70de07f2464f.png"></p>


  <p>4.アプリケーションが無効になっているxp_cmdshell<a href="https://msdn.microsoft.com/en-us/library/ms190693.aspx">&lsquo;&rsquo;も良い考えです</a>。&rsquo;&nbsp; ここでも、これは既定で無効になっている必要があります。</p>


  <p>5.TCP&nbsp; ポート 1433 をインターネットに開く必要がない場合は、ネットワーク セキュリティ グループに 1433 を許可する規則が設定されていない必要があります。 Azure Portal から、次の手順を実行して、ネットワーク セキュリティ グループで 1433 をブロックするルールを構成します。</p>


  <p>A。&nbsp;ファイルを開 <a href="https://portal.azure.com">Azure portal</a></p>


  <p>B。&nbsp;[(その &gt; 他のサービス) - ネットワーク セキュリティ グループ&gt; ] に移動します</p>


  <p><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/9d526346-b846-4459-ac77-cedbab6c4a93.png"></p>


  <p>c.&nbsp;[ネットワーク &lt; セキュリティ] オプションを選択した場合は、<strong>ComputerName-nsg</strong>&gt; のエントリが表示されます。クリックしてセキュリティ規則を表示します</p>


  <p>d.&nbsp;[&quot;&quot;設定受信セキュリティ規則] をクリックし、次のウィンドウで 1433 を許可する規則の存在を確認します (以下の例を参照)。</p>


  <p><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b14ab477-f170-45ee-a916-3311ec0db89b.png"></p>


  <p>E。&nbsp;SQL ポート 1433&rsquo;&ldquo;&rdquo; へのアクセスを許可する規則が存在する場合は、ルールを編集して [アクション] を [許可] から [拒否] に変更&ldquo;します&rdquo;。 &ldquo;[保存]&rdquo;をクリックします。</p>


  <p><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a5a7f0c2-8185-4291-b4d8-f4b0da759d15.png"></p>


  <p>F。&nbsp;次に、新しく作成したルールをサブスクリプションに適用します<br>

  <img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/6a5105da-7f12-4259-9a33-97e357447d80.png"></p>


  <p>6.SQL&nbsp;&lsquo; で有効になっている可能性があるすべてのストアド プロシージャを検査し、xp_cmdshellを実装し、通常とは異なるコマンドを実行している可能性がある&rsquo;ストアド プロシージャを探します。</p>


  <p>たとえば、この例では、次のコマンドを特定しました。</p>


  <p><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/02ceb4e0-ebe5-4770-9b1e-641268f0bdb5.png"></p>


  <p>7.&nbsp;最後に、今後のアラートと電子メール通知を受信するように Azure サブスクリプションを構成することを強くおMicrosoft Azure Security Center。 今後、このようなセキュリティの問題に関するアラートと電子メール通知を受信するには、ASC Free&rdquo; (基本的な検出) レベルから ASC &ldquo;&ldquo;Standard&rdquo; (高度な検出) レベルにアップグレードをお勧めします。</p>


  <p>このインシデントが検出された場合に ASC から受信した電子メール アラートSQL例を次に示します。</p>


  <p><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/62b2d45e-883e-45d3-9cd8-b32e30a099ae.png"></p>


  <h2>詳細については、検出SQL&nbsp;してください</h2>


  <ul>
   <li><a href="https://blogs.msdn.microsoft.com/azuresecurity/2016/09/08/azure-sql-database-threat-detection-advanced-db-security-in-the-cloud/">Azure SQL Database脅威検出&ndash;クラウドでの高度な DB セキュリティ</a></li>
   <li><a href="https://blogs.msdn.microsoft.com/azuresecurity/2016/10/26/protect-azure-sql-databases-with-azure-security-center/">Azure SQL データベースを保護するAzure Security Center</a></li>
   <li><a href="https://blogs.msdn.microsoft.com/sqlsecurity/2016/08/08/sql-threat-detection-your-built-in-security-expert/">SQL脅威検出&ndash;組み込みのセキュリティエキスパート</a></li>
  </ul>
