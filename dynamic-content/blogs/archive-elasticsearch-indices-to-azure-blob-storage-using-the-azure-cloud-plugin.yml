### YamlMime:Yaml
ms.openlocfilehash: fe20060c628be8d5f74d5ff8769134a5cd8acee0
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139890314"
Slug: archive-elasticsearch-indices-to-azure-blob-storage-using-the-azure-cloud-plugin
Title: Azure クラウド プラグインを使用して Elasticsearch インデックスStorage Azure BLOB にアーカイブする
Summary: Elasticsearch 用の Azure Cloud プラグインを低コストのインデックス アーカイブ ソリューションとして使用する方法について説明します。
Content: >-
  <p>Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/cloud-azure.html">用の Azure Cloud</a> プラグインには、Elasticsearch 環境を Azure と統合する機能がいくつか追加されています。 提供される機能の 1 つは、Azure Blob Storage に対するインデックスのスナップショットと復元です。インデックスを復旧するためのコスト効率と高可用性のオプションが提供されます。 これにより、使用されなくなったが、将来アクセスできるインデックスをアーカイブする方法も提供できます。 このドキュメントでは、新しく統合された Azure Cloud プラグインを使用して Azure VM に Elasticsearch クラスターをデプロイする手順について説明し、アーカイブ目的でインデックスをスナップショット化して復元する手順について詳しく説明します。</p>


  <h2>セットアップ</h2>


  <h4>ストレージ アカウントの作成</h4>


  <p>最初に必要なものの 1 つは、スナップショットのターゲットとして使用するストレージ アカウントです。 Azure Portal で[新規]、 [データ + Storage]、または [Storage アカウント] を選択し、要件 (LRS、ZRS、GRS、RA-GRS) に最適な冗長性オプションを使用して新しいストレージ アカウントを作成します。</p>


  <p><img alt="image" border="0" height="302" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/19aa1201-8600-4f6c-a8ae-153284861c43.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="610"></p>


  <p>作成したら、ストレージ アカウント名とアクセス キーの 1 つをコピーします。Elasticsearch クラスターをデプロイするときに必要になります。 この情報を取得するには、ストレージ アカウントを開き、[すべての設定] を展開し、[アクセス キー] を選択します。 ストレージ アカウント&#39;アクセス キーを見つけるには、コピー ボタンをクリックしてクリップボードにコピーし、後で入手しやすくするために メモ帳 ドキュメントに貼り付けます。</p>


  <p><img alt="image" border="0" height="397" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/86fec469-10ff-43a6-a3eb-ea35cac73e57.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="421"></p>


  <h4>Azure Cloud プラグインをインストールして Elasticsearch クラスターを構築する</h4>


  <p><a href="https://github.com/Azure/azure-quickstart-templates/tree/master/elasticsearch">Elasticsearch 用の Azure</a> クイック スタート テンプレートが最近更新され、Azure Cloud プラグインをインストールして構成する機能が含まれます。 クラスターをデプロイするには、テンプレートリンクの [GitHubに移動し、[ Azure にデプロイ] ボタンをクリックします。 これにより、Azure Portal に戻り、クラスターを Azure サブスクリプションにデプロイできます。 環境に関連するその他のパラメーターをカスタマイズするか、既定値を使用できます。</p>


  <p>インストールする Elasticsearch の最新バージョン (この記事の執筆時点では 2.3.1) を選択してください。 プラグインに関連する追加の入力パラメーターがいくつか追加されています (CLOUDAZURE、CLOUDAZURESTORAGEACCOUNT、CLOUDAZURESTORAGEKEY)。 プラグインを自動的にインストールして構成できます。 [はい] を選択してプラグインをインストールし (既定では no に設定されています)、先に作成したストレージ アカウントの名前とストレージ アカウント キーを入力します。</p>


  <p><img alt="image" border="0" height="156" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c935f07b-30b7-45d5-94af-05e4385ce526.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="250"></p>


  <p>このプラグインの実装では、ストレージ アカウント <code>elasticsearch.yml</code> とキーを指定するクラスター内の各ノード上のファイルに、いくつかの追加の構成行が追加されます。 使用できるパラメーターの詳細については、 <a href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/cloud-azure-repository.html">Elasticsearch Azure リポジトリのドキュメント ページを参照してください</a>。</p>


  <p><img alt="image" border="0" height="192" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/df7b90eb-717f-4f0c-b4ae-e25a329ffd19.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="610"></p>


  <p>クラスターをデプロイしたら、インデックスを作成し、スナップショット プロセスを実行する準備が整います。</p>


  <h4>インデックスを作成して設定する</h4>


  <p>デモンストレーションのために、スナップショットと復元に必要な手順を説明するために、データの基本的なインデックスを作成します。 これを行うには、クラスターと一緒にデプロイされた Sense UI を使用しますが、curl または標準の HTTP 要求を送信できるその他のユーティリティを使用することもできます。 Sense は Kibana サーバーにデプロイされます。URL を取得するには、クラスターを含む親リソース グループを開き、[最後のデプロイ] リンクをクリックします。</p>


  <p><img alt="image" border="0" height="224" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/90865dea-77a6-4795-8b25-1cabd42d9be1.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="360"></p>


  <p>[Kibana] を選択すると、デプロイからの KIBANA-URL 出力が表示されます。コピー ボタンをクリックして、URL をクリップボードにコピーします。</p>


  <p><img alt="image" border="0" height="265" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a67e9d30-e093-4a18-a290-a263f9996b61.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="480"></p>


  <p>Sense の URL は、IP <a href=""></a>アドレスに置き換える です。 意味では、サーバー URL を Elasticsearch ノードの内部アドレスの 1 つに更新します。</p>


  <p><img alt="image" border="0" height="109" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/b4092cc1-0f29-4902-be97-4abb28e345a6.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="250"></p>


  <p>これで、いくつかのドキュメントを含む という名前 <code>myindex</code> のインデックスを作成できます。 次の HTTP 要求をコピーして Sense に貼り付け、緑色の矢印をクリックして各コマンドを実行します (矢印を表示するには、各コマンドにカーソルを置く必要があります)。</p>


  <pre class="prettyprint">

  PUT myindex

  {
    &quot;number_of_shards&quot; : 1,
    &quot;number_of_replicas&quot; : 0
  }</pre>


  <pre class="prettyprint">

  POST /myindex/documents

  {
    &quot;name&quot; : &quot;document1&quot;,
    &quot;content&quot; : &quot;Some example content for document1&quot;
  }</pre>


  <pre class="prettyprint">

  POST /myindex/documents

  {
    &quot;name&quot; : &quot;document2&quot;,
    &quot;content&quot; : &quot;Some example content for document2&quot;
  }</pre>


  <pre class="prettyprint">

  POST /myindex/documents

  {
    &quot;name&quot; : &quot;document3&quot;,
    &quot;content&quot; : &quot;Some example content for document3&quot;
  }</pre>


  <p>次に、次のコマンドを実行すると、新しく作成されたインデックスを表示し、それを検索して、追加したエントリを確認できます。</p>


  <pre class="prettyprint">

  GET _cat/indices?v

  GET myindex/_search</pre>


  <p>インデックスが作成されたので、スナップショットを使用してアーカイブするプロセスを実行します。</p>


  <h2>インデックスのスナップショットとアーカイブ</h2>


  <h4>スナップショット リポジトリを作成する</h4>


  <p>まず、リポジトリを作成する必要があります。 リポジトリは、スナップショットを格納する場所を示す論理コンテナーであり、この場合はスナップショットを Azure に格納します。 意味で次を実行して、新しいリポジトリを設定します。</p>


  <pre class="prettyprint">

  PUT _snapshot/myrepository

  {
    &quot;type&quot; : &quot;azure&quot;
  }</pre>


  <p>これにより、 ファイルで指定されたストレージ アカウント <code>myrepository</code> のパラメーターを使用して、 という名前の新しいリポジトリが作成 <code>elasticsearch.yml</code> されます。</p>


  <h4>スナップショットを取得する</h4>


  <p>次に、インデックスのスナップショットを作成します。</p>


  <pre class="prettyprint">

  PUT /_snapshot/myrepository/myindexsnapshot

  {
    &quot;indices&quot; : &quot;myindex&quot;,
    &quot;include_global_state&quot; : false
  }

  </pre>


  <p>ここでは、いくつかのオプションを指定しました。 1 つ <code>indices</code> 目は、このスナップショットに含めるインデックス (またはコンマで区切られたインデックス) を指定できるです。 2 番目 <code>include_global_state</code> のオプションは、クラスターのグローバル状態がスナップショットに含まれるのではなく、アーカイブするインデックスだけである false に設定したオプションです。 次の要求を使用して、スナップショットの進行状況の状態を監視できます。</p>


  <pre class="prettyprint">

  GET _snapshot/myrepository/myindexsnapshot/_status</pre>


  <p>スナップショットが完了したら、その状態は である必要があります <code>SUCCESS</code>。</p>


  <p><img alt="image" border="0" height="217" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/75763f67-7411-4c80-a193-f0b4a0d88aca.png" style="border-width: 0px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;" title="image" width="300"></p>


  <p>ストレージ アカウントを確認すると、BLOB コンテナー内のインデックスに関連付けられているファイルが表示されます。このファイルは、既定では と呼ばされています <code>elasticsearch-snapshots</code>。 これは、<code>cloud.azure.storage.default.container</code><code>elasticsearch.yml</code>スナップショットを格納するコンテナーの名前を&#39;パラメーターを構成ファイルに追加するか、HTTP 要求で container オプションを渡して構成できます。</p>


  <h4>インデックスを削除する</h4>


  <p>これでインデックスのスナップショットが作成されたので、それを閉じてインデックスに何も書き込みされていないことを確認し、クラスターから削除することができます。</p>


  <pre class="prettyprint">

  POST myindex/_close

  DELETE myindex</pre>


  <p>この時点で、インデックスはクラスター上に存在しなくなったので、スナップショットで使用されている Azure Blob Storage 以外のリソースは使用できません。</p>


  <h2>インデックスを復元する</h2>


  <p>インデックスを同じクラスターに復元するプロセスは簡単です。 リポジトリは既に登録済み (登録解除されていない場合) ので、クラスターに復元するリポジトリとスナップショットを次のように単に POST します。</p>


  <pre class="prettyprint">

  POST _snapshot/myrepository/myindexsnapshot/_restore</pre>


  <p>スナップショットを別のクラスターに復元することもできます。 同じ Azure Cloud プラグイン設定を使用するように構成された 2 つ目のクラスターがある場合は、クラスターにリポジトリを登録する必要があります。</p>


  <pre class="prettyprint">

  PUT _snapshot/myarchiverepository

  {
    &quot;type&quot;:&quot;azure&quot;
  }</pre>


  <p>リポジトリの名前が異なっています。 これは、単に、リポジトリの名前が、スナップショットが作成されたクラスターの名前と一致する必要はないが、スナップショット自体の名前を一致する必要があるという点を示すものです。 リポジトリが登録されたので、インデックスを復元できます。</p>


  <pre class="prettyprint">

  POST _snapshot/myarchiverepository/myindexsnapshot/_restore</pre>


  <p>次のコマンドを実行して回復を監視できます。このコマンドを実行すると、クラスター上の復旧アクティビティの詳細が表示されます。 その他のオプションについては、 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-recovery.html">Elasticsearch のインデックスの回復に関するドキュメントを参照してください</a>。</p>


  <pre class="prettyprint">

  GET _cat/recovery?v</pre>


  <p>インデックスに対して検索を実行すると、最初にインデックスを作成するときに追加されたエントリが表示されます。</p>


  <pre class="prettyprint">

  GET myindex/_search</pre>


  <h2>詳細情報</h2>


  <p>Elasticsearch 用の Azure Cloud プラグインは、Elasticsearch インデックスを低コストの Azure Blob Storage にアーカイブするための優れたオプションを提供します。このオプションを使用すると、古いインデックスやすぐにオンライン状態で不要になったインデックスの維持に関連するリソースと費用を削減できます。 Azure IaaS または Elasticsearch Azure Cloud プラグインで Elasticsearch を実行する方法の詳細については、次のリンクを参照してください。</p>


  <ul>
   <li><a href="https://azure.microsoft.com/en-us/documentation/articles/guidance-elasticsearch/">Azure での Elasticsearch ガイダンス</a></li>
   <li><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/current/cloud-azure.html">Elasticsearch Azure Cloud プラグイン</a></li>
   <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html">Elasticsearch のスナップショットと復元</a></li>
  </ul>


  <p>&nbsp;</p>


  <p><em>この投稿に</em><a href="https://azure.microsoft.com/en-us/blog/author/hkrijger/"><em>関して、Hans Krijger</em></a> と <em> Harold Perry</em> の協力に感謝します。</p>
