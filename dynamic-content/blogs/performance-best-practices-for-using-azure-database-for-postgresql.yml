### YamlMime:Yaml
ms.openlocfilehash: 902ccb3fb38dda1c3df164106538efcaf61b211d
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139891415"
Slug: performance-best-practices-for-using-azure-database-for-postgresql
Title: Azure Database for PostgreSQL でのパフォーマンスのベスト プラクティス
Summary: Microsoft は、Azure Database Services for PostgreSQL と MySQL のパブリック プレビューをビルド 2017 で発表しました。これは、 を削除する PostgreSQL および MySQL 用のシンプルでフル マネージドのデータベース サービスです。
Content: "<p>Microsoft は、<a href=\"https://azure.microsoft.com/en-us/blog/announcing-azure-database-for-postgresql-preview/\" target=\"_blank\"></a>Azure Database Services for PostgreSQL と MySQL のパブリック プレビューをビルド 2017 で発表しました。これは、インフラストラクチャ管理、データの可用性、保護、スケールに関する複雑さを取り除く、PostgreSQL および MySQL 用のシンプルでフル マネージドのデータベース サービスです。 このサービスは大きな成長を見てきたので、サービスで最適なクエリ パフォーマンスを実現するためのベスト プラクティスについてお客様からご連絡を差し上げてきたのです。 この投稿では、バックエンド データベースとしてデータ を使用してパフォーマンスをトラブルシューティングAzure Database for PostgreSQL方法について説明します。</p>\n\n<p>使用パターンに基づいて、2 つの一般的なデプロイ パターンが表示されます。</p>\n\n<ul>\n <li>データベースに接続するアプリケーション サーバー上の Web エンドポイントを公開するアプリケーション サーバー。</li>\n <li>クライアントがデータベースに直接接続するクライアントとサーバーのアーキテクチャ。</li>\n</ul>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/ebec4fc5-93be-4ee6-8205-b6dbd743765e.png\"><img alt=\"Azure Database for PostgreSQL\" border=\"0\" height=\"697\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/f3d30f5c-483f-4390-b9f3-985ee1af3ab1.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Azure Database for PostgreSQL\" width=\"1154\"></a></p>\n\n<p>サービスを使用するアプリケーションまたはサービスのパフォーマンスAzure Database for PostgreSQL、次のカテゴリに大きく分類できます。 詳細については、下の箇条書きのセクションの番号を参照してください。</p>\n\n<p>クライアント上のリソースの問題 (CPU、メモリ、ディスク<strong>) &ndash;クライアントとして機能するマシン/サーバーには、タスク マネージャー、Azure portal、または CLI (クライアント コンピューターが Azure で実行されている場合) で識別できるリソース制約が含まれます。1.</strong></p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7c34d278-73c5-486d-b37a-59bf264aecb3.png\"><img alt=\"Pic1\" border=\"0\" height=\"430\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0557d5ad-0782-4532-95e5-4de954e37c2c.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Pic1\" width=\"1024\"></a></p>\n\n<p><strong>2. リソースの問題 (CPU、メモリ、ディスク) &ndash;</strong> アプリケーション サーバーとして機能するマシン/サーバーによってリソースの制約が発生する可能性があります。リソース制約は、アプリケーション サーバー/サービス VM が Azure で実行されている場合は、タスク マネージャー、Azure portal、または CLI で識別できます。 アプリケーション サーバーが Azure サービスまたは仮想マシンの場合、Azure メトリックはリソースの問題の特定に役立ちます。</p>\n\n<p><strong>3. Azure Database for PostgreSQL 上のリソースの問題 データベース &ndash;</strong> サービスで、CPU、メモリ、ストレージに関連するパフォーマンスのボトルネックが発生している可能性があります。これは、データベース サービス インスタンスの Azure メトリックから判断できます。 詳細については、以下を参照してください。 詳細については、監視の詳細に関する記事を <a href=\"https://docs.microsoft.com/en-us/azure/postgresql/concepts-monitoring\" target=\"_blank\">Azure Database for PostgreSQL</a>。</p>\n\n<p><a href=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/be6d2ef6-83c0-4b70-964d-1a223dad370e.png\"><img alt=\"Pic2\" border=\"0\" height=\"429\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/2e366381-55ec-4d3e-82bc-465ebfd42222.png\" style=\"border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;\" title=\"Pic2\" width=\"1024\"></a></p>\n\n<p><strong>4. ネットワーク待機時間 パフォーマンス &ndash;</strong> のトラブルシューティング中に発生する一般的な問題の 1 つは、クライアントとデータベース サービス インスタンス間のネットワーク待機時間です。&nbsp;パフォーマンス ベンチマークの実行を開始する前に、簡単な SELECT 1 クエリを使用して、クライアントとデータベース間のネットワーク待機時間を確認します。 ほとんどのリージョンでは、Azure でホストされているリモート クライアントを Azure Database for PostgreSQL サーバーと同じリージョンとリソース グループで使用する場合、SELECT 1 のタイミングで待機時間が 2 ミリ秒未満になります。</p>\n\n<p>psql を使用して SELECT 1 のタイミングを取得するコマンド:</p>\n\n<pre>\n\\timing\nSELECT;\n\\watch 1</pre>\n\n<p>お客様は、アプリケーション サーバーとデータベース サービスを同じリージョン、リソース グループに作成し、アプリケーション サーバー/クライアント マシンに高速ネットワークを使用することで、アプリケーションのスループットを大幅に向上させることができます 。該当する場合は、 <strong>高速ネットワークを使用すると</strong> 、VM への単一ルート I/O 仮想化 (SR-IOV) が可能で、ネットワーク パフォーマンスが大幅に向上します。 この高パフォーマンスのパスによってデータパスからホストがバイパスされ、サポートされる VM タイプの最も要件の厳しいネットワーク ワークロードで使用した場合でも、待機時間、ジッター、CPU 使用率が軽減されます。 高速ネットワークをサポートする OS リリースの詳細については、高速ネットワークを使用して仮想マシンを作成する手順 <a href=\"https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-create-vm-accelerated-networking\" target=\"_blank\">に従ってください</a>。</p>\n\n<h2>データベースのパフォーマンス</h2>\n\n<p>考えられる根本原因としてリソースの問題を排除したら、最も長い期間に寄与しているデータベース サーバーに対するクエリを特定する必要があります。 これは、 モジュールを使用 <a href=\"https://www.postgresql.org/docs/9.6/static/pgstatstatements.html\" target=\"_blank\">pg_stat_statements</a> できます。 コミュニティ PostgreSQL とのパリティは維持されています。PostgreSQL でのクエリ パフォーマンスのトラブルシューティングに使用したネイティブ クエリは、サービスにも適用されます。</p>\n\n<p>Azure Database for PostgreSQL サーバーで次のクエリを実行して、パフォーマンス/ベンチマークの実行中に実行された上位 5 期間のクエリを取得できます。</p>\n\n<pre>\nSELECT query, calls, total_time, rows, 100.0 * shared_blks_hit/           \nnullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent\nFROM pg_stat_statements\nORDER BY total_time\nDESC LIMIT 5</pre>\n\n<p>次のクエリを使用して<a href=\"https://www.postgresql.org/docs/9.6/static/pgstatstatements.html\" target=\"_blank\"></a>pg_stat_statementsをリセットして、パフォーマンス/ベンチマークの実行からのみステートメントをキャプチャすることをお勧めします。</p>\n\n<pre>\nSELECT pg_stat_statements_reset()</pre>\n\n<h2>ポップ ヒント</h2>\n\n<p>Azure Database for PostgreSQL サーバーの <em><strong> CPU</strong> 使用率が 100% </em> で飽和している場合は、次に高いレベルのコンピューティング ユニットを選択して CPU を増やします。たとえば、Standard 100 の営業時間中に CPU 使用率が約 100% 継続的にホバーしている場合は、Standard 200 を検討する価値がある可能性があります。</p>\n\n<p>よくある問題は、データベースに既定で含まれるストレージ <strong></strong> サイズ (125 GB) の使用です。 125 GB の既定のストレージ サイズは <strong>、375 IOP に制限されています</strong>。 アプリケーションで高い IOP が必要な場合は、より大きなストレージ サイズの Azure Database for PostgreSQL サーバーを作成して、より多くの IOP を取得して、アプリケーションのパフォーマンスがストレージ調整の影響を受けない場合に推奨されます。</p>\n\n<p><em>MySQL/PostgreSQL のパフォーマンスのトラブルシューティングで <strong>IO</strong> 待機が観察された場合は、IO スループットを高くするには、ストレージ サイズを増やす必要があります。 </em>たとえば、 <strong>walWriteLock</strong> を pg_stat_activity を使用した最大要求の待機イベントの種類として観察した場合、ストレージ のパフォーマンスが割り当てられたストレージ サイズでスケーリングされるので、ストレージ サイズが大きいサーバーを使用すると便利です。</p>\n\n<p>WRITE Ahead Log 書き込みに関連する IO ボトルネックを示す WALWriteLock の待機数を確認するクエリ:</p>\n\n<pre>\nselect wait_event, wait_event_type, count(*) as counts\nfrom pg_stat_activity\ngroup by wait_event, wait_event_type;</pre>\n\n<p>アプリケーション サーバー/クライアント マシンを Azure の同じリージョンとリソース グループに含め、クライアント/アプリケーション サーバーとデータベースの間を減らすことをお勧めします。</p>\n\n<p>パフォーマンスのテストに <strong>pgbench</strong> を使用している場合は、少なくとも接続数よりも多いスケール ファクターを使用して、パフォーマンス ベンチマークが更新プログラムの問題でボトルネックにならなくなっています。 たとえば、pgbench3 を実行するために 100 接続を使用している場合は、少なくとも 100 以上のスケール ファクターを使用する必要があります。</p>\n\n<p>アプリケーション サーバーとして機能する仮想マシンのメモリまたは <em>CPU </em>使用率に関連するリソースのコンサイションが発生し、アプリケーションで可能なすべての最適化が実装されている場合は、仮想マシンのサイズを増やして、仮想マシンで使用可能なコンピューティングとメモリを増やしてください。</p>\n\n<p>アプリケーション サーバーとして機能する仮想マシンで IO 関連のボトルネックが見られる場合は、アプリケーション ファイルをホストするディスク サイズを増やし、場合によっては <a href=\"https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview\" target=\"_blank\">プレミアム Managed Disks</a> の使用を評価する必要があります。</p>\n\n<p>パフォーマンスの問題が解決し、サポートが必要な場合は、次のオプションがあります。</p>\n\n<ul>\n <li>Microsoft サポートでサポート インシデントを開きます。</li>\n <li><a href=\"https://social.msdn.microsoft.com/Forums/en-US/home?forum=AzureDatabaseforPostgreSQL\" target=\"_blank\">MSDN フォーラムに質問を投稿してください</a>。</li>\n <li>にツイートを送信します <a href=\"https://twitter.com/AzureDBPostgres\" target=\"_blank\">@AzureDBforPostgreSQL</a>。</li>\n</ul>\n\n<h2>リファレンス</h2>\n\n<ul>\n <li><a href=\"https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-create-vm-accelerated-networking\" target=\"_blank\">高速ネットワークを使用した仮想マシンの作成</a></li>\n <li><a href=\"https://wiki.postgresql.org/wiki/Pgbenchtesting\" target=\"_blank\">Pgbench のテスト</a></li>\n <li><a href=\"https://wiki.postgresql.org/wiki/Performance_Optimization\" target=\"_blank\">PostgreSQL のパフォーマンスの詳細</a></li>\n <li><a href=\"https://docs.microsoft.com/en-us/azure/postgresql/concepts-compute-unit-and-storage\" target=\"_blank\">コンピューティング ユニットのAzure Database for PostgreSQL</a></li>\n</ul>"
