### YamlMime:Yaml
ms.openlocfilehash: cb1abf110e0e4cd482cafd333431591557e4f591
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139908875"
Slug: microsoft-365-boosts-usage-analytics-with-azure-cosmos-db-part-2
Title: Microsoft 365 Azure Cosmos DB を使用して使用状況分析を向上させる – パート 2
Summary: この投稿は、組織が現実世界のニーズを満たすために Azure Cosmos DB を使用する方法と、それが彼らに与える違いについて、2 部構成のシリーズの一部です。 この投稿では、追加の実装の詳細と、チームの取り組みによって得られる結果を確認します。
Content: >-
  <p><i>この投稿は、組織が現実世界のニーズを満たすために Azure Cosmos DB&rsquo; を使用する方法と、その違いについて、2 部構成のシリーズの一部です。パート <a href="https://azure.microsoft.com/en-us/blog/microsoft-365-boosts-usage-analytics-with-azure-cosmos-db/">1</a> では、Microsoft 365 使用状況分析チームがアクションを実行するための課題、新しいソリューションのアーキテクチャ、および実稼働ワークロードの移行について説明しました。この投稿では、追加の&rsquo;実装の詳細と、チームの取り組みによって得られる結果を&rsquo;確認します。</i></p>


  <h2>適切なパーティション キーを見つける&mdash;重要な設計上の決定</h2>


  <p>Azure Cosmos DB に移行した後、チームはデータのパーティション分割方法を見直しました (&ldquo;&rdquo;MongoDB ではシャーディングと呼ばれます)。 Azure Cosmos DB では、各コレクションにパーティション キーが必要です<a href="https://docs.microsoft.com/en-us/azure/cosmos-db/partitioning-overview"></a>。パーティション キーは、データの論理パーティションとして機能し、パーティション間でデータを分散するための自然な境界を Azure Cosmos DB に提供します。 1 つの論理パーティションのデータは、1 つの物理パーティション内に存在する必要があります。 物理パーティション管理は、Azure Cosmos DB によって内部的に管理されます。</p>


  <p>Microsoft 365分析チームは、Azure Cosmos DB チームと密接にやり取りし、高パフォーマンスを確保する方法でデータ分散を最適化しました。 チームは最初、パーティション キーとしてランダムな GUID を使用した MongoDB と同じアプローチを試しました。 ただし、この場合、すべてのパーティションをスキャンして読み取りを行い、書き込み用にリソースを割り当てる必要があります。書き込み速度は速くなりますが、読み取りは遅くなります。 その後、チームはパーティション キーとしてテナント ID を使用してみましたが、各テナントのレポート データの量の大きな違いによって、一部のパーティションがホットすぎて、調整が必要だったのに対し、他のパーティションはコールドのままでした。</p>


  <p>ソリューションは、合成パーティション <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/synthetic-partition-keys">キーの作成に置かされています</a>。 最後に、チームは、テナント ID ごとに 100 のドキュメントをバケットにグループ化し、テナント ID とバケット ID の組み合わせをパーティション キーとして使用することで、読み取りが遅い問題と、ホットすぎる問題とコールドすぎる問題の両方を解決しました。 バケット ID は 1 から n までループ <i>します</i> 。 <i>n</i> は変数であり、各レポートに合わせて調整できます。</p>


  <h3>毎日 4 テラバイトの新しいデータを処理する</h3>


  <p>1 つのリージョンだけで、6 TB を超えるデータが Azure Cosmos DB に格納され、その 4 TB が毎日書き込みおよび更新されます。 これらの数値はどちらも増加し続けています。 データベースは 50 を超える異なるコレクションで構成され、最大サイズは 300 GB を超えるサイズです。 1 秒あたり平均 150,000 要求ユニット (RU<a href="https://docs.microsoft.com/en-us/azure/cosmos-db/request-units"></a>/秒) のスループットを消費し、必要に応じてこの数をスケールアップおよびスケールダウンします。</p>


  <p>異なるコレクションは、システムが提供するさまざまなレポートに密接にマップされます。また、スループット要件も異なります。 この設計により、Microsoft 365 使用状況分析チームは、各コレクション (および各レポート) に割り当てられる <a href="https://docs.microsoft.com/en-ca/azure/cosmos-db/how-to-provision-container-throughput">RU/秒</a>の数を最適化し、コレクションごとにレポートごとにそのスループットを柔軟にスケールアップまたはスケールダウンできます。</p>


  <h2>組み込みのコスト効率の高いスケーラビリティとパフォーマンス</h2>


  <p>Azure Cosmos DB を使用すると、Microsoft 365&mdash; 使用状況分析チームは、メンテナンスが少なく、パフォーマンスが向上し、可用性が向上し、低コストでリアルタイムの顧客分析情報を提供しています。 新しい使用状況分析システムは、商用顧客の数の増加に対応するために、Office 365に拡張できます。 サービスが中断することなく、5 か月未満で完了したすべて。 &ldquo;MongoDB から Azure Cosmos DB&rdquo; に移行する利点は、実行した労力を正当化する以上に大きいと、Microsoft 365 使用状況分析チームのプリンシパル ソフトウェア開発マネージャーである Guo Chen は言います。</p>


  <h3>パフォーマンスとサービスの可用性の向上</h3>


  <p>チームは、&rsquo;組み込みのターンキー geo ディストリビューションを使用して、2 つのリージョン間で読み取りと書き込みを簡単に分散する方法を提供しました。 Azure Cosmos DB Core (SQL) API を使用したデータ アクセス層の書き換えなど、チームが行った他の作業と組み合わせると、チームは読み取りの大部分の時間を 12 ミリ秒から 3 ミリ秒に短縮できます。 次の図は、このパフォーマンスの向上を示しています。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/d5ff7c82-0c12-449a-a3a1-f17c4bdbee6f.png"><img alt="The move to Azure Cosmos DB led to a 4x improvement in average query speeds." border="0" height="290" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/a6aec864-7945-4966-b1cc-444975a4dafa.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="" width="1024"></a></p>


  <p>この違いは、レポートを表示するコンテキストではごくわずかに見えますが、サービスが大幅に改善されました。 &ldquo;使用状況分析システムのレポート データにアクセスするには、Microsoft 365 管理センター を通じてアクセスする方法と、Microsoft Graph&rdquo; を通じてアクセスする方法の 2 つがあります。「Microsoft 365 Usage Analytics チームのソフトウェア エンジニアである、 &ldquo;過去には、API の使用が遅すぎるとGraphのユーザーから苦情が出ていました。 これは&rsquo;問題ではなくなりました。 さらに、クエリのタイミングが減る可能性が低くなるので、サービスの可用性が向上しました。&rdquo;</p>


  <p>次の図は、サービスの可用性が向上した量を示しています。 このグラフは、成功した API 要求を API 要求の合計で割って示し、システムが 99.99% を超えるサービス可用性レベルを提供している状況を示しています。</p>


  <p><a href="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/00ef063f-ee22-4b66-aa1b-77d0b697e307.png"><img alt="Service availability is now greater than 99.99 percent." border="0" height="257" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1bac520b-048b-42de-b394-d8108ad60045.png" style="border: 0px currentcolor; border-image: none; margin-right: auto; margin-left: auto; float: none; display: block; background-image: none;" title="" width="1024"></a></p>


  <h3>メンテナンスと管理が不要</h3>


  <p>Azure Cosmos DB はフル マネージド サービスなので、Office 365 開発チームは、1 人のフルタイムユーザーをデータベースのメンテナンスと管理に専念する必要がなくなりました。 年間証明書のメンテナンスは負担ではなくなりました。また、サービスの可用性の侵害から保護するために、VM を毎週再起動する必要がなくなりました。</p>


  <p>&ldquo;以前は、MongoDB&rdquo; では、データ ストアの管理管理にコア開発者リソースを割り当てる必要がありました。Microsoft 365 使用状況分析チームのプリンシパル プログラム マネージャーである Shilpi Sinha は言います。 &ldquo;フル マネージド サービスで実行できたので、インフラストラクチャを管理する代わりに、新しい顧客価値の追加に向けて開発者リソースを再利用できます。&rdquo;</p>


  <h3>柔軟なスケーラビリティ</h3>


  <p>Microsoft 365 使用状況分析チームは、3 か月ごとに平均で 8% の割合で増加している変動するワークロードに対応するために、必要に応じて、データベースのスループットをオンデマンドでスケールアップまたはスケールダウンできます。 各コレクションに割り当てられる RU/s の数を調整するだけで、Azure portal またはプログラムで行うことができます。チームは、新しいレポートを処理するために、データインジェストの負荷の高い期間中に簡単にスケールアップできます。最も重要なのは、世界中の Office 365 の継続的な成長に対応することです。</p>


  <p>&ldquo;現在、行う必要がある&rdquo; のは、要求ユニットの使用量と予算を設定した量に対する監視を行う必要があるというのが、"1 人" と言います。 &ldquo;容量に&rsquo;達した場合は、わずか数分でより多くの RU/s を割り当てできます。 必要になるまで&rsquo;予備容量の料金を支払う必要はありません。さらに重要なこととして、データ ボリュームの将来の増加に対処できるかどうか、または使用状況を報告できるかどうかを心配する必要がなくなりました。&rdquo;</p>


  <h3>低コスト</h3>


  <p>これらの利点の上に、Microsoft 365 使用状況分析チームは、使用状況分析システムに対する毎月の Microsoft Azure 請求を 13% 以上削減しながら、データとレポートの量を増やしました。 &ldquo;Azure Cosmos DB に切り上げた後、毎月の Azure の経費は約 20%&rdquo; 減少しました。Chen は言います。 &ldquo;お客様にサービスを提供するために、このプロジェクトに取りかかっています。 年間 400&mdash;&mdash; 万ドルに近い節約が可能で、将来さらに節約できる可能性が高いのは、チップの上のアイシングなどです。&rdquo;</p>


  <p>&ldquo;使用状況分析は、購入するサブスクリプションの種類に関係&quot;なく、すべての Microsoft 365 顧客に対して基本機能の一部として提供されます。Sinha は述べています。 &quot;このサービスの運用コストを可能な限り低く抑えることは、Microsoft 365 サービス全体を可能な限り効率的に実行すると同時に、お客様のユーザーがサービスを使用している方法に関する新しい改善された分析情報を提供するという目標に貢献します。&rdquo;</p>


  <p><a href="https://docs.microsoft.com/en-us/office365/admin/usage-analytics/usage-analytics?view=o365-worldwide">Microsoft Usage Analytics と Azure Cosmos</a> <a href="https://azure.microsoft.com/en-us/services/cosmos-db/">DB の詳細を確認</a>してください。</p>
