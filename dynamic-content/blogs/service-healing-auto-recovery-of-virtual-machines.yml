### YamlMime:Yaml
ms.openlocfilehash: 9a3b4893e1b5a796342f71d2be0e77ef0cd1c2aa
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139892540"
Slug: service-healing-auto-recovery-of-virtual-machines
Title: サービス復旧 - 仮想マシンの自動復旧
Summary: このブログ記事では、障害が発生した場合の Azure でのサービス復旧/自動復旧のメカニズムについて説明します。
Content: >-
  <p align="justify">7 年近く前の PDC 2008 でのパブリック プレビューの開始以降、Microsoft Azure は、プラットフォーム上で実行されている仮想マシン (VM) の正常性を検出し、障害が発生した場合にそれらの仮想マシンの自動復旧を実行する手段を提供してきました。 自動復旧のこのプロセスは、サービス インスタンス&ldquo;&rdquo;&ldquo;を復旧する手段として、サービス復旧と&rdquo;呼ばれます。&nbsp;サービス復旧 (つまり自動復旧) は、クラウドでビジネス クリティカルなワークロードを実行する上で不可欠な部分と考えています。そのため、この自動復旧メカニズムは、すべての Azure リージョンとデータセンター全体で、さまざまな <strong>VM</strong> サイズとオファリングにわたって仮想マシンで有効にされ、使用できます。 このブログ記事では、障害が発生した場合の Azure でのサービス復旧/自動復旧のメカニズムについて説明します。</p>


  <p align="justify">障害からの復旧における重要な側面は、まず障害が発生したという検出です。 障害を検出する時間が短い場合、障害が発生した場合に仮想マシンがダウンしならずにいます。 これは、平均検出時間 (MTTD) とも呼ばれます。 Microsoft Azure クラウド オペレーティング システムのカーネルであるファブリック コントローラーには、すべての仮想マシンの状態と、その中で実行されるコード (Web ロールまたは Worker ロールの場合) を追跡する多くの正常性プロトコルがあります。</p>


  <p align="justify">次の図は、障害が発生する可能性があるシステムの異なるレイヤーと、それらを検出するために Azure が実行する正常性チェックの概要を示しています。 &ndash;</p>


  <p><a href="https://acom.azurecomcdn.net/80C57D/blogmedia/blogmedia/2015/04/07/Service-Healing-Blog-Post-Diagrams.png"><img alt="Service Healing Blog Post Diagrams" border="0" height="414" src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/Service-Healing-Blog-Post-Diagrams_thumb.png" style="float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; padding-right: 0px; margin-right: auto; border: 0px;" title="サービスの回復に関するブログの投稿図" width="640"></a></p>


  <p><strong>Cloud Services：</strong> Web ロールと Worker ロールの場合、コードは Web ロールまたは worker ロール インスタンスで実行されています。 Web ロール&rsquo;の場合、その Web エンドポイントは 15 秒ごとにロード バランサーによって ping され、正常&#39;判断されます。 定義済みの連続する ping の数に対して正常性チェックが失敗した場合、エンドポイントは不健康と見なされ、ロールをローテーションから削除し、ロールを "不健康" としてマークする復旧アクションが実行されます。</p>


  <p><strong>メモ：</strong> これは、カスタム LB プローブではなく、既定の GA ベースのLoad Balancerの場合 <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/jj151530(v=azure.100)" target="_blank">にのみ適用されます</a>。</p>


  <p>Web ロールと worker ロールの両方について、Azure によって VM にゲスト エージェントが挿入され、ロールが監視されます。 また、このゲスト エージェントは、仮想マシンのロール インスタンスの 15 秒ごとに正常性チェックを実行します。 繰り返しますが、定義済みの数の連続する正常性チェックエラーまたはロード バランサーからのシグナルが原因で、ロールが不健康になり、ロール インスタンスを再起動する復旧アクションが開始されます。 Azure&rsquo; 全体でこれらの正常性チェックが 15 秒間隔で実行されるのは、MTTD の改善です。 障害の迅速かつ早期の検出は、障害が発生するとすぐに修正し、依存システムがシステムを介して障害やカスケードを防ぐことを意味します。</p>


  <p>システム内の次のレイヤーは、ロール インスタンスが実行されている仮想マシン自体の正常性です。 仮想マシンは、Azure データセンター内で実行されている物理サーバーでホストされます。 物理サーバーは、ホスト エージェントと呼ばれる別のエージェントを実行します。 ホスト エージェントは、Web ロール VM と worker ロール VM のゲスト エージェントからのハートビートが 15 秒ごとに確保され、仮想マシンの正常性を監視します。 仮想マシンがワークロードの負荷を受けているのは非常に便利です。CPU 使用率が 100%&rsquo; である可能性があるため、正常性チェックの数が不足しても復旧アクションは保証できません。 復旧アクションを開始する前に、仮想マシンが正常性チェックに応答するために最大 10 分かかります。 この場合の回復アクションは、Web &amp; Worker ロールの場合に、クリーンな OS ディスクで仮想マシンをリサイクルします。</p>


  <p><strong>Azure Virtual Machines:</strong> Azure Virtual Machinesの場合、ロール インスタンスは作成されません。既定では、ゲスト エージェントは自動的に挿入されません。 そのため、正常性チェックは、ハイパーバイザーによって報告された仮想マシンの状態に対して実行されます。 VM の電源状態に問題がある場合は、ディスクの状態を維持して再起動を実行します。 Azure Virtual Machinesでは&rsquo;、VM 内で発生する問題に対して何も行っていません。 これには、継続的な高い CPU 使用率、VM OS の停止、VM OS でのアプリケーション エラーが含まれます。 内部 VM OS の問題については、アプリケーション内で監視を設定する必要があります。</p>


  <p>システムの次のレイヤーは、仮想マシンが実行されている物理サーバー自体の正常性です。 ファブリック コントローラーは、ホスト エージェントを介して物理サーバーで正常性チェックを定期的に実行しています。 一定の数&rsquo;の正常性チェックが連続して失敗した場合、物理サーバーは正常とマークされ、マシンが正常な状態に戻らない場合は回復アクションが開始されます。 まず、物理サーバーの再起動を実行します。</p>


  <p align="justify">物理サーバーが定義済&rsquo;みの期間中に正常な状態に戻らない場合は、物理サーバーで実行されている仮想マシンを、データセンターのそのパーティション内の別の正常なサーバーに回復します。</p>


  <p align="justify">その後、物理サーバーはローテーションから取り出され、分離され、障害の原因を特定するための広範な診断が受け、必要に応じて、修理のために製造元に送信されます。</p>


  <p>&nbsp;</p>


  <h2>予防措置を実行する前でも障害を予測する</h2>


  <p align="justify">これまでに説明&rsquo;したのは、障害が発生したケースと、Azure での検出と復旧の方法です。 Azure は、障害に対応するだけでなく、ヒューリスティックを使用して、障害が発生する前に差し迫った障害を予測し、予防措置を取り、平均復旧時間 (MTTR) を改善します。</p>


  <p align="justify">物理サーバー上にあるホスト エージェントは、サーバーと、ディスク、メモリ、その他のハードウェアなど、サーバーに接続されている他のデバイスに関する正常性情報を定期的に収集します。 この情報には、CPU 使用率やディスク IO などのパフォーマンス カウンターだけでなく、他のメトリックも含まれます。 たとえば、ディスク ドライブの不良セクターは、ディスク障害が差し迫っている場合の予測に役立ちます。 これらのサーバー上の仮想マシンの復旧は、障害が発生する前でも可能な限り迅速に実行し、広範な診断のために物理サーバーをに渡します。</p>


  <p>&nbsp;</p>


  <h2>ビッグ データ分析を使用したエラーの分析</h2>


  <p align="justify">Microsoft Azure、プラットフォーム上で実行されているすべての仮想マシンから、テラバイト単位の診断ログ、正常性チェック情報、クラッシュ ダンプが毎日生成されます。 このデータを使用して、障害のパターンを特定します。 これらのログとクラッシュを分析するために、Cosmosと呼ばれる map-reduce &ldquo;<a href="https://bit.ly/1CW8U3f">実装で</a>&rdquo;、自動化されたビッグ データ分析を実行します。 これらの分析は、システム内のバグを特定するのに役立つ、これらの障害のパターンを特定するのに役立ちます。 さらに、多くの場合、これらは、システムを改善したり、既存の機能を改善したりするための新機能を特定するのに役立ちます。 このデータと、ご自身などのお客様からの貴重なフィードバックが組み合わせて、プラットフォームを進化させるのに役立ちます。</p>


  <p align="justify">また、MTTD と MTTR をさらに改善するために、このブログ投稿に記載されている正常性チェックの値をいつでも調整できます。これらは、Azure サービスの回復メカニズムのしくみを説明するために、この記事で提供されています。</p>
