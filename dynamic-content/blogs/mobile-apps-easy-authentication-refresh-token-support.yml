### YamlMime:Yaml
ms.openlocfilehash: ec222b09abcdd546471827f17d184b78a7e0b02b
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139895354"
Slug: mobile-apps-easy-authentication-refresh-token-support
Title: App Service Mobile Apps でのユーザーログインの更新
Summary: Azure Mobile Apps では、更新トークンが認証機能に組み込まれています。これにより、アプリのユーザーのログインを維持することが簡単になりました。
Content: "<p>&nbsp;</p>\n\n<p>Azure App Service&#39;s 認証/承認機能を使用すると、クライアントフローとサーバーフローのどちらで作業している場合でも、アプリの認証を非常にシンプルにすることができます。 それでも、トークンベースの認証を過去に&#39;した場合、トークンの有効期限と更新は面倒になる可能性があります。 認証プロバイダーによっては、トークンの有効期限は数分から数か月まで広範囲に及びます。 Facebook には60日間の有効期限がありますが、Google、Azure AD、Azure での米国などの他の一般的なプロバイダーには、1時間の有効期限があり Mobile Apps。 アプリユーザーの認証とクライアントエクスペリエンスを保証するために、コード内でこれらを処理する必要がありました。これは、 <a href=\"https://shellmonger.com/2016/04/13/30-days-of-zumo-v2-azure-mobile-apps-day-7-refresh-tokens/\">Azure Mobile Apps の30日間</a> で詳細に説明されている Adrian Hall に似ています。更新トークンの投稿です。</p>\n\n<p>このトークンの更新エクスペリエンスを簡単にするために、<a href=\"https://azure.microsoft.com/en-us/documentation/articles/app-service-authentication-overview/\">認証/承認</a> &rsquo; のクライアント sdk に<a href=\"https://tools.ietf.org/html/rfc6749#section-1.5\">Auth 2.0 &rsquo; s 更新トークン</a>を導入しました。 認証用に独自の更新ロジックを追加するのではなく、ここ &rsquo; では、Managed <a href=\"https://www.nuget.org/packages/Microsoft.Azure.Mobile.Client\">Azure MOBILE Client SDK 2.1.0</a>の組み込みトークン更新機能を使用する方法について説明します。 以降のバージョンでは、アプリユーザーがログインしたままになります。</p>\n\n<p>この機能は、サーバーで管理された認証フローでのみ使用できます。 また、セキュリティとアプリの間のバランスが&#39;週末に非アクティブになる可能性があるため、Mobile Apps 認証トークンの有効期限が72時間を超えない限り、更新トークンを取得できます (詳細については、 <a href=\"https://cgillum.tech/2016/03/07/app-service-token-store/\">Chris Gillum&#39;s の投稿</a> を参照してください)。</p>\n\n<h4>Id プロバイダーで更新トークンを使用する方法</h4>\n\n<p><a href=\"https://azure.microsoft.com/en-us/documentation/articles/app-service-mobile-how-to-configure-microsoft-authentication/\">Microsoft アカウント</a>、 <a href=\"https://azure.microsoft.com/en-us/documentation/articles/app-service-mobile-how-to-configure-google-authentication/\">Google</a>、または<a href=\"https://azure.microsoft.com/en-us/documentation/articles/app-service-mobile-how-to-configure-active-directory-authentication/\">Azure Active Directory</a> (<a href=\"https://azure.microsoft.com/en-us/documentation/articles/app-service-mobile-how-to-configure-facebook-authentication/\">Facebook</a>と<a href=\"https://azure.microsoft.com/en-us/documentation/articles/app-service-mobile-how-to-configure-twitter-authentication/\">Twitter</a>はサポートされていません) の手順に従って、モバイルアプリで必要な id プロバイダーを正常に設定したことを前提としています。</p>\n\n<p><u>Microsoft アカウント</u></p>\n\n<p>ポータル &gt; 設定 &gt; 認証/承認 &gt; の Microsoft アカウントで<em>wl.offline_access</em>スコープを有効にします。</p>\n\n<p><img alt=\"clip_image002\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/91a1392a-bb41-41e8-8825-20bdd7eef2c2.jpg\" style=\"border-image: none; width: 400px; height: 319px; padding-top: 0px; padding-right: 0px; padding-left: 0px; display: inline; background-image: none;\" title=\"clip_image002\"></p>\n\n<p>次のスニペットは、サーバーによって管理される認証ワークフローでユーザーを更新するのに役立ちます。</p>\n\n<pre class=\"prettyprint\">\nMobileServiceUser user = await client.LoginAsync(MobileServiceAuthenticationProvider.MicrosoftAccount);          \n//...\nuser = await client.RefreshUser();\n</pre>\n\n<p><u>Google</u></p>\n\n<p>サーバーで管理される認証ワークフローで、 <em>MobileServiceClient ()</em>に追加のパラメーター <em>(access_type = offline)</em>を渡します。</p>\n\n<pre class=\"prettyprint\">\nMobileServiceUser user = await client.LoginAsync(MobileServiceAuthenticationProvider.Google, \n\n                new Dictionary&lt;string, string&gt;() {{ &quot;access_type&quot;, &quot;offline&quot; }});\n//...\nuser = await client.RefreshUser();</pre>\n\n<p><u>AAD</u></p>\n\n<p>Azure Resource Explorer で AAD クライアントシークレットを構成した後<s>(方法&#39;を知らない場合は、<a href=\"https://shellmonger.com/2016/04/13/30-days-of-zumo-v2-azure-mobile-apps-day-7-refresh-tokens/\">こちら</a>の Azure Resource Explorer のスニペットを参照してください)</s> [UPDATE 9/22: ポータル &gt; &gt; で AAD クライアントシークレットを構成できるようになりました。認証/承認 &gt; 設定] で、追加のパラメーター<em>を渡すことができます。</em>サーバーによって管理される認証フローの MobileServiceClient ()。</p>\n\n<pre class=\"prettyprint\">\nMobileServiceUser user = await client.LoginAsync(MobileServiceAuthenticationProvider.WindowsAzureActiveDirectory, \n\n                new Dictionary&lt;string, string&gt;() {{ &quot;response_type&quot;, &quot;code id_token&quot; }});\n//...\nuser = await client.RefreshUser();\n</pre>\n\n<div>&nbsp;</div>\n\n<h4>更新エラーの処理</h4>\n\n<p>RefreshUser は、次の要件が <em>すべて</em> 満たされている場合にのみ機能します。</p>\n\n<ol>\n <li>Id プロバイダーは、OAuth 2.0 &rsquo; s 更新トークンをサポートしています。 Microsoft アカウント、Google、Azure Active Directory は更新トークンをサポートしていますが、Facebook と Twitter ではサポートされていません。</li>\n <li>更新トークンを使用するために必要なアクセス許可またはスコープは、開発者によって付与されます。たとえば、Microsoft アカウントの<em>wl</em>スコープ、Google アカウントの<em>オフライン access_type</em> 、Azure Active Directory アカウントのコード<em>reponse_type</em>です。</li>\n <li>アクセストークンまたは更新トークンが開発者によって取り消されていません。</li>\n <li><em>MobileServiceAuthenticationToken</em> の有効期限が72時間を超えていません。</li>\n</ol>\n\n<p>ここでは、更新呼び出しで発生する可能性があるエラーについて説明します。</p>\n\n<table border=\"1\" bordercolor=\"#ccc\" cellpadding=\"5\" cellspacing=\"0\" style=\"border-collapse: collapse;\">\n <tbody>\n  <tr>\n   <td valign=\"top\" width=\"253\">\n   <p><b>エラー</b></p>\n   </td>\n   <td valign=\"top\" width=\"895\">\n   <p><b>理由</b></p>\n   </td>\n   <td valign=\"top\" width=\"498\">\n   <p><b>どうすればよいでしょうか。</b></p>\n   </td>\n  </tr>\n  <tr>\n   <td valign=\"top\" width=\"253\">\n   <p>400 Bad Request</p>\n   </td>\n   <td valign=\"top\" width=\"899\">\n   <ol>\n    <li>\n    <p align=\"left\">オフラインアクセス許可またはスコープがない</p>\n    </li>\n    <li>\n    <p align=\"left\">Id プロバイダー (Facebook、Twitter など) は更新トークンをサポートしていません</p>\n    </li>\n   </ol>\n   </td>\n   <td valign=\"top\" width=\"524\">\n   <p>ユーザーに再ログインを求めるメッセージを表示する</p>\n   </td>\n  </tr>\n  <tr>\n   <td valign=\"top\" width=\"257\">\n   <p>401 権限がありません</p>\n   </td>\n   <td valign=\"top\" width=\"895\">\n   <ol>\n    <li>\n    <p><em>MobileServiceAuthenticationToken</em> が無効です</p>\n    </li>\n    <li>\n    <p><em>MobileServiceAuthenticationToken</em> の有効期限が72時間を超えています</p>\n    </li>\n   </ol>\n   </td>\n   <td valign=\"top\" width=\"495\">\n   <p>ユーザーに再ログインを求めるメッセージを表示する</p>\n   </td>\n  </tr>\n  <tr>\n   <td valign=\"top\" width=\"253\">\n   <p>403 許可されていません</p>\n   </td>\n   <td valign=\"top\" width=\"895\">\n   <ol>\n    <li>\n    <p>アクセストークンが失効しています</p>\n    </li>\n    <li>\n    <p>更新トークンが取り消される</p>\n    </li>\n    <li>\n    <p>取り消されるユーザーアクセス許可</p>\n    </li>\n   </ol>\n   </td>\n   <td valign=\"top\" width=\"524\">\n   <p>ユーザーに再ログインを求めるメッセージを表示する</p>\n   </td>\n  </tr>\n </tbody>\n</table>\n\n<p>&nbsp;</p>\n\n<p>試してみて、ご意見をお聞かせください。</p>"
