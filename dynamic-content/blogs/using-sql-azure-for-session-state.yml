### YamlMime:Yaml
ms.openlocfilehash: a4710624211754877a0bde3d2dd27c96ff4cd3b9
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139895247"
Slug: using-sql-azure-for-session-state
Title: セッション状態に SQL Azure を使用する
Summary: '[この記事は SQL Azure チームによって提供されました。]ハイパーテキスト転送プロトコル (HTTP) はステートレスプロトコルです。ステートレスプロトコルの利点は、web サーバーで保持する必要がないということです。'
Content: "<p>[この記事は SQL Azure チームによって提供されました。]</p><p><a href=\"https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol\">ハイパーテキスト転送プロトコル</a> (HTTP) はステートレスプロトコルです。ステートレスプロトコルの利点は、web サーバーが要求間でユーザーに関する情報を保持する必要がないことです。 ただし、web サイトの開発者は、web アプリケーションとの一貫性を提供するために、ページ要求間で状態を維持する必要がある場合があります。 ステートレスプロトコルから状態を作成するために、ASP.NET には、ユーザーの最初の要求から web サイトへのアクセス要求まで保持されるセッションの概念があります。 既定では、ASP.NET セッションは、実行中の web サーバーの RAM に保持されます。 ただし<a href=\"https://blogs.msdn.com/b/tims/archive/2009/03/24/overview-of-windows-azure.aspx\">Windows、Azure</a>はステートレスなプラットフォームであるため、web ロールインスタンスはローカルストレージを持ちません。 web ロールインスタンスをデータセンター内の別のサーバーに移動することはいつでも可能です。 Web ロールインスタンスを移動すると、セッション状態は失われます。 ステートレスな web サーバー上でステートレスプロトコルを使用して状態を認識できるようにするには、web ロールインスタンスを移動しても永続化されたサーバー側ストレージが必要です。 この記事では、SQL Azure を使用して Windows Azure で ASP.NET セッション用の永続的なストレージを作成する方法について説明します。</p>  <p>SQL Azure は、既に<a href=\"https://msdn.microsoft.com/en-us/library/aa478952.aspx\">SqlSessionStateStore</a>があるため、Azure Windows でセッションを維持する場合に最適です。オンプレミスの SQL Server インストール用に開発された Microsoft セッション状態プロバイダーです。 SQL server プロバイダーは、コンピューター間でユーザーの状態を維持する必要がある web ファーム内の複数の web サーバーにわたるローカル IIS のインストール用に開発されました。</p>  <p><font color=\"#ff0000\">次のコードは microsoft でサポートされていません。 SQL Azure データベースを使用したセッション状態のサポートポリシーは、このサポート技術情報の記事の「SQL Azure databases for ASP.net applications を使用した SQL セッション状態管理をサポートしていません。 </font> <a href=\"https://support.microsoft.com/kb/2006191\"><font color=\"#ff0000\"></font></a><font color=\"#ff0000\"></font></p>  <h2>テーブルを作成する</h2>  <p>SQL Azure に対して Windows Azure で<a href=\"https://msdn.microsoft.com/en-us/library/aa478952.aspx\">SqlSessionStateStore</a> <b> </b>プロバイダーを使用する場合は、適切なテーブルとストアドプロシージャを作成する必要があります。 通常、これは .net framework (または Aspnet_regsql.exe の<b>– sstype)</b>に付属する<b>installsqlstate .sql</b>スクリプトで実行されます。ただし、このスクリプトは SQL Azure では機能しません。これは、Transact SQL の違いが原因です。 代わりに、変更したスクリプトを使用する必要があります (このブログ記事の下部にあるダウンロードを参照してください)。</p>  <p>ここでは、セッション状態を格納するために必要なデータベース、ストアドプロシージャ、およびテーブルを作成する手順について説明し SQL Azure</p>  <ol>   <li>\" <b>aspstateinstall .sql</b> \" という名前の変更された SQL transact-sql スクリプト<b>をダウンロードし</b>ます。このスクリプトでは、このデータベースを作成します。 </li>    <li>master データベースの SQL Server Management Studio から<b>aspstateinstall .sql</b>スクリプトを実行します。詳細については、SQL Server Management Studio を SQL Azure に接続する方法に関するページを参照してください。 </li>    <li>先ほど作成したデータベースに SQL Server Management Studio 再<b>接続します</b>。 </li>    <li>このデータベースの SQL Server Management Studio からダウンロード<b>した</b> <b>installsqlstate .sql</b>スクリプトを実行します。 </li> </ol>  <h2>web.config の変更</h2>  <p>次に、Azure Windows がセッション状態のストレージとして SQL Azure を使用するように<b>web.config</b>を変更します。 <b>web.config</b>は次のようになります。</p>  <pre class=\"csharpcode\"><span class=\"kwrd\">&lt;</span><span class=\"html\">sessionState</span>    <span class=\"attr\">mode</span><span class=\"kwrd\">=&quot;SQLServer&quot;</span>    <span class=\"attr\">sqlConnectionString</span><span class=\"kwrd\">=&quot;Server=tcp:...;Trusted_Connection=False;Encrypt=True;&quot;</span>    <span class=\"attr\">cookieless</span><span class=\"kwrd\">=&quot;false&quot;</span>    <span class=\"attr\">timeout</span><span class=\"kwrd\">=&quot;20&quot;</span>    <span class=\"attr\">allowCustomSqlDatabase</span><span class=\"kwrd\">=&quot;true&quot;</span>  <span class=\"kwrd\">/&gt;</span></pre>    <p>    <p>必ず<b>sqlconnectionstring</b>を変更して、 <a href=\"https://sql.azure.com/\">SQL Azure ポータル</a>の SQL Azure 接続文字列に一致させてください。 IIS のオンプレミスインストールでこれを実行する場合は、 <b>web.config</b> に対して同じ変更を行うことができます。</p>    <h2>クリーンアップを実行する</h2>    <p>オンプレミス SQL Server を使用して ASP.NET SQL セッション状態管理プロバイダーをインストールすると、インストールによって、古いセッションデータをクリーンアップするジョブが SQL Server エージェントで実行されます。 SQL Azure には SQL Server エージェントの概念がありません。代わりに、Windows Azure ワーカーロールを使用して SQL Azure データベースをクリーンアップできます。 詳細については、SQL Server エージェントのブログシリーズ (パート1、パート2、パート 3) を参照してください。 データベースをセットアップするために実行した<b>Installsqlstate .sql</b>スクリプトには、DeleteExpiredSessions が含まれてい<b>ます</b>。 有効期限が切れたセッションのトリミングは、ワーカーロールからこのスクリプトを呼び出すことによって簡単に行うことができます。 コードは次のようになります。</p>    <pre class=\"csharpcode\"><span class=\"kwrd\">public</span> <span class=\"kwrd\">override</span> <span class=\"kwrd\">void</span> Run()  {      <span class=\"rem\">// This is a sample worker implementation. Replace with your logic.</span>      Trace.WriteLine(<span class=\"str\">&quot;WorkerRole1 entry point called&quot;</span>, <span class=\"str\">&quot;Information&quot;</span>);        <span class=\"kwrd\">while</span> (<span class=\"kwrd\">true</span>)      {          Thread.Sleep(60000);            <span class=\"rem\">// Create a SqlConnection Class, the connection isn't established </span>          <span class=\"rem\">// until the Open() method is called</span>          <span class=\"kwrd\">using</span> (SqlConnection sqlConnection = <span class=\"kwrd\">new</span> SqlConnection(              ConfigurationManager.ConnectionStrings[<span class=\"str\">&quot;ASPState&quot;</span>].                  ConnectionString))          {              <span class=\"kwrd\">try</span>              {                  <span class=\"rem\">// Open the connection</span>                  sqlConnection.Open();                    SqlCommand sqlCommand = <span class=\"kwrd\">new</span> SqlCommand(                      <span class=\"str\">&quot;DeleteExpiredSessions&quot;</span>, sqlConnection);                    sqlCommand.CommandType =                       System.Data.CommandType.StoredProcedure;                    sqlCommand.ExecuteNonQuery();              }              <span class=\"kwrd\">catch</span> (SqlException)              {                  <span class=\"rem\">// WWB: Don't Fail On SQL Exceptions, </span>                  <span class=\"rem\">// Just Try Again After the Sleep</span>              }          }      }  }</pre>    <p>    <p>Azure Windows にデプロイするときに、ワーカーロールの<b>app.config</b>に<b>は、必ず</b>、またはワーカーロールが完全に初期化されないようにしてください。 次のようになります。</p>    <pre class=\"csharpcode\"><span class=\"kwrd\">&lt;?</span><span class=\"html\">xml</span> <span class=\"attr\">version</span><span class=\"kwrd\">=&quot;1.0&quot;</span> <span class=\"attr\">encoding</span><span class=\"kwrd\">=&quot;utf-8&quot;</span> ?<span class=\"kwrd\">&gt;</span>  <span class=\"kwrd\">&lt;</span><span class=\"html\">configuration</span><span class=\"kwrd\">&gt;</span>    <span class=\"kwrd\">&lt;</span><span class=\"html\">connectionStrings</span><span class=\"kwrd\">&gt;</span>      <span class=\"kwrd\">&lt;</span><span class=\"html\">add</span> <span class=\"attr\">name</span><span class=\"kwrd\">=&quot;ASPState&quot;</span> <span class=\"attr\">connectionString</span><span class=\"kwrd\">=&quot;Server=tcp:…;Trusted_Connection=False;Encrypt=True;&quot;</span><span class=\"kwrd\">/&gt;</span>    <span class=\"kwrd\">&lt;/</span><span class=\"html\">connectionStrings</span><span class=\"kwrd\">&gt;</span></pre>    <p>    <p>上記のコードを切り取って貼り付ける場合は、 <a href=\"https://sql.azure.com/\">SQL Azure ポータル</a>の SQL Azure 接続文字列と一致するように<b>connectionString</b>属性を変更してください。</p>    <h2>まとめ</h2>    <p>質問、懸念事項、コメントがありますか。 これらを下に投稿してください。</p>"
