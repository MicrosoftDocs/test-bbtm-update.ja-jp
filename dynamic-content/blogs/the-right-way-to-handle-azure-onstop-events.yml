### YamlMime:Yaml
ms.openlocfilehash: f7d498bc3c63c591d4169bb594ed195e3a27c21c
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139905101"
Slug: the-right-way-to-handle-azure-onstop-events
Title: Azure OnStop イベントを処理するための適切な方法
Summary: 'Editor のメモ: この投稿は、Windows Azure および ASP.NET MVC チームのプログラマ/ライターである Rick Anderson &nbsp; からのものです。  Web ロールを再起動します。 Windows では、よくありません。'
Content: '<p><strong>エディターのメモ:</strong>この投稿は、Windows Azure と ASP.NET の MVC チームのプログラマ/ライターである<strong> <a href="https://twitter.com/RickAndMSFT" target="_blank">Rick Anderson</a> &nbsp; </strong>からのものです。</p>  <h4>Web ロールの再起動</h4>  <p>Windows Azure では、再起動を処理する方法については、あまり放置されていません。 再起動を正しく処理することが重要である &rsquo; ため、データが失われたり、永続化された &rsquo; データが破損したりすることがあります。これにより、Azure Cloud Service アプリケーションは、オペレーティングシステムの更新のために、1か月に約2回再起動され Windows ます。 &nbsp; (OS の更新の詳細については、「 <a href="https://blogs.msdn.com/b/kwill/archive/2012/09/19/role-instance-restarts-due-to-os-upgrades.aspx" target="_blank">os のアップグレードによるロールインスタンスの再起動</a>」を参照してください)。Web アプリケーションがシャットダウンされるときに、 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">Roleenvironment. 停止</a> イベントが発生します。 Visual Studio によって作成された web ロールの定型句は<a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx">OnStop</a>メソッドをオーバーライドしないため、アプリケーションの HTTP 要求の処理が終了するまでに数秒しかかかりません。 Web ロールが保留中の要求でビジー状態になっている場合、一部の要求が失われる可能性があります。 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> &nbsp; メソッドをオーバーライドしてスリープを呼び出すことにより、再起動または web ロールを最大5分遅延させることができますが &rsquo; 、これは最適ではありません。 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">停止</a>イベントが発生すると、負荷分散 (LB) によって web ロールへの要求の送信が停止されます。そのため、保留中の要求の処理にかかる時間よりも長く再起動を遅らせることで、仮想マシンがスリープ状態のままになり、役に立ちません。 最適な方法は、要求がなくなるまで <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> メソッドを待機してから、シャットダウンを開始することです。 すぐにシャットダウンすると、VM が再起動して要求の処理を開始できるようになります。 最適なシャットダウン戦略を実装するには、 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx" target="_blank">WebRole</a> クラスに次のコードを追加します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4251.aa.PNG" alt="" border="0"></a></p>  <p>上記のコードでは、ASP.NET 要求 &rsquo; s の現在のカウンターをチェックします。 要求がある限り、 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> メソッドはスリープを呼び出してシャットダウンを遅延させることができます。 現在の要求 &rsquo; s カウンターがゼロになると、 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> はを返します。これにより、シャットダウンが開始されます。 Web サーバーがビジー状態になり、保留中の要求を5分以内に完了できない場合、アプリケーションはシャットダウンされます。 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">停止</a>イベントが発生すると、LB は web ロールへの要求の送信を停止します。そのため、大規模な (またはインスタンスが少なすぎる) web ロールのサイズが非常に大きい場合を除き、現在の要求を完了するのに数秒以上かかることはありません。</p>  <p>上記のコードではトレースデータを書き込みますが、 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/gg433075.aspx" target="_blank">必要に応じてオンデマンド転送</a>を実行しない限り、 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> メソッドからのトレースデータは <strong>WADLogsTable</strong>に表示されません。 このブログ &rsquo; の後半では、 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">debugview</a> を使用してこれらのトレースイベントを表示する方法について説明します。 &rsquo;また、web ロール<a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx" target="_blank">OnStart</a>メソッドでトレースを取得する方法についても説明します。</p>  <h4>Worker ロールの再起動の最適化</h4>  <p>ワーカーロールでの <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">停止</a> イベントの処理には、別のアプローチが必要です。 通常、ワーカーロールは <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx" target="_blank">Run</a> メソッドでキューメッセージを処理します。 この戦略には、2つのグローバル変数が含まれます。1つは、<a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx" target="_blank">停止</a>イベントが発生したことを<a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx" target="_blank">Run</a>メソッドに通知するためのもので、もう1つは、シャットダウンを開始する安全であること &rsquo; を<a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a>メソッドに通知するためのグローバルです。 (シャットダウンは、 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a>から戻ることによって開始されます)。次のコードは、2つのグローバルアプローチを示しています。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/5102.aa1.PNG" alt="" border="0"></a></p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7484.aa2.PNG" alt="" border="0"></a></p>  <p><a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a>が呼び出されると、グローバル<strong>onstopcalled</strong>れたが true に設定されます。これは、キューイベントが処理されないときに、 <a href="https://msdn.microsoft.com/en-us/library/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx" target="_blank">Run</a>メソッド内のコードがループの先頭でシャットダウンすることを通知します。</p>  <h4>OnStop トレースデータの表示</h4>  <p>前述のように、必要に応じて <a href="https://msdn.microsoft.com/en-us/library/windowsazure/gg433075.aspx" target="_blank">オンデマンド転送</a>を実行しない限り、 <a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a> メソッドからのトレースデータは <strong>WADLogsTable</strong>に表示されません。 &rsquo; <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">Dbgview</a>を使用して、これらのトレースイベントを確認します。 ソリューションエクスプローラーで、クラウドプロジェクトを右クリックし、[ <strong>発行</strong>] を選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1565.aa3.png" alt="" border="0"></a></p>  <p>発行プロファイルをダウンロードします。 &nbsp;[ <strong>Publish Windows Azure アプリケーション</strong>] ダイアログボックスで、[<strong>デバッグ</strong>] を選択し、[すべてのロールの<strong>リモートデスクトップを有効にする</strong>] を選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0116.aa4.png" alt="" border="0"></a></p>  <p>コンパイラはリリースビルドからのトレース呼び出しを削除するため &rsquo; 、トレースデータを表示するには、ビルド構成を [<strong>デバッグ</strong> &nbsp; ] に設定する必要があります。 アプリケーションが発行され、実行されたら、Visual Studio で [<strong>サーバーエクスプローラー</strong> (Ctl + Alt + S)] を選択します。 [ <strong>Windows Azure Compute</strong>] を選択し、クラウドデプロイを選択します。 (この場合 &rsquo; 、は t6 と &rsquo; 呼ばれ、運用環境のデプロイです)。web ロールインスタンスを選択し、右クリックして、[<strong>リモートデスクトップを使用して Connect</strong>] を選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/3223.aa5.png" alt="" border="0"></a></p>  <p>リモートデスクトップ接続 (RDC) は、発行ウィザードで指定したアカウント名を使用し、入力したパスワードの入力を求めます。 タスクバーの左側で、[ <strong>サーバーマネージャー</strong> ] アイコンを選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8463.aa6.png" alt="" border="0"></a></p>  <p><strong>サーバーマネージャー</strong>の左側のタブで、[<strong>ローカルサーバー</strong>] を選択し、[ <strong>ie セキュリティ強化の構成</strong>] (ie ESC) を選択します。 [IE ESC] ダイアログボックスの [オフ] オプションボタンを選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/1447.aa7.png" alt="" border="0"></a></p>  <p>Internet Explorer を起動し、 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">Debugview</a>をダウンロードしてインストールします。 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">Debugview</a>を起動し、<strong>キャプチャ</strong>メニューで [<strong>グローバル Win32 のキャプチャ</strong>] を選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8688.aa8.png" alt="" border="0"></a></p>  <p>フィルターアイコンを選択し、次の除外フィルターを入力します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4532.0.PNG" alt="" border="0"></a></p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/0246.aa9.png" alt="" border="0"></a></p>  <p>このテストでは、名前に示されているように、 <a href="https://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.serviceruntime.roleenvironment.requestrecycle.aspx" target="_blank">Roleenvironment. requestrecycle</a> &nbsp; メソッドを<strong>About</strong>アクションメソッドに追加しました。これにより、シャットダウン/再起動シーケンスが開始されます。 もう1つの方法として、アプリケーションを再度発行することもできます。これにより、シャットダウン/再起動シーケンスも開始されます。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8561.aa10.png" alt="" border="0"></a></p>  <p>同じ手順に従って、worker ロール VM のトレースデータを表示します。 worker ロールのインスタンスを選択し、右クリックして、[<strong>リモートデスクトップを使用して Connect</strong>] を選択します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/8306.aa11.png" alt="" border="0"></a></p>  <p>上記の手順に従って、 <strong>IE セキュリティ強化の構成</strong>を無効にします。 上記の手順に従って、 <a href="https://technet.microsoft.com/en-us/sysinternals/bb896647.aspx" target="_blank">Debugview</a> をインストールして構成します。 Worker ロールには次のフィルターを使用します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4606.00.PNG" alt="" border="0"></a></p>  <p>&nbsp;このサンプルでは、Azure パッケージを発行しました。これにより、シャットダウン/再起動の手順が実行されます。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/7607.aa12.png" alt="" border="0"></a></p>  <p>最後に出発したヒント: web ロール <strong>OnStart</strong> メソッドでトレースを実行するには、次のものを追加します。</p>  <p><a href="" target="_blank"><img src="https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/4130.000.PNG" alt="" border="0"></a></p>  <p><strong>WADLogsTable</strong>に表示される<a href="https://technet.microsoft.com/en-us/subscriptions/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx" target="_blank">OnStop</a>メソッドからトレース &nbsp; データを取得する方法についてのブログが必要 &rsquo; な場合は、お知らせください。 &nbsp;このブログのほとんどの情報は、 <a href="https://azure.microsoft.com/en-us/develop/net/tutorials/multi-tier-web-site/1-overview/" target="_blank">Azure 多層チュートリアル</a>Tom から、先週公開されたものです。 他の多くのヒントについては、必ず確認してください。&nbsp;<br><br>--Rick<br><a href="https://twitter.com/RickAndMSFT">@RickAndMSFT</a>&nbsp;</p>'
