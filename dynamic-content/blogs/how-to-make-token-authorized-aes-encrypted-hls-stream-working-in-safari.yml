### YamlMime:Yaml
ms.openlocfilehash: 9d6d3cccda5a4b0db83b879c92bc9386be538b1b
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139910772"
Slug: how-to-make-token-authorized-aes-encrypted-hls-stream-working-in-safari
Title: トークンが承認された AES で暗号化された HLS ストリームを Safari で動作させる方法
Summary: Azure Media Servicesは、AES キーの取得でトークン承認が構成された AES で暗号化された HLS ストリームを生成する機能を提供します。
Content: "<p>Azure Media Servicesは、AES キーの取得でトークン承認が構成された <a href=\"https://azure.microsoft.com/blog/2015/01/29/azure-media-services-enhances-streaming-security-with-general-availability-of-drm-technology/\" target=\"_blank\">AES で暗号化された HLS ストリーム</a>を生成する機能を提供します。 ただし、ご存知のように、Safari はネイティブ スタック内で HLS プレイリストとキーの取得を処理します。開発者がキー要求をインターセプトし、トークンを 2 つ目のレベルの HLS プレイリストに追加する簡単な方法はありません。 認証モジュールで何らかのマジックを実行してこれを機能させる場合に提案されるソリューションを次に示します。 このソリューションのしくみを示す図を次に示します。 <img alt=\"\" src=\"https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/architecture_thumb.png\" style=\"padding-top: 0px; padding-left: 0px; padding-right: 0px; border-width: 0px; width: 640px; height: 247px;\" title=\"\"></p>\n\n<h2>各ステップの説明:</h2>\n\n<p>1. 顧客は、ビデオ ID を使用して認証システムに要求を送信します。 ビデオ ID と実際のストリーミング URL の間にいくつかのマッピングが必要です。 2. 認証システムはユーザーを認証し、ビデオ ストリーミング URL を使用して Azure Media Servicesプレイリストを要求します。 ストリーミング&rsquo; URL は次のように表示されます <a href=\"(format=m3u8-aapl\">(format=m3u8-aapl</a>)。 3. Azure Media Services、上部のプレイリストが認証システムに返されます。 上位のプレイリストは次のように表示されます。</p>\n\n<pre class=\"prettyprint\">\n#EXTM3U \n#EXT-X-VERSION:4 \n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&quot;audio&quot;,NAME=&quot;AAC_und_ch2_96kbps&quot;,URI=&quot;QualityLevels(92405)/Manifest(AAC_und_ch2_96kbps,format=m3u8-aapl)&quot; \n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&quot;audio&quot;,NAME=&quot;AAC_und_ch2_56kbps&quot;,DEFAULT=YES,URI=&quot;QualityLevels(53017)/Manifest(AAC_und_ch2_56kbps,format=m3u8-aapl)&quot;\n#EXT-X-STREAM-INF:BANDWIDTH=1092766,RESOLUTION=384x288,CODECS=&quot;avc1.4d4015,mp4a.40.2&quot;,AUDIO=&quot;audio&quot;\nQualityLevels(960870)/Manifest(video,format=m3u8-aapl)\n#EXT-X-STREAM-INF:BANDWIDTH=1607960,RESOLUTION=480x360,CODECS=&quot;avc1.4d401e,mp4a.40.2&quot;,AUDIO=&quot;audio&quot;\nQualityLevels(1464974)/Manifest(video,format=m3u8-aapl)\n#EXT-X-STREAM-INF:BANDWIDTH=62343,CODECS=&quot;mp4a.40.2&quot;,AUDIO=&quot;audio&quot;\nQualityLevels(53017)/Manifest(AAC_und_ch2_56kbps,format=m3u8-aapl) \n</pre>\n\n<p>4. 上位のプレイリストを変更して、プレーヤー (この場合は Safari) がキー サービスではなくプロキシ サーバーに直接 ping を実行し、プレイリストにトークンを追加します。 認証システムには、トークンの構成方法に関する知識がありますが、プロキシ サーバーでは知&rsquo;らされません。 上位のプレイリストの変更方法を次に示します。</p>\n\n<pre class=\"prettyprint\">\n#EXTM3U\n#EXT-X-VERSION:4\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&quot;audio&quot;,NAME=&quot;AAC_und_ch2_56kbps&quot;,URI=&quot;https://test.cloudvideo.azure-int.net/api/ManifestProxy?playbackUrl=(53017)/Manifest(AAC_und_ch2_56kbps,format=m3u8-aapl)&amp;token=[PUT_YOUR_TOKEN_HERE]&quot;\n#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID=&quot;audio&quot;,NAME=&quot;AAC_und_ch2_96kbps&quot;,DEFAULT=YES,URI=&quot;https://proxy.cloudvideo.azure-int.net/api/ManifestProxy?playbackUrl=(92405)/Manifest(AAC_und_ch2_96kbps,format=m3u8-aapl)&amp;token=[PUT_YOUR_TOKEN_HERE]&quot;\n#EXT-X-STREAM-INF:BANDWIDTH=1092766,RESOLUTION=384x288,CODECS=&quot;avc1.4d4015,mp4a.40.2&quot;,AUDIO=&quot;audio&quot;\nhttps://proxy.cloudvideo.azure-int.net/api/ManifestProxy?playbackUrl=(960870)/Manifest(video,format=m3u8-aapl)&amp;token=[PUT_YOUR_TOKEN_HERE]\n#EXT-X-STREAM-INF:BANDWIDTH=1607960,RESOLUTION=480x360,CODECS=&quot;avc1.4d401e,mp4a.40.2&quot;,AUDIO=&quot;audio&quot;\nhttps://proxy.cloudvideo.azure-int.net/api/ManifestProxy?playbackUrl=(1464974)/Manifest(video,format=m3u8-aapl)&amp;token=[PUT_YOUR_TOKEN_HERE]\n</pre>\n\n<p>上記の例では、絶対パスを URI に入れる必要があります (そうしないと、要求は Auth サーバーに返されます)。</p>\n\n<ul>\n <li><a href=\"https://test.cloudvideo.azure-int.net/api/ManifestProxy?\" title=\"https://test.cloudvideo.azure-int.net/api/ManifestProxy?\">https://test.cloudvideo.azure-int.net/api/ManifestProxy?</a> はプロキシ サーバーのアドレスであり、ManifestProxy は後で URI を解析する のパラメーターにすすまれます</li>\n <li>PlaybackURL は実際のストリーミング URL です (ただし、URL は品質レベルの追加を含む 2 つ目のレベルのマニフェストになります)</li>\n <li>トークンは、パラメーターとして末尾に追加されます。 キー サービスは、キー要求のパラメーターとしてトークンを受け入れる</li>\n</ul>\n\n<p>5. Safari は URI パラメーターに&nbsp; 指定された URL に基づいて要求を送信し、キー情報を含む 2 番目のレベルのプレイリストを取得します。 プロキシ サーバーを指すプレイリストを変更したので、要求はプロキシ サーバー 6 に送信されます。 プロキシ サーバーは、第 2 レベルのプレイリスト要求を受け取ります。 プレイリスト<a href=\"https://test.cloudvideo.azure-int.net/api/ManifestProxy?\" title=\"https://test.cloudvideo.azure-int.net/api/ManifestProxy?https://test.cloudvideo.azure-int.net/api/ManifestProxy?\"></a>内の playbackUrl を含むオリジン サーバーを削除して ping し、実際のキー URL を含む 2 つ目のプレイリストを取得します。 そして、この 2 つ目のレベルの Playlist 内にトークンを追加します。 そのため、返されるプレイリストは次のように表示されます。</p>\n\n<pre class=\"prettyprint\">\n#EXTM3U\n#EXT-X-VERSION:4\n#EXT-X-ALLOW-CACHE:NO\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-TARGETDURATION:10\n#EXT-X-KEY:METHOD=AES-128,URI=&quot;https://test.keydelivery.mediaservices.windows.net/?kid=a99263cd-43b3-490a-a4d6-ea04d4645fb7&amp;token=[PUT_YOUR_Token]\n#EXT-X-PROGRAM-DATE-TIME:1970-01-01T00:00:00Z\n#EXTINF:3.947392,no-desc\n(92405)/Fragments(AAC_und_ch2_96kbps=0,format=m3u8-aapl)\n#EXT-X-ENDLIST\n</pre>\n\n<p>7. Safari は、#EXT-X-KEY:METHOD=AES-128,URI= の後に URI を含むキー要求をキー サーバーに送信します。 トークンはパラメーターとして埋め込まれているので、キー サービスは要求を承認し、プレーヤーに AES キーを与える可能性があります。 この&#39;&nbsp;プロキシ サーバー上のプレイリストを変更するために使用したコードをアップロードして、この作業を行いました<a href=\"https://github.com/AzureMediaServicesSamples/HLSSafariProxy\" target=\"_blank\"></a>。動作中のサンプル サイトについては、こちらを参照<a href=\"https://mingfeiy.azurewebsites.net/\" target=\"_blank\">してください</a>。&nbsp;ご質問がある場合は、お問い合わせください。</p>"
