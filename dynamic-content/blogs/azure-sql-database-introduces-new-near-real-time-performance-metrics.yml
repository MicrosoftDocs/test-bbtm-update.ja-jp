### YamlMime:Yaml
ms.openlocfilehash: 21c3ef241e8ed8189116fbfc000814103d1f95fe
ms.sourcegitcommit: d03bdc7fe5447adb6530886aab848b75fe8fa8ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/11/2022
ms.locfileid: "139889948"
Slug: azure-sql-database-introduces-new-near-real-time-performance-metrics
Title: Azure SQL Database では、ほぼリアルタイムのパフォーマンスメトリックが新しく導入されました
Summary: この記事では、この DMV からの情報を使用して、データベースワークロードに適したパフォーマンスレベルを評価および選択するプロセスについて、簡単な手順とガイドラインについて説明します。
Content: "<strong>エディターのメモ-</strong>最新情報については、「 <a href=\"https://azure.microsoft.com/en-us/documentation/articles/sql-database-upgrade-new-service-tiers/\">SQL Database Web/Business データベースを新しいサービス階層にアップグレードする</a>」を参照してください。\n\nAzure SQL Database サービスの新しいサービス/パフォーマンスレベルのプレビュー (<a href=\"https://msdn.microsoft.com/en-us/library/dn741336.aspx\">Basic、Standard、プレミアム</a>) の最近の導入により、お客様のデータベースに最適なサービス階層を評価して決定する方法に関して、多くの質問が寄せられています。 この決定を効率化するために、Azure SQL Database によって、詳細なリアルタイムリソース消費データを公開する新しい動的管理ビュー (DMV- <b><i>sys.dm_db_resource_stats</i></b>) が追加されました。 この新しい DMV とその使用方法の詳細については、 <a href=\"https://msdn.microsoft.com/en-us/library/dn800981.aspx\">MSDN ドキュメント</a>を参照してください。 このブログの投稿では、この DMV からの情報を使用して、データベースワークロードに適したパフォーマンスレベルを評価および選択するプロセスに関する簡単な手順とガイドラインについて説明します。\n<h3>適切なサービス階層/パフォーマンスレベルの選択</h3>\n1. アプリケーションまたはビジネス要件に必要な最小限の機能を提供するサービスレベルを決定します。 たとえば、バックアップが保持される期間やデータベース全体のサイズが最小サービスレベルに影響を与えるビジネス要件があります (詳細については、 <a href=\"https://azure.microsoft.com/blog/2014/08/26/new-azure-sql-database-service-tiers-generally-available-in-september-with-reduced-pricing-and-enhanced-sla/\">サービスレベルのアナウンス</a> に関するブログを参照してください)。\n\n2. 選択したサービスレベルの最低のパフォーマンスレベルでデータベースを作成します。 たとえば、Standard サービスレベルを選択した場合は、パフォーマンスレベル S1 から開始します。\n<blockquote><b>注</b>:<i>データベースのサービス/パフォーマンスレベルの変更は、Azure SQL Database ポータルページのボタンをクリックするだけで簡単に行うことができます。これは完全なオンライン操作であり、データベースはこの操作の期間中に使用できます。</i></blockquote>\n3. 通常の運用環境でのデータベース使用の予想される範囲をキャプチャする期間中に、アプリケーションの代表的なワークロードを1時間以上実行します。\n\n4. 新しい DMV sys.dm_db_ resource_stats に対してクエリを実行し、過去1時間のリソース消費量に関する情報を取得します。 次のクエリでは、データベースのリソース使用量が、このパフォーマンスレベルで提供されているリソース制限 (割合に適合) に収まる割合に関する情報を提供しています。これは、データベースをパフォーマンスレベルの制限の80% 以内に実行することを前提としています。\n<pre class=\"prettyprint\">SELECT \n    (COUNT(end_time) - SUM(CASE WHEN avg_cpu_percent &gt; 80 THEN 1 ELSE 0 END) * 1.0) / COUNT(end_time) AS 'CPU Fit Percent'\n    ,(COUNT(end_time) - SUM(CASE WHEN avg_log_write_percent &gt; 80 THEN 1 ELSE 0 END) * 1.0) / COUNT(end_time) AS 'Log Write Fit Percent'\n    ,(COUNT(end_time) - SUM(CASE WHEN avg_data_io_percent &gt; 80 THEN 1 ELSE 0 END) * 1.0) / COUNT(end_time) AS 'Physical Data Read Fit Percent'\nFROM sys.dm_db_resource_stats</pre>\nデータベースのサービスレベル目標 (SLO) に基づき、ワークロードがこのパフォーマンスレベルに適合するかどうかを判断できます。 たとえば、データベースワークロード SLO が99.9% で、上記のクエリが3つのリソースディメンションのいずれかに対して99.9% 未満の値を返す場合は、次に高いパフォーマンスレベルに移行するか、Azure SQL Database の負荷を軽減するようにアプリケーションを調整することを検討する必要があります。\n<blockquote><b>注</b>: <i>1 時間以上の忠実度の高いデータが必要な場合は、上記の DMV のクエリを1時間ごとに実行し、データを別のローカル DB/excel スプレッドシートに保存することができます。または、カタログビューの</i> <a href=\"https://msdn.microsoft.com/en-us/library/dn269979.aspx\"><i>sys.resource_stats</i></a>を照会して、<i>過去14日間に同じデータを取得することもできます。ただし、5分の平均の精度は低くなります。</i></blockquote>\n1. 高いパフォーマンスレベルを試す場合は、データベースを次に高いパフォーマンスレベルにアップグレードし、上記の手順3-4 を繰り返します。\n\n2. 必要な SLO と待機時間を使用してワークロードに適した適切なパフォーマンスレベルを見つけたら、この DMV を使用して、リソース使用量を定期的に監視することができます。 このリソース使用量の情報と関連するグラフは、Microsoft Azure ポータルページからも入手できます。\n<h3>データベースワークロードがリソース制限に達した場合はどうなりますか。</h3>\n選択したサービス レベル/パフォーマンス レベルで許可されている最大限度までデータベース ワークロードを実行するため、必要なリソースを提供できるようにパフォーマンス レベルが調整、制御されます。 ワークロードが CPU/データ IO/ログ IO 制限の1つの制限に達した場合、許可される最大レベルでリソースを受信し続けますが、クエリの待機時間が長くなる可能性があります。 これらの制限によってエラーが発生することはありませんが、ワークロードの速度が低下するだけです。ただし、クエリがタイムアウトになることはありません。許可される同時ユーザーセッション/要求の最大数 (ワーカースレッド) の制限に達している場合は、明示的なエラーが表示されます ( <a href=\"https://msdn.microsoft.com/en-us/library/azure/dn338078.aspx\">こちら</a>の MSDN ドキュメントを参照してください)。\n<h3>Web/business tier データベースのガイドライン</h3>\n新しい DMV sys.dm_db_resource_stats には、web/business 層データベースのリソース消費量データが表示されません。 ただし、master データベースの以前の <a href=\"https://msdn.microsoft.com/en-us/library/dn269979.aspx\">sys.resource_stats</a> ビューには、web/business 層データベースのリソース消費データも含まれています。 Web/Business レベルのデータベースには、保証された Dtu/リソースの制限はありません。そのため、S2 パフォーマンスレベルでは、データベースで使用できるリソースの量の観点からパーセンテージの値を正規化します。 S2 データベースレベルの観点から、DTU 消費情報を使用すると、Web/Business データベースの現在の使用量を新しいレベルのデータベースの観点から正規化し、最適な場所を確認することができます。 Master データベースに対する次のクエリでは、S2 データベースの DTU 電力の割合で、Web/Business 層の平均 DTU 消費量を計算できます。\n<pre class=\"prettyprint\">SELECT start_time, end_time,   \n  (SELECT Max(v)    FROM (VALUES (avg_cpu_percent), (avg_physical_data_read_percent), (avg_log_write_percent)) AS value(v)) as [avg_DTU_percent] \nFROM sys.resource_stats where database_name = ‘&lt;your db name&gt;’ order by end_time desc</pre>\nたとえば、DTU の消費が80% の値を示している場合、S2 データベースの制限の80% の割合で DTU を消費していることを示します。 このビューで100% を超える値が表示される場合は、S2 より大きいパフォーマンスレベルが必要であることを意味します。\n\nたとえば、割合の値が300% であるとします。これは、S2 で使用できるリソースの 3 倍のリソースを使用していることを表します。妥当な開始サイズを判断するには、S2 で利用可能な Dtu (50 Dtu) と、次に大きいサイズ (P1 = 100 Dtu、または S2 の200%、P2 = 200 Dtu または S2 の 400%) を比較します。S2 の300% であるため、P2 から開始して再テストする必要があります。\n\nDTU の使用率の割合に基づいて、データベースが S2 パフォーマンスレベル (または、 <a href=\"https://msdn.microsoft.com/en-us/library/dn741336.aspx\">MSDN サイトに記載</a>されているように、さまざまなパフォーマンスレベルの dtu の割合と相対 dtu によって示された下位/上位レベル) 内に収まるかどうかを判断できます。\n<blockquote><b>注:</b> <i>さまざまなパフォーマンスレベル間の相対 DTU 数は、 </i> <a href=\"https://msdn.microsoft.com/en-us/library/dn741327.aspx\"><i>Azure SQL Database ベンチマーク</i></a>ワークロードに基づいてい<i>ます。データベースのワークロードはとは異なる可能性が高いため、新しい階層の web/business データベースに最初に適合するように、上記の計算をガイドラインとして使用する必要があります。データベースを新しい層に移動したら、前のセクションで説明したプロセスを使用して、ワークロードのニーズに合った適切なサービス階層を検証/微調整します。</i></blockquote>"
